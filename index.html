<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Outbound AMZL Tool</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="." />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --system-font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            --mono-font: 'SF Mono', Consolas, 'Courier New', Courier, monospace;
            --primary-bg: #ffffff; /* White background */
            --container-bg: #ffffff;
            --text-color: #1d1d1f;
            --secondary-text-color: #6e6e73;
            --placeholder-text-color: #aaaaaf;
            --accent-blue: #007aff;
            --accent-blue-hover: #0071e3;
            --accent-blue-active: #006adc;
            --accent-blue-rgb: 0, 122, 255;
            --button-bg: #ffffff; /* White button bg */
            --button-text: var(--accent-blue); /* Blue button text */
            --button-border-color: #d2d2d7; /* Light grey button border */
            --button-hover-bg: #f5f5f7; /* Slightly grey hover */
            --button-active-bg: #e8e8ed; /* Darker grey active */
            --border-color: #d2d2d7;
            --focus-ring-color: rgba(var(--accent-blue-rgb), 0.25);
            --shadow-color-light: rgba(0, 0, 0, 0.04);
            --shadow-color-medium: rgba(0, 0, 0, 0.08);
            --base-border-radius: 10px; /* Adjusted rounding */
            --button-border-radius: 6px; /* Slightly less round buttons */
            --input-border-radius: 6px; /* Slightly less round inputs */
        }
        html { box-sizing: border-box; }
        *, *:before, *:after { box-sizing: inherit; }
        body {
            font-family: var(--system-font); background-color: var(--primary-bg);
            color: var(--text-color); margin: 0; padding: 0; display: flex;
            flex-direction: column; min-height: 100vh;
            -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
            font-size: 14px;
        }

        .main-wrapper {
            display: flex;
            flex-direction: column; /* Default: Column layout for narrow screens */
            flex-grow: 1; padding: 16px; gap: 16px;
            width: 100%; max-width: 1600px; /* Increased max-width for wide screens */
            margin: 0 auto;
        }

        /* Side-by-side layout for wider screens */
        @media (min-width: 992px) {
            .main-wrapper {
                flex-direction: row;
                padding: 24px; gap: 24px;
                align-items: stretch; /* Make columns equal height */
            }
            .parser-tool {
                width: 35%; /* Adjust width */
                flex-shrink: 0;
                height: fit-content; /* Don't stretch parser tool vertically */
                max-height: calc(100vh - 48px); /* Limit height */
                overflow-y: auto; /* Allow scrolling if needed */
            }
            .note-taker-tool {
                width: 65%; /* Adjust width */
                flex-shrink: 0;
                display: flex; /* Needed for textarea growth */
                flex-direction: column;
                max-height: calc(100vh - 48px); /* Limit height */
            }
             #noteArea {
                 flex-grow: 1; /* Allow textarea to fill space */
                 min-height: 300px; /* Adjust min height for row layout */
            }
             .note-taker-tool .controls-and-stats {
                 flex-shrink: 0; /* Prevent controls from shrinking */
                 margin-top: 16px; /* Add space above controls */
             }
             .note-taker-tool #merchantList {
                max-height: 180px; /* Adjust merchant list height */
             }
        }

        .tool-container {
             background-color: var(--container-bg); border-radius: var(--base-border-radius);
             box-shadow: 0 1px 2px var(--shadow-color-light), 0 3px 8px var(--shadow-color-medium);
             padding: 20px;
             display: flex; flex-direction: column; position: relative;
             border: 1px solid var(--border-color);
             /* Removed flex property to let content define size initially */
         }

        textarea, input[type="text"], input[type="number"] {
            width: 100%; margin-bottom: 12px; padding: 10px 12px;
            border: 1px solid var(--border-color); border-radius: var(--input-border-radius);
            background-color: var(--container-bg);
            color: var(--text-color);
            line-height: 1.5; font-family: var(--system-font); font-size: 14px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            box-shadow: none; /* Removed inner shadow */
        }
        textarea {
            font-family: var(--mono-font);
            resize: vertical;
            min-height: 100px;
        }
        textarea::placeholder, input::placeholder { color: var(--placeholder-text-color); }
        textarea:focus, input[type="text"]:focus, input[type="number"]:focus {
            border-color: var(--accent-blue); outline: none;
            box-shadow: 0 0 0 3px var(--focus-ring-color); /* Adjusted focus ring */
        }
        input[type="number"] { width: auto; margin-bottom: 0; }

       #shipmentInput {
           margin-bottom: 0;
           flex-grow: 1; /* Allow textarea to grow if needed */
       }
       #noteArea {
           min-height: 350px;
           margin-bottom: 16px;
           flex-grow: 1; /* Allow textarea to fill space */
       }

        /* Updated Button Styles */
        button {
            background-color: var(--button-bg); color: var(--button-text);
            padding: 7px 14px; /* Slightly adjusted padding */
            border: 1px solid var(--button-border-color);
            border-radius: var(--button-border-radius); cursor: pointer; margin: 0;
            transition: background-color 0.15s ease, border-color 0.15s ease, transform 0.1s ease;
            font-family: var(--system-font);
            font-weight: 500; font-size: 13px; /* Slightly smaller font */
            flex-shrink: 0; text-align: center; display: inline-flex;
            align-items: center; justify-content: center; position: relative; overflow: hidden;
            box-shadow: none; /* Remove default shadow */
        }
        button:hover {
            background-color: var(--button-hover-bg);
            border-color: #c8c8cd; /* Slightly darker border on hover */
            box-shadow: none;
        }
        button:active {
            background-color: var(--button-active-bg);
            border-color: #b5b5ba; /* Darker border on active */
            transform: scale(0.97);
            box-shadow: none;
        }
        button:disabled {
             background-color: #f8f8f8; /* Lighter disabled background */
             color: #b5b5b7;
             border-color: #e8e8ed; /* Lighter disabled border */
             cursor: not-allowed; box-shadow: none;
        }
        button:disabled:hover { background-color: #f8f8f8; border-color: #e8e8ed; }
        button:disabled:active { transform: none; }

        /* Remove secondary distinction if all buttons are styled the same */
        button.secondary { /* These styles are now the same as default */ }
        button.secondary:hover { }
        button.secondary:active { }
        button.secondary:disabled { }


        .note-taker-tool .controls-and-stats { display: flex; flex-direction: column; gap: 12px; flex-shrink: 0; margin-top: auto; }
        .note-taker-tool .top-controls { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .note-taker-tool .button-group { display: flex; gap: 8px; flex-wrap: wrap; }
        .note-taker-tool .counter-pill { display: inline-flex; align-items: center; gap: 12px; background-color: #f0f0f5; padding: 5px 14px; border-radius: 20px; border: 1px solid #e8e8ed; } /* Added border */
        .note-taker-tool .counter-pill p { margin: 0; font-size: 12px; font-weight: 500; color: var(--secondary-text-color); } /* Slightly smaller font */
        .note-taker-tool .counter-pill span { font-weight: 600; color: var(--text-color); margin-left: 2px; }
        .note-taker-tool .stats { padding: 12px 0 0 0; background-color: transparent; border-radius: 0; border: none; border-top: 1px solid var(--border-color); display: flex; flex-direction: column; flex-shrink: 0; margin-top: 12px; }
        .note-taker-tool .bulk-actions { margin-bottom: 12px; display: flex; gap: 8px; flex-wrap: wrap; flex-shrink: 0; }
        .note-taker-tool #merchantList { flex-grow: 0; flex-shrink: 0; max-height: 200px; overflow-y: auto; margin: 0; padding: 0; } /* Adjusted height */
        .note-taker-tool .merchant-stats { margin: 0 0 4px 0; padding: 7px 10px; background-color: transparent; border: none; border-radius: 5px; display: flex; align-items: center; justify-content: flex-start; font-size: 13px; transition: background-color 0.15s ease; cursor: pointer; } /* Smaller font/padding */
        .note-taker-tool .merchant-stats:hover { background-color: #f0f0f5; } /* Use light grey hover */
        .note-taker-tool .merchant-stats:has(.merchant-checkbox:checked) { background-color: #e8f3ff; } /* Lighter blue checked */
        .note-taker-tool .merchant-stats > div { display: flex; align-items: center; justify-content: flex-start; width: 100%; gap: 8px; }
        .note-taker-tool .merchant-checkbox { appearance: none; -webkit-appearance: none; -moz-appearance: none; width: 16px; height: 16px; border: 1px solid #c7c7cc; border-radius: 4px; outline: none; cursor: pointer; position: relative; transition: background-color 0.15s ease, border-color 0.15s ease; flex-shrink: 0; background-color: var(--container-bg); margin: 0; }
        .note-taker-tool .merchant-checkbox:checked { background-color: var(--accent-blue); border-color: var(--accent-blue); }
        .note-taker-tool .merchant-checkbox:checked::after { content: ''; position: absolute; top: 1px; left: 4px; width: 4px; height: 8px; border: solid white; border-width: 0 2px 2px 0; transform: rotate(45deg); }

        /* Scrollbar Styling */
        * { scrollbar-width: thin; scrollbar-color: #c0c0c0 transparent; }
        *::-webkit-scrollbar { width: 9px; height: 9px; }
        *::-webkit-scrollbar-track { background: transparent; }
        *::-webkit-scrollbar-thumb { background-color: #cccccc; border-radius: 5px; border: 2px solid transparent; background-clip: content-box; }
        *::-webkit-scrollbar-thumb:hover { background-color: #b3b3b3; }

        .button-ripple { display: none; }

        .parser-controls {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-top: 12px; /* Reduced top margin */
            margin-bottom: 0; /* Remove bottom margin */
            padding-bottom: 4px; /* Add slight padding if needed */
            flex-wrap: wrap;
        }
        .toggle-label {
            font-size: 13px;
            color: var(--text-color);
            cursor: pointer;
            user-select: none;
            margin-right: 4px;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 22px;
            flex-shrink: 0;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #c7c7cc; transition: .3s; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 2px; bottom: 2px; background-color: white; transition: .3s; box-shadow: 0 1px 3px rgba(0,0,0,0.15); } /* Slightly softer shadow */
        input:checked + .slider { background-color: var(--accent-blue); } /* Updated to blue */
        input:focus + .slider { box-shadow: 0 0 0 2px var(--focus-ring-color); } /* Use blue focus ring */
        input:checked + .slider:before { transform: translateX(18px); }
        .slider.round { border-radius: 22px; }
        .slider.round:before { border-radius: 50%; }
        .parser-group-label {
            font-size: 13px;
            color: var(--secondary-text-color);
            white-space: nowrap;
            user-select: none;
        }
        .parser-group-input {
            width: 60px;
            padding: 6px 8px;
            font-size: 13px;
            margin-bottom: 0;
            text-align: center;
            border: 1px solid var(--border-color);
            border-radius: var(--input-border-radius);
            background-color: var(--container-bg);
            transition: background-color 0.3s ease, opacity 0.3s ease;
        }
        .parser-group-input:disabled {
            background-color: #f8f8f8;
            color: #bbb;
            cursor: not-allowed;
            opacity: 0.7;
            border-color: #e8e8ed;
        }

        .duplicate-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #ff9f0a;
            border-radius: 50%;
            margin-right: 6px;
            vertical-align: middle;
            flex-shrink: 0;
            box-shadow: none;
        }

        #upsUspsOutputArea {
            width: 100%;
            min-height: 80px; /* Reduced min-height */
            resize: vertical;
            border-radius: var(--input-border-radius);
        }
        #btnProcessUpsUsps {
            margin-top: 8px;
        }
        #upsUspsOutputContainer {
             margin-top: 12px; /* Reduced space above */
             padding-bottom: 4px; /* Add slight padding */
         }

        #splitModal {
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            background-color: rgba(60,60,67,0.4); /* Adjusted overlay color */
        }
        #splitModalContent {
             background-color: #f9f9f9; /* Slightly off-white modal bg */
             margin: auto;
             padding: 20px;
             border: none;
             border-radius: 14px; /* iOS modal rounding */
             width: 90%;
             max-width: 480px;
             box-shadow: 0 6px 20px rgba(0,0,0,0.12);
             display: flex;
             flex-direction: column;
             gap: 12px; /* Reduced gap */
         }
        #splitModalContent h2 {
             margin-top: 0; margin-bottom: 8px; font-size: 1.15em; /* Adjusted size */
             font-weight: 600; color: var(--text-color);
             border-bottom: 1px solid #e5e5ea; padding-bottom: 10px; text-align: center;
         }
        #splitModalContent label {
             font-size: 0.85rem; font-weight: 500; color: var(--secondary-text-color); margin-bottom: 4px; display: block;
         }
         #splitModalContent #splitOrdersPerTemplate,
         #splitModalContent #splitNumberInput {
             margin-bottom: 0;
             border-radius: var(--input-border-radius);
         }
        #splitModalContent #splitOrdersPerTemplate { width: 60px; }
        #splitModalContent #splitNumberInput { width: 75px; flex-grow: 1; }

        #splitMerchantInfo {
             font-size: 0.9em; color: var(--secondary-text-color); background-color: #f0f0f5;
             padding: 8px 12px; border-radius: var(--input-border-radius); border: 1px solid var(--border-color);
         }
        #splitModalContent hr { border: none; border-top: 1px solid #e5e5ea; margin: 6px 0; }
        #splitModalContent .modal-actions { display: flex; gap: 10px; margin-top: 10px; justify-content: flex-end; }

    </style>
</head>
<body>

    <div class="main-wrapper">
        <div class="tool-container parser-tool">
            <textarea id="shipmentInput" placeholder="Paste Amazon removal shipment data here..."></textarea>
            <div class="parser-controls">
                <div style="display: flex; align-items: center; gap: 8px;" id="groupOrdersControl">
                    <label class="toggle-switch">
                        <input type="checkbox" id="groupToggle"> <span class="slider round"></span>
                    </label>
                    <label for="groupToggle" class="toggle-label">Group Orders (AMZL)</label>
                    <input type="number" id="parserGroupSize" min="1" value="2" class="parser-group-input" disabled>
                    <label for="parserGroupSize" class="parser-group-label">Orders per Template</label>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;"> <label class="toggle-switch">
                        <input type="checkbox" id="upsUspsToggle"> <span class="slider round"></span>
                    </label>
                    <label for="upsUspsToggle" class="toggle-label">Extract UPS/USPS</label>
                </div>
            </div>
            <div id="upsUspsOutputContainer" style="display: none;"> <textarea id="upsUspsOutputArea" placeholder="Extracted UPS/USPS Tracking Numbers..."></textarea> <button id="btnProcessUpsUsps">Process & Add to Notes</button> </div>
        </div>

        <div class="tool-container note-taker-tool">
            <textarea id="noteArea" placeholder="Notes area..."></textarea>
            <div class="controls-and-stats">
                <div class="top-controls">
                    <div class="button-group">
                        <button id="btnAddSeparator">Add Separator</button>
                        <button id="btnAddSpacing">Add Spacing</button>
                    </div>
                    <div class="counter-pill">
                        <p class="merchant-count">Merchants: <span id="merchantCount">0</span></p>
                        <p class="total-templates">Cases: <span id="totalTemplates">0</span></p>
                    </div>
                </div>
                <div class="stats">
                    <div class="bulk-actions">
                        <button id="btnDownloadSelected">Download Selected</button>
                        <button id="btnClearSelected">Clear Selected</button>
                        <button id="btnSelectAll">Select All</button>
                        <button id="btnSplitSelected" disabled>Split Selected</button> <button id="btnDownloadAll">Download All Notes</button>
                    </div>
                    <div id="merchantList"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="splitModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; /* background set by CSS */ justify-content: center; align-items: center; font-family: var(--system-font);">
        <div id="splitModalContent">
             <h2>Split Selected Merchant(s)</h2>
            <div id="splitMerchantInfo">
            </div>
            <div>
                <label for="splitOrdersPerTemplate">Removal Orders per Template:</label>
                <input type="number" id="splitOrdersPerTemplate" min="1" value="2" class="parser-group-input">
            </div>
            <div style="font-size: 0.9em; color: var(--secondary-text-color);">
                Calculated Total Templates: <span id="splitCalculatedTemplates" style="font-weight: 600; color: var(--text-color);">0</span>
            </div>
            <hr>
            <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                <label for="splitNumberInput" style="flex-shrink: 0;">Templates per Split File:</label>
                <input type="number" id="splitNumberInput" min="1" placeholder="e.g., 100" class="parser-group-input">
            </div>
            <div class="modal-actions">
                <button id="btnCancelSplit">Cancel</button> <button id="btnGenerateSplits">Generate & Download Splits</button>
            </div>
        </div>
    </div>

<script>
    const amzlTemplate = `We've reviewed our removal orders and discovered some shipments whose delivery status is unclear. Could you please check on your end? We're unable to verify the tracking status. If they were lost in transit, could you kindly issue a reimbursement`;
    const upsUspsTemplate = `The Removal Order Status indicates "Completed," yet we never received this order. We kindly request a reimbursement for this discrepancy.`;
    const noteSeparator = '\n\n' + '-'.repeat(41) + '\n';
    const noteSeparatorRegex = /\n\n-{41}\n/g;
    const localStorageKey = 'savedNotesContent_amzlTool';
    const upsUspsOutputKey = 'stagedUpsUspsTNs_amzlTool';
    const upsUspsContextKey = 'stagedUpsUspsContext_amzlTool';

    let tempUpsUspsData = {};

    function saveNotesToLocalStorage() {
        const noteArea = document.getElementById('noteArea');
        if (noteArea) {
            localStorage.setItem(localStorageKey, noteArea.value);
        }
    }

    function saveUpsUspsOutputToLocalStorage() {
        const upsUspsOutputArea = document.getElementById('upsUspsOutputArea');
        if (upsUspsOutputArea) {
            localStorage.setItem(upsUspsOutputKey, upsUspsOutputArea.value);
        }
    }

    function saveUpsUspsContextToLocalStorage() {
        try {
            localStorage.setItem(upsUspsContextKey, JSON.stringify(tempUpsUspsData));
        } catch (error) {
            console.error("Error saving UPS/USPS context to localStorage:", error);
        }
    }

    function getFormattedDate() {
        const date = new Date();
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        return `${month}-${day}`;
    }

    function countTemplatesInText(text, templateString) {
        if (!text || !templateString) return 0;
        const escapedTemplate = templateString.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        return (text.match(new RegExp(escapedTemplate, 'g')) || []).length;
    }

    function downloadText(text, filename) {
        try {
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        } catch (error) {
            console.error("Error during download:", error);
            alert("An error occurred while trying to download the file.");
        }
    }

    function createRipple(event) {
        // Ripple effect is currently disabled via CSS (.button-ripple { display: none; })
        // If you want it back, remove that line from CSS.
        const btn = event.currentTarget;
        if (!btn || typeof btn.getBoundingClientRect !== 'function') return;
        btn.querySelectorAll('.button-ripple').forEach(ripple => ripple.remove());
        const circle = document.createElement('span');
        const diameter = Math.max(btn.clientWidth, btn.clientHeight);
        const radius = diameter / 2;
        circle.style.width = circle.style.height = `${diameter}px`;
        const rect = btn.getBoundingClientRect();
        circle.style.left = `${event.clientX - rect.left - radius}px`;
        circle.style.top = `${event.clientY - rect.top - radius}px`;
        circle.classList.add('button-ripple');
        // Ensure .button-ripple style exists if re-enabling
        // .button-ripple { position: absolute; border-radius: 50%; background-color: rgba(0, 122, 255, 0.3); transform: scale(0); animation: ripple-effect 0.6s linear; pointer-events: none; z-index: 1; }
        // @keyframes ripple-effect { to { transform: scale(4); opacity: 0; } }
        btn.appendChild(circle);
        setTimeout(() => { circle.remove(); }, 600);
    }

    function sanitizeFilename(name) {
        return name.replace(/[\s\\/:"*?<>|]+/g, '_').substring(0, 50);
    }

    function parseShipmentData() {
        const input = document.getElementById('shipmentInput');
        const noteArea = document.getElementById('noteArea');
        const groupToggle = document.getElementById('groupToggle');
        const groupSizeInput = document.getElementById('parserGroupSize');
        const upsUspsToggle = document.getElementById('upsUspsToggle');
        const upsUspsOutputArea = document.getElementById('upsUspsOutputArea');
        const inputValue = input.value;
        const currentNoteValue = noteArea.value;

        if (!inputValue.trim()) { return; }

        const isUpsUspsMode = upsUspsToggle ? upsUspsToggle.checked : false;

        const trackingNumberSourceRegex = isUpsUspsMode
            ? /\b([A-Z0-9]+)\s*\((UPS|USPS)\)/gi
            : /\b([A-Z0-9]+(?:-|\s)*\(AMZ[NL]\))/g;

        const existingTrackingNumberRegexGlobal = /\b([A-Z0-9]+(?:-|\s)*\((?:AMZ[NL]|UPS|USPS)\))/gi;
        const existingTrackingNumbers = new Set();
        let matchCheck;
        while ((matchCheck = existingTrackingNumberRegexGlobal.exec(currentNoteValue)) !== null) {
            const coreTN = matchCheck[1].replace(/\s*\((?:AMZ[NL]|UPS|USPS)\)$/i, '').replace(/\s|-/g, '');
            if (coreTN) existingTrackingNumbers.add(coreTN);
        }
        if (upsUspsOutputArea && upsUspsOutputArea.value) {
            upsUspsOutputArea.value.split('\n').forEach(tn => {
                const trimmedTn = tn.trim();
                if (trimmedTn) existingTrackingNumbers.add(trimmedTn.replace(/\s|-/g, ''));
            });
        }
        const seenTrackingNumbersInCurrentInput = new Set();


        let groupSize = 1;
        const isGroupingActive = !isUpsUspsMode && groupToggle ? groupToggle.checked : false;
        if (isGroupingActive && groupSizeInput) {
            const parsedValue = parseInt(groupSizeInput.value, 10);
            groupSize = (!isNaN(parsedValue) && parsedValue >= 1) ? parsedValue : 2;
        }

        let removalOrderId = '';
        const removalOrderMatch = inputValue.match(/Removal order ID:\s*([^\n]+)/);
        if (removalOrderMatch) { removalOrderId = removalOrderMatch[1].trim(); }

        const shipmentSections = inputValue.split(/(?=Shipment ID:)/g).filter(section => section.trim() !== '');
        const parsedDataBlocksForAmzl = [];
        const extractedUpsUspsNumbers = [];
        let validShipmentsFound = 0;
        let skippedDuplicateCount = 0;

        shipmentSections.forEach(section => {
            const trackingMatches = Array.from(section.matchAll(trackingNumberSourceRegex));
            if (!trackingMatches || trackingMatches.length === 0) {
                return;
            }

            const sectionCoreTNs = new Set();
            const sectionFullTNs = [];
            trackingMatches.forEach(match => {
                let extractedPart = match[1];
                let fullFormattedTN = '';
                const coreTN = extractedPart.replace(/\s*\((?:AMZ[NL]|UPS|USPS)\)$/i, '').replace(/\s|-/g, '');

                if (!coreTN) return;

                sectionCoreTNs.add(coreTN);

                if (isUpsUspsMode) {
                    fullFormattedTN = `${match[1].trim()}(${match[2]})`;
                } else {
                    fullFormattedTN = extractedPart.replace(/\s*\((AMZ[NL])\)$/, '($1)');
                }
                sectionFullTNs.push(fullFormattedTN);
            });

            let hasDuplicate = false;
            const coreTNsToCheck = Array.from(sectionCoreTNs);

            for (const coreTn of coreTNsToCheck) {
                if (existingTrackingNumbers.has(coreTn) || seenTrackingNumbersInCurrentInput.has(coreTn)) {
                    hasDuplicate = true;
                    break;
                }
            }

            if (hasDuplicate) {
                skippedDuplicateCount++;
                coreTNsToCheck.forEach(tn => seenTrackingNumbersInCurrentInput.add(tn));
                return;
            }

             coreTNsToCheck.forEach(tn => seenTrackingNumbersInCurrentInput.add(tn));

            const shipmentIdMatch = section.match(/^Shipment ID:\s*([^\n]+)/m);
            const shipmentId = shipmentIdMatch ? shipmentIdMatch[1].trim() : 'N/A';

            const productLines = section.split('\n').map(line => line.trim());
            const parsedProducts = []; let currentProduct = null;
            for (let i = 0; i < productLines.length; i++) { const line = productLines[i]; if (line.startsWith('Merchant SKU:')) { if (currentProduct && currentProduct.merchantSku && currentProduct.qty !== undefined) { parsedProducts.push(currentProduct); } currentProduct = { merchantSku: line.substring('Merchant SKU:'.length).trim(), qty: undefined }; } else if (currentProduct) { if (line.startsWith('FNSKU:')) { currentProduct.fnsku = line.substring('FNSKU:'.length).trim(); } else if (/^\d{1,4}$/.test(line) && productLines[i - 1]?.match(/^(EAN|UPC|Condition|Shipped Quantity|Cancelled Quantity):/i)) { currentProduct.qty = parseInt(line, 10); parsedProducts.push(currentProduct); currentProduct = null; } } } if (currentProduct && currentProduct.merchantSku && currentProduct.qty !== undefined && !parsedProducts.includes(currentProduct)) { parsedProducts.push(currentProduct); }

            if (parsedProducts.length === 0) { return; }

            const outputParts = [
                `Removal order ID:${removalOrderId}`,
                `Shipment ID:${shipmentId}`,
                `Tracking Number(s):${Array.from(new Set(sectionFullTNs)).join(', ')}`
            ];
            const productOutputs = parsedProducts.map(p => [`Merchant SKU:${p.merchantSku || 'N/A'}`, `FNSKU:${p.fnsku || 'N/A'}`, `Qty:${p.qty}`].join('\n') );
            const completeDataBlock = outputParts.join('\n') + '\n' + productOutputs.join('\n\n');

            if (isUpsUspsMode) {
                 coreTNsToCheck.forEach(coreTN => {
                     if (!tempUpsUspsData[coreTN]) {
                           tempUpsUspsData[coreTN] = completeDataBlock;
                     }
                    extractedUpsUspsNumbers.push(coreTN);
                 });
            } else {
                parsedDataBlocksForAmzl.push(completeDataBlock);
            }
            validShipmentsFound++;
        });

        if (isUpsUspsMode) {
            if (extractedUpsUspsNumbers.length > 0) {
                const uniqueNumbersToAdd = Array.from(new Set(extractedUpsUspsNumbers));
                upsUspsOutputArea.value += (upsUspsOutputArea.value ? '\n' : '') + uniqueNumbersToAdd.join('\n');
                upsUspsOutputArea.scrollTop = upsUspsOutputArea.scrollHeight;

                saveUpsUspsOutputToLocalStorage();
                saveUpsUspsContextToLocalStorage();

                input.value = '';
                let processedMessage = `Extracted ${uniqueNumbersToAdd.length} unique UPS/USPS number(s) for review. `;
                 if (skippedDuplicateCount > 0) { processedMessage += `Skipped ${skippedDuplicateCount} duplicate(s). `; }
                processedMessage += `Click 'Process' to add to notes.`;
                 input.placeholder = processedMessage;
            } else {
                input.value = '';
                 let message = "No new valid UPS/USPS shipments found. ";
                 if (skippedDuplicateCount > 0) { message += `Skipped ${skippedDuplicateCount} duplicate(s). `; }
                 else if (shipmentSections.length > 0) { message += "Check data format or carrier type. "; }
                 else { message += "Check data format. "; }
                 input.placeholder = message;
            }
        } else {
            let finalOutputString = '';
            if (parsedDataBlocksForAmzl.length > 0) {
                if (groupSize > 1) {
                    const groupedOutputs = [];
                    for (let i = 0; i < parsedDataBlocksForAmzl.length; i += groupSize) {
                        const dataChunk = parsedDataBlocksForAmzl.slice(i, i + groupSize);
                        const completeTemplate = amzlTemplate + "\n\n" + dataChunk.join('\n\n');
                        groupedOutputs.push(completeTemplate);
                    }
                    finalOutputString = groupedOutputs.join('\n\n');
                } else {
                    const individualOutputs = parsedDataBlocksForAmzl.map(dataBlock => amzlTemplate + "\n\n" + dataBlock );
                    finalOutputString = individualOutputs.join('\n\n');
                }

                const currentNoteTrimmed = currentNoteValue.trimEnd();
                const spacing = currentNoteTrimmed ? '\n\n' : '';
                noteArea.value = currentNoteTrimmed + spacing + finalOutputString;
                noteArea.scrollTop = noteArea.scrollHeight;

                countTemplatesNoteTaker();
                saveNotesToLocalStorage();

                input.value = '';
                const groupingStatus = groupSize > 1 ? `ON (${groupSize} per template)` : 'OFF';
                let processedMessage = `Processed ${validShipmentsFound} new AMZL shipment(s). `;
                 if (skippedDuplicateCount > 0) { processedMessage += `Skipped ${skippedDuplicateCount} duplicate(s). `; }
                processedMessage += `Grouping: ${groupingStatus}. Ready...`;
                 input.placeholder = processedMessage;
            } else {
                input.value = '';
                 let message = "No new valid AMZL shipments found. ";
                 if (skippedDuplicateCount > 0) { message += `Skipped ${skippedDuplicateCount} duplicate(s). `; }
                 else if (shipmentSections.length > 0) { message += "Check data format or carrier type. "; }
                 else { message += "Check data format. "; }
                 input.placeholder = message;
            }
        }

        setTimeout(() => {
            if (input) {
                const currentModeIsUps = document.getElementById('upsUspsToggle')?.checked;
                input.placeholder = currentModeIsUps
                    ? "Paste shipment data containing UPS/USPS..."
                    : "Paste Amazon removal shipment data here...";
            }
        }, 5000);
    }

   function processUpsUspsData() {
        const upsUspsOutputArea = document.getElementById('upsUspsOutputArea');
        const noteArea = document.getElementById('noteArea');
        const shipmentInput = document.getElementById('shipmentInput');

        if (!upsUspsOutputArea || !noteArea || !shipmentInput) {
            console.error("Cannot process UPS/USPS data: Missing required elements.");
            return;
        }

        const trackingNumbersToProcess = upsUspsOutputArea.value.split('\n').map(tn => tn.trim()).filter(tn => tn);

        if (trackingNumbersToProcess.length === 0) {
            alert("No UPS/USPS tracking numbers found in the staging area.");
            return;
        }

        let processedBlocks = [];
        let notFoundCount = 0;
        const processedTNs = new Set();

        trackingNumbersToProcess.forEach(tn => {
            const coreTN = tn.replace(/\s|-/g, '');
            if (!processedTNs.has(coreTN)) {
                if (tempUpsUspsData[coreTN]) {
                    const formattedBlock = upsUspsTemplate + "\n\n" + tempUpsUspsData[coreTN];
                    processedBlocks.push(formattedBlock);
                    processedTNs.add(coreTN);
                } else {
                    console.warn(`Could not find data block for staged TN: ${tn}`);
                    notFoundCount++;
                }
            }
        });

        if (processedBlocks.length > 0) {
            const currentNoteTrimmed = noteArea.value.trimEnd();
            const spacing = currentNoteTrimmed ? '\n\n' : '';
            noteArea.value = currentNoteTrimmed + spacing + processedBlocks.join('\n\n');
            noteArea.scrollTop = noteArea.scrollHeight;

            countTemplatesNoteTaker();
            saveNotesToLocalStorage();

            upsUspsOutputArea.value = '';
            tempUpsUspsData = {};

            saveUpsUspsOutputToLocalStorage();
            saveUpsUspsContextToLocalStorage();

            shipmentInput.placeholder = `Added ${processedBlocks.length} UPS/USPS entries to notes. Ready...`;
            setTimeout(() => {
                if (shipmentInput) {
                     shipmentInput.placeholder = "Paste shipment data containing UPS/USPS...";
                }
             }, 3000);

        } else {
            alert("No data could be processed. Check console for details.");
        }
        if (notFoundCount > 0) {
             alert(`Warning: Could not find original data for ${notFoundCount} tracking number(s) listed.`);
        }
   }


    function addSeparator() { const ta = document.getElementById('noteArea'); const trimmedValue = ta.value.trimEnd(); ta.value = trimmedValue + (trimmedValue ? noteSeparator : ''); ta.focus(); ta.scrollTop = ta.scrollHeight; countTemplatesNoteTaker(); saveNotesToLocalStorage(); }
    function addSpacing() { const ta = document.getElementById('noteArea'); ta.value = ta.value.trimEnd() + '\n\n'; ta.focus(); ta.scrollTop = ta.scrollHeight; saveNotesToLocalStorage(); }
    function selectAllMerchants() { document.querySelectorAll('#merchantList .merchant-checkbox').forEach(cb => { cb.checked = true; }); updateSelectedCountNoteTaker(); }

    function countTemplatesNoteTaker() {
        const noteArea = document.getElementById('noteArea');
        const fullText = noteArea.value;
        const merchantListDiv = document.getElementById('merchantList');
        merchantListDiv.innerHTML = '';

        const trackingNumberRegex = /\b([A-Z0-9]+(?:-|\s)*\((?:AMZ[NL]|UPS|USPS)\))/gi;
        const allTrackingNumbers = (fullText.match(trackingNumberRegex) || []);
        const seenTrackingNumbers = new Set();
        const duplicatedTrackingNumbers = new Set();
        allTrackingNumbers.forEach(tn => {
            const coreTN = tn.replace(/\s*\((?:AMZ[NL]|UPS|USPS)\)$/i, '').replace(/\s|-/g, '');
            if (seenTrackingNumbers.has(coreTN)) { duplicatedTrackingNumbers.add(coreTN); }
            seenTrackingNumbers.add(coreTN);
        });

        const merchants = {};
        let totalTemplatesOverall = 0;
        let merchantIndex = 0;
        const sections = fullText.split(noteSeparatorRegex);

        sections.forEach((section) => {
            const sectionText = section.trim();
            if (!sectionText) return;

            const amzlTemplateCount = countTemplatesInText(sectionText, amzlTemplate);
            const upsUspsTemplateCount = countTemplatesInText(sectionText, upsUspsTemplate);
            const templateCount = amzlTemplateCount + upsUspsTemplateCount;
            totalTemplatesOverall += templateCount;

            let merchantName = `Entry ${++merchantIndex}`;
            const firstLine = sectionText.split('\n')[0]?.trim();
            if (firstLine && !firstLine.startsWith(amzlTemplate.substring(0, 10)) && !firstLine.startsWith(upsUspsTemplate.substring(0,10)) && firstLine.length < 100 && !firstLine.includes(':') && !firstLine.startsWith('Removal order ID')) {
                merchantName = firstLine;
            } else if (sectionText.includes('Removal order ID:')) {
                 merchantName = `Data Entry ${merchantIndex}`;
            }

             merchants[sectionText] = {
                 displayName: merchantName,
                 count: templateCount,
                 text: sectionText
             };
        });

        document.getElementById('merchantCount').textContent = Object.keys(merchants).length;
        document.getElementById('totalTemplates').textContent = totalTemplatesOverall;

        const sortedMerchants = Object.entries(merchants).sort(([, a], [, b]) => a.displayName.localeCompare(b.displayName));

        sortedMerchants.forEach(([key, data]) => {
            const merchantDiv = document.createElement('div');
            merchantDiv.className = 'merchant-stats';
            merchantDiv.dataset.key = key;
            merchantDiv.dataset.displayName = data.displayName;
            merchantDiv.dataset.count = data.count;

            const sectionTrackingNumbersFull = (data.text.match(trackingNumberRegex) || []);
            let sectionHasDuplicate = false;
            const duplicatesInSectionDisplay = new Set();
            sectionTrackingNumbersFull.forEach(tn => {
                const coreTn = tn.replace(/\s*\((?:AMZ[NL]|UPS|USPS)\)$/i, '').replace(/\s|-/g, '');
                if (duplicatedTrackingNumbers.has(coreTn)) {
                    sectionHasDuplicate = true;
                    duplicatesInSectionDisplay.add(tn);
                }
            });

            const displayNameShort = data.displayName.length > 45 ? data.displayName.substring(0, 42) + '...' : data.displayName; /* Adjusted length */
            const caseLabel = data.count === 1 ? 'case' : 'cases';
            let titleText = `${data.displayName} (${data.count} ${caseLabel})`;
            let indicatorHTML = '';
            let duplicateListHTML = '';

            if (sectionHasDuplicate) {
                const duplicateList = Array.from(duplicatesInSectionDisplay).join(', ');
                indicatorHTML = `<span class="duplicate-indicator" title="Contains duplicate TN(s): ${duplicateList}"></span>`;
                duplicateListHTML = `<span style="color: #ff9f0a; font-size: 0.8em; margin-left: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-shrink: 1;" title="Duplicate TN(s): ${duplicateList}">(${duplicateList})</span>`;
                titleText += ` | DUPLICATES FOUND: ${duplicateList}`;
            }

            merchantDiv.innerHTML = `
                <div style="display: flex; align-items: center; width: 100%; justify-content: flex-start;">
                    ${indicatorHTML}
                    <input type="checkbox" class="merchant-checkbox" onchange="updateSelectedCountNoteTaker()" style="margin-left: 4px; margin-right: 8px;"> <span title="${titleText}" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 0; flex-shrink: 1;"> ${displayNameShort} (${data.count} ${caseLabel})
                    </span>
                    ${duplicateListHTML}
                </div>`;

             merchantDiv.onclick = (e) => {
                 if (e.target.type !== 'checkbox') {
                     const cb = merchantDiv.querySelector('.merchant-checkbox');
                     if (cb) { cb.checked = !cb.checked; updateSelectedCountNoteTaker(); }
                 }
             };
            merchantListDiv.appendChild(merchantDiv);
        });
        updateSelectedCountNoteTaker();
    }

    function updateSelectedCountNoteTaker() {
        const selectedCheckboxes = document.querySelectorAll('#merchantList .merchant-checkbox:checked');
        const splitButton = document.getElementById('btnSplitSelected');
        let selectedCaseCount = 0;

        selectedCheckboxes.forEach(cb => {
            selectedCaseCount += parseInt(cb.closest('.merchant-stats')?.dataset?.count || '0', 10);
        });

        const totalTemplatesSpan = document.getElementById('totalTemplates');
        const merchantCountSpan = document.getElementById('merchantCount');
        const totalMerchantCount = document.querySelectorAll('#merchantList .merchant-stats').length;
        const totalCaseCountOverall = Array.from(document.querySelectorAll('#merchantList .merchant-stats')).reduce((sum, el) => sum + parseInt(el.dataset.count || '0', 10), 0);

        if (selectedCheckboxes.length > 0) {
            totalTemplatesSpan.textContent = selectedCaseCount;
            merchantCountSpan.textContent = selectedCheckboxes.length;
            if (splitButton) { splitButton.disabled = false; }
        } else {
            totalTemplatesSpan.textContent = totalCaseCountOverall;
            merchantCountSpan.textContent = totalMerchantCount;
            if (splitButton) { splitButton.disabled = true; }
        }
    }


    function downloadSelectedMerchants() {
        const selectedDivs = document.querySelectorAll('#merchantList .merchant-stats:has(.merchant-checkbox:checked)');
        if (selectedDivs.length === 0) { alert('Please select merchant(s) to download.'); return; }

        const textsToDownload = [];
        let totalSelectedCases = 0;
        selectedDivs.forEach((div) => {
            const key = div.dataset.key;
            if (key !== undefined && key !== null) {
                textsToDownload.push(key);
                totalSelectedCases += parseInt(div.dataset.count || '0', 10);
            }
        });

        if (textsToDownload.length === 0) { alert("Could not retrieve text for selected merchants."); return; }

        const combinedText = textsToDownload.join(noteSeparator);
        const filename = `3COUTB_${getFormattedDate()}_(${totalSelectedCases}).txt`;
        downloadText(combinedText + '\n', filename);
    }

    function clearSelectedMerchants() {
        const selectedDivs = document.querySelectorAll('#merchantList .merchant-stats:has(.merchant-checkbox:checked)');
        if (selectedDivs.length === 0) { alert('Please select merchant(s) to clear.'); return; }

        const noteArea = document.getElementById('noteArea');
        const fullText = noteArea.value;
        const keysToRemove = new Set();
        selectedDivs.forEach(div => { if (div.dataset.key !== undefined && div.dataset.key !== null) { keysToRemove.add(div.dataset.key); } });

        const allSections = fullText.split(noteSeparatorRegex);
        const remainingSections = allSections.filter(section => {
             const trimmedSection = section.trim();
             return trimmedSection && !keysToRemove.has(trimmedSection);
        });
        noteArea.value = remainingSections.join(noteSeparator).trim();
        countTemplatesNoteTaker();
        saveNotesToLocalStorage();
    }

    function downloadAllNotes() {
        const noteArea = document.getElementById('noteArea');
        const textToDownload = noteArea.value.trim();
        if (!textToDownload) { alert("Nothing to download."); return; }
        const totalTemplatesCount = document.getElementById('totalTemplates').textContent;
        const filename = `3COUTB_${getFormattedDate()}_(${totalTemplatesCount}).txt`;
        downloadText(textToDownload + '\n', filename);
    }


    function processSingleROBlock(roBlockText, removalOrdersArray) {
        const roIdLineMatch = roBlockText.match(/^\s*Removal order ID:[^\n]+/);
        if (!roIdLineMatch) {
            return;
        }
        const currentRoIdLine = roIdLineMatch[0].trim();

        const remainingText = roBlockText.substring(roIdLineMatch[0].length).trim();
        if (!remainingText) { return; }

        const shipmentBlocks = remainingText.split(/(?=^\s*Shipment ID:)/m);

        shipmentBlocks.forEach((shipmentBlock) => {
             const trimmedShipmentBlock = shipmentBlock.trim();
             if (trimmedShipmentBlock.startsWith('Shipment ID:') && trimmedShipmentBlock.includes('Merchant SKU:')) {
                 const completeOrderBlock = (currentRoIdLine + '\n' + trimmedShipmentBlock);
                 removalOrdersArray.push(completeOrderBlock);
             }
        });
    }

   function splitTextIntoRemovalOrders(inputText) {
        const removalOrders = [];
        if (!inputText) { return removalOrders; }

        let textToProcess = inputText.trim();
        const escapedAmzlTemplate = amzlTemplate.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const escapedUpsUspsTemplate = upsUspsTemplate.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const templateRegexAmzl = new RegExp('^\\s*' + escapedAmzlTemplate + '\\s*\\n*', 'gm');
        const templateRegexUpsUsps = new RegExp('^\\s*' + escapedUpsUspsTemplate + '\\s*\\n*', 'gm');

        textToProcess = textToProcess.replace(templateRegexAmzl, '').replace(templateRegexUpsUsps, '').trim();

        const potentialROBlocks = textToProcess.split(/(?=^\s*Removal order ID:)/m);

        potentialROBlocks.forEach((roBlock, index) => {
            const trimmedROBlock = roBlock.trim();
            if (!trimmedROBlock) return;
            if (trimmedROBlock.startsWith('Removal order ID:')) {
                processSingleROBlock(trimmedROBlock, removalOrders);
            }
        });
        return removalOrders;
   }

   function createTemplates(removalOrders, removalOrdersPerTemplate) {
        const templates = [];
        if (!removalOrders || removalOrders.length === 0 || removalOrdersPerTemplate <= 0) {
            return templates;
        }
        for (let i = 0; i < removalOrders.length; i += removalOrdersPerTemplate) {
            const templateRemovalOrders = removalOrders.slice(i, i + removalOrdersPerTemplate);
             const validOrders = templateRemovalOrders.filter(order => order && typeof order === 'string');
             if (validOrders.length > 0) {
                 templates.push(validOrders.join('\n\n'));
             }
        }
        return templates;
   }

    let selectedMerchantDataForSplit = [];

    function openSplitModal() {
        selectedMerchantDataForSplit = [];
        const selectedDivs = document.querySelectorAll('#merchantList .merchant-stats:has(.merchant-checkbox:checked)');
        if (selectedDivs.length === 0) { alert("Please select at least one merchant to split."); return; }

        const modalElements = {
            modal: document.getElementById('splitModal'),
            merchantInfoDiv: document.getElementById('splitMerchantInfo'),
            ordersPerTemplateInput: document.getElementById('splitOrdersPerTemplate'),
            calculatedTemplatesSpan: document.getElementById('splitCalculatedTemplates'),
            splitNumberInput: document.getElementById('splitNumberInput')
        };
        let missingElement = null;
        for (const key in modalElements) { if (!modalElements[key]) { missingElement = key; break; } }
        if (missingElement) { console.error(`openSplitModal error: Modal element with ID '${missingElement}' not found!`); alert("Error: Could not initialize the split dialog."); return; }

        const modal = modalElements.modal;
        const merchantInfoDiv = modalElements.merchantInfoDiv;
        const ordersPerTemplateInput = modalElements.ordersPerTemplateInput;
        const calculatedTemplatesSpan = modalElements.calculatedTemplatesSpan;
        const splitNumberInput = modalElements.splitNumberInput;

        let combinedTextParts = [];
       let containsUpsUsps = false;
       let containsAmzl = false;

        selectedDivs.forEach((div) => {
            const key = div.dataset.key;
            const displayName = div.dataset.displayName || `Merchant (Unknown)`;
            if (key !== undefined && key !== null) {
                selectedMerchantDataForSplit.push({ key: key, name: displayName });
                combinedTextParts.push(key);
                if (key.includes(upsUspsTemplate)) containsUpsUsps = true;
                if (key.includes(amzlTemplate)) containsAmzl = true;
            }
        });
        const merchantNames = selectedMerchantDataForSplit.map(item => item.name);
        const combinedText = combinedTextParts.join(noteSeparator);
        modal.dataset.combinedText = combinedText;
        modal.dataset.containsAmzl = containsAmzl;
        modal.dataset.containsUpsUsps = containsUpsUsps;


        if (merchantNames.length === 1) { merchantInfoDiv.textContent = `Merchant: ${merchantNames[0]}`; }
        else if (merchantNames.length > 1) { merchantInfoDiv.textContent = `Merchants: ${merchantNames.slice(0, 3).join(', ')}${merchantNames.length > 3 ? '...' : ''} (${merchantNames.length} total)`; }
        else { merchantInfoDiv.textContent = 'No valid merchants selected.'; }

        ordersPerTemplateInput.value = '2';
        splitNumberInput.value = '';
        calculatedTemplatesSpan.textContent = '0';
        updateCalculatedTemplates();
        modal.style.display = 'flex';
    }

    function closeSplitModal() {
        const modal = document.getElementById('splitModal');
        if(modal) {
          modal.style.display = 'none';
          modal.dataset.combinedText = '';
          modal.dataset.containsAmzl = '';
          modal.dataset.containsUpsUsps = '';
        }
    }

    function updateCalculatedTemplates() {
         const modal = document.getElementById('splitModal');
         if (!modal) return;
         const combinedText = modal.dataset.combinedText || '';
         const ordersPerTemplateInput = document.getElementById('splitOrdersPerTemplate');
         const calculatedTemplatesSpan = document.getElementById('splitCalculatedTemplates');
         if (!ordersPerTemplateInput || !calculatedTemplatesSpan) return;

         const ordersPerTemplate = parseInt(ordersPerTemplateInput.value) || 0;
         if (ordersPerTemplate > 0 && combinedText) {
             const removalOrders = splitTextIntoRemovalOrders(combinedText);
             const templateGroups = createTemplates(removalOrders, ordersPerTemplate);
             calculatedTemplatesSpan.textContent = templateGroups.length;
         } else {
             calculatedTemplatesSpan.textContent = '0';
         }
       }

   function generateAndDownloadSplits() {
        const modal = document.getElementById('splitModal');
        if (!modal) return;

        const combinedText = modal.dataset.combinedText || '';
        const ordersPerTemplateInput = document.getElementById('splitOrdersPerTemplate');
        const splitNumberInput = document.getElementById('splitNumberInput');
        const containsAmzl = modal.dataset.containsAmzl === 'true';
        const containsUpsUsps = modal.dataset.containsUpsUsps === 'true';

        if (!ordersPerTemplateInput || !splitNumberInput) { alert("Error: Modal inputs not found."); return; }

        const ordersPerTemplate = parseInt(ordersPerTemplateInput.value);
        const splitNumber = parseInt(splitNumberInput.value);

        if (!combinedText) { alert("Error: No text found for selected merchants."); return; }
        if (isNaN(ordersPerTemplate) || ordersPerTemplate < 1) { alert("Please enter a valid number for 'Removal Orders per Template'."); return; }
        if (isNaN(splitNumber) || splitNumber < 1) { alert("Please enter a valid number for 'Templates per Split File'."); return; }

        let templateToUse = amzlTemplate;
        if (containsUpsUsps && !containsAmzl) {
            templateToUse = upsUspsTemplate;
        } else if (containsUpsUsps && containsAmzl) {
            console.log("Split contains mixed AMZL and UPS/USPS entries. Using AMZL template for splitting.");
        }

        const removalOrders = splitTextIntoRemovalOrders(combinedText);
        if (removalOrders.length === 0) {
            alert("Could not find any valid removal orders in the selected text after cleaning. Please check data format.");
            return;
        }

        const templateGroups = createTemplates(removalOrders, ordersPerTemplate);
        if (templateGroups.length === 0) { alert("Failed to generate template groups."); return; }

        const splitOutputs = [];
        for (let i = 0; i < templateGroups.length; i += splitNumber) {
            const groupChunk = templateGroups.slice(i, i + splitNumber);
            if (groupChunk.length > 0) {
                 let chunkText = '';
                 groupChunk.forEach((group, index) => {
                     chunkText += templateToUse + '\n\n' + group;
                     if (index < groupChunk.length - 1) {
                         chunkText += '\n\n';
                     }
                 });
                splitOutputs.push({ text: chunkText, count: groupChunk.length });
            }
        }

        if (splitOutputs.length === 0) { alert("No split files generated."); return; }

        let filenameMerchantPart = "SplitSelection";
        let merchantDisplayStringForFile = "Multiple_Selected";

        if (selectedMerchantDataForSplit.length === 1) {
            filenameMerchantPart = sanitizeFilename(selectedMerchantDataForSplit[0].name);
            merchantDisplayStringForFile = selectedMerchantDataForSplit[0].name;
        } else if (selectedMerchantDataForSplit.length > 1) {
            filenameMerchantPart = sanitizeFilename(selectedMerchantDataForSplit[0].name) + "_Multi";
            merchantDisplayStringForFile = selectedMerchantDataForSplit.map(m=>m.name).join(', ');
        }

        const dateStr = getFormattedDate();
        splitOutputs.forEach((outputData, index) => {
            const partNumber = index + 1;
            const filename = `3COUTB_${dateStr}_${filenameMerchantPart}_PART_${partNumber}(${outputData.count}).txt`;
            const fileContent = merchantDisplayStringForFile + '\n\n' + outputData.text + '\n';
            downloadText(fileContent, filename);
        });

        closeSplitModal();
   }

    document.addEventListener('DOMContentLoaded', () => {
        const shipmentInput = document.getElementById('shipmentInput');
        const noteArea = document.getElementById('noteArea');
        const groupToggle = document.getElementById('groupToggle');
        const groupSizeInput = document.getElementById('parserGroupSize');
        const upsUspsToggle = document.getElementById('upsUspsToggle');
        const upsUspsOutputContainer = document.getElementById('upsUspsOutputContainer');
        const upsUspsOutputArea = document.getElementById('upsUspsOutputArea');
        const groupOrdersControl = document.getElementById('groupOrdersControl');
        const btnProcessUpsUsps = document.getElementById('btnProcessUpsUsps');


        if (noteArea) {
            const savedNotes = localStorage.getItem(localStorageKey);
            if (savedNotes) { noteArea.value = savedNotes; }
             let countTimer;
             noteArea.addEventListener('input', () => {
                 clearTimeout(countTimer);
                 countTimer = setTimeout(() => { countTemplatesNoteTaker(); saveNotesToLocalStorage(); }, 300);
             });
             noteArea.addEventListener('paste', (e) => {
                 setTimeout(() => { countTemplatesNoteTaker(); saveNotesToLocalStorage(); }, 50);
             });
        } else { console.error("Note area element not found!"); }

        if (upsUspsOutputArea) {
            const savedUpsUspsTNs = localStorage.getItem(upsUspsOutputKey);
            if (savedUpsUspsTNs) {
                upsUspsOutputArea.value = savedUpsUspsTNs;
            }
        } else { console.error("UPS/USPS output area element not found!"); }

        try {
            const savedUpsUspsContext = localStorage.getItem(upsUspsContextKey);
            if (savedUpsUspsContext) {
                tempUpsUspsData = JSON.parse(savedUpsUspsContext);
                if (typeof tempUpsUspsData !== 'object' || tempUpsUspsData === null) {
                    tempUpsUspsData = {};
                }
            } else {
                tempUpsUspsData = {};
            }
        } catch (error) {
            console.error("Error loading UPS/USPS context from localStorage:", error);
            tempUpsUspsData = {};
        }


        if (shipmentInput) {
            let parseTimer;
            shipmentInput.addEventListener('input', () => {
                clearTimeout(parseTimer);
                if (shipmentInput.value.trim()) { parseTimer = setTimeout(parseShipmentData, 500); }
            });
        } else { console.error("Shipment input element not found!"); }

        try { countTemplatesNoteTaker(); } catch(error) { console.error("Error during initial countTemplatesNoteTaker:", error); }

         document.body.addEventListener('click', function(event) {
              const button = event.target.closest('button');
              if (button && !button.classList.contains('button-ripple')) { // Avoid re-adding ripple to ripple span
                  // createRipple(event); // Ripple disabled by default now
              }
         });

        const noteTakerContainer = document.querySelector('.note-taker-tool');
        if (noteTakerContainer) {
             noteTakerContainer.addEventListener('click', function(event){
                  const targetButton = event.target.closest('button');
                   if (!targetButton || targetButton.closest('#splitModal')) { return; }
                  try {
                       switch (targetButton.id) {
                           case 'btnAddSeparator': addSeparator(); break;
                           case 'btnAddSpacing': addSpacing(); break;
                           case 'btnDownloadSelected': downloadSelectedMerchants(); break;
                           case 'btnClearSelected': clearSelectedMerchants(); break;
                           case 'btnSelectAll': selectAllMerchants(); break;
                           case 'btnDownloadAll': downloadAllNotes(); break;
                           case 'btnSplitSelected': openSplitModal(); break;
                           default: break; // Handles Process button if needed elsewhere
                       }
                  } catch (error) { console.error(`Error executing action for note taker button ${targetButton.id}:`, error); }
             });
        } else { console.error("Note Taker container element not found!"); }

        // Handle Process UPS/USPS button separately if it's outside note taker container
        const parserToolContainer = document.querySelector('.parser-tool');
         if (parserToolContainer) {
             parserToolContainer.addEventListener('click', function(event){
                 const targetButton = event.target.closest('button');
                 if (targetButton && targetButton.id === 'btnProcessUpsUsps') {
                     try { processUpsUspsData(); }
                     catch(error) { console.error(`Error executing action for button ${targetButton.id}:`, error); }
                 }
             });
         }


         if (groupToggle && groupSizeInput) {
               groupToggle.addEventListener('change', function() { groupSizeInput.disabled = !this.checked; });
               // Ensure initial state matches checkbox
               groupSizeInput.disabled = !groupToggle.checked;
         } else { console.error("Parser Group toggle or group size input not found!"); }

         if (upsUspsToggle && upsUspsOutputContainer && groupOrdersControl && shipmentInput && upsUspsOutputArea) {
             function toggleUpsUspsMode(isUpsMode) {
                  upsUspsOutputContainer.style.display = isUpsMode ? 'block' : 'none';
                  groupOrdersControl.style.opacity = isUpsMode ? '0.5' : '1';
                  groupOrdersControl.style.pointerEvents = isUpsMode ? 'none' : 'auto';
                  if (isUpsMode && groupToggle) {
                      groupToggle.checked = false;
                       if (groupSizeInput) groupSizeInput.disabled = true;
                  }

                  if (isUpsMode) {
                      shipmentInput.placeholder = "Paste shipment data containing UPS/USPS...";
                  } else {
                      upsUspsOutputArea.value = ''; // Clear staged numbers when switching off
                      tempUpsUspsData = {};
                      saveUpsUspsOutputToLocalStorage();
                      saveUpsUspsContextToLocalStorage();
                      shipmentInput.placeholder = "Paste Amazon removal shipment data here...";
                      if (groupToggle && groupSizeInput) groupSizeInput.disabled = !groupToggle.checked; // Re-enable based on group toggle
                  }
             }

              upsUspsToggle.addEventListener('change', function() {
                  toggleUpsUspsMode(this.checked);
              });

              // Set initial state based on checkbox
              toggleUpsUspsMode(upsUspsToggle.checked);

         } else { console.error("Parser UPS/USPS toggle or related elements not found!"); }

        /* Process UPS/USPS button event listener moved to parserToolContainer listener above */


         const splitModal = document.getElementById('splitModal');
         const btnCancelSplit = document.getElementById('btnCancelSplit');
         const btnGenerateSplits = document.getElementById('btnGenerateSplits');
         const ordersPerTemplateInputModal = document.getElementById('splitOrdersPerTemplate');
         if (splitModal && btnCancelSplit && btnGenerateSplits && ordersPerTemplateInputModal) {
               btnCancelSplit.addEventListener('click', closeSplitModal);
               splitModal.addEventListener('click', (event) => {
                    if (event.target === splitModal) { closeSplitModal(); }
                 });
               btnGenerateSplits.addEventListener('click', generateAndDownloadSplits);
               ordersPerTemplateInputModal.addEventListener('input', updateCalculatedTemplates);
         } else { console.error("Could not attach one or more Split Modal event listeners."); }

    });
</script>

</body>
</html>
