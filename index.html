<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <title>Outbound AMZL Tool</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="." />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://rsms.me/">
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
<style>
    :root {
        --system-font: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        --mono-font: 'SF Mono', Consolas, 'Courier New', Courier, monospace;
        --bg-primary: #F2F2F2;
        --bg-window: #FFFFFF;
        --bg-toolbar: #F2F2F2; 
        --bg-input: #FFFFFF;
        --bg-hover: rgba(0, 0, 0, 0.05);
        --text-primary: #1d1d1f;
        --text-secondary: #6e6e73;
        --text-placeholder: #aaaaaf;
        --border-color: #C6C6C6;
        --border-subtle: #E0E0E0;
        --accent-blue: #007AFF;
        --accent-blue-dark: #007AFF;
        --accent-red: #FF3B30;
        --accent-red-hover: #FF3B30;
        --accent-green: #34C759;
        --accent-green-manual: #34C759;
        --accent-orange: #FF9500;
        --accent-purple: #5856d6;
        --highlight-bg: #B4D7FF; 
        --highlight-text: #000000; 
        --top-bar-height: 50px;
        --bg-window-blur: rgba(250, 250, 250, 0.85);
        color-scheme: light;
    }

    html[data-theme="dark"] {
        --bg-primary: #000000;
        --bg-window: #1C1C1E;
        --bg-toolbar: #000000; 
        --bg-input: #3a3a3c;
        --bg-hover: rgba(255, 255, 255, 0.1);
        --text-primary: #f2f2f7;
        --text-secondary: #9a9a9e;
        --text-placeholder: #8e8e93;
        --border-color: #000000;
        --border-subtle: #424245;
        --accent-blue: #0A84FF;
        --accent-blue-dark: #0A84FF;
        --accent-red: #FF453A;
        --accent-red-hover: #FF453A;
        --accent-green: #30D158;
        --accent-green-manual: #30D158;
        --accent-orange: #FF9F0A;
        --accent-purple: #BF5AF2;
        --highlight-bg: #0052A3; 
        --highlight-text: #FFFFFF; 
        --bg-window-blur: rgba(44, 44, 46, 0.85);
        color-scheme: dark;
    }

    html[data-theme="dark"] .macos-textfield-container {
    border-color: transparent;
}

html[data-theme="dark"] .counter-pill,
html[data-theme="dark"] button.macos.secondary,
html[data-theme="dark"] .macos-checkbox,
html[data-theme="dark"] .merchant-item {
    border-color: transparent;
}
html[data-theme="dark"] .merchant-item {
    background-color: var(--bg-input);
}

    html[data-theme="dark"] .macos-checkbox {
    background-color: var(--bg-window); /* Use the main card background color for contrast */
}
    
    html { box-sizing: border-box; background-color: var(--bg-primary); }
    *, *:before, *:after { box-sizing: inherit; }
    body {
        font-family: var(--system-font);
        background-color: var(--bg-primary);
        color: var(--text-primary);
        margin: 0; padding: 0; display: flex; flex-direction: column;
        height: 100vh; max-height: 100vh; overflow: hidden;
        -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
        font-size: 13px;
        transition: background-color 0.2s ease, color 0.2s ease;
    }
    body.is-resizing { user-select: none; }
    body.is-standalone-mode #mainWrapper { display: none; }
    body.is-standalone-mode .non-standalone { display: none !important; }

    .top-bar {
        background-color: var(--bg-toolbar);
        padding: 0 16px;
        min-height: var(--top-bar-height);
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-shrink: 0;
        gap: 16px;
        position: sticky; top: 0; z-index: 1001;
        transition: box-shadow 0.2s ease-in-out;
    }

    .top-bar-title {
        font-size: 1.4em;
        font-weight: 700;
        color: var(--text-primary);
        margin-right: auto;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .toolbar-right { display: flex; align-items: center; gap: 16px; flex-wrap: nowrap; }
    .toolbar-icon-group, .url-generator-group {
        display: flex;
        align-items: center;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 4px;
        background-color: var(--bg-window);
        box-shadow: 0 1px 4px rgba(0,0,0,0.07);
        gap: 4px;
    }
    .toolbar-icon-group .macos-icon-button, .toolbar-icon-group .dropdown > .macos-icon-button {
        background-color: transparent;
    }
    .toolbar-icon-group > *:not(:last-child) {
        position: relative;
    }
    .toolbar-icon-group > *:not(:last-child)::after {
        content: '';
        position: absolute;
        right: -2px;
        top: 50%;
        transform: translateY(-50%);
        height: 20px;
        width: 1px;
        background-color: var(--border-subtle);
    }

    #caseModeToggleGroup {
        cursor: pointer;
        display: flex;
        align-items: center;
    }
    #caseModeToggleGroup #btnCaseMode, #caseModeToggleGroup #caseModeText {
        height: 30px;
        padding-top: 0;
        padding-bottom: 0;
        display: flex;
        align-items: center;
    }
    #caseModeToggleGroup #btnCaseMode {
        border-top-right-radius: 0;
        border-bottom-right-radius: 0;
    }
    #caseModeToggleGroup #caseModeText {
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
        padding-left: 10px;
    }

    html[data-theme="dark"] .toolbar-icon-group,
    html[data-theme="dark"] .url-generator-group {
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    #marketplaceSelectUrlGen {
        all: unset;
        font-family: var(--system-font);
        font-size: 13px;
        font-weight: 500;
        color: var(--text-primary);
        padding: 0 12px 0 6px;
        height: 30px;
        cursor: pointer;
        border-radius: 15px;
        transition: background-color 0.15s ease;
        -moz-appearance: none;
        -webkit-appearance: none;
        appearance: none;
        line-height: 30px;
    }

    #marketplaceSelectUrlGen:hover {
        background-color: var(--bg-hover);
    }
    
    #prefixToggleGroup .macos-icon-button {
        font-weight: 600;
        font-size: 12px;
        padding: 0 10px;
    }

    .main-wrapper {
        display: flex; flex-direction: column; flex-grow: 1; padding: 16px; gap: 16px;
        width: 100%; max-width: 1600px; margin: 0 auto; overflow-y: auto;
    }
    .left-column-wrapper { display: flex; flex-direction: column; gap: 16px; }

    .tool-container {
        background-color: #FFFFFF;
        border-radius: 24px;
        box-shadow: none;
        padding: 20px 20px 25px 20px;
        display: flex; flex-direction: column;
        position: relative;
        border: 1px solid var(--border-color);
        overflow: hidden;
        resize: none;
        min-height: 200px;
        transition: min-height 0.3s ease;
    }
    html[data-theme="dark"] .tool-container {
        background-color: #1C1C1E;
    }
    html[data-theme="dark"] .main-wrapper.layout-side-by-side .left-column-wrapper {
        background-color: #1C1C1E;
    }
    .parser-tool.is-hidden { min-height: 50px; padding-bottom: 20px;}
    .parser-tool .parser-content {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        overflow: hidden;
        transition: opacity 0.3s ease, max-height 0.3s ease;
        opacity: 1;
        max-height: 1000px;
    }
    .parser-tool.is-hidden .parser-content {
        opacity: 0;
        max-height: 0;
        pointer-events: none;
    }

    .merchant-actions-tool, .note-taker-tool { padding-bottom: 25px; }

    .tool-card-title-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: -5px 0 10px 0;
        flex-shrink: 0;
        flex-wrap: wrap;
        gap: 10px;
    }
    .tool-card-title {
        display: flex;
        align-items: center;
        font-size: 1.1em; font-weight: 600; color: var(--text-primary);
        margin: 0;
        margin-right: auto;
    }
    .ro-match-controls {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .ro-match-controls .macos-textfield-container {
        width: 300px;
        position: relative;
    }
    #roMatchInput.macos-textfield {
        height: 28px;
        padding: 0 30px 0 10px;
        font-size: 13px;
    }
    #roMatchCounter {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-secondary);
        white-space: nowrap;
        display: none; /* Hidden by default */
    }
    #ro-not-found-btn {
        display: none;
        color: var(--accent-orange);
    }
    #btnClearRoInput {
        position: absolute;
        right: 4px; top: 50%;
        transform: translateY(-50%);
        width: 20px; height: 20px;
        color: white;
        background-color: var(--accent-red); /* Always red */
        font-size: 10px;
    }
    #btnClearRoInput:hover {
        background-color: var(--accent-red-hover);
    }


    .tool-card-title > i.fa-solid { margin-right: 8px; font-size: 0.9em; }
    
    .main-wrapper.layout-side-by-side { flex-direction: row; padding: 24px; gap: 24px; align-items: stretch; overflow: hidden; }
    .main-wrapper.layout-side-by-side .left-column-wrapper {
        width: 480px;
        flex-shrink: 0;
        gap: 0;
        display: flex;
        flex-direction: column;
        background-color: #FFFFFF;
        border-radius: 24px;
        padding: 20px;
        position: relative;
        overflow-y: auto;
        border: 1px solid var(--border-color); 
    }
    .main-wrapper.layout-side-by-side .note-taker-tool {
        flex-grow: 1;
        width: auto;
        display: flex;
        flex-direction: column;
    }
    .main-wrapper.layout-side-by-side .left-column-wrapper .tool-container {
        background-color: transparent; border-radius: 0; padding: 0;
        min-height: unset; overflow: visible; flex-grow: 1; border: none;
    }
    .main-wrapper.layout-side-by-side .left-column-wrapper .parser-tool {
        padding-bottom: 20px !important; margin-bottom: 20px;
        flex-grow: 0;
        border-bottom: 1px solid var(--border-color);
    }
    .main-wrapper.layout-side-by-side .left-column-wrapper .merchant-actions-tool {
        padding-bottom: 0 !important;
    }
    .main-wrapper.layout-side-by-side .merchant-actions-tool .resize-handle {
        display: none;
    }

    .main-wrapper.layout-stacked .top-bar { flex-wrap: nowrap; overflow-x: auto; }
    .main-wrapper.layout-stacked .top-bar .toolbar-right { gap: 8px; }

    button.macos {
        font-family: var(--system-font); font-weight: 500; cursor: pointer;
        border: none; transition: all 0.15s ease; font-size: 13px;
        padding: 4px 14px; border-radius: 12px;
        min-height: 32px;
        display: inline-flex; align-items: center; justify-content: center;
    }
    button.macos > i { margin-right: 6px; font-size: 0.9em; }
    
    button.macos.primary { background-image: linear-gradient(to bottom, var(--accent-blue), var(--accent-blue-dark)); color: white; box-shadow: 0 0.5px 1px rgba(0,0,0,0.1); }
    button.macos.primary:hover { filter: brightness(1.1); }
    button.macos.primary:active { filter: brightness(0.9); box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.15); }
    button.macos.primary:disabled { background-image: none; background-color: var(--border-color); color: var(--text-secondary); filter: none; cursor: not-allowed; box-shadow: none; }
    
    button.macos.secondary { background-color: var(--bg-input); border: 0.5px solid var(--border-color); box-shadow: 0 0.5px 1px rgba(0, 0, 0, 0.08); color: var(--text-primary); }
    button.macos.secondary:active { background-color: var(--bg-hover); }
    button.macos.secondary:disabled { background-color: var(--bg-input); color: var(--text-placeholder); border-color: var(--border-subtle); }

    button.macos.danger { background-color: var(--accent-red); color: white; box-shadow: 0 0.5px 1px rgba(0,0,0,0.1); }
    button.macos.danger:hover { background-color: var(--accent-red-hover); }
    button.macos.success { background-color: var(--accent-green); color: white; }
    button.macos.warning { background-color: var(--accent-orange); color: white; }
    button.macos.purple, button.macos.purple:active {
        background-image: none;
        background-color: var(--accent-purple);
        color: white;
        border: none;
        box-shadow: 0 0.5px 1px rgba(0,0,0,0.1);
    }
    button.macos.purple:hover { filter: brightness(1.1); }


    .macos-icon-button {
        background: transparent; border: none; cursor: pointer;
        width: 30px; height: 30px; border-radius: 50%;
        display: inline-flex; align-items: center; justify-content: center;
        color: var(--text-secondary); transition: all 0.15s ease;
    }
    .macos-icon-button:hover:not(:disabled) { background-color: var(--bg-hover); color: var(--text-primary); }
    .macos-icon-button.active { background-color: var(--accent-blue); color: white; }
    .macos-icon-button.success { background-color: var(--accent-green); color: white; }
    .macos-icon-button.success:hover:not(:disabled) { filter: brightness(1.1); }
    .macos-icon-button:disabled { color: var(--text-placeholder); background: transparent; cursor: not-allowed; }
    .macos-icon-button:disabled:hover { background: transparent; }
    .macos-icon-button.danger:hover { background-color: var(--accent-red); color: white; }


    textarea, input[type="text"], input[type="number"], input[type="file"] { all: unset; box-sizing: border-box; }
.macos-textfield-container {
    width: 100%;
    border-radius: 12px;
    border: 0.5px solid var(--border-subtle); /* Use the lightest grey for a subtle border */
    background-color: var(--bg-input);
    transition: all 0.15s ease;
    box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1); /* Made the shadow darker and more noticeable */
}
    .macos-textfield-container.fixed-width { width: 50px; margin-left: auto; }
    .macos-textfield-container:focus-within {
        border-color: var(--accent-blue);
        box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent-blue) 30%, transparent);
    }
    .macos-textfield-container input, .macos-textfield-container textarea {
        width: 100%; background-color: transparent; padding: 8px 10px;
        font-size: 14px; color: var(--text-primary);
    }
    textarea.macos-textfield { font-family: var(--mono-font); resize: none; min-height: 100px; }
    
    .macos-switch { position: relative; display: inline-block; width: 44px; height: 26px; flex-shrink: 0; }
    .macos-switch input { opacity: 0; width: 0; height: 0; }
    .macos-switch .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #c7c7cc; transition: background-color .2s; border-radius: 34px; }
    .macos-switch .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 2px; bottom: 2px; background-color: white; transition: transform .2s; border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.15); }
    .macos-switch input:checked + .slider { background-color: var(--accent-blue); } 
    html[data-theme="dark"] .macos-switch input:not(:checked) + .slider { background-color: #555; } 
    .macos-switch input:checked + .slider:before { transform: translateX(18px); }

    .modal-overlay {
        display: none; position: fixed; z-index: 1000; left: 0; top: 0;
        width: 100%; height: 100%; justify-content: center; align-items: center; /* Centered */
        background-color: transparent; 
        padding: 8vh 20px; 
        overflow-y: auto;
    }
    .modal-content {
        background-color: var(--bg-window-blur);
        -webkit-backdrop-filter: blur(20px);
        backdrop-filter: blur(20px);
        border: 1px solid var(--border-subtle);
        padding: 20px; border-radius: 12px; width: 100%;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; flex-direction: column; gap: 15px;
        margin-bottom: auto;
    }
    #splitModal .modal-content, #settingsModal .modal-content, #caseTextModal .modal-content, #caseModeActionModal .modal-content, #roMatchModal .modal-content {max-width: 520px;}
    #historyModal .modal-content { max-width: 800px; }
    #clearAllConfirmModal .modal-content, #clearAllSuccessPopup .modal-content, #confirmClearHistoryModal .modal-content { max-width: 400px; text-align: center;}
    .modal-content h2 {
        margin: 0 0 8px 0; font-size: 1.15em; font-weight: 600;
        border-bottom: 1px solid var(--border-subtle); padding-bottom: 10px; display:flex; align-items:center;
    }
    #clearAllConfirmModal .modal-content h2, #clearAllSuccessPopup .modal-content h2, #confirmClearHistoryModal .modal-content h2 { justify-content: center; }
    #clearAllConfirmModal p, #clearAllSuccessPopup p, #confirmClearHistoryModal p { margin: 10px 0 20px; font-size: 1.05em;}
    .modal-actions { display: flex; gap: 10px; margin-top: 10px; justify-content: flex-end; }
    #clearAllConfirmModal .modal-actions, #confirmClearHistoryModal .modal-actions { justify-content: center; }
    .modal-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 1rem; gap: 0.5rem; }
    .modal-footer .right-actions { display: flex; gap: 0.5rem; }
    
    #toastContainer {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 2000;
        display: flex;
        flex-direction: column-reverse;
        gap: 10px;
        pointer-events: none;
    }

    .toast {
        color: white;
        padding: 12px 20px;
        border-radius: 12px;
        font-size: 1em;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(0,0,0,0.25);
        min-width: 250px;
        max-width: 400px;
        opacity: 0;
        transform: translateX(400px);
        transition: all 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        pointer-events: auto;
    }

    .toast.show {
        opacity: 1;
        transform: translateX(0);
    }

    .toast.hiding {
        opacity: 0;
        transform: translateX(400px);
    }

    .toast.success { background-color: color-mix(in srgb, var(--accent-blue) 85%, #000000 15%); }
    .toast.error { background-color: color-mix(in srgb, var(--accent-red) 85%, #000000 15%); }
    .toast.info { background-color: color-mix(in srgb, var(--accent-blue) 85%, #000000 15%); }
    
    /* Modern, minimal scrollbar */
    html {
        scrollbar-width: thin;
        scrollbar-color: var(--border-color) transparent;
    }
    ::-webkit-scrollbar {
        width: 14px;
        height: 14px;
    }
    ::-webkit-scrollbar-track {
        background: transparent;
    }
    ::-webkit-scrollbar-thumb {
        background-color: var(--border-color);
        border-radius: 10px;
        border: 4px solid transparent;
        background-clip: content-box;
        min-width: 32px;
        min-height: 32px;
    }
    ::-webkit-scrollbar-thumb:hover {
        background-color: var(--text-secondary);
    }
    ::-webkit-scrollbar-button {
        display: none;
    }


    #merchantList {
        min-height: 100px; max-height: 70vh; overflow-y: auto; overflow-x: hidden; 
        margin-top: 16px; padding: 0; border: none;
        display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 8px; background-color: transparent; flex-grow: 1;
        align-content: start; max-width: 100%; 
    }
    .merchant-item {
        padding: 8px 12px; background-color: var(--bg-window);
        border-radius: 12px;
        border: 1px solid var(--border-subtle); display: flex; align-items: center;
        transition: all 0.2s ease; cursor: pointer; min-width: 0; 
    }
    .merchant-item:hover { background-color: var(--bg-hover); }
    .merchant-item.selected { background-color: var(--accent-blue); border-color: var(--accent-blue-dark); color: white; }
    .merchant-item .merchant-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 1; min-width: 50px;}
    .merchant-item .status-dot {
        display: none;
    }
    
    .merchant-item .merchant-controls { display: flex; align-items: center; gap: 8px; margin-left: auto; flex-shrink: 0; }
    .merchant-item .edit-merchant-btn {
        width: 24px; height: 24px; font-size: 12px;
        background-color: var(--bg-hover);
    }
    .merchant-item.selected .edit-merchant-btn { background-color: rgba(255,255,255,0.2); color: white; }
    .merchant-item.selected .edit-merchant-btn:hover { background-color: rgba(255,255,255,0.3); }


    .merchant-item .case-count {
        font-size: 11px; font-weight: 600; color: var(--text-secondary);
        background-color: var(--bg-hover); padding: 3px 8px;
        border-radius: 10px; transition: all 0.2s ease;
    }
    .merchant-item .case-count.matched {
        background-color: var(--accent-green);
        color: white;
    }
    .merchant-item.selected .case-count { background-color: rgba(255,255,255,0.2); color: white; }
    .merchant-item.selected .case-count.matched { background-color: rgba(255,255,255,0.3); color: white; }
    
    .macos-checkbox-container { display: flex; align-items: center; cursor: pointer; gap: 8px; width: auto; }
    .macos-checkbox {
        appearance: none; margin: 0; width: 20px; height: 20px; border-radius: 5px;
        display: flex; align-items: center; justify-content: center;
        background-color: var(--bg-input); border: 0.5px solid var(--border-color); flex-shrink: 0;
    }
    .macos-checkbox:checked { background-color: var(--accent-blue); border-color: var(--accent-blue-dark); }
    .macos-checkbox:checked::after { content: 'âœ”'; color: white; font-size: 14px; font-weight: bold; }
    .merchant-item.selected .macos-checkbox { background-color: #fff; border-color: transparent; }
    .merchant-item.selected .macos-checkbox:checked::after { color: var(--accent-blue); }

    .counter-pill {
        display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 15px;
        padding: 5px 10px; border-radius: 8px; border: 1px solid var(--border-color);
        background-color: var(--bg-hover);
    }
    .counter-pill p { margin:0; display:flex; align-items:center; gap: 5px;}
    .counter-pill p > i { color: var(--text-secondary); }

    .resize-handle {
        position: absolute; bottom: 0; left: 0; right: 0;
        height: 25px; cursor: ns-resize; z-index: 10;
        overflow: hidden;
    }
    .resize-handle::before, .resize-handle::after {
        content: ""; position: absolute;
        border-bottom: 2px solid var(--text-placeholder);
        opacity: 0.7;
        transition: border-color 0.2s ease;
        transform: rotate(-45deg);
        transform-origin: bottom right;
    }
    .resize-handle:hover::before, .resize-handle:hover::after { border-color: var(--text-primary); }
    .resize-handle::before { width: 14px; right: 4px; bottom: 8px; }
    .resize-handle::after { width: 8px; right: 6px; bottom: 13px; }

    textarea::selection { background-color: var(--highlight-bg); color: var(--highlight-text); }
    .parser-tool .macos-textfield-container {
        flex-grow: 1;
        min-height: 0;
    }
    .note-taker-tool .macos-textfield-container, #merchantList {
        flex-grow: 1;
        min-height: 0;
    }
    #shipmentInput, #upsUspsOutputArea, #noteArea { height: 100%; }
    .parser-controls label.parser-control-row { display: flex; align-items: center; gap: 8px; width: 100%; cursor: pointer; }
    .controls-and-stats { margin-top: 16px; } 
    .controls-and-stats > div { display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap; }
    #merchantCounterTarget { display: none; } 
    .tool-card-title-bar #merchantCounterTarget { margin-top: 0; display: flex; }

    .settings-group { margin-bottom: 8px; }
    .settings-category h4 { 
        margin: 18px 0 10px 0; 
        font-size: 0.9em; 
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-secondary);
        padding-bottom: 5px;
        border-bottom: 1px solid var(--border-subtle);
    }
    .settings-category:first-of-type h4 { margin-top: 0; }
    .settings-group label { display: block; margin-bottom: 5px; font-weight: 500;}
    .settings-group.inline { display: flex; justify-content: space-between; align-items: center; }
    .settings-group.inline label:first-child { margin-bottom: 0; }
    .settings-group .radio-group label { display: inline-flex; align-items: center; margin-right: 15px; font-weight: normal; }
    .settings-group .radio-group input[type="radio"] { margin-right: 5px; }

    #historyList, #caseModeActionModalBody { max-height: 60vh; overflow-y: auto; margin-top: 10px; }
    .history-item { background-color: var(--bg-input); padding: 10px 15px; border: 1px solid var(--border-subtle); border-radius: 10px; margin-bottom: 10px; }
    .history-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .history-item-date { font-size: 0.9em; color: var(--text-secondary); }
    .history-item-content p { margin: 4px 0; font-size: 0.95em; }
    .history-item-files { margin-top: 8px; font-size: 0.9em; color: var(--text-secondary); font-family: var(--mono-font); }
    
    #preSendFileList { max-height: 40vh; overflow-y: auto; padding: 5px; border: 1px solid var(--border-subtle); border-radius: 8px; background-color: var(--bg-primary); }
    
    /* --- CASE MODE STYLES --- */
    .standalone-only { display: none; }
    body.is-standalone-mode .standalone-only { display: flex; }
    .case-mode-wrapper { width: 100%; max-width: 100%; /* Use full width */ margin: 0 auto; display: flex; flex-direction: column; flex-grow: 1; overflow: hidden; }
    .case-mode-header { z-index: 100; flex-shrink:0; background-color: var(--bg-primary); padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
    .case-mode-title-group { display: flex; align-items: center; gap: 1rem; }
    .case-mode-title { font-size: 1.5rem; font-weight: 700; margin: 0; color: var(--text-primary); }
    #caseModeGlobalStats { font-weight: 600; color: var(--text-secondary); background-color: var(--bg-hover); padding: 6px 12px; border-radius: 8px; font-size: 0.95rem; white-space: nowrap; }
    .case-mode-tab-container { z-index: 100; flex-shrink:0; background-color: var(--bg-primary); display: flex; flex-wrap: wrap; gap: 8px; padding: 0 1.5rem 1.5rem 1.5rem; border-bottom: 1px solid var(--border-subtle); }
    .case-mode-tab-button { display: flex; flex-direction: column; align-items: flex-start; gap: 4px; padding: 6px 10px; background-color: var(--bg-hover); color: var(--text-secondary); border: 1px solid var(--border-subtle); border-radius: 12px; font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: all 0.2s ease; min-width: 180px; }
    .case-mode-tab-button:hover:not(.active) { background-color: color-mix(in srgb, var(--text-secondary) 15%, transparent); color: var(--text-primary); }
    .case-mode-tab-button.active { background-color: var(--accent-blue); color: white; border-color: var(--accent-blue-dark); font-weight: 600; }
    .case-mode-tab-button.done { background-color: color-mix(in srgb, var(--accent-green) 10%, var(--bg-primary)); color: color-mix(in srgb, var(--accent-green) 85%, #000); border: 1px solid color-mix(in srgb, var(--accent-green) 30%, transparent); }
    .case-mode-tab-button.done.active { background-color: var(--accent-green); color: white; border-color: color-mix(in srgb, var(--accent-green) 85%, black); }
    html[data-theme="dark"] .case-mode-tab-button.done:not(.active) { color: var(--accent-green); }
    .case-mode-tab-button.active .case-mode-tab-meta, .case-mode-tab-button.active .copy-merchant-btn, .case-mode-tab-button.active .tab-action-btn { background-color: rgba(255,255,255,0.2); color: white; }
    .case-mode-tab-button.active .copy-merchant-btn:hover { background-color: rgba(255,255,255,0.3); }

    .case-mode-tab-button.account-issue {
        background-color: color-mix(in srgb, var(--accent-purple) 15%, var(--bg-primary));
        color: color-mix(in srgb, var(--accent-purple) 85%, #000);
        border: 1px solid color-mix(in srgb, var(--accent-purple) 30%, transparent);
    }
    .case-mode-tab-button.account-issue:hover:not(.active) {
        background-color: color-mix(in srgb, var(--accent-purple) 25%, var(--bg-primary));
    }
    .case-mode-tab-button.account-issue.active {
        background-color: var(--accent-purple);
        color: white;
        border-color: color-mix(in srgb, var(--accent-purple) 85%, black);
    }
    html[data-theme="dark"] .case-mode-tab-button.account-issue:not(.active) { color: var(--accent-purple); }

    .case-mode-merchant-name { flex-grow: 1; max-width: 250px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: left; width: 100%; margin-bottom: 4px; font-weight: 600; }
    .case-mode-tab-bottom-row { display: flex; width: 100%; align-items: center; }
    .copy-merchant-btn { all: unset; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; border-radius: 50%; color: var(--text-secondary); cursor: pointer; transition: all 0.2s ease; flex-shrink: 0; }
    .copy-merchant-btn:hover { background-color: var(--bg-hover); color: var(--text-primary); }
    .case-mode-tab-meta { font-weight: 600; background-color: var(--bg-window); padding: 4px 10px; border-radius: 8px; margin: 0 auto 0 8px;}
    .case-mode-tab-button.account-issue .case-mode-tab-meta {
        font-weight: 700;
        letter-spacing: 0.5px;
    }
    .case-mode-tab-button.account-issue.active .case-mode-tab-meta {
        background-color: rgba(255,255,255,0.2);
        color: white;
    }
    
    .case-mode-tab-button .tab-action-btn {
        background: var(--bg-window); border: none; color: var(--text-secondary); width: 22px; height: 22px;
        border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;
        font-size: 11px; flex-shrink: 0; transition: all 0.2s ease;
    }
    .case-mode-tab-button .delete-merchant-btn:hover { background-color: var(--accent-red); color: white; }
    .case-mode-tab-button .toggle-complete-btn:hover { background-color: var(--accent-green); color: white; }
    
    .card-content.layout-right {
        flex-direction: row-reverse;
    }
    
    #caseModeTabContents { flex-grow: 1; overflow-y: auto; padding: 0 1.5rem; }
    .case-mode-tab-content { display: none; }
    .case-mode-tab-content.active { display: block; }
    .case-mode-tab-content-header { position: sticky; top: 0; z-index: 99; background-color: var(--bg-primary); padding: 1rem 0; display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem; border-bottom: 1px solid var(--border-subtle); }
    .tab-actions-left, .tab-actions-right { display: flex; gap: 8px; flex-wrap: wrap; align-items: center;}
    .case-card { background-color: var(--bg-window); border-radius: 12px; margin-bottom: 1rem; overflow: hidden; transition: all 0.2s ease-in-out; box-shadow: 0 1px 2px rgba(0,0,0,0.05); border: 1px solid var(--border-subtle); }
    .case-card.editing { border-color: var(--accent-orange); }
    .card-content { display: flex; gap: 1rem; padding: 10px 16px; align-items: stretch; }
    .case-card:not(.unfiled) .card-content { align-items: center; }
    .left-pane { flex-grow: 1; display: flex; gap: 1rem; align-items: flex-start; min-width: 0; }
    .case-card:not(.unfiled) .left-pane { align-items: center; }
    .case-number { font-size: 1.1rem; font-weight: 600; color: var(--text-secondary); width: 30px; text-align: center; flex-shrink: 0; padding-top: 4px; }
    .case-card:not(.unfiled) .case-number { padding-top: 0; }
    .ro-match-indicator {
        display: none;
        margin-left: -12px;
        margin-right: 4px;
        font-size: 1.1em;
        color: var(--accent-green);
    }
    .case-card.ro-matched .ro-match-indicator { display: inline-block; }
    .main-content { flex-grow: 1; min-width: 0; }
    .case-text { white-space: pre-wrap; font-family: var(--mono-font); max-height: 150px; overflow-y: auto; font-size: 0.85rem; background: var(--bg-primary); padding: 8px; border-radius: 8px; }
    .filed-info { display: none; }
    .case-id-display { font-weight: 600; font-family: var(--mono-font); color: var(--accent-green); font-size: 1.1rem; }
    .editing-info { display: none; align-items: center; gap: 0.5rem; width: 100%;}
    .editing-info .macos-textfield-container { flex-grow: 1; }
    .case-card.editing .editing-info { display: flex; }
    .right-pane { flex-shrink: 0; width: 220px; display: flex; flex-direction: column;}
    .case-card:not(.unfiled) .right-pane { align-items: flex-end; justify-content: center; }
    .unfiled-controls { display: flex; flex-direction: column; width: 100%; gap: 8px; align-items: stretch; }
    .unfiled-controls .case-id-input-group { display: flex; gap: 8px; align-items: center; }
    .unfiled-controls .case-id-input-group .macos-textfield-container { flex-grow: 1; }
    .unfiled-controls .case-id-input-group .macos-icon-button { flex-shrink: 0; }
    .unfiled-controls button.macos.primary { padding-top: 10px; padding-bottom: 10px; }
    button.copy-case-title { display: none; }
    #caseModeWrapper.show-copy-title .copy-case-title { display: inline-flex; }
    .filed-controls { display: none; }
    .case-card.filed .filed-controls { display: flex; gap: 8px; }
    .case-card:is(.filed, .editing) .unfiled-controls { display: none; }
    .case-card.editing .right-pane { display: none; }
    .case-card.filed .case-text, .case-card.editing .case-text { display: none; }
    .case-card.filed .filed-info { display: block; }
    #caseTextModal .modal-content pre { white-space: pre-wrap; font-family: var(--mono-font); background-color: var(--bg-input); padding: 12px; border-radius: 12px; max-height: 60vh; overflow-y: auto; font-size: 0.9rem; border: 1px solid var(--border-subtle); }
    #ro-paste-area { height: 20vh; min-height: 120px; }
    .ro-id-list, .history-list { display: flex; flex-direction: column; gap: 0.5rem; }
    .ro-id-item { display: flex; align-items: center; justify-content: space-between; gap: 0.75rem; padding: 0.5rem; background-color: var(--bg-primary); border-radius: 8px; border: 1px solid var(--border-subtle); }
    .ro-id-text, .history-text { font-family: var(--mono-font); font-weight: 600; flex-grow: 1; }
    .ro-id-match-status {
        font-weight: 600;
        font-size: 0.8em;
        padding: 2px 8px;
        border-radius: 6px;
        margin-left: 1rem;
    }
    .ro-id-match-status.auto {
        background-color: color-mix(in srgb, var(--accent-green) 15%, transparent);
        color: var(--accent-green);
    }
    .ro-id-match-status.manual {
        background-color: color-mix(in srgb, var(--accent-green-manual) 15%, transparent);
        color: var(--accent-green-manual);
    }
    .history-merchant-name { color: var(--text-secondary); font-size: 0.85rem; font-style: italic; margin-left: 1rem; }
    .history-timestamp { color: var(--text-secondary); }
    #caseModeActionModalBody .macos-textfield-container { margin-top: 1rem; }
    
    /* Horizontal Scroll Tab Layout */
    .case-mode-wrapper.tab-layout-h-scroll #caseModeTabContainer {
        flex-wrap: nowrap;
        overflow-x: auto;
    }

    /* UI Preferences Dropdown */
    .dropdown { position: relative; display: inline-block; }
    .dropdown > button:disabled + .dropdown-content { display:none !important; }
    .dropdown-content {
        display: none;
        position: absolute;
        right: 0;
        background-color: var(--bg-window-blur);
        -webkit-backdrop-filter: blur(15px);
        backdrop-filter: blur(15px);
        min-width: 280px;
        box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
        z-index: 1002;
        border-radius: 12px;
        padding: 10px;
        border: 1px solid var(--border-subtle);
    }
    .dropdown[data-align="left"] .dropdown-content {
        left: 0;
        right: auto;
    }
    .dropdown-content.show { display: block; }
    .dropdown-content.download-options {
        min-width: unset;
        padding: 8px;
    }
    .download-options .button-row { display: flex; gap: 8px; }
    .download-options button {
        flex-direction: column;
        gap: 4px;
        padding: 8px;
        width: 100px;
    }
    .download-options button i { margin: 0; font-size: 1.2em; }

    .split-button-dropdown { display: flex; gap: 0; position: relative; }
    .split-button-main { border-top-right-radius: 0; border-bottom-right-radius: 0; }
    .split-button-toggle {
        border-top-left-radius: 0; border-bottom-left-radius: 0;
        padding: 4px 8px; border-left: 1px solid rgba(255,255,255,0.2);
    }
    .split-button-toggle > i { margin: 0; }
    .dropdown-content .settings-group.inline {
        padding: 8px 6px;
        border-radius: 8px;
    }
     .dropdown-content .settings-group.inline label {
        display: flex;
        align-items: center;
        gap: 8px;
     }
    .dropdown-content .settings-group.inline:hover {
        background-color: var(--bg-hover);
    }
    .toggle-icons {
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }
    .toggle-icons i { color: var(--text-secondary); font-size: 1.1em; }


    @media (max-width: 768px) {
        .desktop-only {
            display: none !important;
        }
    }

    @media (max-width: 600px) {
        .card-content {
            flex-direction: column;
        }
        .right-pane {
            width: 100%;
            margin-top: 1rem;
        }
    }
</style>
</head>
<body>
    <!-- Hidden textarea for Chrome extension paste target (must be first input) -->
    <textarea id="extensionPasteTarget" style="position: absolute; left: -9999px; width: 1px; height: 1px; opacity: 0; pointer-events: none;" tabindex="-1" aria-hidden="true"></textarea>
    <div id="toastContainer"></div>
    <div id="clearAllConfirmModal" class="modal-overlay">
        <div class="modal-content">
            <h2><i class="fa-solid fa-triangle-exclamation" style="color: var(--accent-red); margin-right: 8px;"></i>Clear All Notes?</h2>
            <p>Are you sure you want to clear ALL notes and case data? This action cannot be undone.</p>
            <div class="modal-actions">
                <button id="cancelClearAllBtn" class="macos secondary">Cancel</button>
                <button id="confirmClearAllBtn" class="macos danger">Clear All</button>
            </div>
        </div>
    </div>
    <div id="clearAllSuccessPopup" class="modal-overlay">
         <div class="modal-content" style="max-width:300px; text-align:center;">
            <h2 style="justify-content:center;"><i class="fa-solid fa-check-circle" style="color: var(--accent-blue); margin-right: 8px;"></i>Success</h2>
            <p>All notes have been cleared.</p>
            <button id="closeClearSuccessPopupBtn" class="macos primary" style="margin: 10px auto 0;">OK</button>
        </div>
    </div>
    <div id="confirmClearHistoryModal" class="modal-overlay">
        <div class="modal-content">
            <h2><i class="fa-solid fa-triangle-exclamation" style="color: var(--accent-red); margin-right: 8px;"></i>Clear All History?</h2>
            <p>Are you sure you want to permanently delete all history entries? This action cannot be undone.</p>
            <div class="modal-actions">
                <button id="btnCancelClearHistory" class="macos secondary">Cancel</button>
                <button id="btnConfirmClearHistory" class="macos danger">Clear All History</button>
            </div>
        </div>
    </div>

    <div class="top-bar">
        <h1 class="top-bar-title">OUTB</h1>
        <div class="toolbar-right">
            <div class="url-generator-group">
                <button id="openUrlBtn" class="macos-icon-button" title="Open Report URL in New Tab">
                    <i class="fa-solid fa-arrow-up-right-from-square"></i>
                </button>
                <select id="marketplaceSelectUrlGen">
                    <option value="com">US</option>
                    <option value="co.uk">UK</option>
                    <option value="ca">CA</option>
                </select>
            </div>
            <div id="prefixToggleGroup" class="toolbar-icon-group non-standalone">
                <span class="desktop-only" style="margin-right: 8px; font-weight: 500;">Use Prefix:</span>
                <button id="btnPrefix3C" class="macos-icon-button" title="Use 3C-OUTB Prefix">3C</button>
                <button id="btnPrefixLS" class="macos-icon-button" title="Use LS-OUTB Prefix">LS</button>
            </div>
            
            <div id="caseModeToggleGroup" class="toolbar-icon-group non-standalone" title="Toggle Case/Audit View">
                <button id="btnCaseMode" class="macos-icon-button"><i class="fa-solid fa-briefcase"></i></button>
                <span id="caseModeText" style="font-weight: 500; padding: 0 8px 0 2px; cursor:pointer;">File Cases</span>
            </div>
            
            <div class="toolbar-icon-group standalone-only">
                 <button id="btnToggleFilerLayout" class="macos-icon-button" title="Toggle Template Position"><i class="fa-solid fa-align-left"></i></button>
                 <button id="btnToggleCardLayout" class="macos-icon-button" title="Reverse Card Layout"><i class="fa-solid fa-sort"></i></button>
                 <button id="btnToggleCopyTitle" class="macos-icon-button" title="Toggle 'Copy Case Title' Button"><i class="fa-solid fa-heading"></i></button>
                 <button id="btnToggleAutoSave" class="macos-icon-button" title="Toggle Auto-Save on Paste"><i class="fa-solid fa-paste"></i></button>
                 <button id="btnReExportFilerView" class="macos-icon-button" title="Save & Re-export Filer View"><i class="fa-solid fa-save"></i></button>
            </div>
            <div class="toolbar-icon-group standalone-only">
                <button id="btnTabLayoutWrap" class="macos-icon-button" title="Wrap Tabs"><i class="fa-solid fa-grip"></i></button>
                <button id="btnTabLayoutHScroll" class="macos-icon-button" title="Horizontal Scroll Tabs"><i class="fa-solid fa-grip-lines"></i></button>
            </div>
            <div class="toolbar-icon-group non-standalone">
                <button id="btnThemeToggle" class="macos-icon-button" title="Toggle Theme"><i class="fa-solid fa-moon"></i></button>
                <div class="dropdown">
                    <button id="btnOpenHistory" class="macos-icon-button" title="Deletion History"><i class="fa-solid fa-trash-alt"></i></button>
                    <div id="historyDropdown" class="dropdown-content" style="min-width: 400px; max-width: 500px; max-height: 400px; overflow-y: auto;">
                        <div style="font-weight: 600; font-size: 0.9em; margin-bottom: 8px; padding-left: 4px;">Deletion History</div>
                        <div id="historyList">
                            <p style="color: var(--text-secondary); font-size: 0.9em;">No history found.</p>
                        </div>
                        <button id="btnClearAllHistory" class="macos danger" style="width: 100%; margin-top: 8px;"><i class="fa-solid fa-trash"></i> Clear History</button>
                    </div>
                </div>
                <div class="dropdown">
                    <button id="uiPreferencesBtn" class="macos-icon-button" title="UI Preferences"><i class="fa-solid fa-swatchbook"></i></button>
                    <div id="uiPreferencesDropdown" class="dropdown-content" style="min-width: 320px; max-width: 360px;">
                        <div style="font-weight: 600; font-size: 0.85em; color: var(--text-secondary); margin-bottom: 8px; padding-left: 4px;">General Preferences</div>
                        <div class="settings-group inline">
                            <label>Theme</label>
                            <span class="toggle-icons"><i class="fa-solid fa-sun"></i><label class="macos-switch"><input type="checkbox" id="dropdownThemeToggle"><span class="slider"></span></label><i class="fa-solid fa-moon"></i></span>
                        </div>
                        <hr style="border:none; border-top: 1px solid var(--border-subtle); margin: 8px 0;">

                        <div style="font-weight: 600; font-size: 0.85em; color: var(--text-secondary); margin-bottom: 8px; padding-left: 4px;">Audit UI Preferences</div>
                        <div class="settings-group inline">
                            <label>Show RO Match popup on new merchant</label>
                            <label class="macos-switch"><input type="checkbox" id="dropdownShowRoMatchPopupToggle"><span class="slider"></span></label>
                        </div>
                        <div class="settings-group inline">
                            <label>Show Parser View</label>
                            <label class="macos-switch"><input type="checkbox" id="dropdownParserToggle"><span class="slider"></span></label>
                        </div>
                        <div class="settings-group inline">
                            <label>Counter Position</label>
                            <span class="toggle-icons"><i class="fa-solid fa-align-left"></i><label class="macos-switch"><input type="checkbox" id="dropdownCounterPosToggle"><span class="slider"></span></label><i class="fa-solid fa-users"></i></span>
                        </div>
                        <hr style="border:none; border-top: 1px solid var(--border-subtle); margin: 8px 0;">

                        <div style="font-weight: 600; font-size: 0.85em; color: var(--text-secondary); margin-bottom: 8px; padding-left: 4px;">File UI Preferences</div>
                        <div class="settings-group inline">
                            <label>Auto-save Case ID on paste</label>
                            <label class="macos-switch"><input type="checkbox" id="dropdownAutoSaveOnPasteToggle"><span class="slider"></span></label>
                        </div>
                        <div class="settings-group inline">
                            <label>Show "Copy Case Title" Button</label>
                            <label class="macos-switch"><input type="checkbox" id="dropdownCopyTitleToggle"><span class="slider"></span></label>
                        </div>
                        <div class="settings-group inline">
                            <label>Case Card Text Position</label>
                            <span class="toggle-icons">Left<label class="macos-switch"><input type="checkbox" id="dropdownTextPosToggle"><span class="slider"></span></label>Right</span>
                        </div>
                        <div class="settings-group inline">
                            <label>Reverse Case Card Controls</label>
                            <span class="toggle-icons">Left<label class="macos-switch"><input type="checkbox" id="dropdownCaseCardLayoutToggle"><span class="slider"></span></label>Right</span>
                        </div>
                        <div class="settings-group inline">
                            <label>Case Filer Tab Layout</label>
                            <span class="toggle-icons"><i class="fa-solid fa-grip"></i><label class="macos-switch"><input type="checkbox" id="dropdownTabLayoutToggle"><span class="slider"></span></label><i class="fa-solid fa-grip-lines"></i></span>
                        </div>
                    </div>
                </div>
                <div class="dropdown">
                    <button id="btnOpenSettings" class="macos-icon-button" title="Settings"><i class="fa-solid fa-sliders"></i></button>
                <div id="settingsDropdown" class="dropdown-content" style="min-width: 300px;">
                    <div style="font-weight: 600; font-size: 0.85em; color: var(--text-secondary); margin-bottom: 8px; padding-left: 4px;">Carrier Settings</div>
                    <div class="settings-group">
                        <label for="settingsAmzlCarriers" style="font-size: 0.9em;">AMZL-type Carriers:</label>
                        <div class="macos-textfield-container"><input type="text" id="settingsAmzlCarriers" class="macos-textfield" placeholder="e.g., AMZL,AMZN"></div>
                    </div>
                    <div class="settings-group">
                        <label for="settingsOtherCarriers" style="font-size: 0.9em;">Other Carriers:</label>
                        <div class="macos-textfield-container"><input type="text" id="settingsOtherCarriers" class="macos-textfield" placeholder="e.g., UPS,USPS"></div>
                    </div>
                    <div class="settings-group inline">
                        <label>Enable UPS/USPS Mode</label>
                        <label class="macos-switch"><input type="checkbox" id="settingsUpsUspsToggle"><span class="slider"></span></label>
                    </div>
                    <hr style="border:none; border-top: 1px solid var(--border-subtle); margin: 8px 0;">
                    <div style="font-weight: 600; font-size: 0.85em; color: var(--text-secondary); margin-bottom: 8px; padding-left: 4px;">Data & History</div>
                    <div class="settings-group inline">
                        <label>Auto-clear history (24h)</label>
                        <label class="macos-switch"><input type="checkbox" id="settingsAutoClearHistoryToggleInput"><span class="slider"></span></label>
                    </div>
                    <hr style="border:none; border-top: 1px solid var(--border-subtle); margin: 8px 0;">
                    <div style="font-weight: 600; font-size: 0.85em; color: var(--text-secondary); margin-bottom: 8px; padding-left: 4px;">Download Settings</div>
                    <div class="settings-group inline">
                        <label>Default Download Format</label>
                        <span class="toggle-icons">TXT<label class="macos-switch"><input type="checkbox" id="settingsDefaultFileTypeToggle"><span class="slider"></span></label>HTML</span>
                    </div>
                </div>
                </div>
            </div>
        </div>
    </div>

    <div id="mainWrapper" class="main-wrapper">
        <div class="left-column-wrapper">
            <div id="parserTool" class="tool-container parser-tool">
                 <div class="tool-card-title-bar">
                    <h3 class="tool-card-title">Parser</h3>
                    <button id="parserToggle" class="macos-icon-button" title="Toggle Parser View"><i class="fa-solid fa-eye-slash"></i></button>
                </div>
                <div class="parser-content">
                    <div class="macos-textfield-container">
                        <textarea id="shipmentInput" class="macos-textfield" placeholder="Paste Amazon removal shipment data here..."></textarea>
                    </div>
                    <div id="upsUspsOutputContainer" style="display: none; margin-top: 16px;">
                        <div class="macos-textfield-container"><textarea id="upsUspsOutputArea" class="macos-textfield" placeholder="Extracted Other Carrier Tracking Numbers..."></textarea></div>
                        <button id="btnProcessUpsUsps" class="macos primary" style="margin-top: 8px;"><i class="fa-solid fa-gears"></i>Process & Add</button>
                    </div>
                </div>
            </div>

            <div class="tool-container merchant-actions-tool">
                <div class="tool-card-title-bar">
                    <h3 class="tool-card-title">Merchants</h3>
                    <div id="merchantCounterTarget"></div>
                </div>
                <div style="flex-shrink: 0; display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
                    <button id="btnDownloadSelected" class="macos primary" disabled><i class="fa-solid fa-download"></i>Download Selected</button>
                    <button id="btnSplitSelected" class="macos secondary" disabled><i class="fa-solid fa-table-columns"></i>Split</button>
                    <button id="btnClearSelected" class="macos danger"><i class="fa-regular fa-trash-can"></i>Clear Selected</button>
                    <div class="macos-textfield-container" style="min-width: 250px;">
                        <input type="text" id="newMerchantInput" class="macos-textfield" placeholder="Paste merchant ID and name here...">
                    </div>
                </div>
                
                <div id="merchantList"></div>
                <div class="resize-handle"></div>
            </div>
        </div>

        <div class="tool-container note-taker-tool">
             <div class="tool-card-title-bar">
                <h3 class="tool-card-title">Notes</h3>
                <div class="ro-match-controls non-standalone">
                     <div class="macos-textfield-container">
                        <input type="text" id="roMatchInput" class="macos-textfield" placeholder="Paste RO data for matching...">
                        <button id="btnClearRoInput" class="macos-icon-button" title="Clear RO Data"><i class="fa-solid fa-trash-can"></i></button>
                    </div>
                    <span id="roMatchCounter">0/0</span>
                    <button id="btnViewRoIdsMain" class="macos primary" disabled><i class="fa-solid fa-list-check"></i>View ROs</button>
                </div>
            </div>
            <div id="noteAreaContainer" class="macos-textfield-container" style="flex-grow: 1; display:flex;">
                <textarea id="noteArea" class="macos-textfield" placeholder="Notes area..."></textarea>
            </div>
            <div class="controls-and-stats">
                <div>
                    <div style="display: flex; gap: 8px; flex-wrap:wrap; align-items: center;">
                        <button id="btnAddSeparator" class="macos secondary"><i class="fa-solid fa-equals"></i>Separator</button>
                        <button id="btnClearAllNotes" class="macos danger"><i class="fa-solid fa-eraser"></i>Clear All</button>
                        <div class="toolbar-icon-group">
                            <button id="btnUndoNote" class="macos-icon-button" title="Undo"><i class="fa-solid fa-undo"></i></button>
                            <button id="btnRedoNote" class="macos-icon-button" title="Redo"><i class="fa-solid fa-redo"></i></button>
                       </div>
                    </div>
                     <div id="notesCounterTarget" class="counter-pill-container">
                        <div id="theCounterPill" class="counter-pill">
                            <p><i class="fa-solid fa-users"></i>Merchants: <span id="merchantCount">0</span></p>
                            <p><i class="fa-solid fa-file-lines"></i>Cases: <span id="totalTemplates">0</span></p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="resize-handle"></div>
        </div>
    </div>

    <div id="caseModeWrapper" class="case-mode-wrapper" style="display: none;">
        <header class="case-mode-header">
            <div class="case-mode-title-group">
                <h2 class="case-mode-title">File Cases</h2>
                <span id="caseModeGlobalStats"></span>
            </div>
            <div class="tab-actions-right">
                <button id="copyAllMerchantsBtn" class="macos success" style="display: none;"><i class="fa-solid fa-copy"></i>Copy All Merchants & IDs</button>
            </div>
        </header>
        <div id="caseModeTabContainer" class="case-mode-tab-container"></div>
        <div id="caseModeTabContents"></div>
    </div>
    
    <div id="splitModal" class="modal-overlay">
        <div class="modal-content">
            <h2><i class="fa-solid fa-table-columns" style="margin-right:8px;"></i>Split Selected Merchant(s)</h2>
            <div id="splitMerchantInfo" style="font-size: 0.9em; color: var(--text-secondary); background-color: var(--bg-hover); padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border-subtle);"></div>
            <div>
                <label for="splitOrdersPerTemplate">Removal Orders per Template:</label>
                <div class="macos-textfield-container" style="width: 80px; margin-top: 4px;">
                    <input type="number" id="splitOrdersPerTemplate" class="macos-textfield" style="text-align:center;" min="1" value="1">
                </div>
            </div>
            <div style="font-size: 0.9em; color: var(--text-secondary);">
                Calculated Total Templates: <span id="splitCalculatedTemplates" style="font-weight: 600; color: var(--text-primary);">0</span>
            </div>
            <hr style="border:none; border-top: 1px solid var(--border-subtle); margin: 6px 0;">
            <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                <label for="splitNumberInput" style="flex-shrink: 0;">Templates per Split File:</label>
                <div class="macos-textfield-container" style="width: 100px;">
                    <input type="number" id="splitNumberInput" class="macos-textfield" style="text-align:center;" min="1" placeholder="e.g., 100">
                </div>
            </div>
            <div class="modal-actions">
                <button id="btnCancelSplit" class="macos secondary"><i class="fa-solid fa-xmark"></i>Cancel</button>
                <div class="dropdown" data-align="left">
                    <button id="generateSplitsDropdownBtn" class="macos primary"><i class="fa-solid fa-file-zipper"></i>Generate & Download</button>
                    <div id="generateSplitsDropdown" class="dropdown-content download-options">
                         <div class="button-row">
                            <button class="macos secondary" data-action="download-split-txt"><i class="fa-solid fa-file-lines"></i>as Text</button>
                            <button class="macos secondary" data-action="download-split-html"><i class="fa-solid fa-file-code"></i>as Filer</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals for Case Mode -->
    <div id="caseTextModal" class="modal-overlay">
        <div class="modal-content">
            <h2><i class="fa-solid fa-file-alt" style="margin-right:8px;"></i>Original Template</h2>
            <pre id="caseTextModalContent"></pre>
            <div class="modal-actions">
                <button id="closeCaseTextModalBtn" class="macos primary">Close</button>
            </div>
        </div>
    </div>

    <div id="caseModeActionModal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="caseModeActionModalTitle">Action</h2>
            <div id="caseModeActionModalBody"></div>
            <div class="modal-footer">
                <div class="left-actions">
                    <button id="caseModeActionModalCopyAllBtn" class="macos secondary" style="display:none;">Copy All</button>
                </div>
                <div class="right-actions">
                    <button id="caseModeActionModalCancelBtn" class="macos secondary">Close</button>
                    <button id="caseModeActionModalActionBtn" class="macos primary" style="display:none;">Action</button>
                </div>
            </div>
        </div>
    </div>

    <div id="roMatchModal" class="modal-overlay">
        <div class="modal-content">
            <h2><i class="fa-solid fa-paste" style="margin-right:8px;"></i>Paste RO Data for Matching</h2>
            <div class="macos-textfield-container">
                <textarea id="roMatchModalInput" class="macos-textfield" style="min-height: 150px;" placeholder="Paste RO data here..."></textarea>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                <label class="macos-checkbox-container">
                    <input type="checkbox" id="autoCloseOnPaste" class="macos-checkbox" checked>
                    <span>Auto close after pasting</span>
                </label>
                <button id="btnDoneRoMatch" class="macos primary">Done</button>
            </div>
        </div>
    </div>

    <div id="roIdsModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <h2><i class="fa-solid fa-list-check" style="margin-right:8px;"></i>Matched RO IDs</h2>
            <div id="roIdsModalContent" style="max-height: 400px; overflow-y: auto;"></div>
            <div class="modal-actions">
                <button id="btnCloseRoIdsModal" class="macos primary">Close</button>
            </div>
        </div>
    </div>

<script>
    // STANDALONE_DATA_PLACEHOLDER
    const amzlTemplate = `We've reviewed our removal orders and discovered some shipments whose delivery status is unclear. Could you please check on your end? We're unable to verify the tracking status. If they were lost in transit, could you kindly issue a reimbursement`;
    const upsUspsTemplate = `The Removal Order Status indicates "Completed," yet we never received this order. We kindly request a reimbursement for this discrepancy.`;
    const merchantSeparator = '\n\n' + 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”' + '\n\n';
    const merchantSeparatorRegex = /\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n/g;
    const caseSeparator = '\n\n' + 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€' + '\n\n';
    const caseSeparatorRegex = /\n\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n/g;
    const localStorageKey = 'savedNotesContent_amzlTool';
    const upsUspsOutputKey = 'stagedUpsUspsTNs_amzlTool';
    const upsUspsContextKey = 'stagedUpsUspsContext_amzlTool';
    const historyKey = 'outboundToolHistory_v2';
    const settingsKey = 'outboundToolSettings_v3';
    const parserStateKey = 'outboundToolParserState';
    const caseModeStateKey = 'outboundToolCaseModeState_v3';
    const merchantCompletionKey = 'outboundToolMerchantCompletionState';
    const matchedRoIdsKey = 'outboundToolMatchedRoIds_v3'; 
    const caseModeActiveKey = 'outboundToolCaseModeActive';
    const filerViewStateKeyPrefix = 'outboundToolFilerViewState_v2_';
    const accountIssueKey = 'outboundToolAccountIssues';
    const roMatchDataKey = 'outboundToolRoMatchData';
    const scrollPosKeys = {
        shipmentInput: 'scrollPos_shipmentInput_amzlTool',
        upsUspsOutputArea: 'scrollPos_upsUspsOutputArea_amzlTool',
        noteArea: 'scrollPos_noteArea_amzlTool'
    };
    let appSettings = {
        prefixOption: '3C',
        amzlTypeCarriers: ['AMZN', 'AMZL', 'AMZL_US_PREMIUM', 'AMZL_CA_PREMIUM', 'AMZN_UK_PRIME', 'AMZN_UK_STD'],
        otherCarriers: ['UPS', 'USPS'],
        showMerchantSearch: false,
        showParser: true,
        theme: 'light',
        layout: 'auto',
        counterPosition: 'notes',
        autoClearHistory: true,
        marketplaceUrlGen: 'com',
        caseTextPosition: 'left',
        showCopyTitleBtn: false,
        tabLayout: 'wrap',
        showRoMatchPopup: false,
        caseCardLayout: 'default', // 'default' or 'reversed'
        autoSaveOnPaste: true,
        upsUspsMode: false,
        defaultFileType: 'html', // 'txt' or 'html'
    };
    let regexPatterns = {
        amzlSource: null,
        otherSource: null,
        allExisting: null,
        coreTnExtract: null
    };
    let tempUpsUspsData = {};
    let merchantsToDeleteAfterSend = [];
    let selectedMerchantDataForSplit = [];
    let noteHistory = [];
    let noteHistoryIndex = -1;
    let isUndoRedoAction = false;
    let noteChangeTimeout;
    let merchantToSelectAfterUpdate = null;

    // --- CASE MODE VARIABLES ---
    let caseModeData = [];
    let activeCaseModeTabId = null;
    let matchedRoIds = new Map();
    let dynamicFilerViewStateKey = 'outboundToolFilerViewState_v2_default'; // Default key


    function escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function sanitizeFilename(name) {
        return name.replace(/[\s\\/:"*?<>|()]+/g, '_').substring(0, 50);
    }

    function getFormattedDate() {
        const date = new Date();
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        return `${month}-${day}`;
    }
    
    function getFilenamePrefix() {
        return appSettings.prefixOption === 'LS' ? 'LS-OUTB' : '3C-OUTB';
    }

    function buildCarrierRegexPart(carrierArray) {
        if (!carrierArray || carrierArray.length === 0) return '(?:UNKNOWN_CARRIER_TYPE)';
        return '(?:' + carrierArray.map(escapeRegExp).join('|') + ')';
    }

    function showNotification(message, type = 'info', duration = 3000) {
        const container = document.getElementById('toastContainer');
        if (!container) return;

        // Create toast element
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;

        // Add to container
        container.appendChild(toast);

        // Trigger show animation
        requestAnimationFrame(() => {
            toast.classList.add('show');
        });

        // Hide and remove after duration
        setTimeout(() => {
            toast.classList.remove('show');
            toast.classList.add('hiding');

            // Remove from DOM after animation completes
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300); // Match transition duration
        }, duration);
    }

    function setTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
    }

    const applyTheme = setTheme; // Alias for consistency

    function updateThemeToggleIcon() {
        const btn = document.getElementById('btnThemeToggle');
        const icon = btn?.querySelector('i');
        if (icon) {
            icon.className = appSettings.theme === 'dark' ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
        }
    }

    function setPrefix(prefix) {
        appSettings.prefixOption = prefix;
        saveSettings();
    }

    function loadSettings() {
        const savedSettings = localStorage.getItem(settingsKey);
        if (savedSettings) {
            try {
                const parsed = JSON.parse(savedSettings);
                appSettings = { ...appSettings, ...parsed};
            } catch (e) {
                console.error("Error parsing settings:", e);
            }
        }
        
        if (appSettings.tabLayout === 'vertical') {
            appSettings.tabLayout = 'wrap';
        }

        initializeRegexPatterns();
        applyAppSettings();
    }
    
    function saveSettings() {
        localStorage.setItem(settingsKey, JSON.stringify(appSettings));
        initializeRegexPatterns();
        applyAppSettings();
        showNotification("Settings saved!", "success");
    }
    
    function applyAppSettings() {
        setTheme(appSettings.theme);
        document.getElementById('btnPrefix3C').classList.toggle('active', appSettings.prefixOption === '3C');
        document.getElementById('btnPrefixLS').classList.toggle('active', appSettings.prefixOption === 'LS');
        
        // Sync UI preferences dropdown toggles
        document.getElementById('dropdownThemeToggle').checked = (appSettings.theme === 'dark');
        document.getElementById('dropdownShowRoMatchPopupToggle').checked = appSettings.showRoMatchPopup;
        document.getElementById('dropdownParserToggle').checked = appSettings.showParser;
        document.getElementById('dropdownCounterPosToggle').checked = (appSettings.counterPosition === 'merchants');
        document.getElementById('dropdownAutoSaveOnPasteToggle').checked = appSettings.autoSaveOnPaste;
        document.getElementById('dropdownCopyTitleToggle').checked = appSettings.showCopyTitleBtn;
        document.getElementById('dropdownTextPosToggle').checked = (appSettings.caseTextPosition === 'right');
        document.getElementById('dropdownCaseCardLayoutToggle').checked = (appSettings.caseCardLayout === 'reversed');
        document.getElementById('dropdownTabLayoutToggle').checked = (appSettings.tabLayout === 'hscroll');

        // Sync settings dropdown toggles
        document.getElementById('settingsDefaultFileTypeToggle').checked = (appSettings.defaultFileType === 'html');
        
        document.getElementById('marketplaceSelectUrlGen').value = appSettings.marketplaceUrlGen;

        // Update theme toggle icon
        updateThemeToggleIcon();

        // Apply visual changes
        applyMerchantSearchVisibility();
        updateParserVisibility();
        updateCounterPillLocation();
        if(document.body.classList.contains('is-standalone-mode') || document.getElementById('caseModeWrapper').style.display !== 'none'){
            applyCaseCardLayout();
        }
        applyCopyTitleButtonVisibility();
        applyTabLayout();
    }

    function getHistory() {
        try {
            const history = localStorage.getItem(historyKey);
            return history ? JSON.parse(history) : [];
        } catch (e) {
            console.error("Failed to parse history:", e);
            return [];
        }
    }

    function saveHistory(history) {
        localStorage.setItem(historyKey, JSON.stringify(history));
    }
    
    function autoClearOldHistory() {
        if (!appSettings.autoClearHistory) return;
        const history = getHistory();
        if (history.length === 0) return;
        const twentyFourHoursAgo = Date.now() - (24 * 60 * 60 * 1000);
        const recentHistory = history.filter(item => {
            const itemDate = new Date(item.deletedAt).getTime();
            return itemDate > twentyFourHoursAgo;
        });
        if (recentHistory.length < history.length) {
            saveHistory(recentHistory);
        }
    }

    function addToHistory(deletedMerchants, fileInfo = []) {
        if (!deletedMerchants || deletedMerchants.length === 0) return;
        const history = getHistory();
        const newEntry = {
            id: Date.now() + Math.random().toString(36).substr(2, 9),
            deletedAt: new Date().toISOString(),
            merchants: deletedMerchants
        };
        history.unshift(newEntry);
        saveHistory(history);
    }
    
    function renderHistoryModal() {
        const history = getHistory();
        const listEl = document.getElementById('historyList');
        listEl.innerHTML = '';
        if (history.length === 0) {
            listEl.innerHTML = '<p>No history found.</p>';
            return;
        }
        history.forEach(item => {
            const itemEl = document.createElement('div');
            itemEl.className = 'history-item';
            const merchantNames = item.merchants.map(m => m.displayName).join(', ');
            const totalCases = item.merchants.reduce((sum, m) => sum + m.count, 0);
            itemEl.innerHTML = `
                <div class="history-item-header">
                    <span class="history-item-date">${new Date(item.deletedAt).toLocaleString()}</span>
                    <button class="macos secondary restore-btn" data-history-id="${item.id}"><i class="fa-solid fa-undo"></i> Restore</button>
                </div>
                <div class="history-item-content">
                    <p><b>Merchants:</b> ${merchantNames}</p>
                    <p><b>Total Cases:</b> ${totalCases}</p>
                </div>`;
            listEl.appendChild(itemEl);
        });
    }

    function restoreHistoryItem(historyId) {
        let history = getHistory();
        const itemIndex = history.findIndex(item => item.id === historyId);
        if (itemIndex === -1) return;
        const [itemToRestore] = history.splice(itemIndex, 1);
        const noteArea = document.getElementById('noteArea');
        const textToRestore = itemToRestore.merchants.map(m => m.key).join(merchantSeparator);
        const currentNoteTrimmed = noteArea.value.trimEnd();
        noteArea.value = currentNoteTrimmed + (currentNoteTrimmed ? merchantSeparator : '') + textToRestore;
        saveHistory(history);
        countTemplatesNoteTaker();
        recordNoteChange();
        renderHistoryModal();
        showNotification("Merchant(s) restored successfully!", "success");
    }

    function formatMerchantBlockForOutput(blockText) {
        let namePart = '';
        let casesPart = blockText;
        const lines = blockText.split('\n');
        const firstLine = lines[0]?.trim();
        
        const isNameFromFirstLine = firstLine && 
                                  !firstLine.startsWith(amzlTemplate.substring(0, 10)) && 
                                  !firstLine.startsWith(upsUspsTemplate.substring(0, 10)) && 
                                  !firstLine.includes(caseSeparator.trim()) && // Ensure it's not a separator
                                  firstLine.length < 100 && 
                                  !firstLine.includes(':') && 
                                  !firstLine.startsWith('Removal order ID');

        if (isNameFromFirstLine) {
            namePart = firstLine;
            casesPart = lines.slice(1).join('\n').trim();
        } else {
            casesPart = blockText.trim();
        }
        
        const trimmedCaseSeparator = caseSeparator.trim();
        if (casesPart.startsWith(trimmedCaseSeparator)) {
            casesPart = casesPart.substring(trimmedCaseSeparator.length).trimStart();
        }
        
        return namePart ? (namePart + '\n\n' + casesPart) : casesPart;
    }

    function isMerchantVerified(merchantObj) {
        const roIdRegex = /Removal order ID:\s*(\S+)/g;
        const allRoIdsInMerchant = merchantObj.cases.flatMap(c => [...c.text.matchAll(roIdRegex)].map(match => match[1]));

        if (allRoIdsInMerchant.length === 0) {
            return false; // Not verifiable if no RO IDs exist
        }

        // Check if every RO ID found in the merchant's cases is also in the matched set
        return allRoIdsInMerchant.every(id => matchedRoIds.has(id));
    }

    function getFormattedBlockWithVerification(merchantObj) {
        let formattedBlock = formatMerchantBlockForOutput(merchantObj.originalText);
        
        if (isMerchantVerified(merchantObj)) {
            const lines = formattedBlock.split('\n\n');
            // The first part is the name, the rest is the case data.
            // This handles both cases where a name was parsed or not.
            if (lines.length > 0) {
                lines[0] = `${lines[0]} ***Verified Removal***`;
                return lines.join('\n\n');
            }
        }
        return formattedBlock;
    }
    
    function initializeRegexPatterns() {
        const amzlCarrierPart = buildCarrierRegexPart(appSettings.amzlTypeCarriers);
        const otherCarrierPart = buildCarrierRegexPart(appSettings.otherCarriers);
        const allCarriersCombined = [...appSettings.amzlTypeCarriers, ...appSettings.otherCarriers];
        const uniqueAllCarriers = Array.from(new Set(allCarriersCombined.filter(Boolean)));
        const allCarrierPart = buildCarrierRegexPart(uniqueAllCarriers.length > 0 ? uniqueAllCarriers : ['TEMP_PLACEHOLDER']);
        regexPatterns.amzlSource = new RegExp(`\\b([A-Z0-9]+(?:-|\\s)*?)\\s*\\((${amzlCarrierPart})\\)`, 'gi');
        regexPatterns.otherSource = new RegExp(`\\b([A-Z0-9]+(?:-|\\s)*?)\\s*\\((${otherCarrierPart})\\)`, 'gi');
        regexPatterns.allExisting = new RegExp(`\\b([A-Z0-9]+(?:-|\\s)*?\\s*\\(${allCarrierPart}\\))`, 'gi');
        regexPatterns.coreTnExtract = new RegExp(`\\s*\\(${allCarrierPart}\\)$`, 'i');
    }

    function updateCounterPillLocation() {
        const counterPillEl = document.getElementById('theCounterPill');
        const notesTarget = document.getElementById('notesCounterTarget');
        const merchantTarget = document.getElementById('merchantCounterTarget');
        if (!counterPillEl || !notesTarget || !merchantTarget) return;
        if (counterPillEl.parentNode) counterPillEl.parentNode.removeChild(counterPillEl);
        if (appSettings.counterPosition === 'merchants') {
            merchantTarget.appendChild(counterPillEl);
            notesTarget.style.display = 'none';
            merchantTarget.style.display = 'flex';
        } else {
            notesTarget.appendChild(counterPillEl);
            notesTarget.style.display = 'flex';
            merchantTarget.style.display = 'none';
        }
    }

    function setLayout(layout) {
        const mainWrapper = document.getElementById('mainWrapper');
        mainWrapper.classList.remove('layout-stacked', 'layout-side-by-side');
        mainWrapper.classList.add(`layout-${layout}`);
    }

    function handleAutoLayout() {
        const isCurrentlyNarrow = window.innerWidth < 1100;
        setLayout(isCurrentlyNarrow ? 'stacked' : 'side-by-side');
    }

    function applyMerchantSearchVisibility() {
        const searchContainer = document.getElementById('merchantSearchContainer');
        const searchInput = document.getElementById('merchantSearchInput');
        if (searchContainer) {
            searchContainer.style.display = appSettings.showMerchantSearch ? 'block' : 'none';
            if (!appSettings.showMerchantSearch && searchInput) searchInput.value = '';
            filterMerchants();
        }
    }

    function updateParserVisibility() {
        const parserTool = document.getElementById('parserTool');
        const parserToggleBtn = document.getElementById('parserToggle');
        if (parserTool && parserToggleBtn) {
            if (appSettings.showParser) {
                parserTool.classList.remove('is-hidden');
                parserToggleBtn.querySelector('i').className = 'fa-solid fa-eye-slash';
            } else {
                parserTool.classList.add('is-hidden');
                parserToggleBtn.querySelector('i').className = 'fa-solid fa-eye';
            }
        }
    }

    function filterMerchants() {
        const searchTerm = document.getElementById('merchantSearchInput')?.value.toLowerCase().trim() || "";
        document.querySelectorAll('#merchantList .merchant-item').forEach(item => {
            const displayName = item.dataset.displayName?.toLowerCase() || "";
            item.style.display = displayName.includes(searchTerm) ? 'flex' : 'none';
        });
        updateSelectedCountNoteTaker();
    }

    function parseShipmentData() {
        const input = document.getElementById('shipmentInput');
        const noteArea = document.getElementById('noteArea');
        const upsUspsOutputArea = document.getElementById('upsUspsOutputArea');
        const inputValue = input.value;
        if (inputValue.trim()) {
            input.value = '';
        } else {
            return;
        }
        const currentNoteValue = noteArea.value;
        const isUpsUspsMode = appSettings.upsUspsMode;
        const trackingNumberSourceRegex = isUpsUspsMode ? regexPatterns.otherSource : regexPatterns.amzlSource;
        const existingTrackingNumberRegexGlobal = regexPatterns.allExisting;
        const coreTNReplaceRegex = regexPatterns.coreTnExtract;
        const existingTrackingNumbers = new Set();
        let matchCheck;
        while ((matchCheck = existingTrackingNumberRegexGlobal.exec(currentNoteValue)) !== null) {
            const coreTN = matchCheck[1].replace(coreTNReplaceRegex, '').replace(/\s|-/g, '');
            if (coreTN) existingTrackingNumbers.add(coreTN);
        }
        if (upsUspsOutputArea && upsUspsOutputArea.value) {
            upsUspsOutputArea.value.split('\n').forEach(tn => {
                const trimmedTn = tn.trim();
                if (trimmedTn) existingTrackingNumbers.add(trimmedTn.replace(/\s|-/g, ''));
            });
        }
        const seenTrackingNumbersInCurrentInput = new Set();
        const overallBlocks = inputValue.split(/(?=Removal order ID:)/g);
        const parsedDataBlocks = [];
        const extractedUpsUspsNumbers = [];
        let validShipmentsFound = 0;
        let skippedDuplicateCount = 0;
        let currentBlockRemovalOrderId = '';
        overallBlocks.forEach(block => {
            if (!block.trim()) return;
            const blockRoMatch = block.match(/Removal order ID:\s*([^\n]+)/);
            if (blockRoMatch) {
                currentBlockRemovalOrderId = blockRoMatch[1].trim();
            }
            const shipmentSections = block.split(/(?=Shipment ID:)/g).filter(section => section.trim() !== '');
            shipmentSections.forEach(section => {
                if (section.trim().startsWith("Removal order ID:")) return;
                const trackingMatches = Array.from(section.matchAll(trackingNumberSourceRegex));
                if (!trackingMatches || trackingMatches.length === 0) return;
                const sectionCoreTNs = new Set();
                const sectionFullTNs = [];
                trackingMatches.forEach(match => {
                    const rawTNPart = match[1].trim();
                    const carrier = match[2];
                    const coreTN = rawTNPart.replace(/\s|-/g, '');
                    if (!coreTN) return;
                    sectionCoreTNs.add(coreTN);
                    const fullFormattedTN = `${rawTNPart}(${carrier})`;
                    sectionFullTNs.push(fullFormattedTN);
                });
                let hasDuplicate = false;
                const coreTNsToCheck = Array.from(sectionCoreTNs);
                for (const coreTn of coreTNsToCheck) {
                    if (existingTrackingNumbers.has(coreTn) || seenTrackingNumbersInCurrentInput.has(coreTn)) {
                        hasDuplicate = true;
                        break;
                    }
                }
                if (hasDuplicate) {
                    skippedDuplicateCount++;
                    coreTNsToCheck.forEach(tn => seenTrackingNumbersInCurrentInput.add(tn));
                    return;
                }
                coreTNsToCheck.forEach(tn => seenTrackingNumbersInCurrentInput.add(tn));
                const shipmentIdMatch = section.match(/^Shipment ID:\s*([^\n]+)/m);
                const shipmentId = shipmentIdMatch ? shipmentIdMatch[1].trim() : 'N/A';
                const productLines = section.split('\n').map(line => line.trim());
                const parsedProducts = [];
                let currentProduct = null;
                for (let i = 0; i < productLines.length; i++) {
                    const line = productLines[i];
                    if (line.startsWith('Merchant SKU:')) {
                        if (currentProduct && currentProduct.merchantSku && currentProduct.qty !== undefined) {
                            parsedProducts.push(currentProduct);
                        }
                        currentProduct = {
                            merchantSku: line.substring('Merchant SKU:'.length).trim(),
                            qty: undefined
                        };
                    } else if (currentProduct) {
                        if (line.startsWith('FNSKU:')) {
                            currentProduct.fnsku = line.substring('FNSKU:'.length).trim();
                        } else if (/^\d{1,4}$/.test(line) && productLines[i - 1]?.match(/^(EAN|UPC|ISBN_10|Condition|Shipped Quantity|Cancelled Quantity):/i)) {
                            currentProduct.qty = parseInt(line, 10);
                            parsedProducts.push(currentProduct);
                            currentProduct = null;
                        }
                    }
                }
                if (currentProduct && currentProduct.merchantSku && currentProduct.qty !== undefined && !parsedProducts.includes(currentProduct)) {
                    parsedProducts.push(currentProduct);
                }
                if (parsedProducts.length === 0) return;
                const roIdToUse = currentBlockRemovalOrderId || "N/A";
                const outputParts = [`Removal order ID:${roIdToUse}`, `Shipment ID:${shipmentId}`, `Tracking Number(s):${Array.from(new Set(sectionFullTNs)).join(', ')}`];
                const productOutputs = parsedProducts.map(p => [`Merchant SKU:${p.merchantSku || 'N/A'}`, `FNSKU:${p.fnsku || 'N/A'}`, `Qty:${p.qty}`].join('\n'));
                const completeDataBlock = outputParts.join('\n') + '\n' + productOutputs.join('\n\n');
                if (isUpsUspsMode) {
                    coreTNsToCheck.forEach(coreTN => {
                        if (!tempUpsUspsData[coreTN]) tempUpsUspsData[coreTN] = completeDataBlock;
                        extractedUpsUspsNumbers.push(coreTN);
                    });
                } else {
                    parsedDataBlocks.push(completeDataBlock);
                }
                validShipmentsFound++;
            });
        });
        let casesAdded = 0;
        let finalOutputString = '';
        let templateUsed = isUpsUspsMode ? upsUspsTemplate : amzlTemplate;
        
        if (isUpsUspsMode) {
            if (extractedUpsUspsNumbers.length > 0) {
                const uniqueNumbersToAdd = Array.from(new Set(extractedUpsUspsNumbers));
                upsUspsOutputArea.value += (upsUspsOutputArea.value ? '\n' : '') + uniqueNumbersToAdd.join('\n');
                saveUpsUspsOutputToLocalStorage();
                saveUpsUspsContextToLocalStorage();
                let processedMessage = `Extracted ${uniqueNumbersToAdd.length} Other Carrier number(s). `;
                if (skippedDuplicateCount > 0) processedMessage += `Skipped ${skippedDuplicateCount} duplicate(s). `;
                showNotification(processedMessage, "info");
            } else {
                let message = "No new Other Carrier shipments found. ";
                if (skippedDuplicateCount > 0) message += `Skipped ${skippedDuplicateCount} duplicate(s). `;
                showNotification(message, "info");
            }
        } else {
            if (parsedDataBlocks.length > 0) {
                const templateChunks = parsedDataBlocks.map(dataBlock => templateUsed + "\n\n" + dataBlock);
                finalOutputString = templateChunks.join(caseSeparator);
                casesAdded = templateChunks.length;
            }
        }
        
        if (casesAdded > 0) {
            const currentNoteTrimmed = noteArea.value.trimEnd();
            let prefix = '';
            if (currentNoteTrimmed && !currentNoteTrimmed.endsWith(merchantSeparator.trim())) {
                prefix = caseSeparator;
            }
            noteArea.value = currentNoteTrimmed + prefix + finalOutputString;

            countTemplatesNoteTaker();
            recordNoteChange();
            let processedMessage = `Processed ${validShipmentsFound} new shipment(s). `;
            if (skippedDuplicateCount > 0) processedMessage += `Skipped ${skippedDuplicateCount} duplicate(s). `;
            showNotification(processedMessage, "success");
            if (casesAdded > 0) showNotification(`+${casesAdded} cases added`, "info");
        } else if (!isUpsUspsMode) {
             let message = "No new AMZL-type shipments found. ";
             if (skippedDuplicateCount > 0) message += `Skipped ${skippedDuplicateCount} duplicate(s). `;
             showNotification(message, "info");
        }
        
        saveShipmentInputScroll();
    }


    function processUpsUspsData() {
        const upsUspsOutputArea = document.getElementById('upsUspsOutputArea');
        const noteArea = document.getElementById('noteArea');
        if (!upsUspsOutputArea || !noteArea) return;
        const trackingNumbersToProcess = upsUspsOutputArea.value.split('\n').map(tn => tn.trim()).filter(Boolean);
        if (trackingNumbersToProcess.length === 0) {
            return;
        }
        let processedBlocks = [];
        let notFoundCount = 0;
        const processedTNs = new Set();
        trackingNumbersToProcess.forEach(tn => {
            const coreTN = tn.replace(/\s|-/g, '');
            if (!processedTNs.has(coreTN)) {
                if (tempUpsUspsData[coreTN]) {
                    processedBlocks.push(upsUspsTemplate + "\n\n" + tempUpsUspsData[coreTN]);
                    processedTNs.add(coreTN);
                } else {
                    notFoundCount++;
                }
            }
        });
        if (processedBlocks.length > 0) {
            const currentNoteTrimmed = noteArea.value.trimEnd();
            const finalContent = processedBlocks.join(caseSeparator);
            
            let prefix = '';
             if (currentNoteTrimmed && !currentNoteTrimmed.endsWith(merchantSeparator.trim())) {
                prefix = caseSeparator;
            }

            noteArea.value = currentNoteTrimmed + prefix + finalContent;
            
            countTemplatesNoteTaker();
            recordNoteChange();
            const remainingOutputTNs = upsUspsOutputArea.value.split('\n').map(t => t.trim()).filter(t => t && !processedTNs.has(t.replace(/\s|-/g, '')));
            upsUspsOutputArea.value = remainingOutputTNs.join('\n');
            processedTNs.forEach(coreTN => {
                delete tempUpsUspsData[coreTN];
            });
            saveUpsUspsOutputToLocalStorage();
            saveUpsUspsContextToLocalStorage();
            showNotification(`Added ${processedBlocks.length} Other Carrier entries to notes.`, "success");
            if (processedBlocks.length > 0) showNotification(`+${processedBlocks.length} cases added`, "info");
        }
        if (notFoundCount > 0) showNotification(`Warning: Could not find data for ${notFoundCount} tracking number(s).`, "error");
    }

    function clearSelectedMerchants() {
        const selectedDivs = document.querySelectorAll('#merchantList .merchant-item.selected');
        if (selectedDivs.length === 0) return;

        const deletedMerchants = Array.from(selectedDivs).map(div => ({
            key: div.dataset.key,
            displayName: div.dataset.displayName,
            count: parseInt(div.dataset.count, 10)
        }));
        addToHistory(deletedMerchants);

        const keysToRemove = new Set(deletedMerchants.map(m => m.key));
        const noteArea = document.getElementById('noteArea');
        
        const allSections = noteArea.value.split(merchantSeparatorRegex);
        const remainingSections = allSections.filter(section => !keysToRemove.has(section));
        
        noteArea.value = remainingSections.join(merchantSeparator);
        countTemplatesNoteTaker();
        recordNoteChange();
        showNotification(`${deletedMerchants.length} merchant(s) deleted and backed up.`, "success");
    }

    function countTemplatesInText(text, templateString) {
        if (!text || !templateString) return 0;
        const escapedTemplate = templateString.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        return (text.match(new RegExp(escapedTemplate, 'g')) || []).length;
    }

    function downloadFile(content, filename, mimeType) {
        const blob = new Blob([content], { type: mimeType });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        a.remove();
    }


    function countTemplatesNoteTaker() {
        const noteArea = document.getElementById('noteArea');
        const fullText = noteArea.value;
        const merchantListDiv = document.getElementById('merchantList');

        // Preserve selection before clearing the list
        const selectedKeys = new Set(
            Array.from(merchantListDiv.querySelectorAll('.merchant-item.selected'), div => div.dataset.key)
        );

        merchantListDiv.innerHTML = '';
        const merchantsData = {};
        let totalTemplatesOverall = 0;
        let merchantIndex = 0;
        const sections = fullText.split(merchantSeparatorRegex);
        sections.forEach((sectionTextOriginal) => {
            const sectionText = sectionTextOriginal.trim();
            if (!sectionText) return;
            const amzlTemplateCount = countTemplatesInText(sectionText, amzlTemplate);
            const upsUspsTemplateCount = countTemplatesInText(sectionText, upsUspsTemplate);
            const templateCount = amzlTemplateCount + upsUspsTemplateCount;
            totalTemplatesOverall += templateCount;
            let merchantName = `Entry ${++merchantIndex}`;
            const firstLine = sectionText.split('\n')[0]?.trim();
            let isNameFromFirstLine = false;
            if (firstLine && !firstLine.startsWith(amzlTemplate.substring(0, 10)) && !firstLine.startsWith(upsUspsTemplate.substring(0, 10)) && firstLine.length < 100 && !firstLine.startsWith('Removal order ID')) {
                merchantName = firstLine;
                isNameFromFirstLine = true;
            } else if (sectionText.includes('Removal order ID:')) {
                merchantName = `Data Entry ${merchantIndex}`;
            }
            merchantsData[sectionTextOriginal] = {
                displayName: merchantName,
                isNameFromFirstLine: isNameFromFirstLine,
                count: templateCount,
                key: sectionTextOriginal
            };
        });
        
        Object.entries(merchantsData).forEach(([key, data]) => {
            const merchantDiv = document.createElement('div');
            merchantDiv.className = 'merchant-item';
            merchantDiv.dataset.key = key;
            merchantDiv.dataset.displayName = data.displayName;
            merchantDiv.dataset.count = data.count;
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'macos-checkbox';
            
            const statusDot = document.createElement('div');
            statusDot.className = 'status-dot';
            
            const nameSpan = document.createElement('span');
            nameSpan.className = 'merchant-name';
            nameSpan.textContent = data.displayName;
            nameSpan.style.margin = '0 8px';

            const controlsDiv = document.createElement('div');
            controlsDiv.className = 'merchant-controls';

            const countSpan = document.createElement('span');
            countSpan.className = 'case-count';
            countSpan.textContent = `${data.count} ${data.count === 1 ? 'case' : 'cases'}`;

            controlsDiv.appendChild(countSpan);

            merchantDiv.appendChild(statusDot);
            merchantDiv.appendChild(checkbox);
            merchantDiv.appendChild(nameSpan);
            merchantDiv.appendChild(controlsDiv);

             merchantDiv.addEventListener('click', (e) => {
                if (e.target.closest('.macos-checkbox')) {
                    updateSelectedCountNoteTaker();
                    return;
                }

                const isChecked = checkbox.checked;

                if(e.ctrlKey || e.metaKey){
                    e.preventDefault();
                    checkbox.checked = !isChecked;
                } else {
                    document.querySelectorAll('#merchantList .macos-checkbox').forEach(cb => cb.checked = false);
                    checkbox.checked = !isChecked;
                }
                updateSelectedCountNoteTaker();
            });

            merchantListDiv.appendChild(merchantDiv);
        });
        
        // Restore selection after rebuilding the list, unless a new merchant was just added
        if (selectedKeys.size > 0 && !merchantToSelectAfterUpdate) {
            merchantListDiv.querySelectorAll('.merchant-item').forEach(item => {
                if (selectedKeys.has(item.dataset.key)) {
                    const checkbox = item.querySelector('.macos-checkbox');
                    if (checkbox) checkbox.checked = true;
                }
            });
        }

        // Auto-select a newly added merchant
        if (merchantToSelectAfterUpdate) {
            const newItem = Array.from(merchantListDiv.querySelectorAll('.merchant-item'))
                                 .find(div => div.dataset.key === merchantToSelectAfterUpdate);
            if (newItem) {
                document.querySelectorAll('#merchantList .macos-checkbox').forEach(cb => cb.checked = false);
                const checkbox = newItem.querySelector('.macos-checkbox');
                if (checkbox) {
                    checkbox.checked = true;
                    newItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
            merchantToSelectAfterUpdate = null;
        }
        
        filterMerchants();
        updateSelectedCountNoteTaker();
        updateStateContent(noteArea.value);
    }
    
    function updateStateContent(content) {
        const state = JSON.parse(localStorage.getItem(caseModeStateKey)) || {};
        state.fileContent = content;
        if (!state.fileNames) {
            state.fileNames = [];
        }
        localStorage.setItem(caseModeStateKey, JSON.stringify(state));
    }


    function updateSelectedCountNoteTaker() {
        const selectedCheckboxes = document.querySelectorAll('#merchantList .macos-checkbox:checked');
        const splitButton = document.getElementById('btnSplitSelected');
        const btnDownloadSelected = document.getElementById('btnDownloadSelected');
        const btnDownloadSelectedToggle = document.getElementById('btnDownloadSelectedDropdownToggle');
        const btnViewRoIdsMain = document.getElementById('btnViewRoIdsMain');

        let selectedCaseCount = 0;
        document.querySelectorAll('.merchant-item').forEach(item => {
            const cb = item.querySelector('.macos-checkbox');
            if (cb?.checked) {
                item.classList.add('selected');
                selectedCaseCount += parseInt(item.dataset.count || '0', 10);
            } else {
                item.classList.remove('selected');
            }
        });

        const isAnythingSelected = selectedCheckboxes.length > 0;
        if (splitButton) splitButton.disabled = !isAnythingSelected;
        if (btnDownloadSelected) btnDownloadSelected.disabled = !isAnythingSelected;
        if (btnDownloadSelectedToggle) btnDownloadSelectedToggle.disabled = !isAnythingSelected;
        if (btnViewRoIdsMain) btnViewRoIdsMain.disabled = selectedCheckboxes.length !== 1;

        const totalTemplatesSpan = document.getElementById('totalTemplates');
        const merchantCountSpan = document.getElementById('merchantCount');

        if (isAnythingSelected) {
            totalTemplatesSpan.textContent = selectedCaseCount;
            merchantCountSpan.textContent = selectedCheckboxes.length;
        } else {
            const allItems = document.querySelectorAll('#merchantList .merchant-item');
            const totalCaseCountOverall = Array.from(allItems).reduce((sum, el) => sum + parseInt(el.dataset.count || '0', 10), 0);
            totalTemplatesSpan.textContent = totalCaseCountOverall;
            merchantCountSpan.textContent = allItems.length;
        }

        const btnSelectAll = document.getElementById('btnSelectAll');
        const selectAllText = document.getElementById('selectAllText');
        const selectAllIcon = btnSelectAll?.querySelector('i');

        if (btnSelectAll && selectAllText && selectAllIcon) {
            const allVisibleCheckboxes = Array.from(document.querySelectorAll('#merchantList .merchant-item'))
                .filter(item => item.style.display !== 'none')
                .map(item => item.querySelector('.macos-checkbox'));
            
            const areAllSelected = allVisibleCheckboxes.length > 0 && allVisibleCheckboxes.every(cb => cb.checked);

            if (areAllSelected) {
                selectAllText.textContent = 'Deselect All';
                selectAllIcon.className = 'fa-solid fa-square-xmark';
            } else {
                selectAllText.textContent = 'Select All';
                selectAllIcon.className = 'fa-regular fa-square-check';
            }
        }
        updateRoMatchCounter();
        updateMerchantStatusDots();
    }
    
    function downloadSelectedMerchants(asHtml = false) {
        if (asHtml) {
            exportCaseTrackerFile(false); 
        } else { 
            const selectedDivs = document.querySelectorAll('#merchantList .merchant-item.selected');
            if (selectedDivs.length === 0) return;

            const selectedMerchantsData = Array.from(selectedDivs).map(div => {
                return caseModeData.find(m => m.originalText === div.dataset.key);
            }).filter(Boolean);

            if (selectedMerchantsData.length === 0) {
                 showNotification("Could not find data for selected merchants.", "error");
                 return;
            }
            
            const totalCases = selectedMerchantsData.reduce((sum, m) => sum + m.cases.length, 0);
            const filenameBase = `${getFilenamePrefix()}(${totalCases})-${getFormattedDate()}-`;

            const combinedText = selectedMerchantsData.map(getFormattedBlockWithVerification).join(merchantSeparator);
            const filename = `${filenameBase}.txt`;
            downloadFile(combinedText + '\n', filename, 'text/plain;charset=utf-8');
        }
    }

    function downloadAll(asHtml = false){
        if (asHtml) {
            exportCaseTrackerFile(true);
        } else {
            const allMerchantsData = caseModeData;
            const totalCases = allMerchantsData.reduce((sum, m) => sum + m.cases.length, 0);
            const filenameBase = `${getFilenamePrefix()}(${totalCases})-${getFormattedDate()}-`;
            const combinedText = allMerchantsData.map(getFormattedBlockWithVerification).join(merchantSeparator);
            const filename = `${filenameBase}.txt`;
            downloadFile(combinedText + '\n', filename, 'text/plain;charset=utf-8');
        }
    }

    function processSingleROBlock(roBlockText, removalOrdersArray) {
        const roIdLineMatch = roBlockText.match(/^\s*Removal order ID:[^\n]+/);
        if (!roIdLineMatch) return;
        const currentRoIdLine = roIdLineMatch[0].trim();
        const remainingText = roBlockText.substring(roIdLineMatch[0].length).trim();
        if (!remainingText) return;
        const shipmentBlocks = remainingText.split(/(?=^\s*Shipment ID:)/m);
        shipmentBlocks.forEach((shipmentBlock) => {
            const trimmed = shipmentBlock.trim();
            if (trimmed.startsWith('Shipment ID:') && trimmed.includes('Merchant SKU:')) removalOrdersArray.push(currentRoIdLine + '\n' + trimmed);
        });
    }

    function splitTextIntoRemovalOrders(inputText) {
        const removalOrders = [];
        if (!inputText) return removalOrders;
        let textToProcess = inputText.trim();
        const escapedAmzl = amzlTemplate.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const escapedUps = upsUspsTemplate.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        textToProcess = textToProcess.replace(new RegExp('^\\s*' + escapedAmzl + '\\s*\\n*', 'gm'), '').replace(new RegExp('^\\s*' + escapedUps + '\\s*\\n*', 'gm'), '').trim();
        const lines = textToProcess.split('\n');
        if (lines.length > 2 && lines[1].trim() === "" && lines[2].startsWith("Removal order ID:")) textToProcess = lines.slice(2).join('\n');
        else if (lines.length > 0 && lines[0].startsWith("Removal order ID:")) textToProcess = lines.join('\n');
        const potentialROBlocks = textToProcess.split(/(?=^\s*Removal order ID:)/m);
        potentialROBlocks.forEach((roBlock) => {
            const trimmed = roBlock.trim();
            if (!trimmed) return;
            if (trimmed.startsWith('Removal order ID:')) processSingleROBlock(trimmed, removalOrders);
        });
        return removalOrders;
    }

    function createTemplates(removalOrders, ordersPerTemplate) {
        const templates = [];
        if (!removalOrders || removalOrders.length === 0 || ordersPerTemplate <= 0) return templates;
        for (let i = 0; i < removalOrders.length; i += ordersPerTemplate) {
            const chunk = removalOrders.slice(i, i + ordersPerTemplate).filter(o => o && typeof o === 'string');
            if (chunk.length > 0) templates.push(chunk.join('\n\n'));
        }
        return templates;
    }
    
    function updateCalculatedTemplates() {
        const modal = document.getElementById('splitModal');
        if (!modal) return;
        const combinedText = modal.dataset.combinedText || '';
        const ordersInput = document.getElementById('splitOrdersPerTemplate');
        const calcSpan = document.getElementById('splitCalculatedTemplates');
        if (!ordersInput || !calcSpan) return;
        const ordersPer = parseInt(ordersInput.value) || 0;
        if (ordersPer > 0 && combinedText) {
            const ros = splitTextIntoRemovalOrders(combinedText);
            calcSpan.textContent = createTemplates(ros, ordersPer).length;
        } else calcSpan.textContent = '0';
    }

    function generateAndDownloadSplits(asHtml = false) {
        const modal = document.getElementById('splitModal');
        if (!modal) return;

        const splitNum = parseInt(document.getElementById('splitNumberInput').value);
        if (isNaN(splitNum) || splitNum < 1) {
            showNotification("Please enter a valid number for 'Templates per Split File'.", "error");
            return;
        }

        closeSplitModal();

        const allCasesWithMerchantContext = selectedMerchantDataForSplit.flatMap(merchantData => {
            const merchantObject = caseModeData.find(m => m.originalText === merchantData.key);
            if (!merchantObject) return [];
            return merchantObject.cases.map(caseItem => ({
                ...caseItem,
                originalMerchant: merchantObject 
            }));
        });
        
        if (allCasesWithMerchantContext.length === 0) {
            showNotification("No valid cases found to split.", "info");
            return;
        }

        const caseChunks = [];
        for (let i = 0; i < allCasesWithMerchantContext.length; i += splitNum) {
            caseChunks.push(allCasesWithMerchantContext.slice(i, i + splitNum));
        }

        if (caseChunks.length === 0) {
            showNotification("No split files generated.", "info");
            return;
        }

        const merchantDisplayNamesForTxt = selectedMerchantDataForSplit.map(item => {
            const merchantObj = caseModeData.find(m => m.originalText === item.key);
            return (merchantObj && isMerchantVerified(merchantObj)) ? `${item.name} ***Verified Removal***` : item.name;
        }).join(' & ');
        
        let filenamePart = sanitizeFilename(selectedMerchantDataForSplit.length === 1 ? selectedMerchantDataForSplit[0].name : `${selectedMerchantDataForSplit[0].name}_Multi`);
        const startDate = new Date();

        caseChunks.forEach((chunkOfCases, index) => {
            const caseCount = chunkOfCases.length;
            
            const currentDate = new Date(startDate);
            currentDate.setDate(startDate.getDate() + index);
            const month = (currentDate.getMonth() + 1).toString().padStart(2, '0');
            const day = currentDate.getDate().toString().padStart(2, '0');
            const dateStr = `${month}-${day}`;
            
            const filenameBase = `${getFilenamePrefix()}(${caseCount})-${dateStr}-${filenamePart}-PART_${index + 1}`;

            if (asHtml) {
                const merchantsInThisSplit = new Map();
                chunkOfCases.forEach(caseItem => {
                    const originalMerchant = caseItem.originalMerchant;
                    if (!merchantsInThisSplit.has(originalMerchant.id)) {
                        merchantsInThisSplit.set(originalMerchant.id, {
                            id: originalMerchant.id,
                            displayName: originalMerchant.displayName,
                            originalText: originalMerchant.originalText,
                            isCompleted: originalMerchant.isCompleted,
                            isAccountIssue: originalMerchant.isAccountIssue,
                            cases: []
                        });
                    }
                    const cleanCaseItem = { ...caseItem };
                    delete cleanCaseItem.originalMerchant;
                    merchantsInThisSplit.get(originalMerchant.id).cases.push(cleanCaseItem);
                });
                
                const fileId = `${Date.now()}_${Math.random().toString(36).substr(2, 9)}_${index}`;
                const payload = {
                    data: Array.from(merchantsInThisSplit.values()),
                    layout: appSettings.caseTextPosition,
                    matched: Array.from(matchedRoIds.entries()),
                    fileId: fileId, // Add unique ID for each part
                    settings: { 
                        showCopyTitleBtn: appSettings.showCopyTitleBtn, 
                        marketplaceUrlGen: appSettings.marketplaceUrlGen, 
                        tabLayout: appSettings.tabLayout,
                        caseCardLayout: appSettings.caseCardLayout,
                        autoSaveOnPaste: appSettings.autoSaveOnPaste
                    }
                };
                
                const fileContent = generateFilerHTML(payload);
                downloadFile(fileContent, `${filenameBase}.html`, 'text/html;charset=utf-8');

            } else { // TXT Download
                const textForSplit = chunkOfCases.map(caseItem => caseItem.text).join(caseSeparator);
                const fileContent = merchantDisplayNamesForTxt + '\n\n' + textForSplit + '\n';
                downloadFile(fileContent, `${filenameBase}.txt`, 'text/plain;charset=utf-8');
            }
        });
    }
    
    function addSeparator() {
        const ta = document.getElementById('noteArea');
        const trimmed = ta.value.trimEnd();
        ta.value = trimmed + (trimmed ? merchantSeparator : '');
        ta.focus();
        countTemplatesNoteTaker();
        recordNoteChange();
    }

    function addNewMerchant(name) {
        const noteArea = document.getElementById('noteArea');
        const currentNoteTrimmed = noteArea.value.trimEnd();
        noteArea.value = currentNoteTrimmed + (currentNoteTrimmed ? merchantSeparator : '') + name;
        
        merchantToSelectAfterUpdate = name;
        
        countTemplatesNoteTaker();
        recordNoteChange();
        showNotification(`Added merchant: ${name}`, 'success');
        if (appSettings.showRoMatchPopup) {
            openRoMatchModal();
        }
    }

    function confirmAndClearAllNotes() {
        document.getElementById('clearAllConfirmModal').style.display = 'none';
        const noteArea = document.getElementById('noteArea');
        const deletedMerchants = [];
        const sections = noteArea.value.split(merchantSeparatorRegex);
        sections.forEach(sectionText => {
            if (sectionText.trim()) {
                const count = countTemplatesInText(sectionText, amzlTemplate) + countTemplatesInText(sectionText, upsUspsTemplate);
                const displayName = sectionText.split('\n')[0].trim();
                deletedMerchants.push({ key: sectionText, displayName, count });
            }
        });
        if (deletedMerchants.length > 0) {
            addToHistory(deletedMerchants);
        }
        noteArea.value = '';
        localStorage.removeItem(caseModeStateKey);
        localStorage.removeItem(merchantCompletionKey);
        localStorage.removeItem(matchedRoIdsKey);
        localStorage.removeItem(accountIssueKey);
        Object.keys(localStorage).filter(key => key.startsWith('case-')).forEach(key => localStorage.removeItem(key));

        countTemplatesNoteTaker();
        recordNoteChange();
        document.getElementById('clearAllSuccessPopup').style.display = 'flex';
    }

    function saveNotesToLocalStorage() {
        const noteArea = document.getElementById('noteArea');
        if (noteArea) {
            updateStateContent(noteArea.value);
            localStorage.setItem(scrollPosKeys.noteArea, noteArea.scrollTop);
        }
    }
    
    function saveUpsUspsOutputToLocalStorage() {
        const upsUspsOutputArea = document.getElementById('upsUspsOutputArea');
        if (upsUspsOutputArea) {
            localStorage.setItem(upsUspsOutputKey, upsUspsOutputArea.value);
            localStorage.setItem(scrollPosKeys.upsUspsOutputArea, upsUspsOutputArea.scrollTop);
        }
    }
    
    function saveShipmentInputScroll() {
        const shipmentInput = document.getElementById('shipmentInput');
        if (shipmentInput) {
            localStorage.setItem(scrollPosKeys.shipmentInput, shipmentInput.scrollTop);
        }
    }
    
    function saveRoMatchInput() {
        const roMatchInput = document.getElementById('roMatchInput');
        if(roMatchInput) {
            localStorage.setItem(roMatchDataKey, roMatchInput.value);
        }
    }

    function saveUpsUspsContextToLocalStorage() {
        try {
            localStorage.setItem(upsUspsContextKey, JSON.stringify(tempUpsUspsData));
        } catch (error) {
            console.error("Error saving Other Carrier context to localStorage:", error);
        }
    }

    function restoreScrollPositions() {
        const shipmentInputEl = document.getElementById('shipmentInput');
        const upsUspsOutputAreaEl = document.getElementById('upsUspsOutputArea');
        const noteAreaEl = document.getElementById('noteArea');

        if (shipmentInputEl) shipmentInputEl.scrollTop = parseInt(localStorage.getItem(scrollPosKeys.shipmentInput)) || 0;
        if (upsUspsOutputAreaEl) upsUspsOutputAreaEl.scrollTop = parseInt(localStorage.getItem(scrollPosKeys.upsUspsOutputArea)) || 0;
        if (noteAreaEl) noteAreaEl.scrollTop = parseInt(localStorage.getItem(scrollPosKeys.noteArea)) || 0;
    }
    
    function saveAllScrollPositions() {
        saveShipmentInputScroll();
        saveUpsUspsOutputToLocalStorage();
        saveNotesToLocalStorage();
        saveRoMatchInput();
    }
    
    function initDraggableWindows() {
        const handles = document.querySelectorAll('.resize-handle');
        handles.forEach(handle => {
            const container = handle.closest('.tool-container');
            if (!container || container.classList.contains('parser-tool')) return;
            let initialHeight, initialY;
            const onMouseMove = (e) => {
                const dy = e.clientY - initialY;
                let newHeight = initialHeight + dy;
                const minHeight = parseInt(getComputedStyle(container).minHeight) || 150;
                if (newHeight < minHeight) newHeight = minHeight;
                container.style.height = `${newHeight}px`;
            };
            const onMouseUp = () => {
                document.body.classList.remove('is-resizing');
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            };
            handle.addEventListener('mousedown', (e) => {
                e.preventDefault();
                initialHeight = container.offsetHeight;
                initialY = e.clientY;
                document.body.classList.add('is-resizing');
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });
        });
    }

    function updateNoteUndoRedoButtons() {
        const undoBtn = document.getElementById('btnUndoNote');
        const redoBtn = document.getElementById('btnRedoNote');
        undoBtn.disabled = noteHistoryIndex <= 0;
        redoBtn.disabled = noteHistoryIndex >= noteHistory.length - 1;
    }

    function recordNoteChange() {
        if (isUndoRedoAction) {
            isUndoRedoAction = false;
            return;
        }
        const noteArea = document.getElementById('noteArea');
        const currentValue = noteArea.value;
        if (noteHistory[noteHistoryIndex] === currentValue) return;

        noteHistory = noteHistory.slice(0, noteHistoryIndex + 1);
        noteHistory.push(currentValue);
        noteHistoryIndex = noteHistory.length - 1;
        updateNoteUndoRedoButtons();
    }

    function handleNoteUndo() {
        if (noteHistoryIndex > 0) {
            isUndoRedoAction = true;
            noteHistoryIndex--;
            document.getElementById('noteArea').value = noteHistory[noteHistoryIndex];
            countTemplatesNoteTaker();
            updateNoteUndoRedoButtons();
        }
    }

    function handleNoteRedo() {
        if (noteHistoryIndex < noteHistory.length - 1) {
            isUndoRedoAction = true;
            noteHistoryIndex++;
            document.getElementById('noteArea').value = noteHistory[noteHistoryIndex];
            countTemplatesNoteTaker();
            updateNoteUndoRedoButtons();
        }
    }

    function generateReportUrl() {
        const marketplaceDomain = `sellercentral.amazon.${appSettings.marketplaceUrlGen}`;
        const today = new Date();
        const endDate = new Date();
        endDate.setDate(today.getDate() - 15);
        const startDate = new Date();
        startDate.setDate(today.getDate() - 60);
        const formatUrlDate = (date) => {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}/${m}/${d}`;
        };
        const urlStartDate = formatUrlDate(startDate);
        const urlEndDate = formatUrlDate(endDate);
        const reportJsonPayload = { filters: ["", "", "", "RETURN", "COMPLETE"], pageOffset: 1, searchDays: -1, startDate: urlStartDate, endDate: urlEndDate };
        const jsonString = JSON.stringify(reportJsonPayload);
        let encodedPayload = encodeURIComponent(jsonString)
            .replace(/%3A/g, ':').replace(/%2C/g, ',')
            .replace(/%5B/g, '[').replace(/%5D/g, ']')
            .replace(/%2F/g, '/');
        return `https://${marketplaceDomain}/reportcentral/REMOVAL_ORDER_DETAIL/0/${encodedPayload}`;
    }

    function openReportUrl() {
        const url = generateReportUrl();
        window.open(url, '_blank');
    }

    // --- MODAL MANAGEMENT FUNCTIONS ---
    function openSplitModal() {
        const selectedDivs = document.querySelectorAll('#merchantList .merchant-item.selected');
        if (selectedDivs.length === 0) {
            showNotification("Please select at least one merchant to split.", "info");
            return;
        }
        
        selectedMerchantDataForSplit = Array.from(selectedDivs).map(div => ({
            key: div.dataset.key,
            name: div.dataset.displayName,
            count: div.dataset.count
        }));
        
        const combinedText = selectedMerchantDataForSplit.map(item => item.key).join(merchantSeparator);
        const totalCases = selectedMerchantDataForSplit.reduce((sum, item) => sum + parseInt(item.count, 10), 0);
        const containsAmzl = combinedText.includes(amzlTemplate);
        const containsUpsUsps = combinedText.includes(upsUspsTemplate);

        const modal = document.getElementById('splitModal');
        modal.dataset.combinedText = combinedText;
        modal.dataset.containsAmzl = containsAmzl;
        modal.dataset.containsUpsUsps = containsUpsUsps;

        const infoDiv = document.getElementById('splitMerchantInfo');
        const merchantNames = selectedMerchantDataForSplit.map(m => m.name).join(', ');
        infoDiv.textContent = `Splitting ${selectedMerchantDataForSplit.length} merchant(s): ${merchantNames} (${totalCases} total cases).`;

        document.getElementById('splitOrdersPerTemplate').value = 1;
        document.getElementById('splitNumberInput').value = 100;
        updateCalculatedTemplates();

        modal.style.display = 'flex';
    }

    function closeSplitModal() {
        document.getElementById('splitModal').style.display = 'none';
    }

    function openSettingsDropdown() {
        // Sync dropdown inputs with current appSettings
        document.getElementById('settingsAmzlCarriers').value = appSettings.amzlTypeCarriers.join(',');
        document.getElementById('settingsOtherCarriers').value = appSettings.otherCarriers.join(',');
        document.getElementById('settingsUpsUspsToggle').checked = appSettings.upsUspsMode;
        document.getElementById('settingsAutoClearHistoryToggleInput').checked = appSettings.autoClearHistory;
        document.getElementById('settingsDefaultFileTypeToggle').checked = (appSettings.defaultFileType === 'html');
    }
    

    function openClearHistoryConfirmModal() {
        document.getElementById('confirmClearHistoryModal').style.display = 'flex';
    }

    function closeClearHistoryConfirmModal() {
        document.getElementById('confirmClearHistoryModal').style.display = 'none';
    }
    
    function handleClearAllHistory() {
        localStorage.removeItem(historyKey);
        renderHistoryModal();
        closeClearHistoryConfirmModal();
        showNotification("All history cleared.", "success");
    }

    function openRoMatchModal() {
        const modal = document.getElementById('roMatchModal');
        const input = document.getElementById('roMatchModalInput');
        if (modal && input) {
            input.value = ''; // Clear previous content
            modal.style.display = 'flex';
            input.focus();
        }
    }

    function closeRoMatchModal() {
        const modal = document.getElementById('roMatchModal');
        if (modal) {
            modal.style.display = 'none';
        }
    }

    // --- CASE MODE ---

    function generateFilerHTML(payload) {
        let payloadString = `const standalonePayload = ${JSON.stringify(payload)};`;
        payloadString = payloadString.replace(/<\/script>/gi, '<\\/script>');
        
        const theme = document.documentElement.getAttribute('data-theme') || 'light';
        const fullScript = document.querySelector('script').innerHTML;
        
        const fileContent = `
            <!DOCTYPE html>
            <html lang="en" data-theme="${theme}">
            <head>
                ${document.head.innerHTML}
            </head>
            <body>
                ${document.getElementById('notificationPopup').outerHTML}
                ${document.querySelector('.top-bar').outerHTML}
                ${document.getElementById('caseModeWrapper').outerHTML}
                ${document.getElementById('caseTextModal').outerHTML}
                ${document.getElementById('caseModeActionModal').outerHTML}

                <script>
                    ${fullScript.replace('// STANDALONE_DATA_PLACEHOLDER', payloadString)}
                <\/script>
            </body>
            </html>`;
        return fileContent;
    }

    function getCompletionState() {
        try {
            const state = localStorage.getItem(merchantCompletionKey);
            return state ? JSON.parse(state) : {};
        } catch (e) {
            console.error("Failed to parse completion state:", e);
            return {};
        }
    }

    function saveCompletionState(state) {
        localStorage.setItem(merchantCompletionKey, JSON.stringify(state));
    }
    
    function toggleCaseMode() {
        const mainWrapper = document.getElementById('mainWrapper');
        const caseModeWrapper = document.getElementById('caseModeWrapper');
        const caseModeText = document.getElementById('caseModeText');
        const caseModeIcon = document.querySelector('#btnCaseMode i');
        const isActivating = caseModeWrapper.style.display === 'none';

        if (isActivating) {
            mainWrapper.style.display = 'none';
            caseModeWrapper.style.display = 'flex';
            caseModeIcon.className = 'fa-solid fa-folder-open';
            caseModeText.textContent = 'Audit Cases';
            localStorage.setItem(caseModeActiveKey, 'true');
            initCaseMode();
        } else if (!document.body.classList.contains('is-standalone-mode')) {
            mainWrapper.style.display = 'flex';
            caseModeWrapper.style.display = 'none';
            caseModeIcon.className = 'fa-solid fa-briefcase';
            caseModeText.textContent = 'File Cases';
            localStorage.removeItem(caseModeActiveKey);
        }
    }

    function initCaseMode() {
        parseNotesForCaseMode();
        renderCaseModeUI();
        applyTabLayout();
    }
    
    function saveFilerViewState() {
        if (!document.body.classList.contains('is-standalone-mode')) return;

        const state = {
            caseModeData: caseModeData,
            appSettings: {
                caseTextPosition: appSettings.caseTextPosition,
                showCopyTitleBtn: appSettings.showCopyTitleBtn,
                caseCardLayout: appSettings.caseCardLayout,
                autoSaveOnPaste: appSettings.autoSaveOnPaste
            }
        };
        localStorage.setItem(dynamicFilerViewStateKey, JSON.stringify(state));
    }
    
    // MODIFICATION START: The entire initStandaloneMode function is updated for the fix.
    function initStandaloneMode(payload) {
        document.body.classList.add('is-standalone-mode');
        
        // Use the fileId from the payload to create a unique localStorage key.
        // This is the core of the fix.
        if (payload && payload.fileId) {
            dynamicFilerViewStateKey = filerViewStateKeyPrefix + payload.fileId;
        }

        // Initial load from payload
        if (payload.settings) {
            appSettings = {...appSettings, ...payload.settings};
        }
        caseModeData = payload.data || (Array.isArray(payload) ? payload : []);
        appSettings.caseTextPosition = payload.layout || 'left';
        matchedRoIds = new Map(payload.matched || []);
        
        // Check for persistent state using the now-unique key and override if found
        const savedStateJSON = localStorage.getItem(dynamicFilerViewStateKey);
        if (savedStateJSON) {
            try {
                const savedState = JSON.parse(savedStateJSON);
                if (savedState.caseModeData && caseModeData.length > 0 && savedState.caseModeData[0]?.id === caseModeData[0]?.id) {
                    caseModeData = savedState.caseModeData;
                    if (savedState.appSettings) {
                        appSettings = {...appSettings, ...savedState.appSettings};
                    }
                }
            } catch(e) { console.error("Could not load Filer View state.", e); localStorage.removeItem(dynamicFilerViewStateKey); }
        }

        // Set initial UI state
        document.getElementById('marketplaceSelectUrlGen').value = appSettings.marketplaceUrlGen;
        document.getElementById('btnToggleCopyTitle').classList.toggle('active', appSettings.showCopyTitleBtn);
        document.getElementById('btnToggleAutoSave').classList.toggle('active', appSettings.autoSaveOnPaste);
        document.getElementById('btnToggleCardLayout').classList.toggle('active', appSettings.caseCardLayout === 'reversed');

        if (caseModeData.length > 0) {
            activeCaseModeTabId = caseModeData[0].id;
        }
        const mainWrapper = document.getElementById('mainWrapper');
        if(mainWrapper) mainWrapper.style.display = 'none';
        
        document.getElementById('caseModeWrapper').style.display = 'flex';
        
        // Set the main title to the filename and add a "Part" indicator if present
        const titleEl = document.querySelector('.top-bar-title');
        if (titleEl) {
            try {
                let path = window.location.pathname;
                let filename = path.split('/').pop();
                filename = decodeURIComponent(filename);
                titleEl.textContent = filename.replace('.html', ''); // Clean up title

                const partMatch = filename.match(/PART_(\d+)/i);
                if (partMatch && partMatch[1]) {
                    const partIndicator = document.createElement('span');
                    partIndicator.className = 'part-indicator';
                    partIndicator.textContent = `Part ${partMatch[1]}`;
                    const titleGroup = document.querySelector('.case-mode-title-group h2.case-mode-title');
                    if(titleGroup) titleGroup.insertAdjacentElement('afterend', partIndicator);
                }
            } catch (e) {
                console.error("Could not set title from filename:", e);
                titleEl.textContent = "OUTB";
            }
        }

        renderCaseModeUI();
        applyCaseCardLayout();
        applyTabLayout();
    }
    // MODIFICATION END

    // MODIFICATION START: exportCaseTrackerFile is updated to inject the unique fileId
    function exportCaseTrackerFile(all = false) {
        let merchantsToExport;
    
        if (all) {
            merchantsToExport = caseModeData;
        } else {
            const selectedDivs = document.querySelectorAll('#merchantList .merchant-item.selected');
            if (selectedDivs.length === 0) {
                showNotification("No merchants selected to export.", "info");
                return;
            }
            const selectedKeys = new Set(Array.from(selectedDivs, div => div.dataset.key));
            merchantsToExport = caseModeData.filter(m => selectedKeys.has(m.originalText));
    
            if (merchantsToExport.length === 0) {
                showNotification("Could not find data for selected merchants. This can happen if notes were edited after selection.", "error");
                return;
            }
        }
        
        const totalCases = merchantsToExport.reduce((sum, m) => sum + m.cases.length, 0);
        const filename = `${getFilenamePrefix()}(${totalCases})-${getFormattedDate()}-.html`;
    
        const fileId = `${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        const payload = { 
            data: merchantsToExport, 
            layout: appSettings.caseTextPosition, 
            matched: Array.from(matchedRoIds.entries()), 
            fileId: fileId, // This unique ID is crucial for the fix
            settings: { 
                showCopyTitleBtn: appSettings.showCopyTitleBtn, 
                marketplaceUrlGen: appSettings.marketplaceUrlGen, 
                tabLayout: appSettings.tabLayout,
                caseCardLayout: appSettings.caseCardLayout,
                autoSaveOnPaste: appSettings.autoSaveOnPaste
            } 
        };
        
        const fileContent = generateFilerHTML(payload);
        downloadFile(fileContent, filename, 'text/html;charset=utf-8');
        showNotification("Filer View HTML file has been downloaded.", "success");
    }
    // MODIFICATION END

    function reExportFilerView() {
        if (!document.body.classList.contains('is-standalone-mode')) return;
        
        // MODIFICATION START: Re-export must also contain the unique ID
        const fileId = dynamicFilerViewStateKey.replace(filerViewStateKeyPrefix, ''); 
        const newPayload = {
            data: caseModeData,
            layout: appSettings.caseTextPosition,
            matched: Array.from(matchedRoIds.entries()),
            fileId: fileId, // Preserve the unique ID
            settings: {
                showCopyTitleBtn: appSettings.showCopyTitleBtn,
                marketplaceUrlGen: appSettings.marketplaceUrlGen,
                tabLayout: appSettings.tabLayout,
                caseCardLayout: appSettings.caseCardLayout,
                autoSaveOnPaste: appSettings.autoSaveOnPaste
            }
        };
        // MODIFICATION END

        const totalCases = caseModeData.reduce((sum, m) => sum + m.cases.length, 0);
        const filename = `${getFilenamePrefix()}(${totalCases})-${getFormattedDate()}-.html`;
        const fileContent = generateFilerHTML(newPayload);

        downloadFile(fileContent, filename, 'text/html;charset=utf-8');
        showNotification("Filer View re-exported with changes saved!", "success");
    }

    function exportSingleMerchantFilerView(merchant) {
        if (!merchant) return;

        const totalCases = merchant.cases.length;
        const filename = `${getFilenamePrefix()}(${totalCases})-${getFormattedDate()}-.html`;
        
        // MODIFICATION START: Also add a fileId here for consistency
        const fileId = `${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        const payload = {
            data: [merchant],
            layout: appSettings.caseTextPosition,
            matched: Array.from(matchedRoIds.entries()),
            fileId: fileId,
            settings: {
                showCopyTitleBtn: appSettings.showCopyTitleBtn,
                marketplaceUrlGen: appSettings.marketplaceUrlGen,
                tabLayout: appSettings.tabLayout,
                caseCardLayout: appSettings.caseCardLayout,
                autoSaveOnPaste: appSettings.autoSaveOnPaste
            }
        };
        // MODIFICATION END
        
        const fileContent = generateFilerHTML(payload);
        downloadFile(fileContent, filename, 'text/html;charset=utf-8');
        showNotification(`Filer View for ${merchant.displayName} downloaded.`, "success");
    }

    function generateUID(merchantId, caseIndex, text) {
        let hash = 0;
        if (text.length === 0) return `case-${merchantId}-${caseIndex}-${hash}`;
        for (let i = 0; i < text.length; i++) {
            const char = text.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash |= 0;
        }
        return `case-${merchantId}-${caseIndex}-${hash}`;
    }

    function parseNotesForCaseMode() {
        const noteArea = document.getElementById('noteArea');
        if (!noteArea || document.body.classList.contains('is-standalone-mode')) return; // Don't re-parse in standalone
        const fullText = noteArea.value;
        const completionState = getCompletionState();
        const accountIssues = JSON.parse(localStorage.getItem(accountIssueKey)) || {};
        caseModeData = [];
        let merchantIndex = 0;
        const merchantBlocks = fullText.split(merchantSeparatorRegex).filter(b => b.trim());

        merchantBlocks.forEach(block => {
            let merchantName = `Merchant ${++merchantIndex}`;
            let casesText = block.trim();
            const firstLine = block.trim().split('\n')[0].trim();
            if (firstLine && !firstLine.startsWith(amzlTemplate.substring(0, 10)) && !firstLine.startsWith(upsUspsTemplate.substring(0, 10)) && firstLine.length < 100) {
                 merchantName = firstLine;
                 casesText = block.trim().substring(firstLine.length).trim();
            }

            const merchantId = sanitizeFilename(merchantName).replace(/ /g, '-');
            const merchantObject = {
                id: merchantId,
                displayName: merchantName,
                originalText: block,
                isCompleted: completionState[merchantId] || false,
                isAccountIssue: accountIssues[merchantId] || false,
                cases: []
            };
            
            const caseTemplatesRaw = casesText.split(caseSeparatorRegex).filter(c => c.trim());
            const separatorLine = 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€';

            const caseTemplates = caseTemplatesRaw.map(template => {
                let cleanedTemplate = template.trim();
                if (cleanedTemplate.startsWith(separatorLine)) {
                    cleanedTemplate = cleanedTemplate.substring(separatorLine.length).trim();
                }
                return cleanedTemplate;
            }).filter(c => c);

            caseTemplates.forEach((caseText, caseIdx) => {
                const uid = generateUID(merchantId, caseIdx, caseText);
                merchantObject.cases.push({
                    uid: uid,
                    text: caseText,
                    filedId: document.body.classList.contains('is-standalone-mode') ? null : localStorage.getItem(uid) || null,
                });
            });
            
            if (merchantObject.cases.length > 0) {
                caseModeData.push(merchantObject);
            }
        });

        const savedState = JSON.parse(localStorage.getItem(caseModeStateKey));
        if (savedState && savedState.activeTabId && caseModeData.some(m => m.id === savedState.activeTabId)) {
            activeCaseModeTabId = savedState.activeTabId;
        } else if (caseModeData.length > 0) {
            activeCaseModeTabId = caseModeData[0].id;
        } else {
            activeCaseModeTabId = null;
        }
        saveCaseModeState();
    }

    function saveCaseModeState() {
        if (document.body.classList.contains('is-standalone-mode')) return;
        const state = JSON.parse(localStorage.getItem(caseModeStateKey)) || {};
        state.activeTabId = activeCaseModeTabId;
        localStorage.setItem(caseModeStateKey, JSON.stringify(state));
    }

    function renderCaseModeUI() {
        const tabContainer = document.getElementById('caseModeTabContainer');
        const contentContainer = document.getElementById('caseModeTabContents');
        const state = JSON.parse(localStorage.getItem(caseModeStateKey)) || {};
        updateFileInfo(state.fileNames);
        tabContainer.innerHTML = '';
        contentContainer.innerHTML = '';

        if (caseModeData.length === 0) {
            tabContainer.innerHTML = '<p>No cases found. Use the Parser to add data.</p>';
            updateCaseModeStats();
            return;
        }

        caseModeData.forEach(merchant => {
            const filedCount = merchant.cases.filter(c => c.filedId !== null).length;
            const totalCount = merchant.cases.length;
            const metaContent = merchant.isAccountIssue ? 'ISSUE' : `${filedCount}/${totalCount}`;
            
            const tabBtn = document.createElement('div');
            tabBtn.className = 'case-mode-tab-button';
            tabBtn.dataset.tabId = merchant.id;
            
            const completeIcon = merchant.isCompleted ? 'fa-solid fa-check-circle' : 'fa-regular fa-circle';
            const actionButtonHtml = `
                <button class="tab-action-btn toggle-complete-btn" title="Toggle Completion Status"><i class="${completeIcon}"></i></button>
                <button class="tab-action-btn delete-merchant-btn non-standalone" title="Delete Merchant"><i class="fa-solid fa-times"></i></button>
            `;


            tabBtn.innerHTML = `
                <span class="case-mode-merchant-name" title="${merchant.displayName}">${merchant.displayName}</span>
                <div class="case-mode-tab-bottom-row">
                    <button class="copy-merchant-btn" title="Copy Name"><i class="fa-regular fa-copy"></i></button>
                    <span class="case-mode-tab-meta">${metaContent}</span>
                    ${actionButtonHtml}
                </div>
            `;
            if (merchant.id === activeCaseModeTabId) tabBtn.classList.add('active');
            if ((filedCount === totalCount && totalCount > 0) || merchant.isCompleted) tabBtn.classList.add('done');
            if (merchant.isAccountIssue) tabBtn.classList.add('account-issue');
            
            tabContainer.appendChild(tabBtn);

            const tabContent = document.createElement('div');
            tabContent.id = `case-content-${merchant.id}`;
            tabContent.className = 'case-mode-tab-content';
            if (merchant.id === activeCaseModeTabId) tabContent.classList.add('active');
            
            tabContent.innerHTML = `
                <div class="case-mode-tab-content-header">
                    <div class="tab-actions-left">
                       <button class="macos secondary" data-action="view-ro-ids"><i class="fa-solid fa-list-ol"></i> View RO IDs</button>
                       <button class="macos secondary" data-action="open-report-url"><i class="fa-solid fa-arrow-up-right-from-square"></i> Open Report URL</button>
                       <button class="macos secondary ${merchant.isAccountIssue ? 'purple' : ''}" data-action="tag-account-issue"><i class="fa-solid fa-user-slash"></i> Tag Account Issue</button>
                    </div>
                    <div class="tab-actions-right">
                        <label class="macos-checkbox-container" style="font-weight: normal; font-size: 0.85rem; margin-right: 8px;">
                            <input type="checkbox" class="macos-checkbox exclude-non-numeric-local" checked> Exclude non-Case IDs
                        </label>
                       <button class="macos success" data-action="copy-merchant-ids" data-merchant-id="${merchant.id}" ${filedCount === 0 ? 'disabled' : ''}>
                           <i class="fa-solid fa-copy"></i>Copy ${filedCount} ID(s)
                       </button>
                    </div>
                </div>
            `;
            
            const casesList = document.createElement('div');
            if (merchant.isAccountIssue) {
                casesList.style.display = 'none';
            }
            merchant.cases.forEach((caseItem, index) => {
                casesList.appendChild(createCaseCard(caseItem, index + 1));
            });
            tabContent.appendChild(casesList);
            contentContainer.appendChild(tabContent);
        });

        addCaseModeEventListeners();
        updateCaseModeStats();
        updateCaseCardMatchStatus();
        applyCopyTitleButtonVisibility();
    }
    
    function createCaseCard(caseItem, number) {
        const roIdMatch = caseItem.text.match(/Removal order ID:\s*(\S+)/);
        const roId = roIdMatch ? roIdMatch[1] : null;
        const isMatched = roId && matchedRoIds.has(roId);
        const controlsDisabled = !isMatched ? 'disabled' : '';

        const card = document.createElement('div');
        card.className = 'case-card';
        card.id = caseItem.uid;
        
        card.innerHTML = `
            <div class="card-content">
                <div class="left-pane">
                    <span class="ro-match-indicator"><i class="fa-solid fa-check-circle"></i></span>
                    <div class="case-number">${number}</div>
                    <div class="main-content">
                        <div class="case-text">${escapeHTML(caseItem.text)}</div>
                        <div class="editing-info">
                            <div class="macos-textfield-container">
                                <input type="text" class="macos-textfield case-id-input" placeholder="Update Case ID..." value="${escapeHTML(caseItem.filedId || '')}">
                            </div>
                            <button class="macos danger" data-action="delete-case"><i class="fa-solid fa-trash"></i></button>
                            <button class="macos primary" data-action="update-case"><i class="fa-solid fa-save"></i>Update</button>
                        </div>
                        <div class="filed-info">
                            <span class="case-id-display">${escapeHTML(caseItem.filedId || '')}</span>
                        </div>
                    </div>
                </div>
                <div class="right-pane">
                    <div class="unfiled-controls"></div>
                    <div class="filed-controls">
                        <button class="macos secondary" data-action="view-case">View</button>
                        <button class="macos primary" data-action="copy-id">Copy ID</button>
                        <button class="macos warning" data-action="edit-case">Edit</button>
                    </div>
                </div>
            </div>`;
        
        const unfiledControlsContainer = card.querySelector('.unfiled-controls');

        const inputGroupHTML = `
            <div class="case-id-input-group">
                <div class="macos-textfield-container">
                    <input type="text" class="macos-textfield case-id-input" placeholder="Enter Case ID..." ${controlsDisabled}>
                </div>
                <button class="macos-icon-button success" data-action="save-case" title="Save Case ID" ${controlsDisabled}><i class="fa-solid fa-save"></i></button>
            </div>`;
        const separatorHTML = `<hr style="border: none; border-top: 1px solid var(--border-subtle); margin: 8px 0;" />`;
        const copyTemplateBtnHTML = `<button class="macos primary" data-action="copy-text" style="padding-top: 8px; padding-bottom: 8px;" ${controlsDisabled}><i class="fa-solid fa-copy"></i>Copy Template</button>`;
        const copyTitleBtnHTML = `<button class="macos secondary copy-case-title" data-action="copy-case-title" style="width: 100%;"><i class="fa-solid fa-heading"></i>Copy Case Title</button>`;
        
        if (appSettings.caseCardLayout === 'reversed') {
            unfiledControlsContainer.innerHTML = copyTemplateBtnHTML + copyTitleBtnHTML + separatorHTML + inputGroupHTML;
            unfiledControlsContainer.style.justifyContent = 'flex-end';
        } else {
            unfiledControlsContainer.innerHTML = inputGroupHTML + separatorHTML + copyTemplateBtnHTML + copyTitleBtnHTML;
            unfiledControlsContainer.style.justifyContent = 'flex-start';
        }

        const cardContent = card.querySelector('.card-content');
        if (appSettings.caseTextPosition === 'right') {
            cardContent.classList.add('layout-right');
        }

        if (caseItem.filedId !== null) {
            card.classList.add('filed');
        } else {
            card.classList.add('unfiled');
        }
        
        const inputs = card.querySelectorAll('.case-id-input');
        inputs.forEach(input => input.addEventListener('paste', handleCasePaste));

        return card;
    }

    function addCaseModeEventListeners() {
        const tabContainer = document.getElementById('caseModeTabContainer');
        const contentContainer = document.getElementById('caseModeTabContents');
        
        tabContainer.addEventListener('click', e => {
            const targetButton = e.target.closest('button');

            // Handle specific buttons within the tab first
            if (targetButton) {
                if (targetButton.classList.contains('copy-merchant-btn')) {
                    e.stopPropagation();
                    const merchantId = targetButton.closest('.case-mode-tab-button').dataset.tabId;
                    const merchant = caseModeData.find(m => m.id === merchantId);
                    if (merchant) {
                        navigator.clipboard.writeText(merchant.displayName);
                        showNotification(`Copied: ${merchant.displayName}`, 'success');
                    }
                    return;
                }
                if (targetButton.classList.contains('delete-merchant-btn')) {
                    e.stopPropagation();
                    const merchantId = targetButton.closest('.case-mode-tab-button').dataset.tabId;
                    handleDeleteMerchant(merchantId);
                    return;
                }
                if (targetButton.classList.contains('toggle-complete-btn')) {
                    e.stopPropagation();
                    const tabButton = targetButton.closest('.case-mode-tab-button');
                    const merchantId = tabButton.dataset.tabId;
                    const merchant = caseModeData.find(m => m.id === merchantId);
                    if(merchant) {
                        merchant.isCompleted = !merchant.isCompleted;
                        tabButton.classList.toggle('done', merchant.isCompleted);
                        targetButton.querySelector('i').className = merchant.isCompleted ? `fa-solid fa-check-circle` : `fa-regular fa-circle`;
                        if (!document.body.classList.contains('is-standalone-mode')) {
                            const completionState = getCompletionState();
                            completionState[merchantId] = merchant.isCompleted;
                            saveCompletionState(completionState);
                        }
                    }
                    return;
                }
            }
            
            // Handle tab switching
            const tabButton = e.target.closest('.case-mode-tab-button');
             if (tabButton && !tabButton.classList.contains('active')) {
                // Deactivate old tab
                const oldActiveTab = document.querySelector('.case-mode-tab-button.active');
                if (oldActiveTab) {
                    oldActiveTab.classList.remove('active');
                    const oldContent = document.getElementById(`case-content-${oldActiveTab.dataset.tabId}`);
                    if (oldContent) oldContent.classList.remove('active');
                }

                // Activate new tab
                tabButton.classList.add('active');
                activeCaseModeTabId = tabButton.dataset.tabId;
                const newContent = document.getElementById(`case-content-${activeCaseModeTabId}`);
                if (newContent) newContent.classList.add('active');

                saveCaseModeState();
            }
        });

        contentContainer.addEventListener('click', e => {
            const button = e.target.closest('button');
            if (!button) return;
            
            if (button.closest('.case-card')) {
                handleCaseCardAction(button);
                return;
            }
            
            const merchant = caseModeData.find(m => m.id === activeCaseModeTabId);
            if (!merchant) return;

            const action = button.dataset.action;
            const exclude = button.parentElement.querySelector('.exclude-non-numeric-local')?.checked || false;

            if (action === 'copy-merchant-ids') {
                const filteredCases = merchant.cases.filter(c => c.filedId !== null && (!exclude || /^\d+$/.test(c.filedId)));
                if (filteredCases.length > 0) {
                    const ids = filteredCases.map(c => c.filedId).join('\n');
                    navigator.clipboard.writeText(`${merchant.displayName}\n${ids}`);
                    showNotification(`Copied ${filteredCases.length} formatted IDs for ${merchant.displayName}`, 'success');
                } else {
                    showNotification(`No matching IDs to copy.`, 'info');
                }
            } else if (action === 'view-ro-ids') {
                 openGlobalRoChecklistModal(merchant);
            } else if (action === 'open-report-url') {
                openReportUrl();
            } else if (action === 'tag-account-issue') {
                merchant.isAccountIssue = !merchant.isAccountIssue;
                
                if (!document.body.classList.contains('is-standalone-mode')) {
                    const accountIssues = JSON.parse(localStorage.getItem(accountIssueKey)) || {};
                    if (merchant.isAccountIssue) {
                        accountIssues[merchant.id] = true;
                    } else {
                        delete accountIssues[merchant.id];
                    }
                    localStorage.setItem(accountIssueKey, JSON.stringify(accountIssues));
                } else {
                    saveFilerViewState();
                }

                button.classList.toggle('purple', merchant.isAccountIssue);
                const casesList = button.closest('.case-mode-tab-content').querySelector('.case-card')?.parentElement;
                if(casesList) {
                    casesList.style.display = merchant.isAccountIssue ? 'none' : 'block';
                }
                const tabButton = document.querySelector(`.case-mode-tab-button[data-tab-id="${merchant.id}"]`);
                if(tabButton) {
                    tabButton.classList.toggle('account-issue', merchant.isAccountIssue);
                    const metaSpan = tabButton.querySelector('.case-mode-tab-meta');
                    if (merchant.isAccountIssue) {
                        metaSpan.textContent = 'ISSUE';
                    } else {
                        const filedCount = merchant.cases.filter(c => c.filedId !== null).length;
                        const totalCount = merchant.cases.length;
                        metaSpan.textContent = `${filedCount}/${totalCount}`;
                    }
                }
                showNotification(`Account issue tagged ${merchant.isAccountIssue ? 'ON' : 'OFF'}.`, 'info');
            }
        });
        
    }

    function handleCasePaste(event) {
        if (!appSettings.autoSaveOnPaste) return;
        const input = event.target;
        setTimeout(() => {
            const card = input.closest('.case-card');
            if (card) {
                const saveButton = input.closest('.unfiled-controls, .editing-info')?.querySelector('[data-action="save-case"], [data-action="update-case"]');
                if (saveButton && !saveButton.disabled) {
                    saveButton.click();
                }
            }
        }, 50);
    }
    
    function handleCaseCardAction(button) {
        const card = button.closest('.case-card');
        const caseItem = findCaseByUID(card.id);
        if (!caseItem) return;

        const action = button.dataset.action;

        switch(action) {
            case 'copy-text':
                navigator.clipboard.writeText(caseItem.text);
                showNotification('Case text copied!', 'success');
                break;
            case 'copy-case-title':
                 navigator.clipboard.writeText('REMOVAL ORDER - LOST OUTBOUND');
                showNotification('Case title copied', 'success');
                break;
            case 'save-case':
            case 'update-case':
                const inputSelector = action === 'save-case' ? '.unfiled-controls input' : '.editing-info input';
                const input = card.querySelector(inputSelector);
                const newId = input.value.trim();

                caseItem.filedId = newId ? newId : null;
                
                if (newId) {
                    if (!document.body.classList.contains('is-standalone-mode')) {
                        localStorage.setItem(caseItem.uid, newId);
                    }
                    card.classList.add('filed');
                    card.classList.remove('unfiled', 'editing');
                    showNotification('Case ID saved!', 'success');
                } else {
                    if (!document.body.classList.contains('is-standalone-mode')) {
                        localStorage.removeItem(caseItem.uid);
                    }
                    card.classList.add('unfiled');
                    card.classList.remove('filed', 'editing');
                    card.querySelector('.unfiled-controls input.case-id-input').value = '';
                    showNotification('Case ID cleared.', 'info');
                }
                card.querySelector('.case-id-display').textContent = newId;
                updateCaseModeStats();
                saveFilerViewState();
                break;
            case 'view-case':
                document.getElementById('caseTextModalContent').textContent = caseItem.text;
                document.getElementById('caseTextModal').style.display = 'flex';
                break;
            case 'copy-id':
                navigator.clipboard.writeText(caseItem.filedId);
                showNotification('Case ID copied!', 'success');
                break;
            case 'edit-case':
                card.classList.add('editing');
                card.classList.remove('filed');
                break;
            case 'delete-case':
                if (confirm('Are you sure you want to clear this case ID? This will mark it as un-filed.')) {
                    caseItem.filedId = null;
                     if (!document.body.classList.contains('is-standalone-mode')) {
                        localStorage.removeItem(caseItem.uid);
                    }
                    card.querySelector('.unfiled-controls input').value = '';
                    card.classList.remove('filed', 'editing');
                    card.classList.add('unfiled');
                    updateCaseModeStats();
                    saveFilerViewState();
                }
                break;
        }
    }
    
    function findCaseByUID(uid) {
        for (const merchant of caseModeData) {
            const caseItem = merchant.cases.find(c => c.uid === uid);
            if (caseItem) return caseItem;
        }
        return null;
    }

    function handleDeleteMerchant(merchantId) {
        if (document.body.classList.contains('is-standalone-mode')) {
            showNotification("Cannot delete merchants in Filer Mode.", "error");
            return;
        }
        if (!confirm("Are you sure you want to permanently delete this merchant and all its cases? This cannot be undone.")) return;

        const merchant = caseModeData.find(m => m.id === merchantId);
        if (!merchant) return;

        merchant.cases.forEach(caseItem => localStorage.removeItem(caseItem.uid));

        const noteArea = document.getElementById('noteArea');
        const allSections = noteArea.value.split(merchantSeparatorRegex);
        const remainingSections = allSections.filter(section => section.trim() !== merchant.originalText.trim());
        noteArea.value = remainingSections.join(merchantSeparator);

        countTemplatesNoteTaker();
        recordNoteChange();
        
        initCaseMode();

        showNotification(`Merchant "${merchant.displayName}" deleted.`, 'success');
    }
    
    function saveMatchedRoIds() {
        localStorage.setItem(matchedRoIdsKey, JSON.stringify(Array.from(matchedRoIds.entries())));
    }

    function loadMatchedRoIds() {
        const savedData = localStorage.getItem(matchedRoIdsKey);
        if(savedData) {
            try {
                matchedRoIds = new Map(JSON.parse(savedData));
            } catch(e) {
                console.error("Failed to load matched RO IDs:", e);
                matchedRoIds = new Map();
            }
        }
    }
    
    function populateRoIdsModal(specificMerchant) {
        parseNotesForCaseMode();
        const modalContent = document.getElementById('roIdsModalContent');
        const dataSource = specificMerchant ? [specificMerchant] : caseModeData;

        const regex = /Removal order ID:\s*(\S+)/g;
        const allUniqueIds = [...new Set(dataSource.flatMap(m => m.cases.flatMap(c => [...c.text.matchAll(regex)].map(match => match[1]))))];

        if (allUniqueIds.length > 0) {
            const idListHTML = allUniqueIds.sort().map((id, index) => {
                const isMatched = matchedRoIds.has(id);
                const matchType = isMatched ? matchedRoIds.get(id) : '';
                const uniqueId = `ro-check-modal-${index}`;

                let statusHTML = '';
                if(isMatched) {
                    statusHTML = `<span class="ro-id-match-status ${matchType}">${matchType.toUpperCase()} MATCHED</span>`;
                }

                return `
                <div class="ro-id-item">
                    <label class="macos-checkbox-container" for="${uniqueId}" style="flex-grow:1;">
                        <input type="checkbox" id="${uniqueId}" class="macos-checkbox ro-match-checkbox-modal" data-id="${id}" ${isMatched ? 'checked' : ''}>
                        <span class="ro-id-text">${id}</span>
                    </label>
                    ${statusHTML}
                </div>`;
            }).join('');

            modalContent.innerHTML = `
                <div style="font-weight: 600; font-size: 0.9em; margin-bottom: 8px; padding-left: 4px;">Match RO IDs for ${specificMerchant.displayName}</div>
                <div class="ro-id-list">${idListHTML}</div>`;
        } else {
             modalContent.innerHTML = "<p>No 'Removal order ID' found in any templates.</p>";
        }

        const checklist = modalContent.querySelector('.ro-id-list');
        if(checklist) {
            checklist.onchange = (e) => {
                if (e.target.classList.contains('ro-match-checkbox-modal')) {
                    const id = e.target.dataset.id;
                    if (e.target.checked) {
                        matchedRoIds.set(id, 'manual');
                    } else {
                        matchedRoIds.delete(id);
                    }
                    saveMatchedRoIds();
                    updateCaseCardMatchStatus();
                }
            };
        }
    }

    function openGlobalRoChecklistModal(specificMerchant = null) {
        parseNotesForCaseMode();
        const modal = document.getElementById('caseModeActionModal');
        const modalTitle = document.getElementById('caseModeActionModalTitle');
        const modalBody = document.getElementById('caseModeActionModalBody');
        const dataSource = specificMerchant ? [specificMerchant] : caseModeData;
        
        const regex = /Removal order ID:\s*(\S+)/g;
        const allUniqueIds = [...new Set(dataSource.flatMap(m => m.cases.flatMap(c => [...c.text.matchAll(regex)].map(match => match[1]))))];
        
        modalTitle.innerHTML = `<i class="fa-solid fa-list-check"></i> Match RO IDs` + (specificMerchant ? ` for ${specificMerchant.displayName}` : '');

        if (allUniqueIds.length > 0) {
            const idListHTML = allUniqueIds.sort().map((id, index) => {
                const isMatched = matchedRoIds.has(id);
                const matchType = isMatched ? matchedRoIds.get(id) : '';
                const uniqueId = `ro-check-global-${index}`;
                
                let statusHTML = '';
                if(isMatched) {
                    statusHTML = `<span class="ro-id-match-status ${matchType}">${matchType.toUpperCase()} MATCHED</span>`;
                }

                return `
                <div class="ro-id-item">
                    <label class="macos-checkbox-container" for="${uniqueId}" style="flex-grow:1;">
                        <input type="checkbox" id="${uniqueId}" class="macos-checkbox ro-match-checkbox" data-id="${id}" ${isMatched ? 'checked' : ''}>
                        <span class="ro-id-text">${id}</span>
                    </label>
                    ${statusHTML}
                </div>`;
            }).join('');
            
            modalBody.innerHTML = `
                <p style="font-size: 0.9em; color: var(--text-secondary); margin: 0 0 10px;">Manually check/uncheck RO IDs or paste raw data below to auto-match.</p>
                <div class="ro-id-list">${idListHTML}</div>
                 <hr style="border:none; border-top: 1px solid var(--border-subtle); margin: 12px 0;">
                <div class="macos-textfield-container">
                    <textarea id="ro-paste-area" class="macos-textfield" placeholder="Paste raw removal report data here..."></textarea>
                </div>`;
        } else {
             modalBody.innerHTML = "<p>No 'Removal order ID' found in any templates.</p>";
        }

        modal.style.display = 'flex';
        
        const checklist = modalBody.querySelector('.ro-id-list');
        if(checklist) {
            checklist.onchange = (e) => { // Use event delegation
                if (e.target.classList.contains('ro-match-checkbox')) {
                    const id = e.target.dataset.id;
                    if (e.target.checked) {
                        matchedRoIds.set(id, 'manual');
                    } else {
                        matchedRoIds.delete(id);
                    }
                    saveMatchedRoIds();
                    updateCaseCardMatchStatus();
                    
                    openGlobalRoChecklistModal(specificMerchant); // Re-render modal to update status
                }
            };
        }
        
        const pasteArea = modalBody.querySelector('#ro-paste-area');
        if (pasteArea) {
            pasteArea.addEventListener('input', (event) => {
                const pastedText = event.target.value;
                const foundIdsInPaste = new Set(pastedText.split(/[\s,;\t\n]+/).filter(Boolean));
                
                modalBody.querySelectorAll('.ro-match-checkbox').forEach(checkbox => {
                    const id = checkbox.dataset.id;
                    if (foundIdsInPaste.has(id) && !matchedRoIds.has(id)) { // only auto-match if not already matched
                        checkbox.checked = true;
                        matchedRoIds.set(id, 'auto');
                    }
                });
                saveMatchedRoIds();
                updateCaseCardMatchStatus();
                openGlobalRoChecklistModal(specificMerchant); // Re-render modal
            });
        }
    }
    
    function updateMatchedRoIdsFromInput() {
        const roMatchInput = document.getElementById('roMatchInput');
        if (!roMatchInput) return;

        const rawText = roMatchInput.value;
        const idsFromPaste = new Set(rawText.split(/[\s,;\t\n]+/).filter(Boolean));
        let newlyMatchedCount = 0;
        
        idsFromPaste.forEach(id => {
            if (!matchedRoIds.has(id)) {
                 matchedRoIds.set(id, 'auto');
                 newlyMatchedCount++;
            }
        });
        
        saveMatchedRoIds();
        updateCaseCardMatchStatus();
        updateRoMatchCounter();

        if (rawText.trim() && newlyMatchedCount > 0){
             parseNotesForCaseMode();
             const regex = /Removal order ID:\s*(\S+)/g;
             const allTemplateIds = new Set(caseModeData.flatMap(m => m.cases.flatMap(c => [...c.text.matchAll(regex)].map(match => match[1]))));
             const notFoundIds = [...idsFromPaste].filter(id => !allTemplateIds.has(id));
             
             const totalMatched = [...allTemplateIds].filter(id => matchedRoIds.has(id)).length;
             showNotification(`Auto-matched ${newlyMatchedCount} new ROs. Total matched: ${totalMatched} / ${allTemplateIds.size}`, 'success');
        }
    }

    function updateRoMatchCounter() {
        const counter = document.getElementById('roMatchCounter');
        const selectedDiv = document.querySelector('#merchantList .merchant-item.selected');
        if (!counter) return;

        if (!selectedDiv) {
            counter.style.display = 'none';
            return;
        }

        parseNotesForCaseMode();
        const merchant = caseModeData.find(m => m.originalText === selectedDiv.dataset.key);
        if (!merchant) {
            counter.style.display = 'none';
            return;
        }

        const regex = /Removal order ID:\s*(\S+)/g;
        const merchantRoIds = new Set(merchant.cases.flatMap(c => [...c.text.matchAll(regex)].map(match => match[1])));
        const matchedCount = [...merchantRoIds].filter(id => matchedRoIds.has(id)).length;
        
        counter.textContent = `${matchedCount}/${merchantRoIds.size}`;
        counter.style.display = 'inline';
    }

    function updateMerchantStatusDots() {
        parseNotesForCaseMode();
        const regex = /Removal order ID:\s*(\S+)/g;

        document.querySelectorAll('#merchantList .merchant-item').forEach(div => {
            const merchant = caseModeData.find(m => m.originalText === div.dataset.key);
            if (!merchant) return;

            const statusDot = div.querySelector('.status-dot');
            const caseCount = div.querySelector('.case-count');
            const merchantRoIds = new Set(merchant.cases.flatMap(c => [...c.text.matchAll(regex)].map(match => match[1])));

            if (merchantRoIds.size === 0) {
                statusDot.classList.remove('matched');
                if (caseCount) caseCount.classList.remove('matched');
                return;
            }

            const allMatched = [...merchantRoIds].every(id => matchedRoIds.has(id));
            statusDot.classList.toggle('matched', allMatched);
            if (caseCount) caseCount.classList.toggle('matched', allMatched);
        });
    }


    function updateCaseCardMatchStatus() {
        const allCaseCards = document.querySelectorAll(`.case-card`);
        const roIdRegex = /Removal order ID:\s*(\S+)/;

        allCaseCards.forEach(card => {
            const caseItem = findCaseByUID(card.id);
            if (caseItem) {
                const match = caseItem.text.match(roIdRegex);
                const roId = match ? match[1] : null;
                const isMatched = roId && matchedRoIds.has(roId);

                card.classList.toggle('ro-matched', isMatched);

                if (card.classList.contains('unfiled')) {
                    const saveBtn = card.querySelector('.unfiled-controls [data-action="save-case"]');
                    const copyBtn = card.querySelector('.unfiled-controls [data-action="copy-text"]');
                    const caseIdInput = card.querySelector('.unfiled-controls .case-id-input');

                    if (saveBtn) saveBtn.disabled = !isMatched;
                    if (copyBtn) copyBtn.disabled = !isMatched;
                    if (caseIdInput) caseIdInput.disabled = !isMatched;
                }
            }
        });
        updateRoMatchCounter();
        updateMerchantStatusDots();
    }
    
    function updateFileInfo(fileNames = []) {
        const fileInfoBtn = document.getElementById('fileInfoBtn');
        if (!fileInfoBtn) return;
        
        const hasData = fileNames && fileNames.length > 0;

        if (!hasData || fileNames.length <= 1) {
            fileInfoBtn.style.display = 'none';
        } else {
            fileInfoBtn.style.display = 'inline-flex';
            fileInfoBtn.title = `Loaded files:\n${fileNames.join('\n')}`;
        }
    }

    function updateCaseModeStats() {
        let globalFiled = 0, globalTotal = 0;
        caseModeData.forEach(m => {
            const filedCount = m.cases.filter(c => c.filedId !== null).length;
            const totalCount = m.cases.length;
            globalFiled += filedCount;
            globalTotal += totalCount;
            
            const tabBtn = document.querySelector(`.case-mode-tab-button[data-tab-id="${m.id}"]`);
            if(tabBtn) {
                const metaSpan = tabBtn.querySelector('.case-mode-tab-meta');
                if (metaSpan) {
                    metaSpan.textContent = m.isAccountIssue ? 'ISSUE' : `${filedCount}/${totalCount}`;
                }
                tabBtn.classList.toggle('done', (filedCount === totalCount && totalCount > 0) || m.isCompleted);
            }

            const contentEl = document.getElementById(`case-content-${m.id}`);
            if (contentEl) {
                const copyBtn = contentEl.querySelector('[data-action="copy-merchant-ids"]');
                if(copyBtn) {
                    copyBtn.innerHTML = `<i class="fa-solid fa-copy"></i>Copy ${filedCount} ID(s)`;
                    copyBtn.disabled = filedCount === 0;
                }
            }
        });

        document.getElementById('caseModeGlobalStats').textContent = `Total Filed: ${globalFiled} / ${globalTotal}`;
        const copyAllBtn = document.getElementById('copyAllMerchantsBtn');
        
        copyAllBtn.style.display = globalFiled > 0 ? 'inline-flex' : 'none';
    }
    
    function escapeHTML(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }
    
    function copyAllMerchantsWithIds() {
        const activeTabContent = document.querySelector('.case-mode-tab-content.active');
        const exclude = activeTabContent?.querySelector('.exclude-non-numeric-local')?.checked || true;

        const merchantsWithFiledCases = caseModeData.filter(m => m.cases.some(c => c.filedId !== null && (!exclude || /^\d+$/.test(c.filedId))));
        if (merchantsWithFiledCases.length === 0) {
            showNotification('No matching IDs to copy.', 'info');
            return;
        }

        const output = merchantsWithFiledCases.map(merchant => {
            const ids = merchant.cases
                .map(c => c.filedId)
                .filter(id => id !== null && (!exclude || /^\d+$/.test(id)))
                .join('\n');
            return ids ? `${merchant.displayName}\n${ids}` : null;
        }).filter(Boolean).join('\n\n');

        if (output) {
            navigator.clipboard.writeText(output);
            showNotification(`Copied IDs for ${merchantsWithFiledCases.length} merchants!`, 'success');
        }
    }

    function syncExcludeCheckboxes(source) {
       // This function is no longer needed as the global checkbox was removed.
    }

    function applyCaseCardLayout() {
        const isRight = appSettings.caseTextPosition === 'right';
        const isReversed = appSettings.caseCardLayout === 'reversed';
        document.querySelectorAll('.case-card .card-content').forEach(el => {
            el.classList.toggle('layout-right', isRight);
        });

        document.querySelectorAll('.case-card .unfiled-controls').forEach(container => {
            const inputGroup = container.querySelector('.case-id-input-group');
            const separator = container.querySelector('hr');
            const copyTemplateBtn = container.querySelector('[data-action="copy-text"]');
            const copyTitleBtn = container.querySelector('[data-action="copy-case-title"]');

            if (isReversed) {
                container.appendChild(copyTemplateBtn);
                container.appendChild(copyTitleBtn);
                container.appendChild(separator);
                container.appendChild(inputGroup);
            } else {
                container.appendChild(inputGroup);
                container.appendChild(separator);
                container.appendChild(copyTemplateBtn);
                container.appendChild(copyTitleBtn);
            }
        });

        const icon = document.getElementById('btnToggleFilerLayout')?.querySelector('i');
        if (icon) {
            icon.className = `fa-solid fa-align-${isRight ? 'right' : 'left'}`;
        }
    }
    
    function applyCopyTitleButtonVisibility() {
        document.getElementById('caseModeWrapper')?.classList.toggle('show-copy-title', appSettings.showCopyTitleBtn);
    }
    
    function setTabLayout(layout) {
        appSettings.tabLayout = layout;
        if (!document.body.classList.contains('is-standalone-mode')) {
             saveSettings();
        } else {
             applyTabLayout();
        }
    }

    function applyTabLayout() {
        const wrapper = document.getElementById('caseModeWrapper');
        if (!wrapper) return;
        const layout = appSettings.tabLayout || 'wrap';
        wrapper.classList.remove('tab-layout-wrap', 'tab-layout-h-scroll');
        wrapper.classList.add(`tab-layout-${layout.startsWith('h') ? 'h-scroll' : 'wrap'}`);

        // Update active state of toggle buttons in standalone mode
        document.getElementById('btnTabLayoutWrap')?.classList.toggle('active', layout === 'wrap');
        document.getElementById('btnTabLayoutHScroll')?.classList.toggle('active', layout === 'h-scroll');
    }

    function toggleFilerLayout() {
        appSettings.caseTextPosition = appSettings.caseTextPosition === 'left' ? 'right' : 'left';
        applyCaseCardLayout();
        saveFilerViewState();
    }

    function toggleCardLayout() {
        appSettings.caseCardLayout = appSettings.caseCardLayout === 'default' ? 'reversed' : 'default';
        document.getElementById('btnToggleCardLayout').classList.toggle('active', appSettings.caseCardLayout === 'reversed');
        renderCaseModeUI(); // Re-render to apply the new layout structure
        saveFilerViewState();
    }

    function toggleAutoSave() {
        appSettings.autoSaveOnPaste = !appSettings.autoSaveOnPaste;
        document.getElementById('btnToggleAutoSave').classList.toggle('active', appSettings.autoSaveOnPaste);
        showNotification(`Auto-save on paste ${appSettings.autoSaveOnPaste ? 'enabled' : 'disabled'}.`, 'info');
        saveFilerViewState();
    }
    
    function toggleCopyTitleVisibility() {
        appSettings.showCopyTitleBtn = !appSettings.showCopyTitleBtn;
        applyCopyTitleButtonVisibility();
        document.getElementById('btnToggleCopyTitle').classList.toggle('active', appSettings.showCopyTitleBtn);
        saveFilerViewState();
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        // Check for standalone "Filer Mode" first
        if (typeof standalonePayload !== 'undefined') {
             initStandaloneMode(standalonePayload);
        } else {
            // Normal tool initialization
            loadSettings();
            loadMatchedRoIds();
            autoClearOldHistory();
            const noteArea = document.getElementById('noteArea');

            const savedState = JSON.parse(localStorage.getItem(caseModeStateKey));
            if (savedState && savedState.fileContent) {
                noteArea.value = savedState.fileContent;
            }
            
            noteHistory = [noteArea.value];
            noteHistoryIndex = 0;
            updateNoteUndoRedoButtons();
            
            noteArea.addEventListener('input', () => {
                clearTimeout(noteChangeTimeout);
                noteChangeTimeout = setTimeout(() => {
                    // When notes change, re-parse data BEFORE re-rendering the list
                    parseNotesForCaseMode(); 
                    countTemplatesNoteTaker();
                    recordNoteChange();
                }, 500);
            });
            noteArea.addEventListener('paste', () => { setTimeout(()=>{recordNoteChange(); countTemplatesNoteTaker();}, 50); });
            noteArea.addEventListener('scroll', saveNotesToLocalStorage);
            
            const shipmentInput = document.getElementById('shipmentInput');
            if (shipmentInput) {
                 let parseTimer;
                 let lastValue = shipmentInput.value;
                 const triggerParse = () => { clearTimeout(parseTimer); parseTimer = setTimeout(parseShipmentData, 300); };

                 shipmentInput.addEventListener('input', triggerParse);
                 shipmentInput.addEventListener('change', triggerParse);
                 shipmentInput.addEventListener('paste', () => { setTimeout(parseShipmentData, 350); });
                 shipmentInput.addEventListener('focus', () => {
                     // Check if value changed while input was not focused (e.g., via extension)
                     if (shipmentInput.value !== lastValue && shipmentInput.value.trim()) {
                         lastValue = shipmentInput.value;
                         triggerParse();
                     }
                 });
                 shipmentInput.addEventListener('blur', () => {
                     lastValue = shipmentInput.value;
                 });
                 shipmentInput.addEventListener('scroll', saveShipmentInputScroll);

                 // Check if extension pre-filled the input on page load
                 setTimeout(() => {
                     if (shipmentInput.value.trim() && shipmentInput.value !== lastValue) {
                         lastValue = shipmentInput.value;
                         triggerParse();
                     }
                 }, 500);

                 // Monitor hidden extension paste target and copy to shipmentInput
                 const extensionPasteTarget = document.getElementById('extensionPasteTarget');
                 if (extensionPasteTarget) {
                     // Monitor for input events (when extension pastes)
                     extensionPasteTarget.addEventListener('input', () => {
                         if (extensionPasteTarget.value.trim()) {
                             shipmentInput.value = extensionPasteTarget.value;
                             lastValue = shipmentInput.value;
                             extensionPasteTarget.value = ''; // Clear the hidden target
                             triggerParse();
                         }
                     });

                     // Also use MutationObserver as backup
                     const observer = new MutationObserver(() => {
                         if (extensionPasteTarget.value.trim()) {
                             shipmentInput.value = extensionPasteTarget.value;
                             lastValue = shipmentInput.value;
                             extensionPasteTarget.value = '';
                             triggerParse();
                         }
                     });
                     observer.observe(extensionPasteTarget, {
                         attributes: true,
                         childList: true,
                         characterData: true,
                         subtree: true
                     });

                     // Poll for changes as another fallback
                     setInterval(() => {
                         if (extensionPasteTarget.value.trim()) {
                             shipmentInput.value = extensionPasteTarget.value;
                             lastValue = shipmentInput.value;
                             extensionPasteTarget.value = '';
                             triggerParse();
                         }
                     }, 200);
                 }
            }
            const upsUspsOutputArea = document.getElementById('upsUspsOutputArea');
            if(upsUspsOutputArea) {
                const saved = localStorage.getItem(upsUspsOutputKey); if (saved) upsUspsOutputArea.value = saved;
                upsUspsOutputArea.addEventListener('scroll', saveUpsUspsOutputToLocalStorage);
            }
            const roMatchInput = document.getElementById('roMatchInput');
            if (roMatchInput) {
                roMatchInput.value = localStorage.getItem(roMatchDataKey) || '';
                let roMatchTimer;
                roMatchInput.addEventListener('input', () => {
                    clearTimeout(roMatchTimer);
                    roMatchTimer = setTimeout(() => {
                        updateMatchedRoIdsFromInput();
                        saveRoMatchInput();
                    }, 300);
                });
                updateMatchedRoIdsFromInput(); // Initial match on load
            }
            try { const savedCtx = localStorage.getItem(upsUspsContextKey); if (savedCtx) tempUpsUspsData = JSON.parse(savedCtx) || {}; }
            catch (e) { tempUpsUspsData = {}; }
            restoreScrollPositions();
            countTemplatesNoteTaker();
            
            const parserTool = document.getElementById('parserTool');
            const parserToggleBtn = document.getElementById('parserToggle');
            const savedParserState = localStorage.getItem(parserStateKey);
            if (savedParserState === 'hidden') {
                parserTool.classList.add('is-hidden');
                parserToggleBtn.querySelector('i').className = 'fa-solid fa-eye';
            }
            parserToggleBtn.addEventListener('click', () => {
                const isHidden = parserTool.classList.toggle('is-hidden');
                parserToggleBtn.querySelector('i').className = `fa-solid fa-eye${isHidden ? '' : '-slash'}`;
                appSettings.showParser = !isHidden;
                saveSettings();
            });

            document.getElementById('btnUndoNote').addEventListener('click', handleNoteUndo);
            document.getElementById('btnRedoNote').addEventListener('click', handleNoteRedo);
            document.getElementById('btnViewRoIdsMain')?.addEventListener('click', (e) => {
                e.stopPropagation();
                parseNotesForCaseMode();
                const selectedDiv = document.querySelector('#merchantList .merchant-item.selected');
                if (selectedDiv) {
                    const merchant = caseModeData.find(m => m.originalText === selectedDiv.dataset.key);
                    if (merchant) {
                        populateRoIdsModal(merchant);
                        document.getElementById('roIdsModal').style.display = 'flex';
                    }
                }
            });

            document.getElementById('btnCloseRoIdsModal')?.addEventListener('click', () => {
                document.getElementById('roIdsModal').style.display = 'none';
            });
            document.getElementById('btnClearRoInput')?.addEventListener('click', () => {
                const roInput = document.getElementById('roMatchInput');
                roInput.value = '';
                saveRoMatchInput();
                updateMatchedRoIdsFromInput();
            });

            document.getElementById('btnPrefix3C').addEventListener('click', () => setPrefix('3C'));
            document.getElementById('btnPrefixLS').addEventListener('click', () => setPrefix('LS'));

            // Settings dropdown
            document.getElementById('btnOpenSettings')?.addEventListener('click', openSettingsDropdown);

            // Auto-save settings on input change
            document.getElementById('settingsAmzlCarriers')?.addEventListener('blur', () => {
                appSettings.amzlTypeCarriers = document.getElementById('settingsAmzlCarriers').value.trim().split(',').map(s => s.trim()).filter(Boolean);
                saveSettings();
                initializeRegexPatterns();
            });

            document.getElementById('settingsOtherCarriers')?.addEventListener('blur', () => {
                appSettings.otherCarriers = document.getElementById('settingsOtherCarriers').value.trim().split(',').map(s => s.trim()).filter(Boolean);
                saveSettings();
                initializeRegexPatterns();
            });

            document.getElementById('settingsUpsUspsToggle')?.addEventListener('change', () => {
                appSettings.upsUspsMode = document.getElementById('settingsUpsUspsToggle').checked;
                const upsUspsContainer = document.getElementById('upsUspsOutputContainer');
                if (upsUspsContainer) {
                    upsUspsContainer.style.display = appSettings.upsUspsMode ? 'block' : 'none';
                }
                saveSettings();
            });

            document.getElementById('settingsAutoClearHistoryToggleInput')?.addEventListener('change', () => {
                appSettings.autoClearHistory = document.getElementById('settingsAutoClearHistoryToggleInput').checked;
                saveSettings();
            });

            document.getElementById('settingsDefaultFileTypeToggle')?.addEventListener('change', () => {
                appSettings.defaultFileType = document.getElementById('settingsDefaultFileTypeToggle').checked ? 'html' : 'txt';
                saveSettings();
            });

            // Theme toggle button
            document.getElementById('btnThemeToggle')?.addEventListener('click', () => {
                appSettings.theme = appSettings.theme === 'dark' ? 'light' : 'dark';
                applyTheme(appSettings.theme);
                saveSettings();
                updateThemeToggleIcon();
            });

            // History button - render history when opening dropdown
            document.getElementById('btnOpenHistory')?.addEventListener('click', renderHistoryModal);

            document.getElementById('btnClearSelected')?.addEventListener('click', clearSelectedMerchants);
            document.getElementById('caseModeToggleGroup')?.addEventListener('click', toggleCaseMode);
            
            const btnSelectAll = document.getElementById('btnSelectAll');
            if (btnSelectAll) {
                btnSelectAll.addEventListener('click', () => {
                    const allVisibleCheckboxes = Array.from(document.querySelectorAll('#merchantList .merchant-item'))
                        .filter(item => item.style.display !== 'none')
                        .map(item => item.querySelector('.macos-checkbox'));
                    
                    const areAllSelected = allVisibleCheckboxes.length > 0 && allVisibleCheckboxes.every(cb => cb.checked);
                    const newCheckedState = !areAllSelected;

                    allVisibleCheckboxes.forEach(cb => {
                        cb.checked = newCheckedState;
                    });
                    updateSelectedCountNoteTaker();
                });
            }

            // Download selected button - uses default file type from settings
            document.getElementById('btnDownloadSelected')?.addEventListener('click', (e) => {
                e.stopPropagation();
                const asHtml = (appSettings.defaultFileType === 'html');
                downloadSelectedMerchants(asHtml);
            });

            document.getElementById('btnSplitSelected')?.addEventListener('click', openSplitModal);
            document.getElementById('btnProcessUpsUsps')?.addEventListener('click', processUpsUspsData);
            document.getElementById('btnAddSeparator')?.addEventListener('click', addSeparator);
            document.getElementById('btnClearAllNotes')?.addEventListener('click', () => document.getElementById('clearAllConfirmModal').style.display = 'flex');
            document.getElementById('cancelClearAllBtn')?.addEventListener('click', () => document.getElementById('clearAllConfirmModal').style.display = 'none');
            document.getElementById('confirmClearAllBtn')?.addEventListener('click', confirmAndClearAllNotes);
            document.getElementById('closeClearSuccessPopupBtn')?.addEventListener('click', () => document.getElementById('clearAllSuccessPopup').style.display = 'none');
            
            document.getElementById('historyList')?.addEventListener('click', e => { if (e.target.closest('.restore-btn')) { restoreHistoryItem(e.target.closest('.restore-btn').dataset.historyId); }});
            document.getElementById('btnClearAllHistory')?.addEventListener('click', openClearHistoryConfirmModal);
            document.getElementById('btnCancelClearHistory')?.addEventListener('click', closeClearHistoryConfirmModal);
            document.getElementById('btnConfirmClearHistory')?.addEventListener('click', handleClearAllHistory);
            document.getElementById('confirmClearHistoryModal')?.addEventListener('click', e => { if (e.target.id === 'confirmClearHistoryModal') closeClearHistoryConfirmModal(); });
            document.getElementById('btnCancelSplit')?.addEventListener('click', closeSplitModal);
            document.getElementById('splitModal')?.addEventListener('click', e => { if (e.target.id === 'splitModal') closeSplitModal(); });
            
            document.getElementById('generateSplitsDropdown').addEventListener('click', e => {
                const action = e.target.closest('button')?.dataset.action;
                if (action === 'download-split-txt') generateAndDownloadSplits(false);
                if (action === 'download-split-html') generateAndDownloadSplits(true);
            });

            document.getElementById('splitOrdersPerTemplate')?.addEventListener('input', updateCalculatedTemplates);
            document.getElementById('splitNumberInput')?.addEventListener('input', updateCalculatedTemplates);

            document.getElementById('merchantSearchInput')?.addEventListener('input', filterMerchants);

            // Initialize UPS/USPS mode from settings
            const upsUspsOutputContainer = document.getElementById('upsUspsOutputContainer');
            if (upsUspsOutputContainer && shipmentInput) {
                upsUspsOutputContainer.style.display = appSettings.upsUspsMode ? 'block' : 'none';
                shipmentInput.placeholder = appSettings.upsUspsMode ? "Paste shipment data for Other Carriers..." : "Paste Amazon removal shipment data here...";
            }
             window.addEventListener('resize', handleAutoLayout);
            window.addEventListener('beforeunload', saveAllScrollPositions);
            initDraggableWindows();
            handleAutoLayout();
            if (localStorage.getItem(caseModeActiveKey) === 'true') {
                toggleCaseMode();
            }

            const newMerchantInput = document.getElementById('newMerchantInput');
            if (newMerchantInput) {
                const handleNewMerchantAdd = (name) => {
                    const newName = name.split('\n')[0].trim(); // Use only the first line
                    if (newName) {
                        addNewMerchant(newName);
                        newMerchantInput.value = '';
                        const dropdown = newMerchantInput.closest('.dropdown-content');
                        if (dropdown) dropdown.classList.remove('show');
                    }
                };
                
                newMerchantInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        handleNewMerchantAdd(newMerchantInput.value);
                    }
                });
                
                newMerchantInput.addEventListener('paste', (e) => {
                    e.preventDefault();
                    const pastedText = (e.clipboardData || window.clipboardData).getData('text');
                    handleNewMerchantAdd(pastedText);
                });
            }

            // RO Match Modal Listeners
            const roMatchModal = document.getElementById('roMatchModal');
            const roMatchModalInput = document.getElementById('roMatchModalInput');
            const autoCloseCheckbox = document.getElementById('autoCloseOnPaste');
            const mainRoInput = document.getElementById('roMatchInput');

            document.getElementById('btnDoneRoMatch')?.addEventListener('click', closeRoMatchModal);
            roMatchModal?.addEventListener('click', (e) => {
                if (e.target === roMatchModal) closeRoMatchModal();
            });

            roMatchModalInput?.addEventListener('input', () => {
                if (mainRoInput) {
                    mainRoInput.value = roMatchModalInput.value;
                    mainRoInput.dispatchEvent(new Event('input', { bubbles: true }));
                }
            });

            roMatchModalInput?.addEventListener('paste', () => {
                setTimeout(() => {
                    if (autoCloseCheckbox?.checked) {
                        closeRoMatchModal();
                    }
                }, 50);
            });
        }

        // --- Common Listeners for both modes ---
        document.getElementById('btnReExportFilerView')?.addEventListener('click', reExportFilerView);
        document.getElementById('btnToggleFilerLayout')?.addEventListener('click', toggleFilerLayout);
        document.getElementById('btnToggleCardLayout')?.addEventListener('click', toggleCardLayout);
        document.getElementById('btnToggleAutoSave')?.addEventListener('click', toggleAutoSave);
        document.getElementById('btnToggleCopyTitle')?.addEventListener('click', toggleCopyTitleVisibility);
        document.getElementById('btnTabLayoutWrap')?.addEventListener('click', () => setTabLayout('wrap'));
        document.getElementById('btnTabLayoutHScroll')?.addEventListener('click', () => setTabLayout('h-scroll'));
        document.getElementById('copyAllMerchantsBtn')?.addEventListener('click', copyAllMerchantsWithIds);
        document.getElementById('openUrlBtn').addEventListener('click', openReportUrl);
        document.getElementById('marketplaceSelectUrlGen').addEventListener('change', (e) => {
            appSettings.marketplaceUrlGen = e.target.value;
            saveSettings();
        });

        document.getElementById('closeCaseTextModalBtn')?.addEventListener('click', () => {
            document.getElementById('caseTextModal').style.display = 'none';
        });
        const actionModal = document.getElementById('caseModeActionModal');
        actionModal.addEventListener('click', e => {
            if(e.target === actionModal) { // Only close if clicking on the overlay itself
                 actionModal.style.display = 'none';
                 updateCaseCardMatchStatus();
            }
        });
        actionModal.querySelector('#caseModeActionModalCancelBtn').addEventListener('click', () => {
             actionModal.style.display = 'none';
             updateCaseCardMatchStatus(); // Update UI when modal is closed
        });
        
        // --- UI Preferences Dropdown Auto-saving Logic ---
        const uiPrefsDropdown = document.getElementById('uiPreferencesDropdown');
        if (uiPrefsDropdown) {
             uiPrefsDropdown.addEventListener('change', (e) => {
                const targetId = e.target.id;
                // General
                if(targetId === 'dropdownThemeToggle') {
                    appSettings.theme = e.target.checked ? 'dark' : 'light';
                    applyTheme(appSettings.theme);
                    updateThemeToggleIcon();
                }
                // Audit UI
                if(targetId === 'dropdownShowRoMatchPopupToggle') appSettings.showRoMatchPopup = e.target.checked;
                if(targetId === 'dropdownParserToggle') {
                    appSettings.showParser = e.target.checked;
                    updateParserVisibility();
                }
                if(targetId === 'dropdownCounterPosToggle') {
                    appSettings.counterPosition = e.target.checked ? 'merchants' : 'notes';
                    updateCounterPillLocation();
                }
                // File UI
                if(targetId === 'dropdownAutoSaveOnPasteToggle') appSettings.autoSaveOnPaste = e.target.checked;
                if(targetId === 'dropdownCopyTitleToggle') {
                    appSettings.showCopyTitleBtn = e.target.checked;
                    updateCopyTitleBtnVisibility();
                }
                if(targetId === 'dropdownTextPosToggle') {
                    appSettings.caseTextPosition = e.target.checked ? 'right' : 'left';
                    updateCaseTextPosition();
                }
                if(targetId === 'dropdownCaseCardLayoutToggle') {
                    appSettings.caseCardLayout = e.target.checked ? 'reversed' : 'default';
                    updateCaseCardLayout();
                }
                if(targetId === 'dropdownTabLayoutToggle') {
                    appSettings.tabLayout = e.target.checked ? 'hscroll' : 'wrap';
                    updateTabLayout();
                }
                saveSettings();
             });
        }
        
        document.addEventListener('click', (e) => {
            document.querySelectorAll('.dropdown').forEach(dropdownContainer => {
                const dropdownContent = dropdownContainer.querySelector('.dropdown-content');
                if (dropdownContent && !dropdownContainer.contains(e.target)) {
                    dropdownContent.classList.remove('show');
                }
            });
        });

        document.querySelectorAll('.dropdown > button').forEach(button => {
            button.addEventListener('click', (e) => {
                e.stopPropagation();
                const dropdownContent = button.nextElementSibling;
                if (dropdownContent && dropdownContent.classList.contains('dropdown-content')) {
                    const isShowing = dropdownContent.classList.contains('show');
                    document.querySelectorAll('.dropdown-content').forEach(d => d.classList.remove('show'));
                    if (!isShowing) {
                        dropdownContent.classList.add('show');
                        // Auto-focus logic for New Merchant input
                        if(button.id === 'btnAddNewMerchant') {
                            setTimeout(() => document.getElementById('newMerchantInput')?.focus(), 50);
                        }
                    }
                }
            });
        });
    });
</script>
</body>
</html>





