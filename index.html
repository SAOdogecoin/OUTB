<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <title>Outbound AMZL Tool</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="." />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://rsms.me/">
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
<style>
    :root {
        --system-font: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        --mono-font: 'SF Mono', Consolas, 'Courier New', Courier, monospace;
        --bg-primary: #fafafa;
        --bg-window: #FFFFFF;
        --bg-toolbar: #fafafa; 
        --bg-input: #FFFFFF;
        --bg-hover: rgba(0, 0, 0, 0.05);
        --text-primary: #1d1d1f;
        --text-secondary: #6e6e73;
        --text-placeholder: #aaaaaf;
        --border-color: #C6C6C6;
        --border-subtle: #E0E0E0;
        --accent-blue: #007AFF;
        --accent-blue-dark: #006ADC;
        --accent-red: #ff3b30;
        --accent-red-hover: #ff453a;
        --accent-green: #34c759;
        --accent-orange: #ff9500;
        --highlight-bg: #B4D7FF; 
        --highlight-text: #000000; 
        --top-bar-height: 50px;
        color-scheme: light;
    }

    html[data-theme="dark"] {
        --bg-primary: #1c1c1e;
        --bg-window: #2c2c2e;
        --bg-toolbar: #1c1c1e; 
        --bg-input: #3a3a3c;
        --bg-hover: rgba(255, 255, 255, 0.1);
        --text-primary: #f2f2f7;
        --text-secondary: #9a9a9e;
        --text-placeholder: #8e8e93;
        --border-color: #545458;
        --border-subtle: #424245;
        --accent-blue: #0A84FF; 
        --accent-blue-dark: #007AFF;
        --accent-red: #ff453a;
        --accent-red-hover: #ff3b30;
        --accent-green: #30d158;
        --accent-orange: #ff9f0a;
        --highlight-bg: #0052A3; 
        --highlight-text: #FFFFFF; 
        color-scheme: dark;
    }

    html { box-sizing: border-box; background-color: var(--bg-primary); }
    *, *:before, *:after { box-sizing: inherit; }
    body {
        font-family: var(--system-font);
        background-color: var(--bg-primary);
        color: var(--text-primary);
        margin: 0; padding: 0; display: flex; flex-direction: column;
        height: 100vh; max-height: 100vh; overflow: hidden;
        -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
        font-size: 13px;
        transition: background-color 0.2s ease, color 0.2s ease;
    }
    body.is-resizing { user-select: none; }
    body.is-standalone-mode #mainWrapper { display: none; }
    body.is-standalone-mode .non-standalone { display: none !important; }

    .top-bar {
        background-color: var(--bg-toolbar);
        padding: 0 16px;
        min-height: var(--top-bar-height);
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-shrink: 0;
        gap: 16px;
        position: sticky; top: 0; z-index: 1001;
        border-bottom: 1px solid var(--border-subtle);
    }
    .top-bar-title {
        font-size: 1.4em;
        font-weight: 700;
        color: var(--text-primary);
        margin-right: auto;
        white-space: nowrap;
    }
    .toolbar-right { display: flex; align-items: center; gap: 16px; flex-wrap: nowrap; }
    .toolbar-icon-group, .url-generator-group {
        display: flex;
        align-items: center;
        border: none;
        border-radius: 50px;
        padding: 4px;
        background-color: var(--bg-window);
        box-shadow: 0 1px 4px rgba(0,0,0,0.07);
        gap: 4px;
    }
    html[data-theme="dark"] .toolbar-icon-group,
    html[data-theme="dark"] .url-generator-group {
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    #marketplaceSelectUrlGen {
        all: unset;
        font-family: var(--system-font);
        font-size: 13px;
        font-weight: 500;
        color: var(--text-primary);
        padding: 0 12px 0 6px;
        height: 30px;
        cursor: pointer;
        border-radius: 15px;
        transition: background-color 0.15s ease;
        -moz-appearance: none;
        -webkit-appearance: none;
        appearance: none;
    }

    #marketplaceSelectUrlGen:hover {
        background-color: var(--bg-hover);
    }
    
    #prefixToggleGroup .macos-icon-button {
        font-weight: 600;
        font-size: 12px;
        padding: 0 10px;
    }

    .main-wrapper {
        display: flex; flex-direction: column; flex-grow: 1; padding: 16px; gap: 16px;
        width: 100%; max-width: 1600px; margin: 0 auto; overflow-y: auto;
    }
    .left-column-wrapper { display: flex; flex-direction: column; gap: 16px; }

    .tool-container {
        background-color: var(--bg-window);
        border-radius: 24px;
        box-shadow: none;
        padding: 20px 20px 25px 20px;
        display: flex; flex-direction: column;
        position: relative;
        border: none;
        overflow: hidden;
        resize: none;
        min-height: 200px;
        transition: min-height 0.3s ease;
    }
    .parser-tool.is-hidden { min-height: 50px; padding-bottom: 20px;}
    .parser-tool .parser-content {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        overflow: hidden;
        transition: opacity 0.3s ease, max-height 0.3s ease;
        opacity: 1;
        max-height: 1000px;
    }
    .parser-tool.is-hidden .parser-content {
        opacity: 0;
        max-height: 0;
        pointer-events: none;
    }

    .merchant-actions-tool, .note-taker-tool { padding-bottom: 25px; }

    .tool-card-title-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: -5px 0 10px 0;
        flex-shrink: 0;
    }
    .tool-card-title {
        display: flex;
        align-items: center;
        font-size: 1.1em; font-weight: 600; color: var(--text-primary);
        margin: 0;
    }
    .tool-card-title > i.fa-solid { margin-right: 8px; font-size: 0.9em; }
    
    .main-wrapper.layout-side-by-side { flex-direction: row; padding: 24px; gap: 24px; align-items: stretch; overflow: hidden; }
    .main-wrapper.layout-side-by-side .left-column-wrapper {
        width: 480px;
        flex-shrink: 0;
        gap: 0;
        display: flex;
        flex-direction: column;
        background-color: var(--bg-window);
        border-radius: 24px;
        padding: 20px;
        position: relative;
        overflow-y: auto;
    }
    .main-wrapper.layout-side-by-side .note-taker-tool {
        flex-grow: 1;
        width: auto;
        display: flex;
        flex-direction: column;
    }
    .main-wrapper.layout-side-by-side .left-column-wrapper .tool-container {
        background-color: transparent; border-radius: 0; padding: 0;
        min-height: unset; overflow: visible; flex-grow: 1;
    }
    .main-wrapper.layout-side-by-side .left-column-wrapper .parser-tool {
        padding-bottom: 20px !important; margin-bottom: 20px;
        border-bottom: 1px solid var(--border-subtle); flex-grow: 0;
    }
    .main-wrapper.layout-side-by-side .left-column-wrapper .merchant-actions-tool {
        padding-bottom: 0 !important;
    }
    .main-wrapper.layout-side-by-side .merchant-actions-tool .resize-handle {
        display: none;
    }

    .main-wrapper.layout-stacked .top-bar { flex-wrap: nowrap; overflow-x: auto; }
    .main-wrapper.layout-stacked .top-bar .toolbar-right { gap: 8px; }

    button.macos {
        font-family: var(--system-font); font-weight: 500; cursor: pointer;
        border: none; transition: all 0.15s ease; font-size: 13px;
        padding: 4px 14px; border-radius: 8px;
        display: inline-flex; align-items: center; justify-content: center;
    }
    button.macos > i { margin-right: 6px; font-size: 0.9em; }
    
    button.macos.primary { background-image: linear-gradient(to bottom, var(--accent-blue), var(--accent-blue-dark)); color: white; box-shadow: 0 0.5px 1px rgba(0,0,0,0.1); }
    button.macos.primary:hover { filter: brightness(1.1); }
    button.macos.primary:active { filter: brightness(0.9); box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.15); }
    button.macos.primary:disabled { background-image: none; background-color: var(--border-color); color: var(--text-secondary); filter: none; cursor: not-allowed; box-shadow: none; }
    
    button.macos.secondary { background-color: var(--bg-input); border: 0.5px solid var(--border-color); box-shadow: 0 0.5px 1px rgba(0, 0, 0, 0.08); color: var(--text-primary); }
    button.macos.secondary:active { background-color: var(--bg-hover); }
    button.macos.secondary:disabled { background-color: var(--bg-input); color: var(--text-placeholder); border-color: var(--border-subtle); }

    button.macos.danger { background-color: var(--accent-red); color: white; box-shadow: 0 0.5px 1px rgba(0,0,0,0.1); }
    button.macos.danger:hover { background-color: var(--accent-red-hover); }
    button.macos.success { background-color: var(--accent-green); color: white; }
    button.macos.warning { background-color: var(--accent-orange); color: white; }


    .macos-icon-button {
        background: transparent; border: none; cursor: pointer;
        width: 30px; height: 30px; border-radius: 50%;
        display: inline-flex; align-items: center; justify-content: center;
        color: var(--text-secondary); transition: all 0.15s ease;
    }
    .macos-icon-button:hover:not(:disabled) { background-color: var(--bg-hover); color: var(--text-primary); }
    .macos-icon-button.active { background-color: var(--accent-blue); color: white; }
    .macos-icon-button.success { background-color: var(--accent-green); color: white; }
    .macos-icon-button.success:hover:not(:disabled) { filter: brightness(1.1); }
    .macos-icon-button:disabled { color: var(--text-placeholder); background: transparent; cursor: not-allowed; }
    .macos-icon-button:disabled:hover { background: transparent; }

    textarea, input[type="text"], input[type="number"], input[type="file"] { all: unset; box-sizing: border-box; }
    .macos-textfield-container {
        width: 100%;
        border-radius: 12px;
        border: 0.5px solid var(--border-color);
        background-color: var(--bg-input);
        transition: all 0.15s ease;
    }
    .macos-textfield-container.fixed-width { width: 50px; margin-left: auto; }
    .macos-textfield-container:focus-within {
        border-color: var(--accent-blue);
        box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent-blue) 30%, transparent);
    }
    .macos-textfield-container input, .macos-textfield-container textarea {
        width: 100%; background-color: transparent; padding: 8px 10px;
        font-size: 14px; color: var(--text-primary);
    }
    textarea.macos-textfield { font-family: var(--mono-font); resize: none; min-height: 100px; }
    
    .macos-switch { position: relative; display: inline-block; width: 44px; height: 26px; flex-shrink: 0; }
    .macos-switch input { opacity: 0; width: 0; height: 0; }
    .macos-switch .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #c7c7cc; transition: background-color .2s; border-radius: 34px; }
    .macos-switch .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 2px; bottom: 2px; background-color: white; transition: transform .2s; border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.15); }
    .macos-switch input:checked + .slider { background-color: var(--accent-blue); } 
    html[data-theme="dark"] .macos-switch input:not(:checked) + .slider { background-color: #555; } 
    .macos-switch input:checked + .slider:before { transform: translateX(18px); }

    .modal-overlay {
        display: none; position: fixed; z-index: 1000; left: 0; top: 0;
        width: 100%; height: 100%; justify-content: center; align-items: flex-start;
        background-color: rgba(0,0,0,0.4);
        padding: 5vh 20px; overflow-y: auto;
    }
    .modal-content {
        background-color: var(--bg-primary); padding: 20px; border-radius: 14px; width: 100%;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; flex-direction: column; gap: 15px;
        margin-bottom: auto;
    }
    #splitModal .modal-content, #settingsModal .modal-content, #telegramSendModal .modal-content, #caseTextModal .modal-content, #caseModeActionModal .modal-content, #pasteTextModal .modal-content {max-width: 520px;}
    #preSendConfirmModal .modal-content { max-width: 600px; }
    #historyModal .modal-content { max-width: 800px; }
    #clearAllConfirmModal .modal-content, #clearAllSuccessPopup .modal-content, #confirmDeleteSentModal .modal-content, #confirmClearHistoryModal .modal-content { max-width: 400px; text-align: center;}
    .modal-content h2 {
        margin: 0 0 8px 0; font-size: 1.15em; font-weight: 600;
        border-bottom: 1px solid var(--border-subtle); padding-bottom: 10px; display:flex; align-items:center;
    }
    #clearAllConfirmModal .modal-content h2, #clearAllSuccessPopup .modal-content h2, #confirmDeleteSentModal .modal-content h2, #confirmClearHistoryModal .modal-content h2 { justify-content: center; }
    #clearAllConfirmModal p, #clearAllSuccessPopup p, #confirmDeleteSentModal p, #confirmClearHistoryModal p { margin: 10px 0 20px; font-size: 1.05em;}
    .modal-actions { display: flex; gap: 10px; margin-top: 10px; justify-content: flex-end; }
    #clearAllConfirmModal .modal-actions, #confirmDeleteSentModal .modal-actions, #confirmClearHistoryModal .modal-actions { justify-content: center; }
    .modal-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 1rem; gap: 0.5rem; }
    .modal-footer .right-actions { display: flex; gap: 0.5rem; }
    
    .notification-popup {
        display: none; position: fixed; top: 20px; left: 50%;
        transform: translateX(-50%) scale(0.9);
        color: white; padding: 10px 20px; border-radius: 20px;
        font-size: 1.1em; font-weight: 600; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 2000; opacity: 0;
        transition: opacity 0.3s ease, top 0.3s ease, transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
    }
    .notification-popup.success { background-color: color-mix(in srgb, var(--accent-green) 85%, #000000 15%); }
    .notification-popup.error { background-color: color-mix(in srgb, var(--accent-red) 85%, #000000 15%); }
    .notification-popup.info { background-color: color-mix(in srgb, var(--accent-blue) 85%, #000000 15%); }

    .notification-popup.show {
        display: block; opacity: 1; top: 30px; transform: translateX(-50%) scale(1);
    }

    .left-column-wrapper, #merchantList, #noteArea, #historyList, #preSendFileList, #caseModeTabContainer { scrollbar-width: thin; scrollbar-color: #c0c0c0 transparent; }
    .left-column-wrapper::-webkit-scrollbar, #merchantList::-webkit-scrollbar, #noteArea::-webkit-scrollbar, #historyList::-webkit-scrollbar, #preSendFileList::-webkit-scrollbar, #caseModeTabContainer::-webkit-scrollbar { width: 9px; }
    .left-column-wrapper::-webkit-scrollbar-thumb, #merchantList::-webkit-scrollbar-thumb, #noteArea::-webkit-scrollbar-thumb, #historyList::-webkit-scrollbar-thumb, #preSendFileList::-webkit-scrollbar-thumb, #caseModeTabContainer::-webkit-scrollbar-thumb { background-color: #cccccc; border-radius: 5px; border: 2px solid transparent; background-clip: content-box; }
    #caseModeTabContainer::-webkit-scrollbar { height: 9px; }


    #merchantList {
        min-height: 100px; max-height: 70vh; overflow-y: auto; overflow-x: hidden; 
        margin-top: 16px; padding: 0; border: none;
        display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 8px; background-color: transparent; flex-grow: 1;
        align-content: start; max-width: 100%; 
    }
    .merchant-item {
        padding: 8px 12px; background-color: var(--bg-window);
        border-radius: 12px;
        border: 1px solid var(--border-subtle); display: flex; align-items: center;
        transition: all 0.2s ease; cursor: pointer; min-width: 0; 
    }
    .merchant-item:hover { background-color: var(--bg-hover); }
    .merchant-item.selected { background-color: var(--accent-blue); border-color: var(--accent-blue-dark); color: white; }
    .merchant-item [contenteditable] { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 1; min-width: 50px;}
    
    .merchant-item .case-count {
        font-size: 11px; font-weight: 600; color: var(--text-secondary);
        background-color: var(--bg-primary); padding: 3px 8px;
        border-radius: 10px; margin-left: auto; flex-shrink: 0; transition: all 0.2s ease;
    }
    .merchant-item.selected .case-count { background-color: rgba(255,255,255,0.2); color: white; }
    
    .macos-checkbox-container { display: flex; align-items: center; cursor: pointer; gap: 8px; width: auto; }
    .macos-checkbox {
        appearance: none; margin: 0; width: 15px; height: 15px; border-radius: 4px;
        display: flex; align-items: center; justify-content: center;
        background-color: var(--bg-input); border: 0.5px solid var(--border-color); flex-shrink: 0;
    }
    .macos-checkbox:checked { background-color: var(--accent-blue); border-color: var(--accent-blue-dark); }
    .macos-checkbox:checked::after { content: '✔'; color: white; font-size: 11px; font-weight: bold; }
    .merchant-item.selected .macos-checkbox { background-color: #fff; border-color: transparent; }
    .merchant-item.selected .macos-checkbox:checked::after { color: var(--accent-blue); }

    .counter-pill {
        display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 15px;
        padding: 5px 10px; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--bg-input);
    }
    .counter-pill p { margin:0; display:flex; align-items:center; gap: 5px;}
    .counter-pill p > i { color: var(--text-secondary); }

    .resize-handle {
        position: absolute; bottom: 0; left: 0; right: 0;
        height: 25px; cursor: ns-resize; z-index: 10;
        overflow: hidden;
    }
    .resize-handle::before, .resize-handle::after {
        content: ""; position: absolute;
        border-bottom: 2px solid var(--text-placeholder);
        opacity: 0.7;
        transition: border-color 0.2s ease;
        transform: rotate(-45deg);
        transform-origin: bottom right;
    }
    .resize-handle:hover::before, .resize-handle:hover::after { border-color: var(--text-primary); }
    .resize-handle::before { width: 14px; right: 4px; bottom: 8px; }
    .resize-handle::after { width: 8px; right: 6px; bottom: 13px; }

    textarea::selection { background-color: var(--highlight-bg); color: var(--highlight-text); }
    .parser-tool .macos-textfield-container {
        flex-grow: 1;
        min-height: 0;
    }
    .note-taker-tool .macos-textfield-container, #merchantList {
        flex-grow: 1;
        min-height: 0;
    }
    #shipmentInput, #upsUspsOutputArea, #noteArea, #paste-textarea { height: 100%; }
    .parser-controls label.parser-control-row { display: flex; align-items: center; gap: 8px; width: 100%; cursor: pointer; }
    .controls-and-stats { margin-top: 16px; } 
    .controls-and-stats > div { display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap; }
    #merchantCounterTarget { display: none; } 
    .tool-card-title-bar #merchantCounterTarget { margin-top: 0; display: flex; }

    .settings-group { margin-bottom: 8px; }
    .settings-category h4 { 
        margin: 18px 0 10px 0; 
        font-size: 0.9em; 
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-secondary);
        padding-bottom: 5px;
        border-bottom: 1px solid var(--border-subtle);
    }
    .settings-category:first-of-type h4 { margin-top: 0; }
    .settings-group label { display: block; margin-bottom: 5px; font-weight: 500;}
    .settings-group.inline { display: flex; justify-content: space-between; align-items: center; }
    .settings-group.inline label:first-child { margin-bottom: 0; }
    .settings-group .radio-group label { display: inline-flex; align-items: center; margin-right: 15px; font-weight: normal; }
    .settings-group .radio-group input[type="radio"] { margin-right: 5px; }
    
    #telegram-merchant-list h4 { margin: 0 0 8px 0; }
    #telegram-merchant-list p { margin: 2px 0 2px 10px; font-size: 0.9em; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    #historyList, #caseModeActionModalBody { max-height: 60vh; overflow-y: auto; margin-top: 10px; }
    .history-item { background-color: var(--bg-input); padding: 10px 15px; border: 1px solid var(--border-subtle); border-radius: 10px; margin-bottom: 10px; }
    .history-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .history-item-date { font-size: 0.9em; color: var(--text-secondary); }
    .history-item-content p { margin: 4px 0; font-size: 0.95em; }
    .history-item-files { margin-top: 8px; font-size: 0.9em; color: var(--text-secondary); font-family: var(--mono-font); }
    
    #preSendFileList { max-height: 40vh; overflow-y: auto; padding: 5px; border: 1px solid var(--border-subtle); border-radius: 8px; background-color: var(--bg-primary); }
    
    /* --- CASE MODE STYLES --- */
    .standalone-only { display: none; }
    body.is-standalone-mode .standalone-only { display: flex; }
    .case-mode-wrapper { width: 100%; max-width: 100%; /* Use full width */ margin: 0 auto; display: flex; flex-direction: column; flex-grow: 1; overflow: hidden; }
    .case-mode-header { z-index: 100; flex-shrink:0; background-color: var(--bg-primary); padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
    .case-mode-title-group { display: flex; align-items: center; gap: 1rem; }
    .case-mode-title { font-size: 1.5rem; font-weight: 700; margin: 0; color: var(--text-primary); }
    #caseModeGlobalStats { font-weight: 600; color: var(--text-secondary); background-color: var(--bg-hover); padding: 6px 12px; border-radius: 8px; font-size: 0.95rem; white-space: nowrap; }
    .case-mode-tab-container { z-index: 100; flex-shrink:0; background-color: var(--bg-primary); display: flex; flex-wrap: wrap; gap: 8px; padding: 0 1.5rem 1.5rem 1.5rem; border-bottom: 1px solid var(--border-subtle); }
    .case-mode-tab-button { display: flex; flex-direction: column; align-items: flex-start; gap: 4px; padding: 6px 10px; background-color: var(--bg-hover); color: var(--text-secondary); border: 1px solid var(--border-subtle); border-radius: 12px; font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: all 0.2s ease; min-width: 180px; }
    .case-mode-tab-button:hover:not(.active) { background-color: color-mix(in srgb, var(--text-secondary) 15%, transparent); color: var(--text-primary); }
    .case-mode-tab-button.active { background-color: var(--accent-blue); color: white; border-color: var(--accent-blue-dark); font-weight: 600; }
    .case-mode-tab-button.done { background-color: color-mix(in srgb, var(--accent-green) 10%, var(--bg-primary)); color: color-mix(in srgb, var(--accent-green) 85%, #000); border: 1px solid color-mix(in srgb, var(--accent-green) 30%, transparent); }
    .case-mode-tab-button.done.active { background-color: var(--accent-green); color: white; border-color: color-mix(in srgb, var(--accent-green) 85%, black); }
    html[data-theme="dark"] .case-mode-tab-button.done:not(.active) { color: var(--accent-green); }
    .case-mode-tab-button.active .case-mode-tab-meta, .case-mode-tab-button.active .copy-merchant-btn, .case-mode-tab-button.active .tab-action-btn { background-color: rgba(255,255,255,0.2); color: white; }
    .case-mode-tab-button.active .copy-merchant-btn:hover { background-color: rgba(255,255,255,0.3); }

    .case-mode-merchant-name { flex-grow: 1; max-width: 250px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: left; width: 100%; margin-bottom: 4px; font-weight: 600; }
    .case-mode-tab-bottom-row { display: flex; width: 100%; align-items: center; }
    .copy-merchant-btn { all: unset; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; border-radius: 50%; color: var(--text-secondary); cursor: pointer; transition: all 0.2s ease; flex-shrink: 0; }
    .copy-merchant-btn:hover { background-color: var(--bg-hover); color: var(--text-primary); }
    .case-mode-tab-meta { font-weight: 600; background-color: var(--bg-window); padding: 4px 10px; border-radius: 8px; margin: 0 auto 0 8px;}
    
    .case-mode-tab-button .tab-action-btn {
        background: var(--bg-window); border: none; color: var(--text-secondary); width: 22px; height: 22px;
        border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;
        font-size: 11px; flex-shrink: 0; transition: all 0.2s ease;
    }
    .case-mode-tab-button .delete-merchant-btn:hover { background-color: var(--accent-red); color: white; }
    .case-mode-tab-button .toggle-complete-btn:hover { background-color: var(--accent-green); color: white; }
    
    .card-content.layout-right {
        flex-direction: row-reverse;
    }
    
    #caseModeTabContents { flex-grow: 1; overflow-y: auto; padding: 0 1.5rem; }
    .case-mode-tab-content { display: none; }
    .case-mode-tab-content.active { display: block; }
    .case-mode-tab-content-header { position: sticky; top: 0; z-index: 99; background-color: var(--bg-primary); padding: 1rem 0; display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem; border-bottom: 1px solid var(--border-subtle); }
    .tab-actions-left, .tab-actions-right { display: flex; gap: 8px; flex-wrap: wrap; align-items: center;}
    .case-card { background-color: var(--bg-window); border-radius: 12px; margin-bottom: 1rem; overflow: hidden; transition: all 0.2s ease-in-out; box-shadow: 0 1px 2px rgba(0,0,0,0.05); border: 1px solid var(--border-subtle); }
    .case-card.editing { border-color: var(--accent-orange); }
    .card-content { display: flex; gap: 1rem; padding: 10px 16px; align-items: stretch; }
    .case-card:not(.unfiled) .card-content { align-items: center; }
    .left-pane { flex-grow: 1; display: flex; gap: 1rem; align-items: flex-start; }
    .case-card:not(.unfiled) .left-pane { align-items: center; }
    .case-number { font-size: 1.1rem; font-weight: 600; color: var(--text-secondary); width: 30px; text-align: center; flex-shrink: 0; padding-top: 4px; }
    .case-card:not(.unfiled) .case-number { padding-top: 0; }
    .ro-match-indicator {
        display: none;
        margin-left: -12px;
        margin-right: 4px;
        font-size: 1.1em;
        color: var(--accent-green);
    }
    .case-card.ro-matched .ro-match-indicator { display: inline-block; }
    .main-content { flex-grow: 1; }
    .case-text { white-space: pre-wrap; font-family: var(--mono-font); max-height: 150px; overflow-y: auto; font-size: 0.85rem; background: var(--bg-primary); padding: 8px; border-radius: 8px; }
    .filed-info { display: none; }
    .case-id-display { font-weight: 600; font-family: var(--mono-font); color: var(--accent-green); font-size: 1.1rem; }
    .editing-info { display: none; align-items: center; gap: 0.5rem; width: 100%;}
    .editing-info .macos-textfield-container { flex-grow: 1; }
    .case-card.editing .editing-info { display: flex; }
    .right-pane { flex-shrink: 0; width: 200px; display: flex; }
    .case-card:not(.unfiled) .right-pane { align-items: center; justify-content: flex-end; }
    .unfiled-controls { display: flex; flex-direction: column; width: 100%; gap: 8px; align-items: stretch; }
    .unfiled-controls .case-id-input-group { display: flex; gap: 8px; align-items: center; }
    .unfiled-controls .case-id-input-group .macos-textfield-container { flex-grow: 1; }
    .unfiled-controls .case-id-input-group .macos-icon-button { flex-shrink: 0; }
    .unfiled-controls button.macos.primary { padding-top: 10px; padding-bottom: 10px; }
    button.copy-case-title { display: none; }
    #caseModeWrapper.show-copy-title .copy-case-title { display: inline-flex; }
    .filed-controls { display: none; }
    .case-card.filed .filed-controls { display: flex; gap: 8px; }
    .case-card:is(.filed, .editing) .unfiled-controls { display: none; }
    .case-card.editing .right-pane { display: none; }
    .case-card.filed .case-text, .case-card.editing .case-text { display: none; }
    .case-card.filed .filed-info { display: block; }
    #caseTextModal .modal-content pre { white-space: pre-wrap; font-family: var(--mono-font); background-color: var(--bg-input); padding: 12px; border-radius: 12px; max-height: 60vh; overflow-y: auto; font-size: 0.9rem; border: 1px solid var(--border-subtle); }
    #paste-textarea, #ro-paste-area { height: 40vh; resize: vertical; padding: 12px; border-radius: 12px; border: 1px solid var(--border-color); background-color: var(--bg-input); color: var(--text-primary); font-family: var(--mono-font); }
    #ro-paste-area { height: 20vh; min-height: 120px; }
    .ro-id-list, .history-list { display: flex; flex-direction: column; gap: 0.5rem; }
    .ro-id-item { display: flex; align-items: center; justify-content: space-between; gap: 0.75rem; padding: 0.5rem; background-color: var(--bg-primary); border-radius: 8px; border: 1px solid var(--border-subtle); }
    .ro-id-text, .history-text { font-family: var(--mono-font); font-weight: 600; flex-grow: 1; }
    .ro-id-match-status {
        font-weight: 600;
        font-size: 0.9em;
        padding: 2px 8px;
        border-radius: 6px;
        background-color: color-mix(in srgb, var(--accent-green) 15%, transparent);
        color: var(--accent-green);
        margin-left: 1rem;
    }
    .history-merchant-name { color: var(--text-secondary); font-size: 0.85rem; font-style: italic; margin-left: 1rem; }
    .history-timestamp { color: var(--text-secondary); }
    #caseModeActionModalBody .macos-textfield-container { margin-top: 1rem; }
    
    /* Horizontal Scroll Tab Layout */
    .tab-layout-h-scroll #caseModeTabContainer {
        flex-wrap: nowrap;
        overflow-x: auto;
    }
    
    /* Vertical Tab Layout */
    .tab-layout-vertical {
        display: grid;
        grid-template-columns: 260px 1fr;
        grid-template-rows: auto 1fr;
        grid-template-areas:
            "sidebar header"
            "sidebar content";
        height: calc(100vh - var(--top-bar-height));
        padding: 0;
        overflow: hidden;
    }
    .tab-layout-vertical .case-mode-header { grid-area: header; }
    .tab-layout-vertical #caseModeTabContainer {
        grid-area: sidebar;
        flex-direction: column;
        border-right: 1px solid var(--border-subtle);
        border-bottom: none;
        overflow-y: auto;
        height: auto; /* Let grid handle height */
        padding: 1rem;
        align-items: stretch;
        gap: 12px;
        background-color: var(--bg-window);
    }
    html[data-theme="dark"] .tab-layout-vertical #caseModeTabContainer { background-color: var(--bg-primary); }
    .tab-layout-vertical #caseModeTabContents { grid-area: content; }
    .tab-layout-vertical .case-mode-tab-button { min-width: 0; width: 100%; }

</style>
</head>
<body>
    <div id="notificationPopup" class="notification-popup">Notification</div>
    <div id="clearAllConfirmModal" class="modal-overlay">
        <div class="modal-content">
            <h2><i class="fa-solid fa-triangle-exclamation" style="color: var(--accent-red); margin-right: 8px;"></i>Clear All Notes?</h2>
            <p>Are you sure you want to clear ALL notes and case data? This action cannot be undone.</p>
            <div class="modal-actions">
                <button id="cancelClearAllBtn" class="macos secondary">Cancel</button>
                <button id="confirmClearAllBtn" class="macos danger">Clear All</button>
            </div>
        </div>
    </div>
    <div id="clearAllSuccessPopup" class="modal-overlay">
         <div class="modal-content" style="max-width:300px; text-align:center;">
            <h2 style="justify-content:center;"><i class="fa-solid fa-check-circle" style="color: var(--accent-blue); margin-right: 8px;"></i>Success</h2>
            <p>All notes have been cleared.</p>
            <button id="closeClearSuccessPopupBtn" class="macos primary" style="margin: 10px auto 0;">OK</button>
        </div>
    </div>
    <div id="confirmClearHistoryModal" class="modal-overlay">
        <div class="modal-content">
            <h2><i class="fa-solid fa-triangle-exclamation" style="color: var(--accent-red); margin-right: 8px;"></i>Clear All History?</h2>
            <p>Are you sure you want to permanently delete all history entries? This action cannot be undone.</p>
            <div class="modal-actions">
                <button id="btnCancelClearHistory" class="macos secondary">Cancel</button>
                <button id="btnConfirmClearHistory" class="macos danger">Clear All History</button>
            </div>
        </div>
    </div>

    <div class="top-bar">
        <h1 class="top-bar-title">Lost Outbound</h1>
        <div class="toolbar-right">
            <div class="url-generator-group">
                <button id="copyUrlBtn" class="macos-icon-button non-standalone" title="Copy Report URL"><i class="fa-solid fa-copy"></i></button>
                <button id="openUrlBtn" class="macos-icon-button" title="Open Report URL in New Tab"><i class="fa-solid fa-arrow-up-right-from-square"></i></button>
                <select id="marketplaceSelectUrlGen">
                    <option value="com">US</option>
                    <option value="co.uk">UK</option>
                    <option value="ca">CA</option>
                </select>
            </div>
            <div id="prefixToggleGroup" class="toolbar-icon-group non-standalone">
                <button id="btnPrefix3C" class="macos-icon-button" title="Use 3C-OUTB Prefix">3C</button>
                <button id="btnPrefixLS" class="macos-icon-button" title="Use LS-OUTB Prefix">LS</button>
            </div>

            <button id="btnCaseMode" class="macos secondary non-standalone"><i class="fa-solid fa-briefcase"></i>File Cases</button>
            
            <div class="toolbar-icon-group standalone-only">
                 <button id="btnToggleFilerLayout" class="macos-icon-button" title="Toggle Template Position"><i class="fa-solid fa-align-left"></i></button>
                 <button id="btnToggleCopyTitle" class="macos-icon-button" title="Toggle 'Copy Case Title' Button"><i class="fa-solid fa-heading"></i></button>
            </div>
            <div class="toolbar-icon-group">
                <button id="themeToggle" class="macos-icon-button" title="Toggle Theme"><i class="fa-solid fa-sun"></i></button>
            </div>
            <div class="toolbar-icon-group non-standalone">
                <button id="btnOpenSettings" class="macos-icon-button" title="Settings"><i class="fa-solid fa-sliders"></i></button>
            </div>
        </div>
    </div>

    <div id="mainWrapper" class="main-wrapper">
        <div class="left-column-wrapper">
            <div id="parserTool" class="tool-container parser-tool">
                 <div class="tool-card-title-bar">
                    <h3 class="tool-card-title"><i class="fa-solid fa-filter"></i>Parser</h3>
                    <button id="parserToggle" class="macos-icon-button" title="Toggle Parser View"><i class="fa-solid fa-eye-slash"></i></button>
                </div>
                <div class="parser-content">
                    <div class="macos-textfield-container">
                        <textarea id="shipmentInput" class="macos-textfield" placeholder="Paste Amazon removal shipment data here..."></textarea>
                    </div>
                    <div class="parser-controls" style="margin-top:16px; display:flex; flex-direction:column; gap: 12px; align-items: flex-start;">
                        <label for="upsUspsToggle" class="parser-control-row">
                            <label class="macos-switch"><input type="checkbox" id="upsUspsToggle"><span class="slider"></span></label>
                            <span>UPS/USPS</span>
                        </label>
                    </div>
                     <div id="upsUspsOutputContainer" style="display: none; margin-top: 16px;">
                        <div class="macos-textfield-container"><textarea id="upsUspsOutputArea" class="macos-textfield" placeholder="Extracted Other Carrier Tracking Numbers..."></textarea></div>
                        <button id="btnProcessUpsUsps" class="macos primary" style="margin-top: 8px;"><i class="fa-solid fa-gears"></i>Process & Add</button>
                    </div>
                </div>
            </div>

            <div class="tool-container merchant-actions-tool">
                <div class="tool-card-title-bar">
                    <h3 class="tool-card-title"><i class="fa-solid fa-users"></i>Merchants</h3>
                    <div id="merchantCounterTarget"></div>
                </div>
                <div style="flex-shrink: 0; display: flex; gap: 8px; flex-wrap: wrap;">
                    <button id="btnDownloadSelected" class="macos primary" disabled><i class="fa-solid fa-download"></i>Download Selected</button>
                    <button id="btnExportCaseTracker" class="macos primary" disabled><i class="fa-solid fa-file-export"></i>Export Filer View</button>
                    <button id="btnViewRoIdsMain" class="macos secondary" disabled><i class="fa-solid fa-list-ol"></i> View RO IDs</button>
                    <button id="btnSendToTelegram" class="macos primary" disabled><i class="fa-solid fa-paper-plane"></i>Send to Telegram</button>
                    <button id="btnSelectAll" class="macos primary"><i class="fa-regular fa-square-check"></i><span id="selectAllText" style="margin-left: 6px;">Select All</span></button>
                    <button id="btnDownloadAll" class="macos primary"><i class="fa-solid fa-file-arrow-down"></i>Download All</button>
                    <button id="btnSplitSelected" class="macos primary" disabled><i class="fa-solid fa-table-columns"></i>Split</button>
                    <button id="btnClearSelected" class="macos danger"><i class="fa-regular fa-trash-can"></i>Clear Selected</button>
                </div>
                 <div id="merchantSearchContainer" style="margin-top:16px; display: none; position:relative; flex-shrink:0;">
                    <div class="macos-textfield-container">
                         <input type="text" id="merchantSearchInput" class="macos-textfield" style="padding-left:30px" placeholder="Search merchants...">
                    </div>
                     <i class="fa-solid fa-search" style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--text-placeholder);"></i>
                </div>
                
                <div id="merchantList"></div>
                <div class="resize-handle"></div>
            </div>
        </div>

        <div class="tool-container note-taker-tool">
             <div class="tool-card-title-bar">
                <h3 class="tool-card-title"><i class="fa-regular fa-pen-to-square"></i>Notes</h3>
                <div class="toolbar-icon-group" style="border:none; padding: 0;">
                     <button id="btnUndoNote" class="macos-icon-button" title="Undo"><i class="fa-solid fa-undo"></i></button>
                     <button id="btnRedoNote" class="macos-icon-button" title="Redo"><i class="fa-solid fa-redo"></i></button>
                </div>
            </div>
            <div id="noteAreaContainer" class="macos-textfield-container" style="flex-grow: 1; display:flex;">
                <textarea id="noteArea" class="macos-textfield" placeholder="Notes area..."></textarea>
            </div>
            <div class="controls-and-stats">
                <div>
                    <div style="display: flex; gap: 8px; flex-wrap:wrap">
                        <button id="btnAddSeparator" class="macos secondary"><i class="fa-solid fa-equals"></i>Separator</button>
                        <button id="btnClearAllNotes" class="macos danger"><i class="fa-solid fa-eraser"></i>Clear All</button>
                    </div>
                     <div id="notesCounterTarget" class="counter-pill-container">
                        <div id="theCounterPill" class="counter-pill">
                            <p><i class="fa-solid fa-users"></i>Merchants: <span id="merchantCount">0</span></p>
                            <p><i class="fa-solid fa-file-lines"></i>Cases: <span id="totalTemplates">0</span></p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="resize-handle"></div>
        </div>
    </div>

    <div id="caseModeWrapper" class="case-mode-wrapper" style="display: none;">
        <header class="case-mode-header">
            <div class="case-mode-title-group">
                <h2 class="case-mode-title">File Cases</h2>
                <span id="caseModeGlobalStats"></span>
            </div>
            <div class="tab-actions-right">
                <button id="copyAllMerchantsBtn" class="macos success" style="display: none;"><i class="fa-solid fa-copy"></i>Copy All Merchants & IDs</button>
            </div>
        </header>
        <div id="caseModeTabContainer" class="case-mode-tab-container"></div>
        <div id="caseModeTabContents"></div>
    </div>
    
    <div id="splitModal" class="modal-overlay">
        <div class="modal-content">
            <h2><i class="fa-solid fa-table-columns" style="margin-right:8px;"></i>Split Selected Merchant(s)</h2>
            <div id="splitMerchantInfo" style="font-size: 0.9em; color: var(--text-secondary); background-color: var(--bg-hover); padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border-subtle);"></div>
            <div>
                <label for="splitOrdersPerTemplate">Removal Orders per Template:</label>
                <div class="macos-textfield-container" style="width: 80px; margin-top: 4px;">
                    <input type="number" id="splitOrdersPerTemplate" class="macos-textfield" style="text-align:center;" min="1" value="1">
                </div>
            </div>
            <div style="font-size: 0.9em; color: var(--text-secondary);">
                Calculated Total Templates: <span id="splitCalculatedTemplates" style="font-weight: 600; color: var(--text-primary);">0</span>
            </div>
            <hr style="border:none; border-top: 1px solid var(--border-subtle); margin: 6px 0;">
            <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                <label for="splitNumberInput" style="flex-shrink: 0;">Templates per Split File:</label>
                <div class="macos-textfield-container" style="width: 100px;">
                    <input type="number" id="splitNumberInput" class="macos-textfield" style="text-align:center;" min="1" placeholder="e.g., 100">
                </div>
            </div>
            <div class="modal-actions">
                <button id="btnCancelSplit" class="macos secondary"><i class="fa-solid fa-xmark"></i>Cancel</button>
                <button id="btnGenerateSplits" class="macos primary"><i class="fa-solid fa-file-zipper"></i>Generate & Download</button>
                <button id="btnSendSplitsToTelegram" class="macos primary"><i class="fa-solid fa-paper-plane"></i>Send Splits</button>
            </div>
        </div>
    </div>
    
    <div id="settingsModal" class="modal-overlay">
        <div class="modal-content">
             <h2><i class="fa-solid fa-sliders" style="margin-right:8px;"></i>Settings</h2>
            <div class="settings-categories">
                <div class="settings-category">
                    <h4>UI Preferences</h4>
                    <div class="settings-group">
                        <label>Counter Position:</label>
                        <div class="radio-group">
                            <label><input type="radio" name="counterPosition" value="notes" id="counterPosNotes"> Notes Area</label>
                            <label><input type="radio" name="counterPosition" value="merchants" id="counterPosMerchants"> Merchant List</label>
                        </div>
                    </div>
                    <div class="settings-group">
                        <label>Case Card Layout (Template Position):</label>
                        <div class="radio-group">
                            <label><input type="radio" name="caseTextPosition" value="left" id="caseTextPosLeft"> Left</label>
                            <label><input type="radio" name="caseTextPosition" value="right" id="caseTextPosRight"> Right</label>
                        </div>
                    </div>
                     <div class="settings-group">
                        <label>Case Filer Tab Layout:</label>
                        <div class="radio-group">
                            <label><input type="radio" name="tabLayout" value="wrap"> Wrap</label>
                            <label><input type="radio" name="tabLayout" value="h-scroll"> Horizontal Scroll</label>
                            <label><input type="radio" name="tabLayout" value="vertical"> Vertical</label>
                        </div>
                    </div>
                    <div class="settings-group inline">
                        <label>Show Merchant Search Bar</label>
                        <label class="macos-switch"><input type="checkbox" id="settingsShowMerchantSearchToggleInput"><span class="slider"></span></label>
                    </div>
                    <div class="settings-group inline">
                        <label>Show "Copy Case Title" Button</label>
                        <label class="macos-switch"><input type="checkbox" id="settingsShowCopyTitleToggleInput"><span class="slider"></span></label>
                    </div>
                </div>
                <div class="settings-category">
                    <h4>Carrier Settings</h4>
                    <div class="settings-group">
                        <label for="settingsAmzlCarriers">AMZL-type Carriers:</label>
                        <div class="macos-textfield-container"><input type="text" id="settingsAmzlCarriers" class="macos-textfield" placeholder="e.g., AMZL,AMZN"></div>
                    </div>
                    <div class="settings-group">
                        <label for="settingsOtherCarriers">Other Carriers (for extraction):</label>
                        <div class="macos-textfield-container"><input type="text" id="settingsOtherCarriers" class="macos-textfield" placeholder="e.g., UPS,USPS"></div>
                    </div>
                </div>
                <div class="settings-category">
                    <h4>Telegram Integration (Send Files)</h4>
                    <div class="settings-group">
                        <label for="settingsTelegramToken">Telegram Bot Token:</label>
                        <div class="macos-textfield-container"><input type="text" id="settingsTelegramToken" class="macos-textfield" placeholder="Enter your bot token"></div>
                    </div>
                    <div class="settings-group">
                        <label for="settingsTelegramChatId">Telegram Chat ID:</label>
                        <div class="macos-textfield-container"><input type="text" id="settingsTelegramChatId" class="macos-textfield" placeholder="Enter your group/chat ID"></div>
                    </div>
                </div>
                 <div class="settings-category">
                    <h4>Data & History</h4>
                    <div class="settings-group inline">
                        <label>Auto-clear history older than 24 hours</label>
                        <label class="macos-switch"><input type="checkbox" id="settingsAutoClearHistoryToggleInput"><span class="slider"></span></label>
                    </div>
                    <div class="settings-group">
                        <button id="btnViewHistoryFromSettings" class="macos secondary"><i class="fa-solid fa-trash-alt"></i> View Deletion History</button>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button id="btnCloseSettingsModal" class="macos secondary">Cancel</button>
                <button id="btnSaveChangesSettings" class="macos primary"><i class="fa-solid fa-save"></i>Save Settings</button>
            </div>
        </div>
    </div>
    
    <div id="telegramSendModal" class="modal-overlay">
        <div class="modal-content">
            <h2><i class="fa-solid fa-paper-plane" style="margin-right:8px;"></i>Send to Telegram</h2>
            <div id="telegram-merchant-list"></div>
            <div class="modal-actions">
                <button id="btnCancelTelegramSend" class="macos secondary">Cancel</button>
                <button id="btnConfirmTelegramSend" class="macos primary">Send File</button>
            </div>
        </div>
    </div>

    <div id="preSendConfirmModal" class="modal-overlay">
        <div class="modal-content">
            <h2><i class="fa-solid fa-file-export" style="margin-right:8px;"></i>Confirm & Send Files</h2>
            <p>Please review the files that will be sent to Telegram. You can edit the filenames below.</p>
            <div id="preSendFileList">
                <!-- File items will be injected here by JS -->
            </div>
            <div class="modal-actions">
                <button id="btnCancelPreSend" class="macos secondary">Cancel</button>
                <button id="btnConfirmAndSend" class="macos primary"><i class="fa-solid fa-paper-plane"></i>Send Files</button>
            </div>
        </div>
    </div>

    <div id="confirmDeleteSentModal" class="modal-overlay">
        <div class="modal-content">
             <h2><i class="fa-solid fa-check-circle" style="color:var(--accent-green); margin-right:8px;"></i>Send Complete</h2>
            <p>All files sent to Telegram successfully. Do you want to remove the sent merchants from the list?</p>
            <div class="modal-actions">
                <button id="btnNoDeleteSent" class="macos secondary">Keep Them</button>
                <button id="btnYesDeleteSent" class="macos danger">Yes, Remove Them</button>
            </div>
        </div>
    </div>

    <div id="historyModal" class="modal-overlay">
        <div class="modal-content">
            <h2><i class="fa-solid fa-trash-alt" style="margin-right:8px;"></i>Deletion History</h2>
            <div id="historyList">
                <p>No history found.</p>
            </div>
            <div class="modal-actions">
                <button id="btnClearAllHistory" class="macos danger"><i class="fa-solid fa-trash"></i> Clear History</button>
                <button id="btnCloseHistoryModal" class="macos primary">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Modals for Case Mode -->
    <div id="caseTextModal" class="modal-overlay">
        <div class="modal-content">
            <h2><i class="fa-solid fa-file-alt" style="margin-right:8px;"></i>Original Template</h2>
            <pre id="caseTextModalContent"></pre>
            <div class="modal-actions">
                <button id="closeCaseTextModalBtn" class="macos primary">Close</button>
            </div>
        </div>
    </div>

    <div id="caseModeActionModal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="caseModeActionModalTitle">Action</h2>
            <div id="caseModeActionModalBody"></div>
            <div class="modal-footer">
                <div class="left-actions">
                    <button id="caseModeActionModalCopyAllBtn" class="macos secondary" style="display:none;">Copy All</button>
                </div>
                <div class="right-actions">
                    <button id="caseModeActionModalCancelBtn" class="macos secondary">Close</button>
                    <button id="caseModeActionModalActionBtn" class="macos primary" style="display:none;">Action</button>
                </div>
            </div>
        </div>
    </div>

<script>
    // STANDALONE_DATA_PLACEHOLDER
    const amzlTemplate = `We've reviewed our removal orders and discovered some shipments whose delivery status is unclear. Could you please check on your end? We're unable to verify the tracking status. If they were lost in transit, could you kindly issue a reimbursement`;
    const upsUspsTemplate = `The Removal Order Status indicates "Completed," yet we never received this order. We kindly request a reimbursement for this discrepancy.`;
    const merchantSeparator = '\n\n' + '━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━' + '\n\n';
    const merchantSeparatorRegex = /\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n/g;
    const caseSeparator = '\n\n' + '────────────────────────────────' + '\n\n';
    const caseSeparatorRegex = /\n\n────────────────────────────────\n\n/g;
    const localStorageKey = 'savedNotesContent_amzlTool';
    const upsUspsOutputKey = 'stagedUpsUspsTNs_amzlTool';
    const upsUspsContextKey = 'stagedUpsUspsContext_amzlTool';
    const historyKey = 'outboundToolHistory_v2';
    const settingsKey = 'outboundToolSettings_v2_telegram';
    const parserStateKey = 'outboundToolParserState';
    const telegramNumberKey = 'outboundToolLastTelegramNumber';
    const caseModeStateKey = 'outboundToolCaseModeState_v3';
    const matchedRoIdsKey = 'outboundToolMatchedRoIds_v1';
    const caseModeActiveKey = 'outboundToolCaseModeActive';
    const filerViewStateKey = 'outboundToolFilerViewState';
    const scrollPosKeys = {
        shipmentInput: 'scrollPos_shipmentInput_amzlTool',
        upsUspsOutputArea: 'scrollPos_upsUspsOutputArea_amzlTool',
        noteArea: 'scrollPos_noteArea_amzlTool'
    };
    let appSettings = {
        prefixOption: '3C',
        amzlTypeCarriers: ['AMZN', 'AMZL', 'AMZL_US_PREMIUM', 'AMZL_CA_PREMIUM', 'AMZN_UK_PRIME', 'AMZN_UK_STD'],
        otherCarriers: ['UPS', 'USPS'],
        showMerchantSearch: false,
        theme: 'light',
        layout: 'auto',
        counterPosition: 'notes',
        telegramBotToken: '',
        telegramChatId: '',
        autoClearHistory: true,
        marketplaceUrlGen: 'com',
        caseTextPosition: 'left',
        showCopyTitleBtn: false,
        tabLayout: 'wrap',
    };
    let regexPatterns = {
        amzlSource: null,
        otherSource: null,
        allExisting: null,
        coreTnExtract: null
    };
    let tempUpsUspsData = {};
    let merchantsToDeleteAfterSend = [];
    let selectedMerchantDataForSplit = [];
    let noteHistory = [];
    let noteHistoryIndex = -1;
    let isUndoRedoAction = false;
    let noteChangeTimeout;

    // --- CASE MODE VARIABLES ---
    let caseModeData = [];
    let activeCaseModeTabId = null;
    let matchedRoIds = new Set();


    function escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function sanitizeFilename(name) {
        return name.replace(/[\s\\/:"*?<>|()]+/g, '_').substring(0, 50);
    }

    function getFormattedDate() {
        const date = new Date();
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        return `${month}-${day}`;
    }
    
    function getFilenamePrefix() {
        return appSettings.prefixOption === 'LS' ? 'LS-OUTB' : '3C-OUTB';
    }

    function buildCarrierRegexPart(carrierArray) {
        if (!carrierArray || carrierArray.length === 0) return '(?:UNKNOWN_CARRIER_TYPE)';
        return '(?:' + carrierArray.map(escapeRegExp).join('|') + ')';
    }

    function showNotification(message, type = 'info', duration = 3000) {
        const popup = document.getElementById('notificationPopup');
        if (!popup) return;
        popup.textContent = message;
        popup.className = 'notification-popup';
        popup.classList.add(type);
        popup.classList.add('show');
        setTimeout(() => {
            popup.classList.remove('show');
        }, duration);
    }

    function setTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        const themeIcon = document.querySelector('#themeToggle i');
        if (themeIcon) {
            themeIcon.className = `fa-solid fa-${theme === 'dark' ? 'moon' : 'sun'}`;
        }
    }
    
    function setPrefix(prefix) {
        appSettings.prefixOption = prefix;
        localStorage.setItem(settingsKey, JSON.stringify(appSettings));
        document.getElementById('btnPrefix3C').classList.toggle('active', prefix === '3C');
        document.getElementById('btnPrefixLS').classList.toggle('active', prefix === 'LS');
    }

    function loadSettings() {
        const savedSettings = localStorage.getItem(settingsKey);
        if (savedSettings) {
            try {
                const parsed = JSON.parse(savedSettings);
                appSettings = { ...appSettings, ...parsed};
            } catch (e) {
                console.error("Error parsing settings:", e);
            }
        }
        setPrefix(appSettings.prefixOption);
        document.getElementById('settingsAmzlCarriers').value = appSettings.amzlTypeCarriers.join(',');
        document.getElementById('settingsOtherCarriers').value = appSettings.otherCarriers.join(',');
        document.getElementById('settingsTelegramToken').value = appSettings.telegramBotToken;
        document.getElementById('settingsTelegramChatId').value = appSettings.telegramChatId;
        document.getElementById('settingsShowMerchantSearchToggleInput').checked = appSettings.showMerchantSearch;
        document.getElementById('settingsAutoClearHistoryToggleInput').checked = appSettings.autoClearHistory;
        document.getElementById('settingsShowCopyTitleToggleInput').checked = appSettings.showCopyTitleBtn;
        document.getElementById('marketplaceSelectUrlGen').value = appSettings.marketplaceUrlGen;
        const counterPosRadio = document.querySelector(`input[name="counterPosition"][value="${appSettings.counterPosition}"]`);
        if (counterPosRadio) counterPosRadio.checked = true;
        const caseTextPosRadio = document.querySelector(`input[name="caseTextPosition"][value="${appSettings.caseTextPosition}"]`);
        if (caseTextPosRadio) caseTextPosRadio.checked = true;
        const tabLayoutRadio = document.querySelector(`input[name="tabLayout"][value="${appSettings.tabLayout}"]`);
        if (tabLayoutRadio) tabLayoutRadio.checked = true;

        initializeRegexPatterns();
        applyAppSettings();
        setTheme(appSettings.theme);
    }

    function saveSettings() {
        const amzlStr = document.getElementById('settingsAmzlCarriers').value.trim();
        appSettings.amzlTypeCarriers = amzlStr ? amzlStr.split(',').map(s => s.trim()).filter(Boolean) : ['AMZN', 'AMZL'];
        const otherStr = document.getElementById('settingsOtherCarriers').value.trim();
        appSettings.otherCarriers = otherStr ? otherStr.split(',').map(s => s.trim()).filter(Boolean) : ['UPS', 'USPS'];
        appSettings.telegramBotToken = document.getElementById('settingsTelegramToken').value.trim();
        appSettings.telegramChatId = document.getElementById('settingsTelegramChatId').value.trim();
        appSettings.showMerchantSearch = document.getElementById('settingsShowMerchantSearchToggleInput').checked;
        appSettings.autoClearHistory = document.getElementById('settingsAutoClearHistoryToggleInput').checked;
        appSettings.showCopyTitleBtn = document.getElementById('settingsShowCopyTitleToggleInput').checked;
        appSettings.marketplaceUrlGen = document.getElementById('marketplaceSelectUrlGen').value;
        const selectedCounterPos = document.querySelector('input[name="counterPosition"]:checked');
        if (selectedCounterPos) appSettings.counterPosition = selectedCounterPos.value;
        const selectedCaseTextPos = document.querySelector('input[name="caseTextPosition"]:checked');
        if (selectedCaseTextPos) appSettings.caseTextPosition = selectedCaseTextPos.value;
        const selectedTabLayout = document.querySelector('input[name="tabLayout"]:checked');
        if (selectedTabLayout) appSettings.tabLayout = selectedTabLayout.value;

        localStorage.setItem(settingsKey, JSON.stringify(appSettings));
        initializeRegexPatterns();
        applyAppSettings();
        showNotification("Settings saved successfully!", "success");
    }
    
    function applyAppSettings() {
        applyMerchantSearchVisibility();
        updateCounterPillLocation();
        applyCaseCardLayout();
        applyCopyTitleButtonVisibility();
        applyTabLayout();
    }

    function getHistory() {
        try {
            const history = localStorage.getItem(historyKey);
            return history ? JSON.parse(history) : [];
        } catch (e) {
            console.error("Failed to parse history:", e);
            return [];
        }
    }

    function saveHistory(history) {
        localStorage.setItem(historyKey, JSON.stringify(history));
    }
    
    function autoClearOldHistory() {
        if (!appSettings.autoClearHistory) return;
        const history = getHistory();
        if (history.length === 0) return;
        const twentyFourHoursAgo = Date.now() - (24 * 60 * 60 * 1000);
        const recentHistory = history.filter(item => {
            const itemDate = new Date(item.deletedAt).getTime();
            return itemDate > twentyFourHoursAgo;
        });
        if (recentHistory.length < history.length) {
            saveHistory(recentHistory);
        }
    }

    function addToHistory(deletedMerchants, fileInfo = []) {
        if (!deletedMerchants || deletedMerchants.length === 0) return;
        const history = getHistory();
        const newEntry = {
            id: Date.now() + Math.random().toString(36).substr(2, 9),
            deletedAt: new Date().toISOString(),
            merchants: deletedMerchants,
            telegramFiles: fileInfo
        };
        history.unshift(newEntry);
        saveHistory(history);
    }
    
    function renderHistoryModal() {
        const history = getHistory();
        const listEl = document.getElementById('historyList');
        listEl.innerHTML = '';
        if (history.length === 0) {
            listEl.innerHTML = '<p>No history found.</p>';
            return;
        }
        history.forEach(item => {
            const itemEl = document.createElement('div');
            itemEl.className = 'history-item';
            const merchantNames = item.merchants.map(m => m.displayName).join(', ');
            const totalCases = item.merchants.reduce((sum, m) => sum + m.count, 0);
            let filesHtml = '';
            if (item.telegramFiles && item.telegramFiles.length > 0) {
                filesHtml = `<div class="history-item-files"><b>Sent Files:</b><br>${item.telegramFiles.map(f => f.filename).join('<br>')}</div>`;
            }
            itemEl.innerHTML = `
                <div class="history-item-header">
                    <span class="history-item-date">${new Date(item.deletedAt).toLocaleString()}</span>
                    <button class="macos secondary restore-btn" data-history-id="${item.id}"><i class="fa-solid fa-undo"></i> Restore</button>
                </div>
                <div class="history-item-content">
                    <p><b>Merchants:</b> ${merchantNames}</p>
                    <p><b>Total Cases:</b> ${totalCases}</p>
                    ${filesHtml}
                </div>`;
            listEl.appendChild(itemEl);
        });
    }

    function restoreHistoryItem(historyId) {
        let history = getHistory();
        const itemIndex = history.findIndex(item => item.id === historyId);
        if (itemIndex === -1) return;
        const [itemToRestore] = history.splice(itemIndex, 1);
        const noteArea = document.getElementById('noteArea');
        const textToRestore = itemToRestore.merchants.map(m => m.key).join(merchantSeparator);
        const currentNoteTrimmed = noteArea.value.trimEnd();
        noteArea.value = currentNoteTrimmed + (currentNoteTrimmed ? merchantSeparator : '') + textToRestore;
        saveHistory(history);
        countTemplatesNoteTaker();
        recordNoteChange();
        renderHistoryModal();
        showNotification("Merchant(s) restored successfully!", "success");
    }

    async function sendFileToTelegram(fileContent, filename, caption = '') {
        const { telegramBotToken, telegramChatId } = appSettings;
        if (!telegramBotToken || !telegramChatId) {
            showNotification("Telegram Bot Token or Chat ID for sending files is missing in settings.", "error");
            return null;
        }
        
        const blob = new Blob([fileContent], { type: 'text/plain;charset=utf-8' });
        const formData = new FormData();
        formData.append('chat_id', telegramChatId);
        formData.append('document', blob, filename);
        if (caption) {
            formData.append('caption', caption);
        }
        
        try {
            const response = await fetch(`https://api.telegram.org/bot${telegramBotToken}/sendDocument`, {
                method: 'POST',
                body: formData
            });
            const result = await response.json();
            if (result.ok) {
                return { success: true, filename: filename };
            } else {
                console.error("Telegram API Error:", result.description);
                showNotification(`Error sending ${filename}: ${result.description}`, "error", 5000);
                return { success: false, filename: filename };
            }
        } catch (error) {
            console.error("Fetch error:", error);
            showNotification(`Network error while sending ${filename}.`, "error", 5000);
            return { success: false, filename: filename };
        }
    }
    
    function formatMerchantBlockForOutput(blockText) {
        let namePart = '';
        let casesPart = blockText;
        const lines = blockText.split('\n');
        const firstLine = lines[0]?.trim();
        
        const isNameFromFirstLine = firstLine && 
                                  !firstLine.startsWith(amzlTemplate.substring(0, 10)) && 
                                  !firstLine.startsWith(upsUspsTemplate.substring(0, 10)) && 
                                  !firstLine.includes(caseSeparator.trim()) && // Ensure it's not a separator
                                  firstLine.length < 100 && 
                                  !firstLine.includes(':') && 
                                  !firstLine.startsWith('Removal order ID');

        if (isNameFromFirstLine) {
            namePart = firstLine;
            casesPart = lines.slice(1).join('\n').trim();
        } else {
            casesPart = blockText.trim();
        }
        
        const trimmedCaseSeparator = caseSeparator.trim();
        if (casesPart.startsWith(trimmedCaseSeparator)) {
            casesPart = casesPart.substring(trimmedCaseSeparator.length).trimStart();
        }
        
        return namePart ? (namePart + '\n\n' + casesPart) : casesPart;
    }

    function isMerchantVerified(merchantObj) {
        const roIdRegex = /Removal order ID:\s*(\S+)/g;
        const allRoIdsInMerchant = merchantObj.cases.flatMap(c => [...c.text.matchAll(roIdRegex)].map(match => match[1]));

        if (allRoIdsInMerchant.length === 0) {
            return false; // Not verifiable if no RO IDs exist
        }

        // Check if every RO ID found in the merchant's cases is also in the matched set
        return allRoIdsInMerchant.every(id => matchedRoIds.has(id));
    }

    function getFormattedBlockWithVerification(merchantObj) {
        let formattedBlock = formatMerchantBlockForOutput(merchantObj.originalText);
        
        if (isMerchantVerified(merchantObj)) {
            const lines = formattedBlock.split('\n\n');
            // The first part is the name, the rest is the case data.
            // This handles both cases where a name was parsed or not.
            if (lines.length > 0) {
                lines[0] = `${lines[0]} ***Verified Removal***`;
                return lines.join('\n\n');
            }
        }
        return formattedBlock;
    }
    
    async function handleConfirmTelegramSend() {
        const modal = document.getElementById('telegramSendModal');
        const sendButton = document.getElementById('btnConfirmTelegramSend');
        const filenameInput = document.getElementById('telegram-filename-edit');
        const numberInput = document.getElementById('telegram-file-number-single');

        sendButton.disabled = true;
        sendButton.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Sending...';
        
        const merchantsData = JSON.parse(modal.dataset.merchantsToSend || '[]');
        if (merchantsData.length === 0) {
             showNotification("No merchants to send.", "error");
             sendButton.disabled = false; sendButton.innerHTML = 'Send File';
             return;
        }
        
        const filename = filenameInput.value.trim();
        if (!filename) {
            showNotification("Filename cannot be empty.", "error");
            sendButton.disabled = false; sendButton.innerHTML = 'Send File';
            return;
        }
        
        const numberToSave = parseInt(numberInput.value, 10);
        if (!isNaN(numberToSave) && numberToSave > 0) {
            localStorage.setItem(telegramNumberKey, numberToSave);
        }
        
        const merchantObjectsToSend = merchantsData.map(m => caseModeData.find(obj => obj.originalText === m.key)).filter(Boolean);
        const fileContent = merchantObjectsToSend.map(getFormattedBlockWithVerification).join(merchantSeparator);

        const result = await sendFileToTelegram(fileContent, filename, ''); 
        
        sendButton.disabled = false;
        sendButton.innerHTML = 'Send File';
        closeTelegramSendModal();

        if (result && result.success) {
            merchantsToDeleteAfterSend = merchantsData;
            addToHistory(merchantsToDeleteAfterSend, [{ filename: result.filename }]);
            document.getElementById('confirmDeleteSentModal').style.display = 'flex';
        }
    }

    function confirmAndDeleteSentMerchants() {
        const keysToRemove = new Set(merchantsToDeleteAfterSend.map(m => m.key));
        if (keysToRemove.size === 0) return;
        const noteArea = document.getElementById('noteArea');
        const allSections = noteArea.value.split(merchantSeparatorRegex);
        const remainingSections = allSections.filter(section => !keysToRemove.has(section));
        noteArea.value = remainingSections.join(merchantSeparator);
        countTemplatesNoteTaker();
        recordNoteChange();
        document.getElementById('confirmDeleteSentModal').style.display = 'none';
        showNotification("Sent merchants removed from the list.", "success");
        merchantsToDeleteAfterSend = [];
    }

    function initializeRegexPatterns() {
        const amzlCarrierPart = buildCarrierRegexPart(appSettings.amzlTypeCarriers);
        const otherCarrierPart = buildCarrierRegexPart(appSettings.otherCarriers);
        const allCarriersCombined = [...appSettings.amzlTypeCarriers, ...appSettings.otherCarriers];
        const uniqueAllCarriers = Array.from(new Set(allCarriersCombined.filter(Boolean)));
        const allCarrierPart = buildCarrierRegexPart(uniqueAllCarriers.length > 0 ? uniqueAllCarriers : ['TEMP_PLACEHOLDER']);
        regexPatterns.amzlSource = new RegExp(`\\b([A-Z0-9]+(?:-|\\s)*?)\\s*\\((${amzlCarrierPart})\\)`, 'gi');
        regexPatterns.otherSource = new RegExp(`\\b([A-Z0-9]+(?:-|\\s)*?)\\s*\\((${otherCarrierPart})\\)`, 'gi');
        regexPatterns.allExisting = new RegExp(`\\b([A-Z0-9]+(?:-|\\s)*?\\s*\\(${allCarrierPart}\\))`, 'gi');
        regexPatterns.coreTnExtract = new RegExp(`\\s*\\(${allCarrierPart}\\)$`, 'i');
    }

    function updateCounterPillLocation() {
        const counterPillEl = document.getElementById('theCounterPill');
        const notesTarget = document.getElementById('notesCounterTarget');
        const merchantTarget = document.getElementById('merchantCounterTarget');
        if (!counterPillEl || !notesTarget || !merchantTarget) return;
        if (counterPillEl.parentNode) counterPillEl.parentNode.removeChild(counterPillEl);
        if (appSettings.counterPosition === 'merchants') {
            merchantTarget.appendChild(counterPillEl);
            notesTarget.style.display = 'none';
            merchantTarget.style.display = 'flex';
        } else {
            notesTarget.appendChild(counterPillEl);
            notesTarget.style.display = 'flex';
            merchantTarget.style.display = 'none';
        }
    }

    function setLayout(layout) {
        const mainWrapper = document.getElementById('mainWrapper');
        mainWrapper.classList.remove('layout-stacked', 'layout-side-by-side');
        mainWrapper.classList.add(`layout-${layout}`);
    }

    function handleAutoLayout() {
        const isCurrentlyNarrow = window.innerWidth < 1100;
        setLayout(isCurrentlyNarrow ? 'stacked' : 'side-by-side');
    }

    function applyMerchantSearchVisibility() {
        const searchContainer = document.getElementById('merchantSearchContainer');
        const searchInput = document.getElementById('merchantSearchInput');
        if (searchContainer) {
            searchContainer.style.display = appSettings.showMerchantSearch ? 'block' : 'none';
            if (!appSettings.showMerchantSearch && searchInput) searchInput.value = '';
            filterMerchants();
        }
    }

    function filterMerchants() {
        const searchTerm = document.getElementById('merchantSearchInput')?.value.toLowerCase().trim() || "";
        document.querySelectorAll('#merchantList .merchant-item').forEach(item => {
            const displayName = item.dataset.displayName?.toLowerCase() || "";
            item.style.display = displayName.includes(searchTerm) ? 'flex' : 'none';
        });
        updateSelectedCountNoteTaker();
    }

    function parseShipmentData() {
        const input = document.getElementById('shipmentInput');
        const noteArea = document.getElementById('noteArea');
        const upsUspsToggle = document.getElementById('upsUspsToggle');
        const upsUspsOutputArea = document.getElementById('upsUspsOutputArea');
        const inputValue = input.value;
        if (inputValue.trim()) {
            input.value = '';
        } else {
            return;
        }
        const currentNoteValue = noteArea.value;
        const isUpsUspsMode = upsUspsToggle ? upsUspsToggle.checked : false;
        const trackingNumberSourceRegex = isUpsUspsMode ? regexPatterns.otherSource : regexPatterns.amzlSource;
        const existingTrackingNumberRegexGlobal = regexPatterns.allExisting;
        const coreTNReplaceRegex = regexPatterns.coreTnExtract;
        const existingTrackingNumbers = new Set();
        let matchCheck;
        while ((matchCheck = existingTrackingNumberRegexGlobal.exec(currentNoteValue)) !== null) {
            const coreTN = matchCheck[1].replace(coreTNReplaceRegex, '').replace(/\s|-/g, '');
            if (coreTN) existingTrackingNumbers.add(coreTN);
        }
        if (upsUspsOutputArea && upsUspsOutputArea.value) {
            upsUspsOutputArea.value.split('\n').forEach(tn => {
                const trimmedTn = tn.trim();
                if (trimmedTn) existingTrackingNumbers.add(trimmedTn.replace(/\s|-/g, ''));
            });
        }
        const seenTrackingNumbersInCurrentInput = new Set();
        const overallBlocks = inputValue.split(/(?=Removal order ID:)/g);
        const parsedDataBlocks = [];
        const extractedUpsUspsNumbers = [];
        let validShipmentsFound = 0;
        let skippedDuplicateCount = 0;
        let currentBlockRemovalOrderId = '';
        overallBlocks.forEach(block => {
            if (!block.trim()) return;
            const blockRoMatch = block.match(/Removal order ID:\s*([^\n]+)/);
            if (blockRoMatch) {
                currentBlockRemovalOrderId = blockRoMatch[1].trim();
            }
            const shipmentSections = block.split(/(?=Shipment ID:)/g).filter(section => section.trim() !== '');
            shipmentSections.forEach(section => {
                if (section.trim().startsWith("Removal order ID:")) return;
                const trackingMatches = Array.from(section.matchAll(trackingNumberSourceRegex));
                if (!trackingMatches || trackingMatches.length === 0) return;
                const sectionCoreTNs = new Set();
                const sectionFullTNs = [];
                trackingMatches.forEach(match => {
                    const rawTNPart = match[1].trim();
                    const carrier = match[2];
                    const coreTN = rawTNPart.replace(/\s|-/g, '');
                    if (!coreTN) return;
                    sectionCoreTNs.add(coreTN);
                    const fullFormattedTN = `${rawTNPart}(${carrier})`;
                    sectionFullTNs.push(fullFormattedTN);
                });
                let hasDuplicate = false;
                const coreTNsToCheck = Array.from(sectionCoreTNs);
                for (const coreTn of coreTNsToCheck) {
                    if (existingTrackingNumbers.has(coreTn) || seenTrackingNumbersInCurrentInput.has(coreTn)) {
                        hasDuplicate = true;
                        break;
                    }
                }
                if (hasDuplicate) {
                    skippedDuplicateCount++;
                    coreTNsToCheck.forEach(tn => seenTrackingNumbersInCurrentInput.add(tn));
                    return;
                }
                coreTNsToCheck.forEach(tn => seenTrackingNumbersInCurrentInput.add(tn));
                const shipmentIdMatch = section.match(/^Shipment ID:\s*([^\n]+)/m);
                const shipmentId = shipmentIdMatch ? shipmentIdMatch[1].trim() : 'N/A';
                const productLines = section.split('\n').map(line => line.trim());
                const parsedProducts = [];
                let currentProduct = null;
                for (let i = 0; i < productLines.length; i++) {
                    const line = productLines[i];
                    if (line.startsWith('Merchant SKU:')) {
                        if (currentProduct && currentProduct.merchantSku && currentProduct.qty !== undefined) {
                            parsedProducts.push(currentProduct);
                        }
                        currentProduct = {
                            merchantSku: line.substring('Merchant SKU:'.length).trim(),
                            qty: undefined
                        };
                    } else if (currentProduct) {
                        if (line.startsWith('FNSKU:')) {
                            currentProduct.fnsku = line.substring('FNSKU:'.length).trim();
                        } else if (/^\d{1,4}$/.test(line) && productLines[i - 1]?.match(/^(EAN|UPC|ISBN_10|Condition|Shipped Quantity|Cancelled Quantity):/i)) {
                            currentProduct.qty = parseInt(line, 10);
                            parsedProducts.push(currentProduct);
                            currentProduct = null;
                        }
                    }
                }
                if (currentProduct && currentProduct.merchantSku && currentProduct.qty !== undefined && !parsedProducts.includes(currentProduct)) {
                    parsedProducts.push(currentProduct);
                }
                if (parsedProducts.length === 0) return;
                const roIdToUse = currentBlockRemovalOrderId || "N/A";
                const outputParts = [`Removal order ID:${roIdToUse}`, `Shipment ID:${shipmentId}`, `Tracking Number(s):${Array.from(new Set(sectionFullTNs)).join(', ')}`];
                const productOutputs = parsedProducts.map(p => [`Merchant SKU:${p.merchantSku || 'N/A'}`, `FNSKU:${p.fnsku || 'N/A'}`, `Qty:${p.qty}`].join('\n'));
                const completeDataBlock = outputParts.join('\n') + '\n' + productOutputs.join('\n\n');
                if (isUpsUspsMode) {
                    coreTNsToCheck.forEach(coreTN => {
                        if (!tempUpsUspsData[coreTN]) tempUpsUspsData[coreTN] = completeDataBlock;
                        extractedUpsUspsNumbers.push(coreTN);
                    });
                } else {
                    parsedDataBlocks.push(completeDataBlock);
                }
                validShipmentsFound++;
            });
        });
        let casesAdded = 0;
        let finalOutputString = '';
        let templateUsed = isUpsUspsMode ? upsUspsTemplate : amzlTemplate;
        
        if (isUpsUspsMode) {
            if (extractedUpsUspsNumbers.length > 0) {
                const uniqueNumbersToAdd = Array.from(new Set(extractedUpsUspsNumbers));
                upsUspsOutputArea.value += (upsUspsOutputArea.value ? '\n' : '') + uniqueNumbersToAdd.join('\n');
                saveUpsUspsOutputToLocalStorage();
                saveUpsUspsContextToLocalStorage();
                let processedMessage = `Extracted ${uniqueNumbersToAdd.length} Other Carrier number(s). `;
                if (skippedDuplicateCount > 0) processedMessage += `Skipped ${skippedDuplicateCount} duplicate(s). `;
                showNotification(processedMessage, "info");
            } else {
                let message = "No new Other Carrier shipments found. ";
                if (skippedDuplicateCount > 0) message += `Skipped ${skippedDuplicateCount} duplicate(s). `;
                showNotification(message, "info");
            }
        } else {
            if (parsedDataBlocks.length > 0) {
                const templateChunks = parsedDataBlocks.map(dataBlock => templateUsed + "\n\n" + dataBlock);
                finalOutputString = templateChunks.join(caseSeparator);
                casesAdded = templateChunks.length;
            }
        }
        
        if (casesAdded > 0) {
            const currentNoteTrimmed = noteArea.value.trimEnd();
            let prefix = '';
            if (currentNoteTrimmed && !currentNoteTrimmed.endsWith(merchantSeparator.trim())) {
                prefix = caseSeparator;
            }
            noteArea.value = currentNoteTrimmed + prefix + finalOutputString;

            countTemplatesNoteTaker();
            recordNoteChange();
            let processedMessage = `Processed ${validShipmentsFound} new shipment(s). `;
            if (skippedDuplicateCount > 0) processedMessage += `Skipped ${skippedDuplicateCount} duplicate(s). `;
            showNotification(processedMessage, "success");
            if (casesAdded > 0) showNotification(`+${casesAdded} cases added`, "info");
        } else if (!isUpsUspsMode) {
             let message = "No new AMZL-type shipments found. ";
             if (skippedDuplicateCount > 0) message += `Skipped ${skippedDuplicateCount} duplicate(s). `;
             showNotification(message, "info");
        }
        
        saveShipmentInputScroll();
    }


    function processUpsUspsData() {
        const upsUspsOutputArea = document.getElementById('upsUspsOutputArea');
        const noteArea = document.getElementById('noteArea');
        if (!upsUspsOutputArea || !noteArea) return;
        const trackingNumbersToProcess = upsUspsOutputArea.value.split('\n').map(tn => tn.trim()).filter(Boolean);
        if (trackingNumbersToProcess.length === 0) {
            return;
        }
        let processedBlocks = [];
        let notFoundCount = 0;
        const processedTNs = new Set();
        trackingNumbersToProcess.forEach(tn => {
            const coreTN = tn.replace(/\s|-/g, '');
            if (!processedTNs.has(coreTN)) {
                if (tempUpsUspsData[coreTN]) {
                    processedBlocks.push(upsUspsTemplate + "\n\n" + tempUpsUspsData[coreTN]);
                    processedTNs.add(coreTN);
                } else {
                    notFoundCount++;
                }
            }
        });
        if (processedBlocks.length > 0) {
            const currentNoteTrimmed = noteArea.value.trimEnd();
            const finalContent = processedBlocks.join(caseSeparator);
            
            let prefix = '';
             if (currentNoteTrimmed && !currentNoteTrimmed.endsWith(merchantSeparator.trim())) {
                prefix = caseSeparator;
            }

            noteArea.value = currentNoteTrimmed + prefix + finalContent;
            
            countTemplatesNoteTaker();
            recordNoteChange();
            const remainingOutputTNs = upsUspsOutputArea.value.split('\n').map(t => t.trim()).filter(t => t && !processedTNs.has(t.replace(/\s|-/g, '')));
            upsUspsOutputArea.value = remainingOutputTNs.join('\n');
            processedTNs.forEach(coreTN => {
                delete tempUpsUspsData[coreTN];
            });
            saveUpsUspsOutputToLocalStorage();
            saveUpsUspsContextToLocalStorage();
            showNotification(`Added ${processedBlocks.length} Other Carrier entries to notes.`, "success");
            if (processedBlocks.length > 0) showNotification(`+${processedBlocks.length} cases added`, "info");
        }
        if (notFoundCount > 0) showNotification(`Warning: Could not find data for ${notFoundCount} tracking number(s).`, "error");
    }

    function clearSelectedMerchants() {
        const selectedDivs = document.querySelectorAll('#merchantList .merchant-item.selected');
        if (selectedDivs.length === 0) return;

        const deletedMerchants = Array.from(selectedDivs).map(div => ({
            key: div.dataset.key,
            displayName: div.dataset.displayName,
            count: parseInt(div.dataset.count, 10)
        }));
        addToHistory(deletedMerchants);

        const keysToRemove = new Set(deletedMerchants.map(m => m.key));
        const noteArea = document.getElementById('noteArea');
        
        const allSections = noteArea.value.split(merchantSeparatorRegex);
        const remainingSections = allSections.filter(section => !keysToRemove.has(section));
        
        noteArea.value = remainingSections.join(merchantSeparator);
        countTemplatesNoteTaker();
        recordNoteChange();
        showNotification(`${deletedMerchants.length} merchant(s) deleted and backed up.`, "success");
    }

    function countTemplatesInText(text, templateString) {
        if (!text || !templateString) return 0;
        const escapedTemplate = templateString.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        return (text.match(new RegExp(escapedTemplate, 'g')) || []).length;
    }

    function downloadFile(content, filename, mimeType) {
        const blob = new Blob([content], { type: mimeType });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        a.remove();
    }

    function handleMerchantNameEdit(event, originalSectionKey, originalDisplayName, isNameOriginallyFromFirstLine) {
        const editableSpan = event.target;
        const newName = editableSpan.textContent.trim();
        if (!newName || newName === originalDisplayName) {
            editableSpan.textContent = originalDisplayName;
            return;
        }
        const noteArea = document.getElementById('noteArea');
        const currentNotes = noteArea.value;
        let newSectionText;
        if (isNameOriginallyFromFirstLine) {
            const lines = originalSectionKey.split('\n');
            newSectionText = newName + (lines.length > 1 ? '\n' + lines.slice(1).join('\n') : '');
        } else {
            newSectionText = newName + '\n\n' + originalSectionKey;
        }
        
        noteArea.value = currentNotes.replace(originalSectionKey, newSectionText);
        countTemplatesNoteTaker();
        recordNoteChange();
    }

    function countTemplatesNoteTaker() {
        const noteArea = document.getElementById('noteArea');
        const fullText = noteArea.value;
        const merchantListDiv = document.getElementById('merchantList');
        merchantListDiv.innerHTML = '';
        const merchantsData = {};
        let totalTemplatesOverall = 0;
        let merchantIndex = 0;
        const sections = fullText.split(merchantSeparatorRegex);
        sections.forEach((sectionTextOriginal) => {
            const sectionText = sectionTextOriginal.trim();
            if (!sectionText) return;
            const amzlTemplateCount = countTemplatesInText(sectionText, amzlTemplate);
            const upsUspsTemplateCount = countTemplatesInText(sectionText, upsUspsTemplate);
            const templateCount = amzlTemplateCount + upsUspsTemplateCount;
            totalTemplatesOverall += templateCount;
            let merchantName = `Entry ${++merchantIndex}`;
            const firstLine = sectionText.split('\n')[0]?.trim();
            let isNameFromFirstLine = false;
            if (firstLine && !firstLine.startsWith(amzlTemplate.substring(0, 10)) && !firstLine.startsWith(upsUspsTemplate.substring(0, 10)) && firstLine.length < 100 && !firstLine.includes(':') && !firstLine.startsWith('Removal order ID')) {
                merchantName = firstLine;
                isNameFromFirstLine = true;
            } else if (sectionText.includes('Removal order ID:')) {
                merchantName = `Data Entry ${merchantIndex}`;
            }
            merchantsData[sectionTextOriginal] = {
                displayName: merchantName,
                isNameFromFirstLine: isNameFromFirstLine,
                count: templateCount,
                key: sectionTextOriginal
            };
        });
        
        Object.entries(merchantsData).forEach(([key, data]) => {
            const merchantDiv = document.createElement('div');
            merchantDiv.className = 'merchant-item';
            merchantDiv.dataset.key = key;
            merchantDiv.dataset.displayName = data.displayName;
            merchantDiv.dataset.count = data.count;
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'macos-checkbox';
            checkbox.onchange = updateSelectedCountNoteTaker;
            const nameSpan = document.createElement('span');
            nameSpan.contentEditable = true;
            nameSpan.textContent = data.displayName;
            nameSpan.style.margin = '0 8px';
            nameSpan.style.flexGrow = '1';
            nameSpan.style.overflow = 'hidden';
            nameSpan.style.textOverflow = 'ellipsis';
            nameSpan.style.whiteSpace = 'nowrap';
            nameSpan.addEventListener('blur', (e) => handleMerchantNameEdit(e, key, data.displayName, data.isNameFromFirstLine));
            nameSpan.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    e.target.blur();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    e.target.textContent = data.displayName;
                    e.target.blur();
                }
            });
            const countSpan = document.createElement('span');
            countSpan.className = 'case-count';
            countSpan.textContent = `${data.count} ${data.count === 1 ? 'case' : 'cases'}`;
            merchantDiv.appendChild(checkbox);
            merchantDiv.appendChild(nameSpan);
            merchantDiv.appendChild(countSpan);
            merchantDiv.onclick = (e) => {
                if (e.target !== checkbox && e.target !== nameSpan) {
                    checkbox.checked = !checkbox.checked;
                    updateSelectedCountNoteTaker();
                }
            };
            merchantListDiv.appendChild(merchantDiv);
        });
        filterMerchants();
        updateSelectedCountNoteTaker();
        updateStateContent(noteArea.value);
    }
    
    function updateStateContent(content) {
        const state = JSON.parse(localStorage.getItem(caseModeStateKey)) || {};
        state.fileContent = content;
        if (!state.fileNames) {
            state.fileNames = [];
        }
        localStorage.setItem(caseModeStateKey, JSON.stringify(state));
    }


    function updateSelectedCountNoteTaker() {
        const selectedCheckboxes = document.querySelectorAll('#merchantList .macos-checkbox:checked');
        const splitButton = document.getElementById('btnSplitSelected');
        const sendButton = document.getElementById('btnSendToTelegram');
        const downloadSelectedButton = document.getElementById('btnDownloadSelected');
        const exportButton = document.getElementById('btnExportCaseTracker');
        const btnViewRoIdsMain = document.getElementById('btnViewRoIdsMain');

        let selectedCaseCount = 0;
        document.querySelectorAll('.merchant-item').forEach(item => {
            const cb = item.querySelector('.macos-checkbox');
            if (cb?.checked) {
                item.classList.add('selected');
                selectedCaseCount += parseInt(item.dataset.count || '0', 10);
            } else {
                item.classList.remove('selected');
            }
        });

        const isAnythingSelected = selectedCheckboxes.length > 0;
        if (splitButton) splitButton.disabled = !isAnythingSelected;
        if (sendButton) sendButton.disabled = !isAnythingSelected;
        if (downloadSelectedButton) downloadSelectedButton.disabled = !isAnythingSelected;
        if (exportButton) exportButton.disabled = !isAnythingSelected;
        if (btnViewRoIdsMain) btnViewRoIdsMain.disabled = selectedCheckboxes.length !== 1;

        const totalTemplatesSpan = document.getElementById('totalTemplates');
        const merchantCountSpan = document.getElementById('merchantCount');

        if (isAnythingSelected) {
            totalTemplatesSpan.textContent = selectedCaseCount;
            merchantCountSpan.textContent = selectedCheckboxes.length;
        } else {
            const allItems = document.querySelectorAll('#merchantList .merchant-item');
            const totalCaseCountOverall = Array.from(allItems).reduce((sum, el) => sum + parseInt(el.dataset.count || '0', 10), 0);
            totalTemplatesSpan.textContent = totalCaseCountOverall;
            merchantCountSpan.textContent = allItems.length;
        }

        const btnSelectAll = document.getElementById('btnSelectAll');
        const selectAllText = document.getElementById('selectAllText');
        const selectAllIcon = btnSelectAll?.querySelector('i');

        if (btnSelectAll && selectAllText && selectAllIcon) {
            const allVisibleCheckboxes = Array.from(document.querySelectorAll('#merchantList .merchant-item'))
                .filter(item => item.style.display !== 'none')
                .map(item => item.querySelector('.macos-checkbox'));
            
            const areAllSelected = allVisibleCheckboxes.length > 0 && allVisibleCheckboxes.every(cb => cb.checked);

            if (areAllSelected) {
                selectAllText.textContent = 'Deselect All';
                selectAllIcon.className = 'fa-solid fa-square-xmark';
            } else {
                selectAllText.textContent = 'Select All';
                selectAllIcon.className = 'fa-regular fa-square-check';
            }
        }
    }
    
    function downloadSelectedMerchants() {
        const selectedDivs = document.querySelectorAll('#merchantList .merchant-item.selected');
        if (selectedDivs.length === 0) return;

        let totalSelectedCases = 0;
        const merchantObjectsToDownload = Array.from(selectedDivs).map(div => {
            const key = div.dataset.key;
            totalSelectedCases += parseInt(div.dataset.count || '0', 10);
            return caseModeData.find(m => m.originalText === key);
        }).filter(Boolean);

        if (merchantObjectsToDownload.length === 0) return;

        const combinedText = merchantObjectsToDownload.map(getFormattedBlockWithVerification).join(merchantSeparator);
        const filename = `${getFilenamePrefix()}_${getFormattedDate()}_(${totalSelectedCases}).txt`;
        downloadFile(combinedText + '\n', filename, 'text/plain;charset=utf-8');
    }

    function processSingleROBlock(roBlockText, removalOrdersArray) {
        const roIdLineMatch = roBlockText.match(/^\s*Removal order ID:[^\n]+/);
        if (!roIdLineMatch) return;
        const currentRoIdLine = roIdLineMatch[0].trim();
        const remainingText = roBlockText.substring(roIdLineMatch[0].length).trim();
        if (!remainingText) return;
        const shipmentBlocks = remainingText.split(/(?=^\s*Shipment ID:)/m);
        shipmentBlocks.forEach((shipmentBlock) => {
            const trimmed = shipmentBlock.trim();
            if (trimmed.startsWith('Shipment ID:') && trimmed.includes('Merchant SKU:')) removalOrdersArray.push(currentRoIdLine + '\n' + trimmed);
        });
    }

    function splitTextIntoRemovalOrders(inputText) {
        const removalOrders = [];
        if (!inputText) return removalOrders;
        let textToProcess = inputText.trim();
        const escapedAmzl = amzlTemplate.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const escapedUps = upsUspsTemplate.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        textToProcess = textToProcess.replace(new RegExp('^\\s*' + escapedAmzl + '\\s*\\n*', 'gm'), '').replace(new RegExp('^\\s*' + escapedUps + '\\s*\\n*', 'gm'), '').trim();
        const lines = textToProcess.split('\n');
        if (lines.length > 2 && lines[1].trim() === "" && lines[2].startsWith("Removal order ID:")) textToProcess = lines.slice(2).join('\n');
        else if (lines.length > 0 && lines[0].startsWith("Removal order ID:")) textToProcess = lines.join('\n');
        const potentialROBlocks = textToProcess.split(/(?=^\s*Removal order ID:)/m);
        potentialROBlocks.forEach((roBlock) => {
            const trimmed = roBlock.trim();
            if (!trimmed) return;
            if (trimmed.startsWith('Removal order ID:')) processSingleROBlock(trimmed, removalOrders);
        });
        return removalOrders;
    }

    function createTemplates(removalOrders, ordersPerTemplate) {
        const templates = [];
        if (!removalOrders || removalOrders.length === 0 || ordersPerTemplate <= 0) return templates;
        for (let i = 0; i < removalOrders.length; i += ordersPerTemplate) {
            const chunk = removalOrders.slice(i, i + ordersPerTemplate).filter(o => o && typeof o === 'string');
            if (chunk.length > 0) templates.push(chunk.join('\n\n'));
        }
        return templates;
    }
    
    function updateCalculatedTemplates() {
        const modal = document.getElementById('splitModal');
        if (!modal) return;
        const combinedText = modal.dataset.combinedText || '';
        const ordersInput = document.getElementById('splitOrdersPerTemplate');
        const calcSpan = document.getElementById('splitCalculatedTemplates');
        if (!ordersInput || !calcSpan) return;
        const ordersPer = parseInt(ordersInput.value) || 0;
        if (ordersPer > 0 && combinedText) {
            const ros = splitTextIntoRemovalOrders(combinedText);
            calcSpan.textContent = createTemplates(ros, ordersPer).length;
        } else calcSpan.textContent = '0';
    }

    function generateAndDownloadSplits() {
        const modal = document.getElementById('splitModal');
        if (!modal) return;
        const combinedText = modal.dataset.combinedText || '';
        const ordersPer = parseInt(document.getElementById('splitOrdersPerTemplate').value);
        const splitNum = parseInt(document.getElementById('splitNumberInput').value);
        if (!combinedText || isNaN(ordersPer) || ordersPer < 1 || isNaN(splitNum) || splitNum < 1) {
             showNotification("Please enter valid numbers for splitting.", "error");
            return;
        }
        let templateToUse = (modal.dataset.containsUpsUsps === 'true' && modal.dataset.containsAmzl !== 'true') ? upsUspsTemplate : amzlTemplate;
        const ros = splitTextIntoRemovalOrders(combinedText);
        if (ros.length === 0) {
            showNotification("No valid removal orders found to split.", "info");
            return;
        }
        const templateGroups = createTemplates(ros, ordersPer);
        if (templateGroups.length === 0) {
            showNotification("Failed to generate template groups.", "error");
            return;
        }
        const splitOutputs = [];
        for (let i = 0; i < templateGroups.length; i += splitNum) {
            const chunk = templateGroups.slice(i, i + splitNum);
            if (chunk.length > 0) {
                 const chunkText = chunk.map(data => templateToUse + "\n\n" + data).join(caseSeparator);
                 splitOutputs.push({ text: chunkText, count: chunk.length });
            }
        }
        if (splitOutputs.length === 0) {
            showNotification("No split files generated.", "info");
            return;
        }
        
        const merchantDisplay = selectedMerchantDataForSplit.map(item => {
            const merchantObj = caseModeData.find(m => m.originalText === item.key);
            let name = item.name;
            if(merchantObj && isMerchantVerified(merchantObj)){
                name += ' ***Verified Removal***';
            }
            return name;
        }).join(' & ');

        let filenamePart = sanitizeFilename(selectedMerchantDataForSplit.length === 1 ? selectedMerchantDataForSplit[0].name : `${selectedMerchantDataForSplit[0].name}_Multi`);
        const dateStr = getFormattedDate();
        
        splitOutputs.forEach((output, index) => {
            const filename = `${getFilenamePrefix()}_${dateStr}_${filenamePart}_PART_${index+1}(${output.count}).txt`;
            const fileContent = merchantDisplay + '\n\n' + output.text + '\n';
            downloadFile(fileContent, filename, 'text/plain;charset=utf-8');
        });
        closeSplitModal();
    }
    
    async function generateAndSendSplitsToTelegram() {
        const splitModal = document.getElementById('splitModal');
        if (!splitModal) return;

        const combinedText = splitModal.dataset.combinedText || '';
        const ordersPer = parseInt(document.getElementById('splitOrdersPerTemplate').value);
        const splitNum = parseInt(document.getElementById('splitNumberInput').value);

        if (!combinedText || isNaN(ordersPer) || ordersPer < 1 || isNaN(splitNum) || splitNum < 1) {
            showNotification("Please enter valid numbers for splitting.", "error");
            return;
        }

        let templateToUse = (splitModal.dataset.containsUpsUsps === 'true' && splitModal.dataset.containsAmzl !== 'true') ? upsUspsTemplate : amzlTemplate;
        const ros = splitTextIntoRemovalOrders(combinedText);
        if (ros.length === 0) {
            showNotification("No valid removal orders found to split.", "info");
            return;
        }
        const templateGroups = createTemplates(ros, ordersPer);
        const splitOutputs = [];
        for (let i = 0; i < templateGroups.length; i += splitNum) {
            const chunk = templateGroups.slice(i, i + splitNum);
             if (chunk.length > 0) {
                 const chunkText = chunk.map(data => templateToUse + "\n\n" + data).join(caseSeparator);
                 splitOutputs.push({ text: chunkText, count: chunk.length });
            }
        }
        if (splitOutputs.length === 0) {
            showNotification("No split files to send.", "info");
            return;
        }

        const merchantDisplay = selectedMerchantDataForSplit.map(item => {
            const merchantObj = caseModeData.find(m => m.originalText === item.key);
            let name = item.name;
            if(merchantObj && isMerchantVerified(merchantObj)){
                name += ' ***Verified Removal***';
            }
            return name;
        }).join(' & ');
        
        const preSendModal = document.getElementById('preSendConfirmModal');
        const fileListEl = document.getElementById('preSendFileList');
        fileListEl.innerHTML = '';
        
        preSendModal.dataset.filesToSend = JSON.stringify(splitOutputs);
        preSendModal.dataset.merchantDisplay = merchantDisplay;

        let filenamePart = sanitizeFilename(selectedMerchantDataForSplit.length === 1 ? selectedMerchantDataForSplit[0].name : `${selectedMerchantDataForSplit[0].name}_Multi`);
        const dateStr = getFormattedDate();
        
        splitOutputs.forEach((output, index) => {
            const filename = `${getFilenamePrefix()}_${dateStr}_${filenamePart}_PART_${index+1}(${output.count}).txt`;
            const fileItem = document.createElement('div');
            fileItem.style.cssText = 'display: flex; align-items: center; gap: 10px; margin-bottom: 8px;';
            fileItem.innerHTML = `
                <i class="fa-solid fa-file-lines" style="color: var(--text-secondary);"></i>
                <div class="macos-textfield-container" style="flex-grow:1;">
                    <input type="text" class="macos-textfield pre-send-filename-input" value="${filename}">
                </div>
            `;
            fileListEl.appendChild(fileItem);
        });
        
        preSendModal.style.display = 'flex';
    }

    async function executeTelegramsendsFromModal() {
        const modal = document.getElementById('preSendConfirmModal');
        const sendButton = document.getElementById('btnConfirmAndSend');
        
        sendButton.disabled = true;
        sendButton.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Sending...';

        const filesToSend = JSON.parse(modal.dataset.filesToSend || '[]');
        const merchantDisplay = modal.dataset.merchantDisplay || '';
        const filenameInputs = document.querySelectorAll('#preSendFileList .pre-send-filename-input');

        if (filesToSend.length !== filenameInputs.length) {
            showNotification('File data mismatch. Please try again.', 'error');
            sendButton.disabled = false;
            sendButton.innerHTML = '<i class="fa-solid fa-paper-plane"></i> Send Files';
            return;
        }

        const sendPromises = filesToSend.map((fileData, index) => {
            const filename = filenameInputs[index].value.trim();
            if (!filename) return Promise.resolve({ success: false, filename: '(empty)' }); // Skip empty filenames
            const fileContent = merchantDisplay + '\n\n' + fileData.text + '\n';
            return sendFileToTelegram(fileContent, filename, '');
        });

        const results = await Promise.all(sendPromises);
        const successfulSends = results.filter(r => r && r.success);
            
        sendButton.disabled = false;
        sendButton.innerHTML = '<i class="fa-solid fa-paper-plane"></i> Send Files';
        modal.style.display = 'none';
        closeSplitModal();

        if (successfulSends.length > 0) {
            merchantsToDeleteAfterSend = selectedMerchantDataForSplit.map(m => ({
                key: m.key,
                displayName: m.name,
                count: parseInt(m.count)
            }));
            const fileInfo = successfulSends.map(r => ({ filename: r.filename }));
            addToHistory(merchantsToDeleteAfterSend, fileInfo);
            document.getElementById('confirmDeleteSentModal').style.display = 'flex';
        }
    }

    function addSeparator() {
        const ta = document.getElementById('noteArea');
        const trimmed = ta.value.trimEnd();
        ta.value = trimmed + (trimmed ? merchantSeparator : '');
        ta.focus();
        countTemplatesNoteTaker();
        recordNoteChange();
    }

    function confirmAndClearAllNotes() {
        document.getElementById('clearAllConfirmModal').style.display = 'none';
        const noteArea = document.getElementById('noteArea');
        const deletedMerchants = [];
        const sections = noteArea.value.split(merchantSeparatorRegex);
        sections.forEach(sectionText => {
            if (sectionText.trim()) {
                const count = countTemplatesInText(sectionText, amzlTemplate) + countTemplatesInText(sectionText, upsUspsTemplate);
                const displayName = sectionText.split('\n')[0].trim();
                deletedMerchants.push({ key: sectionText, displayName, count });
            }
        });
        if (deletedMerchants.length > 0) {
            addToHistory(deletedMerchants);
        }
        noteArea.value = '';
        localStorage.removeItem(caseModeStateKey);
        localStorage.removeItem(matchedRoIdsKey);
        Object.keys(localStorage).filter(key => key.startsWith('case-')).forEach(key => localStorage.removeItem(key));

        countTemplatesNoteTaker();
        recordNoteChange();
        document.getElementById('clearAllSuccessPopup').style.display = 'flex';
    }

    function saveNotesToLocalStorage() {
        const noteArea = document.getElementById('noteArea');
        if (noteArea) {
            updateStateContent(noteArea.value);
            localStorage.setItem(scrollPosKeys.noteArea, noteArea.scrollTop);
        }
    }
    
    function saveUpsUspsOutputToLocalStorage() {
        const upsUspsOutputArea = document.getElementById('upsUspsOutputArea');
        if (upsUspsOutputArea) {
            localStorage.setItem(upsUspsOutputKey, upsUspsOutputArea.value);
            localStorage.setItem(scrollPosKeys.upsUspsOutputArea, upsUspsOutputArea.scrollTop);
        }
    }
    
    function saveShipmentInputScroll() {
        const shipmentInput = document.getElementById('shipmentInput');
        if (shipmentInput) {
            localStorage.setItem(scrollPosKeys.shipmentInput, shipmentInput.scrollTop);
        }
    }

    function saveUpsUspsContextToLocalStorage() {
        try {
            localStorage.setItem(upsUspsContextKey, JSON.stringify(tempUpsUspsData));
        } catch (error) {
            console.error("Error saving Other Carrier context to localStorage:", error);
        }
    }

    function restoreScrollPositions() {
        const shipmentInputEl = document.getElementById('shipmentInput');
        const upsUspsOutputAreaEl = document.getElementById('upsUspsOutputArea');
        const noteAreaEl = document.getElementById('noteArea');
        if (shipmentInputEl) shipmentInputEl.scrollTop = parseInt(localStorage.getItem(scrollPosKeys.shipmentInput)) || 0;
        if (upsUspsOutputAreaEl) upsUspsOutputAreaEl.scrollTop = parseInt(localStorage.getItem(scrollPosKeys.upsUspsOutputArea)) || 0;
        if (noteAreaEl) noteAreaEl.scrollTop = parseInt(localStorage.getItem(scrollPosKeys.noteArea)) || 0;
    }
    
    function saveAllScrollPositions() {
        saveShipmentInputScroll();
        saveUpsUspsOutputToLocalStorage();
        saveNotesToLocalStorage();
    }
    
    function initDraggableWindows() {
        const handles = document.querySelectorAll('.resize-handle');
        handles.forEach(handle => {
            const container = handle.closest('.tool-container');
            if (!container || container.classList.contains('parser-tool')) return;
            let initialHeight, initialY;
            const onMouseMove = (e) => {
                const dy = e.clientY - initialY;
                let newHeight = initialHeight + dy;
                const minHeight = parseInt(getComputedStyle(container).minHeight) || 150;
                if (newHeight < minHeight) newHeight = minHeight;
                container.style.height = `${newHeight}px`;
            };
            const onMouseUp = () => {
                document.body.classList.remove('is-resizing');
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            };
            handle.addEventListener('mousedown', (e) => {
                e.preventDefault();
                initialHeight = container.offsetHeight;
                initialY = e.clientY;
                document.body.classList.add('is-resizing');
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });
        });
    }

    function updateNoteUndoRedoButtons() {
        const undoBtn = document.getElementById('btnUndoNote');
        const redoBtn = document.getElementById('btnRedoNote');
        undoBtn.disabled = noteHistoryIndex <= 0;
        redoBtn.disabled = noteHistoryIndex >= noteHistory.length - 1;
    }

    function recordNoteChange() {
        if (isUndoRedoAction) {
            isUndoRedoAction = false;
            return;
        }
        const noteArea = document.getElementById('noteArea');
        const currentValue = noteArea.value;
        if (noteHistory[noteHistoryIndex] === currentValue) return;

        noteHistory = noteHistory.slice(0, noteHistoryIndex + 1);
        noteHistory.push(currentValue);
        noteHistoryIndex = noteHistory.length - 1;
        updateNoteUndoRedoButtons();
    }

    function handleNoteUndo() {
        if (noteHistoryIndex > 0) {
            isUndoRedoAction = true;
            noteHistoryIndex--;
            document.getElementById('noteArea').value = noteHistory[noteHistoryIndex];
            countTemplatesNoteTaker();
            updateNoteUndoRedoButtons();
        }
    }

    function handleNoteRedo() {
        if (noteHistoryIndex < noteHistory.length - 1) {
            isUndoRedoAction = true;
            noteHistoryIndex++;
            document.getElementById('noteArea').value = noteHistory[noteHistoryIndex];
            countTemplatesNoteTaker();
            updateNoteUndoRedoButtons();
        }
    }

    function generateReportUrl() {
        const marketplaceDomain = `sellercentral.amazon.${appSettings.marketplaceUrlGen}`;
        const today = new Date();
        const endDate = new Date();
        endDate.setDate(today.getDate() - 15);
        const startDate = new Date();
        startDate.setDate(today.getDate() - 75);
        const formatUrlDate = (date) => {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}/${m}/${d}`;
        };
        const urlStartDate = formatUrlDate(startDate);
        const urlEndDate = formatUrlDate(endDate);
        const reportJsonPayload = { filters: ["", "", "", "RETURN", "COMPLETE"], pageOffset: 1, searchDays: -1, startDate: urlStartDate, endDate: urlEndDate };
        const jsonString = JSON.stringify(reportJsonPayload);
        let encodedPayload = encodeURIComponent(jsonString)
            .replace(/%3A/g, ':').replace(/%2C/g, ',')
            .replace(/%5B/g, '[').replace(/%5D/g, ']')
            .replace(/%2F/g, '/');
        return `https://${marketplaceDomain}/reportcentral/REMOVAL_ORDER_DETAIL/0/${encodedPayload}`;
    }

    function openReportUrl() {
        const url = generateReportUrl();
        window.open(url, '_blank');
    }

    // --- MODAL MANAGEMENT FUNCTIONS ---
    function openTelegramSendModal() {
        const selectedDivs = document.querySelectorAll('#merchantList .merchant-item.selected');
        if (selectedDivs.length === 0) {
            showNotification("Please select at least one merchant to send.", "info");
            return;
        }

        const modal = document.getElementById('telegramSendModal');
        const listContainer = document.getElementById('telegram-merchant-list');
        
        const merchantsToSend = Array.from(selectedDivs).map(div => ({
            key: div.dataset.key,
            name: div.dataset.displayName,
            count: parseInt(div.dataset.count, 10)
        }));
        
        modal.dataset.merchantsToSend = JSON.stringify(merchantsToSend);

        const totalCases = merchantsToSend.reduce((sum, m) => sum + m.count, 0);
        const dateStr = getFormattedDate();
        let filenamePart;
        if (merchantsToSend.length === 1) {
            filenamePart = sanitizeFilename(merchantsToSend[0].name);
        } else {
            filenamePart = sanitizeFilename(`${merchantsToSend[0].name}_Multi_${merchantsToSend.length}`);
        }
        const defaultFilename = `${getFilenamePrefix()}_${dateStr}_${filenamePart}(${totalCases}).txt`;

        let lastNumber = parseInt(localStorage.getItem(telegramNumberKey)) || 0;
        const newNumber = lastNumber + 1;

        const merchantListHtml = merchantsToSend.map(m => `<p>${m.name} (${m.count} cases)</p>`).join('');

        listContainer.innerHTML = `
            <h4>Selected Merchants:</h4>
            ${merchantListHtml}
            <hr style="border:none; border-top: 1px solid var(--border-subtle); margin: 12px 0;">
            <div class="settings-group">
                <label for="telegram-filename-edit">Filename:</label>
                <div class="macos-textfield-container">
                    <input type="text" id="telegram-filename-edit" class="macos-textfield" value="${defaultFilename}">
                </div>
            </div>
            <div class="settings-group">
                <label for="telegram-file-number-single">File Number (for tracking):</label>
                <div class="macos-textfield-container" style="width: 80px;">
                    <input type="number" id="telegram-file-number-single" class="macos-textfield" style="text-align:center;" min="1" value="${newNumber}">
                </div>
            </div>
        `;

        modal.style.display = 'flex';
    }

    function closeTelegramSendModal() {
        document.getElementById('telegramSendModal').style.display = 'none';
    }

    function openSplitModal() {
        const selectedDivs = document.querySelectorAll('#merchantList .merchant-item.selected');
        if (selectedDivs.length === 0) {
            showNotification("Please select at least one merchant to split.", "info");
            return;
        }
        
        selectedMerchantDataForSplit = Array.from(selectedDivs).map(div => ({
            key: div.dataset.key,
            name: div.dataset.displayName,
            count: div.dataset.count
        }));
        
        const combinedText = selectedMerchantDataForSplit.map(item => item.key).join(merchantSeparator);
        const totalCases = selectedMerchantDataForSplit.reduce((sum, item) => sum + parseInt(item.count, 10), 0);
        const containsAmzl = combinedText.includes(amzlTemplate);
        const containsUpsUsps = combinedText.includes(upsUspsTemplate);

        const modal = document.getElementById('splitModal');
        modal.dataset.combinedText = combinedText;
        modal.dataset.containsAmzl = containsAmzl;
        modal.dataset.containsUpsUsps = containsUpsUsps;

        const infoDiv = document.getElementById('splitMerchantInfo');
        const merchantNames = selectedMerchantDataForSplit.map(m => m.name).join(', ');
        infoDiv.textContent = `Splitting ${selectedMerchantDataForSplit.length} merchant(s): ${merchantNames} (${totalCases} total cases).`;

        document.getElementById('splitOrdersPerTemplate').value = 1;
        document.getElementById('splitNumberInput').value = 100;
        updateCalculatedTemplates();

        modal.style.display = 'flex';
    }

    function closeSplitModal() {
        document.getElementById('splitModal').style.display = 'none';
    }

    function openSettingsModal() {
        document.getElementById('settingsModal').style.display = 'flex';
    }

    function closeSettingsModal() {
        document.getElementById('settingsModal').style.display = 'none';
    }
    
    function openHistoryModal() {
        renderHistoryModal();
        document.getElementById('historyModal').style.display = 'flex';
    }
    
    function closeHistoryModal() {
        document.getElementById('historyModal').style.display = 'none';
    }

    function openClearHistoryConfirmModal() {
        document.getElementById('confirmClearHistoryModal').style.display = 'flex';
    }

    function closeClearHistoryConfirmModal() {
        document.getElementById('confirmClearHistoryModal').style.display = 'none';
    }
    
    function handleClearAllHistory() {
        localStorage.removeItem(historyKey);
        renderHistoryModal();
        closeClearHistoryConfirmModal();
        showNotification("All history cleared.", "success");
    }

    // --- CASE MODE ---
    
    function toggleCaseMode() {
        const mainWrapper = document.getElementById('mainWrapper');
        const caseModeWrapper = document.getElementById('caseModeWrapper');
        const caseModeBtn = document.getElementById('btnCaseMode');
        const isActivating = caseModeWrapper.style.display === 'none';

        if (isActivating) {
            mainWrapper.style.display = 'none';
            caseModeWrapper.style.display = 'flex';
            if (caseModeBtn) caseModeBtn.classList.add('active');
            localStorage.setItem(caseModeActiveKey, 'true');
            initCaseMode();
        } else if (!document.body.classList.contains('is-standalone-mode')) {
            mainWrapper.style.display = 'flex';
            caseModeWrapper.style.display = 'none';
            if (caseModeBtn) caseModeBtn.classList.remove('active');
            localStorage.removeItem(caseModeActiveKey);
        }
    }

    function initCaseMode() {
        parseNotesForCaseMode();
        renderCaseModeUI();
        applyTabLayout();
    }
    
    function saveFilerViewState() {
        if (!document.body.classList.contains('is-standalone-mode')) return;

        const state = {
            caseModeData: caseModeData,
            appSettings: {
                caseTextPosition: appSettings.caseTextPosition,
                showCopyTitleBtn: appSettings.showCopyTitleBtn,
            }
        };
        localStorage.setItem(filerViewStateKey, JSON.stringify(state));
    }
    
    function initStandaloneMode(payload) {
        document.body.classList.add('is-standalone-mode');
        
        // Initial load from payload
        if (payload.settings) {
            appSettings.showCopyTitleBtn = payload.settings.showCopyTitleBtn;
            appSettings.marketplaceUrlGen = payload.settings.marketplaceUrlGen;
        }
        caseModeData = payload.data || (Array.isArray(payload) ? payload : []);
        appSettings.caseTextPosition = payload.layout || 'left';
        matchedRoIds = new Set(payload.matched || []);
        
        // Check for persistent state and override
        const savedStateJSON = localStorage.getItem(filerViewStateKey);
        if (savedStateJSON) {
            try {
                const savedState = JSON.parse(savedStateJSON);
                // Simple check to see if the saved data might match the payload data
                if (savedState.caseModeData && savedState.caseModeData[0]?.id === caseModeData[0]?.id) {
                    caseModeData = savedState.caseModeData;
                    if (savedState.appSettings) {
                        appSettings.caseTextPosition = savedState.appSettings.caseTextPosition;
                        appSettings.showCopyTitleBtn = savedState.appSettings.showCopyTitleBtn;
                    }
                }
            } catch(e) { console.error("Could not load Filer View state.", e); localStorage.removeItem(filerViewStateKey); }
        }

        // Set initial UI state
        document.getElementById('marketplaceSelectUrlGen').value = appSettings.marketplaceUrlGen;
        document.getElementById('btnToggleCopyTitle').classList.toggle('active', appSettings.showCopyTitleBtn);

        if (caseModeData.length > 0) {
            activeCaseModeTabId = caseModeData[0].id;
        }
        document.getElementById('mainWrapper').style.display = 'none';
        document.getElementById('caseModeWrapper').style.display = 'flex';
        renderCaseModeUI();
        applyCaseCardLayout();
        applyTabLayout();
    }
    
    function exportCaseTrackerFile() {
        parseNotesForCaseMode(); // Ensure data is current
        const selectedDivs = document.querySelectorAll('#merchantList .merchant-item.selected');
        if (selectedDivs.length === 0) {
            showNotification("No merchants selected to export.", "info");
            return;
        }

        const selectedKeys = new Set(Array.from(selectedDivs, div => div.dataset.key));
        const selectedMerchantsData = caseModeData.filter(m => selectedKeys.has(m.originalText));

        if (selectedMerchantsData.length === 0) {
            showNotification("Could not find data for selected merchants.", "error");
            return;
        }
        
        const totalCases = selectedMerchantsData.reduce((sum, m) => sum + m.cases.length, 0);
        let filenamePart;
        if (selectedMerchantsData.length === 1) {
            filenamePart = sanitizeFilename(selectedMerchantsData[0].displayName);
        } else if (selectedMerchantsData.length > 1) {
            filenamePart = sanitizeFilename(`${selectedMerchantsData[0].displayName}_Multi`);
        } else {
            filenamePart = 'FilerView'; // Fallback
        }

        const filename = `${getFilenamePrefix()}_${getFormattedDate()}_${filenamePart}(${totalCases})_FilerView.html`;

        const payload = {
            data: selectedMerchantsData,
            layout: appSettings.caseTextPosition,
            matched: Array.from(matchedRoIds),
            settings: {
                showCopyTitleBtn: appSettings.showCopyTitleBtn,
                marketplaceUrlGen: appSettings.marketplaceUrlGen
            }
        };
        
        const payloadString = `const standalonePayload = ${JSON.stringify(payload)};`;
        
        let fileContent = document.documentElement.outerHTML;
        fileContent = fileContent.replace('// STANDALONE_DATA_PLACEHOLDER', payloadString);

        downloadFile(fileContent, filename, 'text/html;charset=utf-8');
        showNotification("Filer View HTML file has been downloaded.", "success");
    }

    function exportSingleMerchantFilerView(merchant) {
        if (!merchant) return;

        const totalCases = merchant.cases.length;
        const filenamePart = sanitizeFilename(merchant.displayName);
        const filename = `${getFilenamePrefix()}_${getFormattedDate()}_${filenamePart}(${totalCases})_FilerView.html`;

        const payload = {
            data: [merchant], // Pass as an array with one item
            layout: appSettings.caseTextPosition,
            matched: Array.from(matchedRoIds),
            settings: {
                showCopyTitleBtn: appSettings.showCopyTitleBtn,
                marketplaceUrlGen: appSettings.marketplaceUrlGen
            }
        };
        
        const payloadString = `const standalonePayload = ${JSON.stringify(payload)};`;
        
        let fileContent = document.documentElement.outerHTML;
        fileContent = fileContent.replace('// STANDALONE_DATA_PLACEHOLDER', payloadString);

        downloadFile(fileContent, filename, 'text/html;charset=utf-8');
        showNotification(`Filer View for ${merchant.displayName} downloaded.`, "success");
    }

    function generateUID(merchantId, caseIndex, text) {
        let hash = 0;
        if (text.length === 0) return `case-${merchantId}-${caseIndex}-${hash}`;
        for (let i = 0; i < text.length; i++) {
            const char = text.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash |= 0;
        }
        return `case-${merchantId}-${caseIndex}-${hash}`;
    }

    function parseNotesForCaseMode() {
        const noteArea = document.getElementById('noteArea');
        if (!noteArea || document.body.classList.contains('is-standalone-mode')) return; // Don't re-parse in standalone
        const fullText = noteArea.value;
        caseModeData = [];
        let merchantIndex = 0;
        const merchantBlocks = fullText.split(merchantSeparatorRegex).filter(b => b.trim());

        merchantBlocks.forEach(block => {
            let merchantName = `Merchant ${++merchantIndex}`;
            let casesText = block.trim();
            const firstLine = block.trim().split('\n')[0].trim();
            if (firstLine && !firstLine.startsWith(amzlTemplate.substring(0, 10)) && !firstLine.startsWith(upsUspsTemplate.substring(0, 10)) && firstLine.length < 100) {
                 merchantName = firstLine;
                 casesText = block.trim().substring(firstLine.length).trim();
            }

            const merchantId = sanitizeFilename(merchantName).replace(/ /g, '-');
            const merchantObject = {
                id: merchantId,
                displayName: merchantName,
                originalText: block,
                isCompleted: false, // For Filer View toggling
                cases: []
            };
            
            const caseTemplatesRaw = casesText.split(caseSeparatorRegex).filter(c => c.trim());
            const separatorLine = '────────────────────────────────';

            const caseTemplates = caseTemplatesRaw.map(template => {
                let cleanedTemplate = template.trim();
                if (cleanedTemplate.startsWith(separatorLine)) {
                    cleanedTemplate = cleanedTemplate.substring(separatorLine.length).trim();
                }
                return cleanedTemplate;
            }).filter(c => c);

            caseTemplates.forEach((caseText, caseIdx) => {
                const uid = generateUID(merchantId, caseIdx, caseText);
                merchantObject.cases.push({
                    uid: uid,
                    text: caseText,
                    filedId: document.body.classList.contains('is-standalone-mode') ? null : localStorage.getItem(uid) || null,
                });
            });
            
            if (merchantObject.cases.length > 0) {
                caseModeData.push(merchantObject);
            }
        });

        const savedState = JSON.parse(localStorage.getItem(caseModeStateKey));
        if (savedState && savedState.activeTabId && caseModeData.some(m => m.id === savedState.activeTabId)) {
            activeCaseModeTabId = savedState.activeTabId;
        } else if (caseModeData.length > 0) {
            activeCaseModeTabId = caseModeData[0].id;
        } else {
            activeCaseModeTabId = null;
        }
        saveCaseModeState();
    }

    function saveCaseModeState() {
        if (document.body.classList.contains('is-standalone-mode')) return;
        const state = JSON.parse(localStorage.getItem(caseModeStateKey)) || {};
        state.activeTabId = activeCaseModeTabId;
        localStorage.setItem(caseModeStateKey, JSON.stringify(state));
    }

    function renderCaseModeUI() {
        const tabContainer = document.getElementById('caseModeTabContainer');
        const contentContainer = document.getElementById('caseModeTabContents');
        const state = JSON.parse(localStorage.getItem(caseModeStateKey)) || {};
        updateFileInfo(state.fileNames);
        tabContainer.innerHTML = '';
        contentContainer.innerHTML = '';

        if (caseModeData.length === 0) {
            tabContainer.innerHTML = '<p>No cases found. Use the Parser to add data.</p>';
            updateCaseModeStats();
            return;
        }

        caseModeData.forEach(merchant => {
            const filedCount = merchant.cases.filter(c => c.filedId !== null).length;
            const totalCount = merchant.cases.length;
            
            const tabBtn = document.createElement('div');
            tabBtn.className = 'case-mode-tab-button';
            tabBtn.dataset.tabId = merchant.id;
            
            const actionButtonHtml = `
                <button class="tab-action-btn toggle-complete-btn" title="Toggle Completion Status"><i class="fa-regular fa-circle"></i></button>
                <button class="tab-action-btn delete-merchant-btn non-standalone" title="Delete Merchant"><i class="fa-solid fa-times"></i></button>
            `;


            tabBtn.innerHTML = `
                <span class="case-mode-merchant-name" title="${merchant.displayName}">${merchant.displayName}</span>
                <div class="case-mode-tab-bottom-row">
                    <button class="copy-merchant-btn" title="Copy Name"><i class="fa-regular fa-copy"></i></button>
                    <span class="case-mode-tab-meta">${filedCount}/${totalCount}</span>
                    ${actionButtonHtml}
                </div>
            `;
            if (merchant.id === activeCaseModeTabId) tabBtn.classList.add('active');
            if ((filedCount === totalCount && totalCount > 0) || merchant.isCompleted) tabBtn.classList.add('done');
            
            tabContainer.appendChild(tabBtn);

            const tabContent = document.createElement('div');
            tabContent.id = `case-content-${merchant.id}`;
            tabContent.className = 'case-mode-tab-content';
            if (merchant.id === activeCaseModeTabId) tabContent.classList.add('active');
            
            tabContent.innerHTML = `
                <div class="case-mode-tab-content-header">
                    <div class="tab-actions-left">
                       <button class="macos secondary" data-action="view-ro-ids" ${totalCount === 0 ? 'disabled' : ''}><i class="fa-solid fa-list-ol"></i> View RO IDs</button>
                       <button class="macos secondary" data-action="open-report-url"><i class="fa-solid fa-arrow-up-right-from-square"></i> Open Report URL</button>
                       <button class="macos primary non-standalone" data-action="export-filer-view" data-merchant-id="${merchant.id}"><i class="fa-solid fa-file-export"></i> Export Filer View</button>
                    </div>
                    <div class="tab-actions-right">
                        <label class="macos-checkbox-container" style="font-weight: normal; font-size: 0.85rem; margin-right: 8px;">
                            <input type="checkbox" class="macos-checkbox exclude-non-numeric-local" checked> Exclude non-Case IDs
                        </label>
                       <button class="macos success" data-action="copy-merchant-ids" data-merchant-id="${merchant.id}" ${filedCount === 0 ? 'disabled' : ''}>
                           <i class="fa-solid fa-copy"></i>Copy ${filedCount} ID(s)
                       </button>
                    </div>
                </div>
            `;
            
            const casesList = document.createElement('div');
            merchant.cases.forEach((caseItem, index) => {
                casesList.appendChild(createCaseCard(caseItem, index + 1));
            });
            tabContent.appendChild(casesList);
            contentContainer.appendChild(tabContent);
        });

        addCaseModeEventListeners();
        updateCaseModeStats();
        updateCaseCardMatchStatus();
        applyCopyTitleButtonVisibility();
    }
    
    function createCaseCard(caseItem, number) {
        const roIdMatch = caseItem.text.match(/Removal order ID:\s*(\S+)/);
        const roId = roIdMatch ? roIdMatch[1] : null;
        const isMatched = roId && matchedRoIds.has(roId);
        const controlsDisabled = !isMatched ? 'disabled' : '';

        const card = document.createElement('div');
        card.className = 'case-card';
        card.id = caseItem.uid;
        
        card.innerHTML = `
            <div class="card-content">
                <div class="left-pane">
                    <span class="ro-match-indicator"><i class="fa-solid fa-check-circle"></i></span>
                    <div class="case-number">${number}</div>
                    <div class="main-content">
                        <div class="case-text">${caseItem.text}</div>
                        <div class="editing-info">
                            <div class="macos-textfield-container">
                                <input type="text" class="macos-textfield case-id-input" placeholder="Update Case ID..." value="${caseItem.filedId || ''}">
                            </div>
                            <button class="macos danger" data-action="delete-case"><i class="fa-solid fa-trash"></i></button>
                            <button class="macos primary" data-action="update-case"><i class="fa-solid fa-save"></i>Update</button>
                        </div>
                        <div class="filed-info">
                            <span class="case-id-display">${caseItem.filedId || ''}</span>
                        </div>
                    </div>
                </div>
                <div class="right-pane">
                    <div class="unfiled-controls">
                         <div class="case-id-input-group">
                            <div class="macos-textfield-container">
                                 <input type="text" class="macos-textfield case-id-input" placeholder="Enter Case ID..." ${controlsDisabled}>
                            </div>
                            <button class="macos-icon-button success" data-action="save-case" title="Save Case ID" ${controlsDisabled}><i class="fa-solid fa-save"></i></button>
                        </div>
                        <hr style="border: none; border-top: 1px solid var(--border-subtle); margin: 8px 0;" />
                        <button class="macos primary" data-action="copy-text" style="padding-top: 8px; padding-bottom: 8px; margin-top: 8px;" ${controlsDisabled}><i class="fa-solid fa-copy"></i>Copy Template</button>
                        <button class="macos secondary copy-case-title" data-action="copy-case-title" style="width: 100%;"><i class="fa-solid fa-heading"></i>Copy Case Title</button>
                    </div>
                    <div class="filed-controls">
                        <button class="macos secondary" data-action="view-case">View</button>
                        <button class="macos primary" data-action="copy-id">Copy ID</button>
                        <button class="macos warning" data-action="edit-case">Edit</button>
                    </div>
                </div>
            </div>`;
        
        const cardContent = card.querySelector('.card-content');
        if (appSettings.caseTextPosition === 'right') {
            cardContent.classList.add('layout-right');
        }

        if (caseItem.filedId !== null) {
            card.classList.add('filed');
        } else {
            card.classList.add('unfiled');
        }
        
        const inputs = card.querySelectorAll('.case-id-input');
        inputs.forEach(input => input.addEventListener('paste', handleCasePaste));

        return card;
    }

    function addCaseModeEventListeners() {
        const tabContainer = document.getElementById('caseModeTabContainer');
        const contentContainer = document.getElementById('caseModeTabContents');
        
        tabContainer.addEventListener('click', e => {
            const copyBtn = e.target.closest('.copy-merchant-btn');
            if (copyBtn) {
                e.stopPropagation();
                const merchantId = copyBtn.closest('.case-mode-tab-button').dataset.tabId;
                const merchant = caseModeData.find(m => m.id === merchantId);
                if (merchant) {
                    navigator.clipboard.writeText(merchant.displayName);
                    showNotification(`Copied: ${merchant.displayName}`, 'success');
                }
                return;
            }

            const deleteBtn = e.target.closest('.delete-merchant-btn');
            if (deleteBtn) {
                e.stopPropagation();
                const merchantId = deleteBtn.closest('.case-mode-tab-button').dataset.tabId;
                handleDeleteMerchant(merchantId);
                return;
            }

            const completeBtn = e.target.closest('.toggle-complete-btn');
            if (completeBtn) {
                e.stopPropagation();
                const tabButton = completeBtn.closest('.case-mode-tab-button');
                const merchantId = tabButton.dataset.tabId;
                const merchant = caseModeData.find(m => m.id === merchantId);
                if(merchant) {
                    merchant.isCompleted = !merchant.isCompleted;
                    tabButton.classList.toggle('done', merchant.isCompleted);
                    completeBtn.innerHTML = merchant.isCompleted ? `<i class="fa-solid fa-check-circle"></i>` : `<i class="fa-regular fa-circle"></i>`;
                }
                saveFilerViewState();
                return;
            }
            
            const tabButton = e.target.closest('.case-mode-tab-button');
             if (tabButton && !tabButton.classList.contains('active')) {
                // Deactivate old tab
                const oldActiveTab = document.querySelector('.case-mode-tab-button.active');
                if (oldActiveTab) {
                    oldActiveTab.classList.remove('active');
                    const oldContent = document.getElementById(`case-content-${oldActiveTab.dataset.tabId}`);
                    if (oldContent) oldContent.classList.remove('active');
                }

                // Activate new tab
                tabButton.classList.add('active');
                activeCaseModeTabId = tabButton.dataset.tabId;
                const newContent = document.getElementById(`case-content-${activeCaseModeTabId}`);
                if (newContent) newContent.classList.add('active');

                saveCaseModeState();
            }
        });

        contentContainer.addEventListener('click', e => {
            const button = e.target.closest('button');
            if (!button) return;
            
            if (button.closest('.case-card')) {
                handleCaseCardAction(button);
                return;
            }
            
            const merchant = caseModeData.find(m => m.id === activeCaseModeTabId);
            if (!merchant) return;

            const action = button.dataset.action;
            const exclude = button.parentElement.querySelector('.exclude-non-numeric-local')?.checked || false;

            if (action === 'copy-merchant-ids') {
                const filteredCases = merchant.cases.filter(c => c.filedId !== null && (!exclude || /^\d+$/.test(c.filedId)));
                if (filteredCases.length > 0) {
                    const ids = filteredCases.map(c => c.filedId).join('\n');
                    navigator.clipboard.writeText(`${merchant.displayName}\n${ids}`);
                    showNotification(`Copied ${filteredCases.length} formatted IDs for ${merchant.displayName}`, 'success');
                } else {
                    showNotification(`No matching IDs to copy.`, 'info');
                }
            } else if (action === 'view-ro-ids') {
                viewRemovalOrderIds(merchant);
            } else if (action === 'open-report-url') {
                openReportUrl();
            } else if (action === 'export-filer-view') {
                const merchantId = button.dataset.merchantId;
                const merchantToExport = caseModeData.find(m => m.id === merchantId);
                if (merchantToExport) {
                    exportSingleMerchantFilerView(merchantToExport);
                }
            }
        });
        
    }

    function handleCasePaste(event) {
        // Removed auto-save functionality as requested. User must click to save.
    }
    
    function handleCaseCardAction(button) {
        const card = button.closest('.case-card');
        const caseItem = findCaseByUID(card.id);
        if (!caseItem) return;

        const action = button.dataset.action;

        switch(action) {
            case 'copy-text':
                navigator.clipboard.writeText(caseItem.text);
                showNotification('Case text copied!', 'success');
                break;
            case 'copy-case-title':
                 navigator.clipboard.writeText('REMOVAL ORDER - LOST OUTBOUND');
                showNotification('Case title copied', 'success');
                break;
            case 'save-case':
            case 'update-case':
                const inputSelector = action === 'save-case' ? '.unfiled-controls input' : '.editing-info input';
                const input = card.querySelector(inputSelector);
                const newId = input.value.trim();

                caseItem.filedId = newId ? newId : null;
                
                if (newId) {
                    if (!document.body.classList.contains('is-standalone-mode')) {
                        localStorage.setItem(caseItem.uid, newId);
                    }
                    card.classList.add('filed');
                    card.classList.remove('unfiled', 'editing');
                    showNotification('Case ID saved!', 'success');
                } else {
                    if (!document.body.classList.contains('is-standalone-mode')) {
                        localStorage.removeItem(caseItem.uid);
                    }
                    card.classList.add('unfiled');
                    card.classList.remove('filed', 'editing');
                    card.querySelector('.unfiled-controls input.case-id-input').value = '';
                    showNotification('Case ID cleared.', 'info');
                }
                card.querySelector('.case-id-display').textContent = newId;
                updateCaseModeStats();
                saveFilerViewState();
                break;
            case 'view-case':
                document.getElementById('caseTextModalContent').textContent = caseItem.text;
                document.getElementById('caseTextModal').style.display = 'flex';
                break;
            case 'copy-id':
                navigator.clipboard.writeText(caseItem.filedId);
                showNotification('Case ID copied!', 'success');
                break;
            case 'edit-case':
                card.classList.add('editing');
                card.classList.remove('filed');
                break;
            case 'delete-case':
                if (confirm('Are you sure you want to clear this case ID? This will mark it as un-filed.')) {
                    caseItem.filedId = null;
                     if (!document.body.classList.contains('is-standalone-mode')) {
                        localStorage.removeItem(caseItem.uid);
                    }
                    card.querySelector('.unfiled-controls input').value = '';
                    card.classList.remove('filed', 'editing');
                    card.classList.add('unfiled');
                    updateCaseModeStats();
                    saveFilerViewState();
                }
                break;
        }
    }
    
    function findCaseByUID(uid) {
        for (const merchant of caseModeData) {
            const caseItem = merchant.cases.find(c => c.uid === uid);
            if (caseItem) return caseItem;
        }
        return null;
    }

    function handleDeleteMerchant(merchantId) {
        if (document.body.classList.contains('is-standalone-mode')) {
            showNotification("Cannot delete merchants in Filer Mode.", "error");
            return;
        }
        if (!confirm("Are you sure you want to permanently delete this merchant and all its cases? This cannot be undone.")) return;

        const merchant = caseModeData.find(m => m.id === merchantId);
        if (!merchant) return;

        merchant.cases.forEach(caseItem => localStorage.removeItem(caseItem.uid));

        const noteArea = document.getElementById('noteArea');
        const allSections = noteArea.value.split(merchantSeparatorRegex);
        const remainingSections = allSections.filter(section => section.trim() !== merchant.originalText.trim());
        noteArea.value = remainingSections.join(merchantSeparator);

        countTemplatesNoteTaker();
        recordNoteChange();
        
        initCaseMode();

        showNotification(`Merchant "${merchant.displayName}" deleted.`, 'success');
    }
    
    function saveMatchedRoIds() {
        const data = {
            timestamp: Date.now(),
            ids: Array.from(matchedRoIds)
        };
        localStorage.setItem(matchedRoIdsKey, JSON.stringify(data));
    }

    function loadMatchedRoIds() {
        const savedData = localStorage.getItem(matchedRoIdsKey);
        if (savedData) {
            try {
                const data = JSON.parse(savedData);
                const twentyFourHours = 24 * 60 * 60 * 1000;
                if (Date.now() - data.timestamp < twentyFourHours) {
                    matchedRoIds = new Set(data.ids);
                } else {
                    localStorage.removeItem(matchedRoIdsKey); // Clear expired data
                }
            } catch (e) {
                console.error("Failed to load matched RO IDs:", e);
                localStorage.removeItem(matchedRoIdsKey);
            }
        }
    }
    
    function viewRemovalOrderIds(merchant) {
        const modal = document.getElementById('caseModeActionModal');
        const modalTitle = document.getElementById('caseModeActionModalTitle');
        const modalBody = document.getElementById('caseModeActionModalBody');
        
        if (!merchant || merchant.cases.length === 0) return;

        const regex = /Removal order ID:\s*(\S+)/g;
        const uniqueIds = [...new Set(merchant.cases.flatMap(c => [...c.text.matchAll(regex)].map(match => match[1])))];

        modalTitle.innerHTML = `<i class="fa-solid fa-tags"></i> Match Removal Order IDs`;
        
        if (uniqueIds.length > 0) {
            const idListHTML = uniqueIds.map((id, index) => {
                const isMatched = matchedRoIds.has(id);
                const uniqueId = `ro-check-${merchant.id}-${index}`; // Create a unique ID for the label/input pair
                return `
                <label class="ro-id-item macos-checkbox-container" for="${uniqueId}">
                    <input type="checkbox" id="${uniqueId}" class="macos-checkbox ro-match-checkbox" data-id="${id}" ${isMatched ? 'checked' : ''}>
                    <span class="ro-id-text">${id}</span>
                </label>`;
            }).join('');
            
            modalBody.innerHTML = `
                <p style="font-size: 0.9em; color: var(--text-secondary); margin: 0 0 10px;">Manually mark RO IDs as matched to enable case filing controls.</p>
                <div class="ro-id-list">${idListHTML}</div>
                <hr style="border:none; border-top: 1px solid var(--border-subtle); margin: 12px 0;">
                <p style="font-size: 0.9em; color: var(--text-secondary); margin: 0 0 10px;">Or, paste removal report data here to auto-match.</p>
                <div class="macos-textfield-container">
                    <textarea id="ro-paste-area" class="macos-textfield" placeholder="Paste removal report data here..."></textarea>
                </div>
            `;
        } else {
            modalBody.innerHTML = "<p>No 'Removal order ID' found in this merchant's templates.</p>";
        }
        
        modal.style.display = 'flex';

        modalBody.addEventListener('change', e => {
            if (e.target.classList.contains('ro-match-checkbox')) {
                const id = e.target.dataset.id;
                if (e.target.checked) {
                    matchedRoIds.add(id);
                } else {
                    matchedRoIds.delete(id);
                }
                saveMatchedRoIds();
                updateCaseCardMatchStatus(); // Update main UI in real-time
            }
        });

        const pasteArea = document.getElementById('ro-paste-area');
        if (pasteArea) {
            pasteArea.addEventListener('input', (event) => {
                const pastedText = event.target.value;
                const foundIdsInPaste = new Set(pastedText.split(/\s+/).filter(Boolean));
                
                modalBody.querySelectorAll('.ro-match-checkbox').forEach(checkbox => {
                    const id = checkbox.dataset.id;
                    if (foundIdsInPaste.has(id)) {
                        checkbox.checked = true;
                        matchedRoIds.add(id);
                    }
                });
                saveMatchedRoIds();
                updateCaseCardMatchStatus();
            });
        }
    }

    function updateCaseCardMatchStatus() {
        const allCaseCards = document.querySelectorAll(`.case-card`);
        const roIdRegex = /Removal order ID:\s*(\S+)/;

        allCaseCards.forEach(card => {
            const caseItem = findCaseByUID(card.id);
            if (caseItem) {
                const match = caseItem.text.match(roIdRegex);
                const roId = match ? match[1] : null;
                const isMatched = roId && matchedRoIds.has(roId);

                card.classList.toggle('ro-matched', isMatched);

                if (card.classList.contains('unfiled')) {
                    const saveBtn = card.querySelector('.unfiled-controls [data-action="save-case"]');
                    const copyBtn = card.querySelector('.unfiled-controls [data-action="copy-text"]');
                    const caseIdInput = card.querySelector('.unfiled-controls .case-id-input');

                    if (saveBtn) saveBtn.disabled = !isMatched;
                    if (copyBtn) copyBtn.disabled = !isMatched;
                    if (caseIdInput) caseIdInput.disabled = !isMatched;
                }
            }
        });
    }
    
    function updateFileInfo(fileNames = []) {
        const fileInfoBtn = document.getElementById('fileInfoBtn');
        if (!fileInfoBtn) return;
        
        const hasData = fileNames && fileNames.length > 0;

        if (!hasData || fileNames.length <= 1) {
            fileInfoBtn.style.display = 'none';
        } else {
            fileInfoBtn.style.display = 'inline-flex';
            fileInfoBtn.title = `Loaded files:\n${fileNames.join('\n')}`;
        }
    }

    function updateCaseModeStats() {
        let globalFiled = 0, globalTotal = 0;
        caseModeData.forEach(m => {
            const filedCount = m.cases.filter(c => c.filedId !== null).length;
            const totalCount = m.cases.length;
            globalFiled += filedCount;
            globalTotal += totalCount;
            
            const tabBtn = document.querySelector(`.case-mode-tab-button[data-tab-id="${m.id}"]`);
            if(tabBtn) {
                tabBtn.querySelector('.case-mode-tab-meta').textContent = `${filedCount}/${totalCount}`;
                tabBtn.classList.toggle('done', (filedCount === totalCount && totalCount > 0) || m.isCompleted);
            }

            const contentEl = document.getElementById(`case-content-${m.id}`);
            if (contentEl) {
                const copyBtn = contentEl.querySelector('[data-action="copy-merchant-ids"]');
                if(copyBtn) {
                    copyBtn.innerHTML = `<i class="fa-solid fa-copy"></i>Copy ${filedCount} ID(s)`;
                    copyBtn.disabled = filedCount === 0;
                }
            }
        });

        document.getElementById('caseModeGlobalStats').textContent = `Total Filed: ${globalFiled} / ${globalTotal}`;
        const copyAllBtn = document.getElementById('copyAllMerchantsBtn');
        
        copyAllBtn.style.display = globalFiled > 0 ? 'inline-flex' : 'none';
    }
    
    function escapeHTML(str) {
        return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
    }
    
    function copyAllMerchantsWithIds() {
        const activeTabContent = document.querySelector('.case-mode-tab-content.active');
        const exclude = activeTabContent?.querySelector('.exclude-non-numeric-local')?.checked || true;

        const merchantsWithFiledCases = caseModeData.filter(m => m.cases.some(c => c.filedId !== null && (!exclude || /^\d+$/.test(c.filedId))));
        if (merchantsWithFiledCases.length === 0) {
            showNotification('No matching IDs to copy.', 'info');
            return;
        }

        const output = merchantsWithFiledCases.map(merchant => {
            const ids = merchant.cases
                .map(c => c.filedId)
                .filter(id => id !== null && (!exclude || /^\d+$/.test(id)))
                .join('\n');
            return ids ? `${merchant.displayName}\n${ids}` : null;
        }).filter(Boolean).join('\n\n');

        if (output) {
            navigator.clipboard.writeText(output);
            showNotification(`Copied IDs for ${merchantsWithFiledCases.length} merchants!`, 'success');
        }
    }

    function syncExcludeCheckboxes(source) {
       // This function is no longer needed as the global checkbox was removed.
    }

    function applyCaseCardLayout() {
        const isRight = appSettings.caseTextPosition === 'right';
        document.querySelectorAll('.case-card .card-content').forEach(el => {
            el.classList.toggle('layout-right', isRight);
        });
        const icon = document.getElementById('btnToggleFilerLayout')?.querySelector('i');
        if (icon) {
            icon.className = `fa-solid fa-align-${isRight ? 'right' : 'left'}`;
        }
    }
    
    function applyCopyTitleButtonVisibility() {
        document.getElementById('caseModeWrapper')?.classList.toggle('show-copy-title', appSettings.showCopyTitleBtn);
    }
    
    function applyTabLayout() {
        const wrapper = document.getElementById('caseModeWrapper');
        if (!wrapper) return;
        wrapper.classList.remove('tab-layout-wrap', 'tab-layout-h-scroll', 'tab-layout-vertical');
        wrapper.classList.add(`tab-layout-${appSettings.tabLayout || 'wrap'}`);
    }

    function toggleFilerLayout() {
        appSettings.caseTextPosition = appSettings.caseTextPosition === 'left' ? 'right' : 'left';
        applyCaseCardLayout();
        saveFilerViewState();
    }
    
    function toggleCopyTitleVisibility() {
        appSettings.showCopyTitleBtn = !appSettings.showCopyTitleBtn;
        applyCopyTitleButtonVisibility();
        document.getElementById('btnToggleCopyTitle').classList.toggle('active', appSettings.showCopyTitleBtn);
        saveFilerViewState();
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        // Check for standalone "Filer Mode" first
        if (typeof standalonePayload !== 'undefined') {
             initStandaloneMode(standalonePayload);
        } else {
            // Normal tool initialization
            loadSettings();
            loadMatchedRoIds();
            autoClearOldHistory();
            const noteArea = document.getElementById('noteArea');

            const savedState = JSON.parse(localStorage.getItem(caseModeStateKey));
            if (savedState && savedState.fileContent) {
                noteArea.value = savedState.fileContent;
            }
            
            noteHistory = [noteArea.value];
            noteHistoryIndex = 0;
            updateNoteUndoRedoButtons();
            
            noteArea.addEventListener('input', () => {
                clearTimeout(noteChangeTimeout);
                noteChangeTimeout = setTimeout(() => {
                    recordNoteChange();
                    countTemplatesNoteTaker();
                }, 500);
            });
            noteArea.addEventListener('paste', () => { setTimeout(()=>{recordNoteChange(); countTemplatesNoteTaker();}, 50); });
            noteArea.addEventListener('scroll', saveNotesToLocalStorage);
            
            const shipmentInput = document.getElementById('shipmentInput');
            if (shipmentInput) {
                 let parseTimer;
                 shipmentInput.addEventListener('input', () => { clearTimeout(parseTimer); parseTimer = setTimeout(parseShipmentData, 300); });
                 shipmentInput.addEventListener('scroll', saveShipmentInputScroll);
            }
            const upsUspsOutputArea = document.getElementById('upsUspsOutputArea');
            if(upsUspsOutputArea) {
                const saved = localStorage.getItem(upsUspsOutputKey); if (saved) upsUspsOutputArea.value = saved;
                upsUspsOutputArea.addEventListener('scroll', saveUpsUspsOutputToLocalStorage);
            }
            try { const savedCtx = localStorage.getItem(upsUspsContextKey); if (savedCtx) tempUpsUspsData = JSON.parse(savedCtx) || {}; }
            catch (e) { tempUpsUspsData = {}; }
            restoreScrollPositions();
            countTemplatesNoteTaker();
            
            const parserTool = document.getElementById('parserTool');
            const parserToggleBtn = document.getElementById('parserToggle');
            const savedParserState = localStorage.getItem(parserStateKey);
            if (savedParserState === 'hidden') {
                parserTool.classList.add('is-hidden');
                parserToggleBtn.querySelector('i').className = 'fa-solid fa-eye';
            }
            parserToggleBtn.addEventListener('click', () => {
                const isHidden = parserTool.classList.toggle('is-hidden');
                parserToggleBtn.querySelector('i').className = `fa-solid fa-eye${isHidden ? '' : '-slash'}`;
                localStorage.setItem(parserStateKey, isHidden ? 'hidden' : 'visible');
            });

            document.getElementById('btnUndoNote').addEventListener('click', handleNoteUndo);
            document.getElementById('btnRedoNote').addEventListener('click', handleNoteRedo);
            document.getElementById('btnSendToTelegram')?.addEventListener('click', openTelegramSendModal);
            document.getElementById('btnExportCaseTracker')?.addEventListener('click', exportCaseTrackerFile);
            document.getElementById('btnViewHistoryFromSettings')?.addEventListener('click', openHistoryModal);

            document.getElementById('btnPrefix3C').addEventListener('click', () => setPrefix('3C'));
            document.getElementById('btnPrefixLS').addEventListener('click', () => setPrefix('LS'));
            document.getElementById('btnOpenSettings')?.addEventListener('click', openSettingsModal);
            document.getElementById('btnClearSelected')?.addEventListener('click', clearSelectedMerchants);
            document.getElementById('btnCaseMode')?.addEventListener('click', toggleCaseMode);
            document.getElementById('btnViewRoIdsMain')?.addEventListener('click', () => {
                parseNotesForCaseMode(); // Ensure data is fresh
                const selectedDiv = document.querySelector('#merchantList .merchant-item.selected');
                if (selectedDiv) {
                    const merchantKey = selectedDiv.dataset.key;
                    const merchant = caseModeData.find(m => m.originalText === merchantKey);
                    if (merchant) {
                        viewRemovalOrderIds(merchant);
                    }
                }
            });

            const btnSelectAll = document.getElementById('btnSelectAll');
            if (btnSelectAll) {
                btnSelectAll.addEventListener('click', () => {
                    const allVisibleCheckboxes = Array.from(document.querySelectorAll('#merchantList .merchant-item'))
                        .filter(item => item.style.display !== 'none')
                        .map(item => item.querySelector('.macos-checkbox'));
                    
                    const areAllSelected = allVisibleCheckboxes.length > 0 && allVisibleCheckboxes.every(cb => cb.checked);
                    const newCheckedState = !areAllSelected;

                    allVisibleCheckboxes.forEach(cb => {
                        cb.checked = newCheckedState;
                    });
                    updateSelectedCountNoteTaker();
                });
            }

            document.getElementById('btnDownloadAll')?.addEventListener('click', () => {
                const count = caseModeData.reduce((sum, m) => sum + m.cases.length, 0);
                const combinedText = caseModeData.map(getFormattedBlockWithVerification).join(merchantSeparator);
                downloadFile(combinedText + '\n', `${getFilenamePrefix()}_${getFormattedDate()}_(${count}).txt`, 'text/plain;charset=utf-8');
            });
            document.getElementById('btnDownloadSelected')?.addEventListener('click', downloadSelectedMerchants);
            document.getElementById('btnSplitSelected')?.addEventListener('click', openSplitModal);
            document.getElementById('btnProcessUpsUsps')?.addEventListener('click', processUpsUspsData);
            document.getElementById('btnAddSeparator')?.addEventListener('click', addSeparator);
            document.getElementById('btnClearAllNotes')?.addEventListener('click', () => document.getElementById('clearAllConfirmModal').style.display = 'flex');
            document.getElementById('cancelClearAllBtn')?.addEventListener('click', () => document.getElementById('clearAllConfirmModal').style.display = 'none');
            document.getElementById('confirmClearAllBtn')?.addEventListener('click', confirmAndClearAllNotes);
            document.getElementById('closeClearSuccessPopupBtn')?.addEventListener('click', () => document.getElementById('clearAllSuccessPopup').style.display = 'none');
            
            document.getElementById('btnCloseHistoryModal')?.addEventListener('click', closeHistoryModal);
            document.getElementById('historyModal')?.addEventListener('click', e => { if (e.target.id === 'historyModal') closeHistoryModal(); });
            document.getElementById('historyList')?.addEventListener('click', e => { if (e.target.closest('.restore-btn')) { restoreHistoryItem(e.target.closest('.restore-btn').dataset.historyId); }});
            document.getElementById('btnClearAllHistory')?.addEventListener('click', openClearHistoryConfirmModal);
            document.getElementById('btnCancelClearHistory')?.addEventListener('click', closeClearHistoryConfirmModal);
            document.getElementById('btnConfirmClearHistory')?.addEventListener('click', handleClearAllHistory);
            document.getElementById('confirmClearHistoryModal')?.addEventListener('click', e => { if (e.target.id === 'confirmClearHistoryModal') closeClearHistoryConfirmModal(); });
            document.getElementById('btnCancelTelegramSend')?.addEventListener('click', closeTelegramSendModal);
            document.getElementById('telegramSendModal')?.addEventListener('click', e => { if (e.target.id === 'telegramSendModal') closeTelegramSendModal(); });
            document.getElementById('btnConfirmTelegramSend')?.addEventListener('click', handleConfirmTelegramSend);
            document.getElementById('btnYesDeleteSent')?.addEventListener('click', confirmAndDeleteSentMerchants);
            document.getElementById('btnNoDeleteSent')?.addEventListener('click', () => { document.getElementById('confirmDeleteSentModal').style.display = 'none'; merchantsToDeleteAfterSend = []; });
            document.getElementById('btnCloseSettingsModal')?.addEventListener('click', closeSettingsModal);
            document.getElementById('settingsModal')?.addEventListener('click', e => { if (e.target.id === 'settingsModal') closeSettingsModal(); });
            document.getElementById('btnSaveChangesSettings')?.addEventListener('click', () => { saveSettings(); closeSettingsModal(); });
            document.getElementById('btnCancelSplit')?.addEventListener('click', closeSplitModal);
            document.getElementById('splitModal')?.addEventListener('click', e => { if (e.target.id === 'splitModal') closeSplitModal(); });
            document.getElementById('btnGenerateSplits')?.addEventListener('click', generateAndDownloadSplits);
            document.getElementById('btnSendSplitsToTelegram')?.addEventListener('click', generateAndSendSplitsToTelegram);
            document.getElementById('splitOrdersPerTemplate')?.addEventListener('input', updateCalculatedTemplates);
            document.getElementById('splitNumberInput')?.addEventListener('input', updateCalculatedTemplates);

            document.getElementById('btnCancelPreSend')?.addEventListener('click', () => { document.getElementById('preSendConfirmModal').style.display = 'none'; });
            document.getElementById('btnConfirmAndSend')?.addEventListener('click', executeTelegramsendsFromModal);

            document.getElementById('merchantSearchInput')?.addEventListener('input', filterMerchants);

            const upsUspsToggle = document.getElementById('upsUspsToggle');
            const upsUspsOutputContainer = document.getElementById('upsUspsOutputContainer');
            if (upsUspsToggle && upsUspsOutputContainer && shipmentInput) {
                function toggleUpsUspsMode(isUpsMode) {
                    upsUspsOutputContainer.style.display = isUpsMode ? 'block' : 'none';
                    shipmentInput.placeholder = isUpsMode ? "Paste shipment data for Other Carriers..." : "Paste Amazon removal shipment data here...";
                }
                upsUspsToggle.addEventListener('change', function() { toggleUpsUspsMode(this.checked); });
                toggleUpsUspsMode(upsUspsToggle.checked);
            }
             window.addEventListener('resize', handleAutoLayout);
            window.addEventListener('beforeunload', saveAllScrollPositions);
            initDraggableWindows();
            handleAutoLayout();
            if (localStorage.getItem(caseModeActiveKey) === 'true') {
                toggleCaseMode();
            }
        }

        // --- Common Listeners for both modes ---
        document.getElementById('btnToggleFilerLayout')?.addEventListener('click', toggleFilerLayout);
        document.getElementById('btnToggleCopyTitle')?.addEventListener('click', toggleCopyTitleVisibility);
        document.getElementById('themeToggle')?.addEventListener('click', () => {
            const newTheme = document.documentElement.dataset.theme === 'dark' ? 'light' : 'dark';
            appSettings.theme = newTheme;
            localStorage.setItem(settingsKey, JSON.stringify(appSettings));
            setTheme(newTheme);
        });
        document.getElementById('copyAllMerchantsBtn')?.addEventListener('click', copyAllMerchantsWithIds);
        document.getElementById('openUrlBtn').addEventListener('click', openReportUrl);
        document.getElementById('copyUrlBtn').addEventListener('click', () => {
            const url = generateReportUrl();
            navigator.clipboard.writeText(url).then(() => {
                showNotification('Report URL copied!', 'success');
            }, () => {
                showNotification('Failed to copy URL.', 'error');
            });
        });
        document.getElementById('marketplaceSelectUrlGen').addEventListener('change', (e) => {
            appSettings.marketplaceUrlGen = e.target.value;
        });

        document.getElementById('closeCaseTextModalBtn')?.addEventListener('click', () => document.getElementById('caseTextModal').style.display = 'none');
        const actionModal = document.getElementById('caseModeActionModal');
        actionModal.addEventListener('click', e => {
            if(e.target === actionModal) { // Only close if clicking on the overlay itself
                 actionModal.style.display = 'none';
                 updateCaseCardMatchStatus();
            }
        });
        actionModal.querySelector('#caseModeActionModalCancelBtn').addEventListener('click', () => {
             actionModal.style.display = 'none';
             updateCaseCardMatchStatus(); // Update UI when modal is closed
        });
    });
</script>
</body>
</html>
