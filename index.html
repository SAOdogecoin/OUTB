<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Outbound AMZL Tool</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="." />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --system-font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            --mono-font: 'SF Mono', Consolas, 'Courier New', Courier, monospace;
            --primary-bg: #ffffff;
            --container-bg: #ffffff;
            --text-color: #1d1d1f; /* Default black text / now also used for topbar bg */
            --secondary-text-color: #6e6e73;
            --placeholder-text-color: #aaaaaf;
            --accent-blue: #007aff;
            --accent-blue-rgb: 0, 122, 255;

            --button-bg: #1d1d1f;
            --button-text: #ffffff;
            --button-border-color: #1d1d1f;
            --button-hover-bg: #38383a;
            --button-hover-border-color: #38383a;
            --button-active-bg: #4f4f52;
            --button-active-border-color: #4f4f52;
            --button-disabled-bg: #e0e0e0;
            --button-disabled-text: #9e9e9e;
            --button-disabled-border: #e0e0e0;

            --border-color: #d2d2d7;
            /* --focus-ring-color: rgba(var(--accent-blue-rgb), 0.25); -- Focus rings removed */
            --base-border-radius: 10px;
            --button-border-radius: 6px;
            --input-border-radius: 6px;
            --top-bar-height: 50px;
            --top-bar-bg: #1d1d1f; /* Explicitly black for top bar */
            --top-bar-text-color: #ffffff; /* White text for top bar */
        }
        html { box-sizing: border-box; }
        *, *:before, *:after { box-sizing: inherit; }
        body {
            font-family: var(--system-font); background-color: var(--primary-bg);
            color: var(--text-color); margin: 0; padding: 0; display: flex;
            flex-direction: column; min-height: 100vh;
            -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
            font-size: 14px;
        }

        .top-bar {
            background-color: var(--top-bar-bg);
            padding: 0 12px 0 10px; 
            height: var(--top-bar-height);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .top-bar-left {
            display: flex;
            align-items: center; 
            gap: 8px; 
        }

        .icon-placeholder {
            width: 130px;
            height: 30px;
            cursor: pointer;
            background-image: url("data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPSIxLjEiIGlkPSJMYXllcl8xIiB4bWxuczp4PSJuc19leHRlbmQ7IiB4bWxuczppPSJuc19haTsiIHhtbG5zOmdyYXBoPSJuc19ncmFwaHM7IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4PSIwcHgiIHk9IjBweCIgdmlld0JveD0iMCAwIDIwNC40IDUwIiBzdHlsZT0iZW5hYmxlLWJhY2tncm91bmQ6bmV3IDAgMCAyMDQuNCA1MDsiIHhtbDpzcGFjZT0icHJlc2VydmUiPgogPHN0eWxlIHR5cGU9InRleHQvY3NzIj4KICAuc3Qwe2ZpbGw6I0ZGRkZGRjt9Cgkuc3Qxe2ZpbGwtcnVsZTpldmVub2RkO2NsaXAtcnVsZTpldmVub2RkO2ZpbGw6I0ZGRkZGRjt9CiA8L3N0eWxlPgogPG1ldGFkYXRhPgogIDxzZncgeG1sbnM9Im5zX3NmdzsiPgogICA8c2xpY2VzPgogICA8L3NsaWNlcz4KICAgPHNsaWNlU291cmNlQm91bmRzIGJvdHRvbUxlZnRPcmlnaW49InRydWUiIGhlaWdodD0iNTAiIHdpZHRoPSIyMDQuNCIgeD0iLTczLjYiIHk9IjAiPgogICA8L3NsaWNlU291cmNlQm91bmRzPgogIDwvc2Z3PgogPC9tZXRhZGF0YT4KIDxnPgogIDxwYXRoIGNsYXNzPSJzdDAiIGQ9Ik0yMy42LDEzLjVDMjMuNiw1LjUsMTYsMiw4LjcsNGMtMC4zLDAuMS0wLjMsMC41LDAsMC42bDEuNiwwLjZjMC4zLDAuMSwwLjMsMC42LDAsMC43CgkJYy00LjksMS44LTYuNyw4LjktNi43LDEzLjZDMy42LDIwLjQsNCwyMSw0LjksMjFjMS4yLDAsMS42LTEsMi4xLTIuMWMwLjMtMC43LDAuNi0xLjUsMS4yLTIuMWMwLjUtMC42LDEuMy0xLDIuMS0xLjUKCQljMC44LTAuNSwxLjctMSwyLjQtMS42YzAuNC0wLjQsMC43LTEuMywwLjgtMmMwLjEtMC40LDAuNS0wLjcsMC44LTAuNGMwLjYsMC42LDEsMS43LDEsMi44YzAsMS45LTEuMywyLjYtMi41LDMuMwoJCWMtMC44LDAuNC0xLjYsMC45LTIuMSwxLjZjLTAuMywwLjQtMC41LDAuOS0wLjgsMS40QzksMjIuMiw4LDI0LjMsNC44LDI0LjNjLTIuOSwwLTQuNC0yLTQuNC00LjVjMC00LjgsMS4yLTkuNiw0LjItMTMuNgoJCWMwLjItMC4zLTAuMS0wLjctMC40LTAuNUwxLjYsNi45Yy0wLjUsMC4zLTEtMC4zLTAuNy0wLjdDMi41LDMuOSw2LjIsMCwxMi45LDBjOC41LDAsMTUuMiw1LjQsMTUuMiwxMy40YzAsNS4xLTIuNSw4LjMtNCw5LjgKCQljLTAuNSwwLjUtMC40LDEuNCwwLjEsMS44YzEuOCwxLjUsNS4xLDQuOSw1LjEsMTAuMkMyOS40LDQzLjMsMjMuMSw1MCwxNCw1MEM0LjksNTAsMS40LDQ0LjMsMCwzOS41Yy0wLjMtMC45LDEuMi0xLjIsMS43LTAuNQoJCWMyLDMsNS41LDYsMTEuMiw2YzUuOCwwLDEwLjYtMy4xLDEwLjYtMTAuMWMwLTQuNC0zLjktOC4xLTUuOS05LjdjLTAuNS0wLjQtMC41LTEuNCwwLTEuOEMxOS44LDIxLjksMjMuNiwxOC40LDIzLjYsMTMuNXoiPgogIDwvcGF0aD4KICA8cGF0aCBjbGFzcz0ic3QwIiBkPSJNMTEuNCw5LjhjMCwwLjctMC41LDEuMi0xLjIsMS4yUzksMTAuNSw5LDkuOHMwLjUtMS4yLDEuMi0xLjJTMTEuNCw5LjIsMTEuNCw5Ljh6Ij4KICA8L3BhdGg+CiAgPHBhdGggY2xhc3M9InN0MCIgZD0iTTQ0LjIsMTYuOWgtNy41di0zLjdoMTkuM3YzLjdoLTcuNXYyMC42aC00LjRWMTYuOXoiPgogIDwvcGF0aD4KICA8cGF0aCBjbGFzcz0ic3QwIiBkPSJNNjcuNSwyMi43Yy0yLjMsMC0zLjksMS41LTMuOSw0LjF2MTAuN2gtNC4zVjEzLjNoNC4ydjkuMmgwLjJjMC44LTIuMSwyLjYtMy4zLDUuNC0zLjNjMy44LDAsNi4zLDIuNSw2LjMsNi44CgkJdjExLjZoLTQuM1YyNi42QzcxLjEsMjQuMSw2OS44LDIyLjcsNjcuNSwyMi43eiI+CiAgPC9wYXRoPgogIDxwYXRoIGNsYXNzPSJzdDAiIGQ9Ik03OS40LDM3LjVoNC4zVjI2LjhjMC0yLjMsMS43LTMuOSw0LjEtMy45YzAuNywwLDEuNiwwLjEsMiwwLjJ2LTMuOWMtMC40LTAuMS0xLjEtMC4xLTEuNS0wLjEKCQljLTIuMSwwLTMuOCwxLjItNC41LDMuM2gtMC4ydi0zaC00LjJWMzcuNXoiPgogIDwvcGF0aD4KICA8cGF0aCBjbGFzcz0ic3QxIiBkPSJNMTA3LjUsMzIuNmMtMC44LDMuMi0zLjcsNS4yLTcuOSw1LjJjLTUuNSwwLTguOC0zLjYtOC44LTkuM2MwLTUuNiwzLjQtOS40LDguNi05LjRjNC41LDAsOC4zLDIuOCw4LjMsOS4yCgkJdjEuM0g5NWMwLDMuMSwxLjksNC45LDQuNiw0LjljMS44LDAsMy4zLTAuOCwzLjgtMi4zTDEwNy41LDMyLjZ6IE05OS40LDIyLjRjLTIuNiwwLTQuMywyLTQuNCw0LjNoOC41CgkJQzEwMy41LDI0LjIsMTAxLjksMjIuNCw5OS40LDIyLjR6Ij4KICA8L3BhdGg+CiAgPHBhdGggY2xhc3M9InN0MSIgZD0iTTExOSwzNy45YzQuMiwwLDcuMS0yLjEsNy45LTUuMmwtNC0wLjRjLTAuNiwxLjUtMiwyLjMtMy44LDIuM2MtMi44LDAtNC42LTEuOC00LjYtNC45aDEyLjd2LTEuMwoJCWMwLTYuNC0zLjgtOS4yLTguMy05LjJjLTUuMiwwLTguNiwzLjgtOC42LDkuNEMxMTAuMiwzNC4yLDExMy41LDM3LjksMTE5LDM3Ljl6IE0xMTQuNCwyNi43YzAuMS0yLjMsMS44LTQuMyw0LjQtNC4zCgkJYzIuNSwwLDQuMSwxLjgsNC4xLDQuM0gxMTQuNHoiPgogIDwvcGF0aD4KICA8cGF0aCBjbGFzcz0ic3QwIiBkPSJNMTQ2LjEsMzEuM2MtMC4zLDMuOS0zLjIsNi42LTcuOCw2LjZjLTUuNCwwLTguNy0zLjktOC43LTkuNGMwLTUuNiwzLjQtOS40LDguNy05LjRjNC40LDAsNy41LDIuNiw3LjgsNi41CgkJSDE0MmMtMC4zLTEuOC0xLjYtMy4xLTMuNy0zLjFjLTIuNiwwLTQuNCwyLjItNC40LDUuOWMwLDMuNywxLjcsNiw0LjQsNmMxLjksMCwzLjMtMS4xLDMuNy0zLjFIMTQ2LjF6Ij4KICA8L3BhdGg+CiAgPHBhdGggY2xhc3M9InN0MSIgZD0iTTE1Ny4yLDM3LjljNS4zLDAsOC43LTMuOCw4LjctOS40YzAtNS42LTMuNC05LjQtOC43LTkuNGMtNS4zLDAtOC43LDMuOC04LjcsOS40CgkJQzE0OC41LDM0LjEsMTUxLjksMzcuOSwxNTcuMiwzNy45eiBNMTU3LjIsMzQuNGMtMi45LDAtNC40LTIuNi00LjQtNmMwLTMuMywxLjQtNiw0LjQtNmMy45LDAsNC4zLDIuNyw0LjMsNgoJCUITMTYxLjYsMzEuOCwxNjAuMSwzNC40LDE1Ny4yLDM0LjR6Ij4KICA8L3BhdGg+CiAgPHBhdGggY2xhc3M9InN0MCIgZD0iTTE2OS4yLDEzLjNoNC4zdi0yNC4yaC00LjNWMTMuM3oiPgogIDwvcGF0aD4KICA8cGF0aCBjbGFzcz0ic3QwIiBkPSJNMTg2LjcsMTkuM2gtMy42VjE1aC00LjN2NC40aC0yLjZ2My4zaDIuNnYxMC4xYzAsMy40LDIuNSw1LjEsNS43LDVjMS4yLDAsMi4xLTAuMywyLjUtMC40bC0wLjctMy4zCgkJYy0wLjIsMC4xLTAuNywwLjItMS4zLDAuMmMtMS4xLDAtMS45LTAuNC0xLjktMi4xdi05LjRoMy42VjE5LjN6Ij4KICA8L3BhdGg+CiAgPHBhdGggY2xhc3M9InN0MCIgZD0iTTE5Ni43LDE5LjFjNC4zLDAsNi43LDIsNy4zLDVsLTMuOSwwLjRjLTAuMy0xLjItMS40LTIuMy0zLjMtMi4zYy0xLjgsMC0zLjEsMC45LTMuMSwyLjEKCQljMCwxLjEsMC43LDEuNywyLjYsMi4xbDMuMSwwLjdjMy40LDAuNyw1LjEsMi4zLDUuMSw0LjljMCwzLjQtMy4yLDUuOC03LjgsNS44Yy00LjUsMC03LjMtMi03LjgtNS4zbDQuMi0wLjQKCQljMC40LDEuNiwxLjYsMi41LDMuNiwyLjVjMiwwLDMuNC0wLjksMy40LTIuMmMwLTEtMC44LTEuNy0yLjQtMi4xbC0zLjEtMC43Yy0zLjUtMC43LTUuMS0yLjUtNS4xLTUuMQoJCUMxODkuNCwyMS4yLDE5Mi4zLDE5LjEsMTk2LjcsMTkuMXoiPgogIDwvcGF0aD4KIDwvZz4KPC9zdmc+");
            background-repeat: no-repeat;
            background-position: center center;
            background-size: 100% 100%;
        }

        .top-bar-title {
            font-size: 1.1em; 
            font-weight: 600; 
            color: var(--top-bar-text-color);
            margin: 0; 
            line-height: 1; 
        }

        .version-dropdown {
            position: relative;
            display: inline-block;
        }
        .version-button {
            background-color: #ffffff;        
            color: var(--text-color);          
            padding: 6px 12px;
            border: 1px solid #ffffff;        
            border-radius: var(--button-border-radius);
            cursor: pointer;
            font-family: var(--system-font);
            font-weight: 500;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            transition: background-color 0.15s ease, border-color 0.15s ease;
        }
        .version-button:hover {
            background-color: #f0f0f0;        
            border-color: #e0e0e0;            
        }
        .version-button:active {
            background-color: #e0e0e0;        
            border-color: #d0d0d0;            
            transform: scale(0.97);
        }
        .version-button > i.fa-solid { /* Made specific to solid font awesome */
            margin-left: 6px;
            margin-right: 0; /* Ensure no double margin if general button i style is added */
            font-size: 0.8em;
            color: var(--text-color);          
        }

        .version-dropdown-content {
            display: none; position: absolute; background-color: var(--primary-bg);
            min-width: 120px; box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
            z-index: 1001; border-radius: var(--button-border-radius);
            border: 1px solid var(--border-color); right: 0; margin-top: 4px;
        }
        .version-dropdown-content a { color: var(--text-color); padding: 8px 12px; text-decoration: none; display: block; font-size: 13px; white-space: nowrap; }
        .version-dropdown-content a:hover { background-color: #f0f0f0; }
        .version-dropdown:hover .version-dropdown-content,
        .version-dropdown .version-button:focus + .version-dropdown-content,
        .version-dropdown .version-dropdown-content:hover {
            display: block;
        }

        .main-wrapper {
            display: flex; flex-direction: column; flex-grow: 1; padding: 16px; gap: 16px;
            width: 100%; max-width: 1600px; margin: 0 auto; overflow: hidden;
        }

        .left-column-wrapper {
            display: flex; flex-direction: column; gap: 16px;
        }

        .tool-card-title {
            display: none; /* Default for mobile */
            font-size: 1.1em;
            font-weight: 600;
            color: var(--text-color);
            margin: -5px 0 10px 0;
        }
        .tool-card-title > i.fa-solid, .tool-card-title > i.fa-regular {
            margin-right: 8px;
            font-size: 0.9em; /* Relative to title font size */
            color: var(--text-color); 
        }


        @media (min-width: 992px) {
            .main-wrapper {
                flex-direction: row; padding: 24px; gap: 24px; align-items: stretch;
            }
            .tool-card-title {
                display: flex; /* Changed from block for icon alignment */
                align-items: center; /* For icon vertical alignment */
            }
            .left-column-wrapper {
                width: calc(35% - (24px * 0.35)); 
                flex-shrink: 0;
                gap: 24px;
                max-height: calc(100vh - var(--top-bar-height) - (2 * 24px));
                overflow-y: auto; padding-bottom: 1px;
            }
            .note-taker-tool {
                width: calc(65% - (24px * 0.65)); 
                flex-shrink: 0;
                display: flex; flex-direction: column;
                max-height: calc(100vh - var(--top-bar-height) - (2 * 24px));
            }
             #noteArea { flex-grow: 1; min-height: 200px; }
             .note-taker-tool .controls-and-stats { flex-shrink: 0; margin-top: 16px; }
             .merchant-actions-tool #merchantList { height: 220px; }
        }
        @media (max-width: 991px) {
            .top-bar { display: none; }
            .main-wrapper { overflow-y: auto; overflow-x: hidden; max-height: 100vh; }
             .left-column-wrapper, .note-taker-tool { max-height: none; overflow-y: visible; }
             #noteArea { min-height: 300px; }
             .merchant-actions-tool #merchantList { height: 200px; }
        }

        .tool-container {
             background-color: var(--container-bg); border-radius: var(--base-border-radius);
             box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08); /* Apple-like shadow */
             padding: 20px;
             display: flex; flex-direction: column; position: relative;
             border: 1px solid var(--border-color);
         }

        textarea, input[type="text"], input[type="number"] {
            width: 100%; margin-bottom: 12px; padding: 10px 12px;
            border: 1px solid var(--border-color); border-radius: var(--input-border-radius);
            background-color: var(--container-bg);
            color: var(--text-color);
            line-height: 1.5; font-family: var(--system-font); font-size: 14px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            box-shadow: none;
        }
        textarea { font-family: var(--mono-font); resize: vertical; min-height: 100px; }
        textarea::placeholder, input::placeholder { color: var(--placeholder-text-color); }
        textarea:focus, input[type="text"]:focus, input[type="number"]:focus {
            border-color: var(--border-color); 
            outline: none;
            box-shadow: none; 
        }
        input[type="number"] { width: auto; margin-bottom: 0; }

       #shipmentInput { margin-bottom: 0; min-height: 150px; }

        button {
            background-color: var(--button-bg); color: var(--button-text);
            padding: 7px 14px;
            border: 1px solid var(--button-border-color);
            border-radius: var(--button-border-radius); cursor: pointer; margin: 0;
            transition: background-color 0.15s ease, border-color 0.15s ease, transform 0.1s ease;
            font-family: var(--system-font);
            font-weight: 500; font-size: 13px;
            flex-shrink: 0; text-align: center; display: inline-flex;
            align-items: center; justify-content: center; position: relative; overflow: hidden;
            box-shadow: none;
        }
        button:hover {
            background-color: var(--button-hover-bg);
            border-color: var(--button-hover-border-color);
        }
        button:active {
            background-color: var(--button-active-bg);
            border-color: var(--button-active-border-color);
            transform: scale(0.97);
        }
        button:disabled {
            background-color: var(--button-disabled-bg);
            color: var(--button-disabled-text);
            border-color: var(--button-disabled-border);
            cursor: not-allowed;
        }
        button:disabled:hover {
            background-color: var(--button-disabled-bg);
            border-color: var(--button-disabled-border);
        }
        button:disabled:active { transform: none; }
        
        /* Icon styling within buttons (excluding version button handled separately) */
        button > i.fa-solid, button > i.fa-regular {
            margin-right: 6px; /* Space between icon and text */
            font-size: 0.9em;   /* Slightly smaller or same as button text */
        }


        .note-taker-tool .controls-and-stats { display: flex; flex-direction: column; gap: 12px; flex-shrink: 0; margin-top: auto; }
        .note-taker-tool .top-controls { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .note-taker-tool .button-group { display: flex; gap: 8px; flex-wrap: wrap; }

        .note-taker-tool .counter-pill {
            display: inline-flex; align-items: center; 
            /* gap: 12px; Removed, using margins on children */
            background-color: var(--primary-bg);
            padding: 7px 14px;
            border-radius: var(--button-border-radius);
            border: 1px solid var(--border-color);
            font-size: 13px;
            font-weight: 500;
        }
        .note-taker-tool .counter-pill > i.fa-solid, 
        .note-taker-tool .counter-pill > i.fa-regular {
            margin-right: 4px; 
            margin-left: 0; /* Ensure it's reset if it's the first item */
            color: var(--text-color); 
            font-size: 0.9em; 
        }
        /* Add margin to the left of an icon if it's NOT the first child */
        .note-taker-tool .counter-pill > i.fa-solid:not(:first-child),
        .note-taker-tool .counter-pill > i.fa-regular:not(:first-child) {
            margin-left: 8px; 
        }
        .note-taker-tool .counter-pill p { 
            margin: 0; 
            color: var(--text-color); 
        }
        .note-taker-tool .counter-pill p span { 
            font-weight: 600; color: var(--text-color); margin-left: 2px; 
        }


        .merchant-actions-tool .bulk-actions {
            margin-bottom: 12px; display: flex; gap: 8px; flex-wrap: wrap; flex-shrink: 0;
        }
        .merchant-actions-tool #merchantList {
            min-height: 150px; max-height: 60vh; overflow-y: auto; resize: vertical;
            margin: 0; padding: 8px; border: 1px solid var(--border-color);
            border-radius: var(--input-border-radius); display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 8px; align-content: start;
        }
        .merchant-actions-tool .merchant-stats {
            margin: 0; padding: 7px 10px; background-color: transparent; border: none;
            border-radius: 5px; display: flex; align-items: center; justify-content: flex-start;
            font-size: 13px; transition: background-color 0.15s ease; cursor: pointer;
            border: 1px solid var(--border-color);
        }
        .merchant-actions-tool .merchant-stats:hover { background-color: #f0f0f5; }
        .merchant-actions-tool .merchant-stats:has(.merchant-checkbox:checked) { background-color: #e8f3ff; } 
        .merchant-actions-tool .merchant-stats > div { display: flex; align-items: center; justify-content: flex-start; width: 100%; gap: 8px; }

        .merchant-actions-tool .merchant-checkbox {
            appearance: none; -webkit-appearance: none; -moz-appearance: none;
            width: 16px; height: 16px; border: 1px solid #c7c7cc; border-radius: 4px;
            outline: none; cursor: pointer; position: relative;
            transition: background-color 0.15s ease, border-color 0.15s ease;
            flex-shrink: 0; background-color: var(--container-bg); margin: 0;
        }
        .merchant-actions-tool .merchant-checkbox:checked {
            background-color: var(--text-color); 
            border-color: var(--text-color);  
        }
        .merchant-actions-tool .merchant-checkbox:checked::after {
            content: ''; position: absolute; top: 1px; left: 4px; width: 4px; height: 8px;
            border: solid white; border-width: 0 2px 2px 0; transform: rotate(45deg);
        }

        .merchant-name-display { text-overflow: ellipsis; overflow: hidden; white-space: nowrap; cursor: text; padding: 2px 4px; border: 1px solid transparent; border-radius: 3px; display: inline-block; flex-grow: 1; }
        .merchant-name-display:focus { border: 1px solid var(--border-color); background-color: var(--primary-bg); box-shadow: none; outline: none; white-space: normal; overflow: visible; }
        .merchant-name-editable-container { display: flex; align-items: baseline; overflow: hidden; flex-grow: 1; min-width: 0; }
        .merchant-count-text { flex-shrink: 0; margin-left: 4px; }

        * { scrollbar-width: thin; scrollbar-color: #c0c0c0 transparent; }
        *::-webkit-scrollbar { width: 9px; height: 9px; }
        *::-webkit-scrollbar-track { background: transparent; }
        *::-webkit-scrollbar-thumb { background-color: #cccccc; border-radius: 5px; border: 2px solid transparent; background-clip: content-box; }
        *::-webkit-scrollbar-thumb:hover { background-color: #b3b3b3; }

        .parser-controls { display: flex; align-items: center; gap: 16px; margin-top: 12px; margin-bottom: 0; padding-bottom: 4px; flex-wrap: wrap; }
        .toggle-label { font-size: 13px; color: var(--text-color); cursor: pointer; user-select: none; margin-right: 4px; }
        .toggle-switch {
            position: relative; 
            display: inline-block;
            width: 40px;
            height: 22px;
            flex-shrink: 0;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #c7c7cc; 
            transition: background-color 0.3s ease-in-out; 
        }
        .slider:before {
            position: absolute; 
            content: "";
            height: 18px;  
            width: 18px;   
            left: 2px;     
            bottom: 2px;   
            background-color: white; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.15);
            transition: transform 0.3s ease-in-out; 
        }
        input:checked + .slider {
            background-color: var(--text-color); 
        }
        input:checked + .slider:before {
            transform: translateX(18px); 
        }
        .slider.round {
            border-radius: 22px; 
        }
        .slider.round:before {
            border-radius: 50%; 
        }

        #parserGroupSize {
            width: 70px; padding: 6px 8px; font-size: 13px; margin-bottom: 0; text-align: center;
            border: 1px solid var(--border-color); border-radius: var(--input-border-radius);
            background-color: var(--container-bg); transition: background-color 0.3s ease, opacity 0.3s ease;
        }
        #parserGroupSize:disabled { background-color: #f8f8f8; color: #bbb; cursor: not-allowed; opacity: 0.7; border-color: #e8e8ed; }

        .duplicate-indicator { display: inline-block; width: 8px; height: 8px; background-color: #ff9f0a; border-radius: 50%; margin-right: 6px; vertical-align: middle; flex-shrink: 0; box-shadow: none; }
        #upsUspsOutputArea { width: 100%; min-height: 80px; resize: vertical; border-radius: var(--input-border-radius); }
        #btnProcessUpsUsps { margin-top: 8px; }
        #upsUspsOutputContainer { margin-top: 12px; padding-bottom: 4px; }

        #splitModal { backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); background-color: rgba(60,60,67,0.4); }
        #splitModalContent { background-color: #f9f9f9; margin: auto; padding: 20px; border: none; border-radius: 14px; width: 90%; max-width: 480px; box-shadow: 0 6px 20px rgba(0,0,0,0.12); display: flex; flex-direction: column; gap: 12px; }
        #splitModalContent h2 { 
            margin-top: 0; margin-bottom: 8px; font-size: 1.15em; font-weight: 600; color: var(--text-color); 
            border-bottom: 1px solid #e5e5ea; padding-bottom: 10px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        #splitModalContent h2 > i.fa-solid, #splitModalContent h2 > i.fa-regular {
            margin-right: 8px;
            font-size: 0.9em;
        }
        #splitModalContent label { font-size: 0.85rem; font-weight: 500; color: var(--secondary-text-color); margin-bottom: 4px; display: block; }
        #splitModalContent #splitOrdersPerTemplate, #splitModalContent #splitNumberInput { margin-bottom: 0; border-radius: var(--input-border-radius); }
        #splitModalContent #splitOrdersPerTemplate { width: 60px; }
        #splitModalContent #splitNumberInput { width: 75px; flex-grow: 1; }
        #splitMerchantInfo { font-size: 0.9em; color: var(--secondary-text-color); background-color: #f0f0f5; padding: 8px 12px; border-radius: var(--input-border-radius); border: 1px solid var(--border-color); }
        #splitModalContent hr { border: none; border-top: 1px solid #e5e5ea; margin: 6px 0; }
        #splitModalContent .modal-actions { display: flex; gap: 10px; margin-top: 10px; justify-content: flex-end; }
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="top-bar-left">
            <div class="icon-placeholder"></div> 
            <h1 class="top-bar-title">AMZL,UPS/USPS Outbound Tool</h1>
        </div>
        <div class="version-dropdown">
            <button id="versionButton" class="version-button" aria-haspopup="true" aria-expanded="false">Version 1 <i class="fa-solid fa-chevron-down"></i></button>
            <div id="versionDropdownContent" class="version-dropdown-content" role="menu">
                <a href="#" role="menuitem">Version 1</a>
            </div>
        </div>
    </div>

    <div class="main-wrapper">
        <div class="left-column-wrapper">
            <div class="tool-container parser-tool">
                <h3 class="tool-card-title"><i class="fa-solid fa-filter"></i>Parser</h3>
                <textarea id="shipmentInput" placeholder="Paste Amazon removal shipment data here..."></textarea>
                <div class="parser-controls">
                    <div style="display: flex; align-items: center; gap: 8px;" id="groupOrdersControl">
                        <label class="toggle-switch">
                            <input type="checkbox" id="groupToggle"> <span class="slider round"></span>
                        </label>
                        <label for="groupToggle" class="toggle-label">Group Orders (AMZL)</label>
                        <input type="number" id="parserGroupSize" min="1" value="2" disabled>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label class="toggle-switch">
                            <input type="checkbox" id="upsUspsToggle"> <span class="slider round"></span>
                        </label>
                        <label for="upsUspsToggle" class="toggle-label">Extract UPS/USPS</label>
                    </div>
                </div>
                <div id="upsUspsOutputContainer" style="display: none;">
                    <textarea id="upsUspsOutputArea" placeholder="Extracted UPS/USPS Tracking Numbers..."></textarea>
                    <button id="btnProcessUpsUsps"><i class="fa-solid fa-gears"></i>Process & Add to Notes</button>
                </div>
            </div>

            <div class="tool-container merchant-actions-tool">
                <h3 class="tool-card-title"><i class="fa-solid fa-users"></i>Merchants</h3>
                <div class="bulk-actions">
                    <button id="btnDownloadSelected"><i class="fa-solid fa-download"></i>Download Selected</button>
                    <button id="btnClearSelected"><i class="fa-regular fa-trash-can"></i>Clear Selected</button>
                    <button id="btnSelectAll"><i class="fa-regular fa-square-check"></i>Select All</button>
                    <button id="btnSplitSelected" disabled><i class="fa-solid fa-table-columns"></i>Split Selected</button>
                    <button id="btnDownloadAll"><i class="fa-solid fa-file-arrow-down"></i>Download All Notes</button>
                </div>
                <div id="merchantList">
                </div>
            </div>
        </div>

        <div class="tool-container note-taker-tool">
            <h3 class="tool-card-title"><i class="fa-regular fa-pen-to-square"></i>Notes</h3>
            <textarea id="noteArea" placeholder="Notes area..."></textarea>
            <div class="controls-and-stats">
                <div class="top-controls">
                    <div class="button-group">
                        <button id="btnAddSeparator"><i class="fa-solid fa-minus"></i>Add Separator</button>
                        <button id="btnAddSpacing"><i class="fa-solid fa-grip-lines"></i>Add Spacing</button>
                        <button id="btnUndo" disabled><i class="fa-solid fa-rotate-left"></i>Undo</button>
                        <button id="btnRedo" disabled><i class="fa-solid fa-rotate-right"></i>Redo</button>
                    </div>
                    <div class="counter-pill">
                        <i class="fa-solid fa-users"></i><p class="merchant-count">Merchants: <span id="merchantCount">0</span></p>
                        <i class="fa-solid fa-file-lines"></i><p class="total-templates">Cases: <span id="totalTemplates">0</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="splitModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; justify-content: center; align-items: center; font-family: var(--system-font);">
        <div id="splitModalContent">
             <h2><i class="fa-solid fa-table-columns"></i>Split Selected Merchant(s)</h2>
            <div id="splitMerchantInfo">
            </div>
            <div>
                <label for="splitOrdersPerTemplate">Removal Orders per Template:</label>
                <input type="number" id="splitOrdersPerTemplate" min="1" value="2">
            </div>
            <div style="font-size: 0.9em; color: var(--secondary-text-color);">
                Calculated Total Templates: <span id="splitCalculatedTemplates" style="font-weight: 600; color: var(--text-color);">0</span>
            </div>
            <hr>
            <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                <label for="splitNumberInput" style="flex-shrink: 0;">Templates per Split File:</label>
                <input type="number" id="splitNumberInput" min="1" placeholder="e.g., 100">
            </div>
            <div class="modal-actions">
                <button id="btnCancelSplit"><i class="fa-solid fa-xmark"></i>Cancel</button>
                <button id="btnGenerateSplits"><i class="fa-solid fa-file-zipper"></i>Generate & Download Splits</button>
            </div>
        </div>
    </div>
    
<script>
    const amzlTemplate = `We've reviewed our removal orders and discovered some shipments whose delivery status is unclear. Could you please check on your end? We're unable to verify the tracking status. If they were lost in transit, could you kindly issue a reimbursement`;
    const upsUspsTemplate = `The Removal Order Status indicates "Completed," yet we never received this order. We kindly request a reimbursement for this discrepancy.`;
    const noteSeparator = '\n\n' + '-'.repeat(41) + '\n';
    const noteSeparatorRegex = /\n\n-{41}\n/g;
    const localStorageKey = 'savedNotesContent_amzlTool';
    const upsUspsOutputKey = 'stagedUpsUspsTNs_amzlTool';
    const upsUspsContextKey = 'stagedUpsUspsContext_amzlTool';

    let tempUpsUspsData = {};

    function saveNotesToLocalStorage() {
        const noteArea = document.getElementById('noteArea');
        if (noteArea) {
            localStorage.setItem(localStorageKey, noteArea.value);
        }
    }

    function saveUpsUspsOutputToLocalStorage() {
        const upsUspsOutputArea = document.getElementById('upsUspsOutputArea');
        if (upsUspsOutputArea) {
            localStorage.setItem(upsUspsOutputKey, upsUspsOutputArea.value);
        }
    }

    function saveUpsUspsContextToLocalStorage() {
        try {
            localStorage.setItem(upsUspsContextKey, JSON.stringify(tempUpsUspsData));
        } catch (error) {
            console.error("Error saving UPS/USPS context to localStorage:", error);
        }
    }

    function getFormattedDate() {
        const date = new Date();
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        return `${month}-${day}`;
    }

    function countTemplatesInText(text, templateString) {
        if (!text || !templateString) return 0;
        const escapedTemplate = templateString.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        return (text.match(new RegExp(escapedTemplate, 'g')) || []).length;
    }

    function downloadText(text, filename) {
        try {
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        } catch (error) {
            console.error("Error during download:", error);
            alert("An error occurred while trying to download the file.");
        }
    }

    function sanitizeFilename(name) {
        return name.replace(/[\s\\/:"*?<>|]+/g, '_').substring(0, 50);
    }

    function parseShipmentData() {
        const input = document.getElementById('shipmentInput');
        const noteArea = document.getElementById('noteArea');
        const groupToggle = document.getElementById('groupToggle');
        const groupSizeInput = document.getElementById('parserGroupSize');
        const upsUspsToggle = document.getElementById('upsUspsToggle');
        const upsUspsOutputArea = document.getElementById('upsUspsOutputArea');
        const inputValue = input.value;
        const currentNoteValue = noteArea.value;

        if (!inputValue.trim()) { return; }

        const isUpsUspsMode = upsUspsToggle ? upsUspsToggle.checked : false;

        // Regex for parsing input:
        // - UPS/USPS mode: Captures TN (group 1) and "UPS" or "USPS" (group 2)
        // - AMZL mode: Captures TN (group 1) and "AMZN", "AMZL", or "AMZL_US_PREMIUM" (group 2)
        const trackingNumberSourceRegex = isUpsUspsMode
            ? /\b([A-Z0-9]+)\s*\((UPS|USPS)\)/gi
            : /\b([A-Z0-9]+(?:-|\s)*?)\s*\((AMZ[NL]|AMZL_US_PREMIUM)\)/gi;


        // Regex for checking existing TNS in notes/staging (must be comprehensive)
        const existingTrackingNumberRegexGlobal = /\b([A-Z0-9]+(?:-|\s)*?\s*\((?:AMZ[NL]|AMZL_US_PREMIUM|UPS|USPS)\))/gi;
        const existingTrackingNumbers = new Set();
        let matchCheck;
        while ((matchCheck = existingTrackingNumberRegexGlobal.exec(currentNoteValue)) !== null) {
            // matchCheck[1] is the full "TN(CARRIER)" string
            const coreTN = matchCheck[1].replace(/\s*\((?:AMZ[NL]|AMZL_US_PREMIUM|UPS|USPS)\)$/i, '').replace(/\s|-/g, '');
            if (coreTN) existingTrackingNumbers.add(coreTN);
        }
        if (upsUspsOutputArea && upsUspsOutputArea.value) {
            upsUspsOutputArea.value.split('\n').forEach(tn => {
                const trimmedTn = tn.trim(); // These are expected to be core TNS already
                if (trimmedTn) existingTrackingNumbers.add(trimmedTn.replace(/\s|-/g, ''));
            });
        }
        const seenTrackingNumbersInCurrentInput = new Set();


        let groupSize = 1;
        const isGroupingActive = !isUpsUspsMode && groupToggle ? groupToggle.checked : false;
        if (isGroupingActive && groupSizeInput) {
            const parsedValue = parseInt(groupSizeInput.value, 10);
            groupSize = (!isNaN(parsedValue) && parsedValue >= 1) ? parsedValue : 2;
        }

        let removalOrderId = '';
        const removalOrderMatch = inputValue.match(/Removal order ID:\s*([^\n]+)/);
        if (removalOrderMatch) { removalOrderId = removalOrderMatch[1].trim(); }

        const shipmentSections = inputValue.split(/(?=Shipment ID:)/g).filter(section => section.trim() !== '');
        const parsedDataBlocksForAmzl = [];
        const extractedUpsUspsNumbers = []; // For UPS/USPS mode, stores core TNS
        let validShipmentsFound = 0;
        let skippedDuplicateCount = 0;

        shipmentSections.forEach(section => {
            const trackingMatches = Array.from(section.matchAll(trackingNumberSourceRegex));
            if (!trackingMatches || trackingMatches.length === 0) {
                return;
            }

            const sectionCoreTNs = new Set();
            const sectionFullTNs = []; // Stores "TN(CARRIER)" formatted strings

            trackingMatches.forEach(match => {
                // match[1] is the raw tracking number part (e.g., "TBA123 " or "1ZXYZ")
                // match[2] is the carrier type (e.g., "UPS", "AMZL", "AMZL_US_PREMIUM")
                const rawTNPart = match[1].trim(); // Trim spaces from the TN part
                const carrier = match[2];
                const coreTN = rawTNPart.replace(/\s|-/g, ''); // Cleaned TN for comparisons

                if (!coreTN) return;

                sectionCoreTNs.add(coreTN);
                const fullFormattedTN = `${rawTNPart}(${carrier})`; // Reconstruct consistently
                sectionFullTNs.push(fullFormattedTN);
            });


            let hasDuplicate = false;
            const coreTNsToCheck = Array.from(sectionCoreTNs);

            for (const coreTn of coreTNsToCheck) {
                if (existingTrackingNumbers.has(coreTn) || seenTrackingNumbersInCurrentInput.has(coreTn)) {
                    hasDuplicate = true;
                    break;
                }
            }

            if (hasDuplicate) {
                skippedDuplicateCount++;
                coreTNsToCheck.forEach(tn => seenTrackingNumbersInCurrentInput.add(tn));
                return;
            }

            coreTNsToCheck.forEach(tn => seenTrackingNumbersInCurrentInput.add(tn));

            const shipmentIdMatch = section.match(/^Shipment ID:\s*([^\n]+)/m);
            const shipmentId = shipmentIdMatch ? shipmentIdMatch[1].trim() : 'N/A';

            const productLines = section.split('\n').map(line => line.trim());
            const parsedProducts = []; let currentProduct = null;
            for (let i = 0; i < productLines.length; i++) { const line = productLines[i]; if (line.startsWith('Merchant SKU:')) { if (currentProduct && currentProduct.merchantSku && currentProduct.qty !== undefined) { parsedProducts.push(currentProduct); } currentProduct = { merchantSku: line.substring('Merchant SKU:'.length).trim(), qty: undefined }; } else if (currentProduct) { if (line.startsWith('FNSKU:')) { currentProduct.fnsku = line.substring('FNSKU:'.length).trim(); } else if (/^\d{1,4}$/.test(line) && productLines[i - 1]?.match(/^(EAN|UPC|ISBN_10|Condition|Shipped Quantity|Cancelled Quantity):/i)) { currentProduct.qty = parseInt(line, 10); parsedProducts.push(currentProduct); currentProduct = null; } } } if (currentProduct && currentProduct.merchantSku && currentProduct.qty !== undefined && !parsedProducts.includes(currentProduct)) { parsedProducts.push(currentProduct); }

            if (parsedProducts.length === 0) { return; }

            const outputParts = [
                `Removal order ID:${removalOrderId}`,
                `Shipment ID:${shipmentId}`,
                `Tracking Number(s):${Array.from(new Set(sectionFullTNs)).join(', ')}` // Use the formatted TNs
            ];
            const productOutputs = parsedProducts.map(p => [`Merchant SKU:${p.merchantSku || 'N/A'}`, `FNSKU:${p.fnsku || 'N/A'}`, `Qty:${p.qty}`].join('\n') );
            const completeDataBlock = outputParts.join('\n') + '\n' + productOutputs.join('\n\n');

            if (isUpsUspsMode) {
                 coreTNsToCheck.forEach(coreTN => { // Store core TNs for UPS/USPS staging
                     if (!tempUpsUspsData[coreTN]) {
                           tempUpsUspsData[coreTN] = completeDataBlock;
                     }
                    extractedUpsUspsNumbers.push(coreTN);
                 });
            } else { // AMZL mode (includes AMZL_US_PREMIUM here)
                parsedDataBlocksForAmzl.push(completeDataBlock);
            }
            validShipmentsFound++;
        });

        if (isUpsUspsMode) {
            if (extractedUpsUspsNumbers.length > 0) {
                const uniqueNumbersToAdd = Array.from(new Set(extractedUpsUspsNumbers));
                upsUspsOutputArea.value += (upsUspsOutputArea.value ? '\n' : '') + uniqueNumbersToAdd.join('\n');
                upsUspsOutputArea.scrollTop = upsUspsOutputArea.scrollHeight;

                saveUpsUspsOutputToLocalStorage();
                saveUpsUspsContextToLocalStorage();

                input.value = '';
                let processedMessage = `Extracted ${uniqueNumbersToAdd.length} unique UPS/USPS number(s) for review. `;
                 if (skippedDuplicateCount > 0) { processedMessage += `Skipped ${skippedDuplicateCount} duplicate(s). `; }
                processedMessage += `Click 'Process' to add to notes.`;
                 input.placeholder = processedMessage;
            } else {
                input.value = '';
                 let message = "No new valid UPS/USPS shipments found. ";
                 if (skippedDuplicateCount > 0) { message += `Skipped ${skippedDuplicateCount} duplicate(s). `; }
                 else if (shipmentSections.length > 0) { message += "Check data format or ensure carrier is UPS/USPS. "; }
                 else { message += "Check data format. "; }
                 input.placeholder = message;
            }
        } else { // AMZL processing (includes AMZL_US_PREMIUM)
            let finalOutputString = '';
            if (parsedDataBlocksForAmzl.length > 0) {
                if (groupSize > 1) {
                    const groupedOutputs = [];
                    for (let i = 0; i < parsedDataBlocksForAmzl.length; i += groupSize) {
                        const dataChunk = parsedDataBlocksForAmzl.slice(i, i + groupSize);
                        const completeTemplate = amzlTemplate + "\n\n" + dataChunk.join('\n\n');
                        groupedOutputs.push(completeTemplate);
                    }
                    finalOutputString = groupedOutputs.join('\n\n');
                } else {
                    const individualOutputs = parsedDataBlocksForAmzl.map(dataBlock => amzlTemplate + "\n\n" + dataBlock );
                    finalOutputString = individualOutputs.join('\n\n');
                }

                const currentNoteTrimmed = currentNoteValue.trimEnd();
                const spacing = currentNoteTrimmed ? '\n\n' : '';
                noteArea.value = currentNoteTrimmed + spacing + finalOutputString;
                noteArea.scrollTop = noteArea.scrollHeight;

                countTemplatesNoteTaker(); 
                input.value = '';
                const groupingStatus = groupSize > 1 ? `ON (${groupSize} per template)` : 'OFF';
                let processedMessage = `Processed ${validShipmentsFound} new AMZL-type shipment(s). `;
                 if (skippedDuplicateCount > 0) { processedMessage += `Skipped ${skippedDuplicateCount} duplicate(s). `; }
                processedMessage += `Grouping: ${groupingStatus}. Ready...`;
                 input.placeholder = processedMessage;
            } else {
                input.value = '';
                 let message = "No new valid AMZL-type shipments found. ";
                 if (skippedDuplicateCount > 0) { message += `Skipped ${skippedDuplicateCount} duplicate(s). `; }
                 else if (shipmentSections.length > 0) { message += "Check data format or ensure carrier is AMZL-type. "; }
                 else { message += "Check data format. "; }
                 input.placeholder = message;
            }
        }

        setTimeout(() => {
            if (input) {
                const currentModeIsUps = document.getElementById('upsUspsToggle')?.checked;
                input.placeholder = currentModeIsUps
                    ? "Paste shipment data containing UPS/USPS..."
                    : "Paste Amazon removal shipment data here...";
            }
        }, 5000);
    }

   function processUpsUspsData() {
        const upsUspsOutputArea = document.getElementById('upsUspsOutputArea');
        const noteArea = document.getElementById('noteArea');
        const shipmentInput = document.getElementById('shipmentInput');

        if (!upsUspsOutputArea || !noteArea || !shipmentInput) {
            console.error("Cannot process UPS/USPS data: Missing required elements.");
            return;
        }

        const trackingNumbersToProcess = upsUspsOutputArea.value.split('\n').map(tn => tn.trim()).filter(tn => tn);

        if (trackingNumbersToProcess.length === 0) {
            alert("No UPS/USPS tracking numbers found in the staging area.");
            return;
        }

        let processedBlocks = [];
        let notFoundCount = 0;
        const processedTNs = new Set(); // these are core TNs

        trackingNumbersToProcess.forEach(tn => {
            const coreTN = tn.replace(/\s|-/g, ''); // Ensure it's clean core TN
            if (!processedTNs.has(coreTN)) {
                if (tempUpsUspsData[coreTN]) {
                    const formattedBlock = upsUspsTemplate + "\n\n" + tempUpsUspsData[coreTN];
                    processedBlocks.push(formattedBlock);
                    processedTNs.add(coreTN);
                } else {
                    console.warn(`Could not find data block for staged TN: ${tn}`);
                    notFoundCount++;
                }
            }
        });

        if (processedBlocks.length > 0) {
            const currentNoteTrimmed = noteArea.value.trimEnd();
            const spacing = currentNoteTrimmed ? '\n\n' : '';
            noteArea.value = currentNoteTrimmed + spacing + processedBlocks.join('\n\n');
            noteArea.scrollTop = noteArea.scrollHeight;

            countTemplatesNoteTaker(); 

            // Clear only the processed TNs from outputArea and tempUpsUspsData
            const remainingOutputTNs = upsUspsOutputArea.value.split('\n')
                .map(t => t.trim())
                .filter(t => t && !processedTNs.has(t.replace(/\s|-/g, '')));
            upsUspsOutputArea.value = remainingOutputTNs.join('\n');
            
            processedTNs.forEach(coreTN => {
                delete tempUpsUspsData[coreTN];
            });


            saveUpsUspsOutputToLocalStorage();
            saveUpsUspsContextToLocalStorage();

            shipmentInput.placeholder = `Added ${processedBlocks.length} UPS/USPS entries to notes. Ready...`;
            setTimeout(() => {
                if (shipmentInput) {
                     shipmentInput.placeholder = "Paste shipment data containing UPS/USPS...";
                }
             }, 3000);

        } else {
            alert("No data could be processed. Check console for details.");
        }
        if (notFoundCount > 0) {
             alert(`Warning: Could not find original data for ${notFoundCount} tracking number(s) listed.`);
        }
   }


    function addSeparator() { const ta = document.getElementById('noteArea'); const trimmedValue = ta.value.trimEnd(); ta.value = trimmedValue + (trimmedValue ? noteSeparator : ''); ta.focus(); ta.scrollTop = ta.scrollHeight; countTemplatesNoteTaker(); }
    function addSpacing() { const ta = document.getElementById('noteArea'); ta.value = ta.value.trimEnd() + '\n\n'; ta.focus(); ta.scrollTop = ta.scrollHeight; saveNotesToLocalStorage(); }
    function selectAllMerchants() { document.querySelectorAll('#merchantList .merchant-checkbox').forEach(cb => { cb.checked = true; }); updateSelectedCountNoteTaker(); }


    function handleMerchantNameEdit(event, originalSectionKey, originalDisplayName, isNameOriginallyFromFirstLine) {
        const editableSpan = event.target;
        const newName = editableSpan.textContent.trim();

        if (!newName || newName === originalDisplayName) {
            editableSpan.textContent = originalDisplayName;
            return;
        }

        const noteArea = document.getElementById('noteArea');
        const currentNotes = noteArea.value;
        let newSectionText;

        if (isNameOriginallyFromFirstLine) {
            const lines = originalSectionKey.split('\n');
            newSectionText = newName + (lines.length > 1 ? '\n' + lines.slice(1).join('\n') : '');
        } else {
            newSectionText = newName + '\n\n' + originalSectionKey;
        }

        const noteSeparatorCaptureRegex = new RegExp('(' + noteSeparator.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'g');
        const parts = currentNotes.split(noteSeparatorCaptureRegex);
        let reconstructedNotes = "";
        let replaced = false;

        for (let i = 0; i < parts.length; i++) {
            if (i % 2 === 0) { 
                if (parts[i].trim() === originalSectionKey.trim()) {
                    reconstructedNotes += newSectionText;
                    replaced = true;
                } else {
                    reconstructedNotes += parts[i];
                }
            } else { 
                reconstructedNotes += parts[i];
            }
        }

        if (replaced) {
            noteArea.value = reconstructedNotes;
            saveNotesToLocalStorage();
            countTemplatesNoteTaker(); 
        } else {
            console.warn("Failed to replace section text for name edit. Original section key:", originalSectionKey);
            editableSpan.textContent = originalDisplayName; 
        }
    }

    function countTemplatesNoteTaker() {
        const noteArea = document.getElementById('noteArea');
        const fullText = noteArea.value;
        const merchantListDiv = document.getElementById('merchantList');
        merchantListDiv.innerHTML = ''; 

        // This regex must find all known TN formats for accurate duplicate checking in notes
        const trackingNumberRegex = /\b([A-Z0-9]+(?:-|\s)*?\s*\((?:AMZ[NL]|AMZL_US_PREMIUM|UPS|USPS)\))/gi;
        const allTrackingNumbers = (fullText.match(trackingNumberRegex) || []);
        const seenTrackingNumbers = new Set(); // Stores core TNs
        const duplicatedTrackingNumbers = new Set(); // Stores core TNs that are duplicated
        allTrackingNumbers.forEach(tnString => { // tnString is "TN(CARRIER)"
            const coreTN = tnString.replace(/\s*\((?:AMZ[NL]|AMZL_US_PREMIUM|UPS|USPS)\)$/i, '').replace(/\s|-/g, '');
            if (seenTrackingNumbers.has(coreTN)) { duplicatedTrackingNumbers.add(coreTN); }
            seenTrackingNumbers.add(coreTN);
        });

        const merchantsData = {}; 
        let totalTemplatesOverall = 0;
        let merchantIndex = 0;
        const sections = fullText.split(noteSeparatorRegex);

        sections.forEach((sectionTextOriginal) => {
            const sectionText = sectionTextOriginal.trim();
            if (!sectionText) return;

            const amzlTemplateCount = countTemplatesInText(sectionText, amzlTemplate);
            const upsUspsTemplateCount = countTemplatesInText(sectionText, upsUspsTemplate);
            const templateCount = amzlTemplateCount + upsUspsTemplateCount;
            totalTemplatesOverall += templateCount;

            let merchantName = `Entry ${++merchantIndex}`;
            const firstLine = sectionText.split('\n')[0]?.trim();
            let isNameFromFirstLine = false;

            if (firstLine && !firstLine.startsWith(amzlTemplate.substring(0, 10)) && !firstLine.startsWith(upsUspsTemplate.substring(0,10)) && firstLine.length < 100 && !firstLine.includes(':') && !firstLine.startsWith('Removal order ID')) {
                merchantName = firstLine;
                isNameFromFirstLine = true;
            } else if (sectionText.includes('Removal order ID:')) {
                 merchantName = `Data Entry ${merchantIndex}`;
            }

            merchantsData[sectionTextOriginal] = { 
                 displayName: merchantName,
                 isNameFromFirstLine: isNameFromFirstLine,
                 count: templateCount,
                 text: sectionTextOriginal 
            };
        });

        document.getElementById('merchantCount').textContent = Object.keys(merchantsData).length;
        document.getElementById('totalTemplates').textContent = totalTemplatesOverall;

        const sortedMerchants = Object.entries(merchantsData).sort(([, a], [, b]) => a.displayName.localeCompare(b.displayName));

        sortedMerchants.forEach(([key, data]) => {
            const merchantDiv = document.createElement('div');
            merchantDiv.className = 'merchant-stats';
            merchantDiv.dataset.key = key; 
            merchantDiv.dataset.displayName = data.displayName;
            merchantDiv.dataset.count = data.count;

            const sectionTrackingNumbersFull = (data.text.match(trackingNumberRegex) || []); // "TN(CARRIER)" strings
            let sectionHasDuplicate = false;
            const duplicatesInSectionDisplay = new Set(); // Stores "TN(CARRIER)" strings for display
            sectionTrackingNumbersFull.forEach(tnString => {
                const coreTn = tnString.replace(/\s*\((?:AMZ[NL]|AMZL_US_PREMIUM|UPS|USPS)\)$/i, '').replace(/\s|-/g, '');
                if (duplicatedTrackingNumbers.has(coreTn)) {
                    sectionHasDuplicate = true;
                    duplicatesInSectionDisplay.add(tnString);
                }
            });

            const titleText = `${data.displayName} (${data.count} ${data.count === 1 ? 'case' : 'cases'})`;

            const innerFlexDiv = document.createElement('div');

            if (sectionHasDuplicate) {
                const indicatorSpan = document.createElement('span');
                indicatorSpan.className = 'duplicate-indicator';
                const dupeListString = Array.from(duplicatesInSectionDisplay).join(', ');
                indicatorSpan.title = `Contains duplicate TN(s): ${dupeListString}`;
                innerFlexDiv.appendChild(indicatorSpan);
            }

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'merchant-checkbox';
            checkbox.onchange = updateSelectedCountNoteTaker;
            innerFlexDiv.appendChild(checkbox);

            const nameAndCountWrapper = document.createElement('span');
            nameAndCountWrapper.className = 'merchant-name-editable-container';

            const nameSpan = document.createElement('span');
            nameSpan.className = 'merchant-name-display';
            nameSpan.contentEditable = true;
            nameSpan.textContent = data.displayName;
            nameSpan.title = titleText + (sectionHasDuplicate ? ` | DUPLICATES FOUND: ${Array.from(duplicatesInSectionDisplay).join(', ')}` : '');
            
            nameSpan.addEventListener('blur', (e) => handleMerchantNameEdit(e, key, data.displayName, data.isNameFromFirstLine));
            nameSpan.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') { e.preventDefault(); e.target.blur(); }
                else if (e.key === 'Escape') { e.preventDefault(); e.target.textContent = data.displayName; e.target.blur(); }
            });
            nameAndCountWrapper.appendChild(nameSpan);

            const countSpan = document.createElement('span');
            countSpan.className = 'merchant-count-text';
            countSpan.textContent = `(${data.count} ${data.count === 1 ? 'case' : 'cases'})`;
            nameAndCountWrapper.appendChild(countSpan);
            innerFlexDiv.appendChild(nameAndCountWrapper);

            if (sectionHasDuplicate) {
                const duplicateListSpan = document.createElement('span');
                const duplicateList = Array.from(duplicatesInSectionDisplay).join(', ');
                duplicateListSpan.style.cssText = "color: #ff9f0a; font-size: 0.8em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-shrink: 1; max-width: 80px;"; 
                duplicateListSpan.title = `Duplicate TN(s): ${duplicateList}`;
                duplicateListSpan.textContent = `(${duplicateList})`;
                innerFlexDiv.appendChild(duplicateListSpan);
            }

            merchantDiv.appendChild(innerFlexDiv);
            merchantDiv.onclick = (e) => {
                 if (e.target.type !== 'checkbox' && e.target.contentEditable !== true) { 
                     const cb = merchantDiv.querySelector('.merchant-checkbox');
                     if (cb) { cb.checked = !cb.checked; updateSelectedCountNoteTaker(); }
                 }
             };
            merchantListDiv.appendChild(merchantDiv);
        });
        updateSelectedCountNoteTaker();
    }


    function updateSelectedCountNoteTaker() {
        const selectedCheckboxes = document.querySelectorAll('#merchantList .merchant-checkbox:checked');
        const splitButton = document.getElementById('btnSplitSelected');
        let selectedCaseCount = 0;

        selectedCheckboxes.forEach(cb => {
            selectedCaseCount += parseInt(cb.closest('.merchant-stats')?.dataset?.count || '0', 10);
        });

        const totalTemplatesSpan = document.getElementById('totalTemplates');
        const merchantCountSpan = document.getElementById('merchantCount');
        const totalMerchantCount = document.querySelectorAll('#merchantList .merchant-stats').length;
        const totalCaseCountOverall = Array.from(document.querySelectorAll('#merchantList .merchant-stats')).reduce((sum, el) => sum + parseInt(el.dataset.count || '0', 10), 0);

        if (selectedCheckboxes.length > 0) {
            totalTemplatesSpan.textContent = selectedCaseCount;
            merchantCountSpan.textContent = selectedCheckboxes.length;
            if (splitButton) { splitButton.disabled = false; }
        } else {
            totalTemplatesSpan.textContent = totalCaseCountOverall;
            merchantCountSpan.textContent = totalMerchantCount;
            if (splitButton) { splitButton.disabled = true; }
        }
    }


    function downloadSelectedMerchants() {
        const selectedDivs = document.querySelectorAll('#merchantList .merchant-stats:has(.merchant-checkbox:checked)');
        if (selectedDivs.length === 0) { alert('Please select merchant(s) to download.'); return; }

        const textsToDownload = [];
        let totalSelectedCases = 0;
        selectedDivs.forEach((div) => {
            const key = div.dataset.key; 
            if (key !== undefined && key !== null) {
                textsToDownload.push(key);
                totalSelectedCases += parseInt(div.dataset.count || '0', 10);
            }
        });

        if (textsToDownload.length === 0) { alert("Could not retrieve text for selected merchants."); return; }

        const combinedText = textsToDownload.join(noteSeparator.trimEnd()); 
        const filename = `3COUTB_${getFormattedDate()}_(${totalSelectedCases}).txt`;
        downloadText(combinedText + '\n', filename); 
    }

    function clearSelectedMerchants() {
        const selectedDivs = document.querySelectorAll('#merchantList .merchant-stats:has(.merchant-checkbox:checked)');
        if (selectedDivs.length === 0) { alert('Please select merchant(s) to clear.'); return; }

        const noteArea = document.getElementById('noteArea');
        const fullText = noteArea.value;
        const keysToRemove = new Set();
        selectedDivs.forEach(div => { if (div.dataset.key !== undefined && div.dataset.key !== null) { keysToRemove.add(div.dataset.key); } });

        const allSections = [];
        fullText.split(noteSeparatorRegex).forEach(s => {
            if (s.trim() !== "") {
                allSections.push(s); 
            }
        });

        const remainingSections = allSections.filter(section => !keysToRemove.has(section));

        if (remainingSections.length > 0) {
             noteArea.value = remainingSections.join(noteSeparator);
        } else {
            noteArea.value = ""; 
        }

        countTemplatesNoteTaker(); 
    }

    function downloadAllNotes() {
        const noteArea = document.getElementById('noteArea');
        const textToDownload = noteArea.value.trim();
        if (!textToDownload) { alert("Nothing to download."); return; }
        const totalTemplatesCount = document.getElementById('totalTemplates').textContent;
        const filename = `3COUTB_${getFormattedDate()}_(${totalTemplatesCount}).txt`;
        downloadText(textToDownload + '\n', filename);
    }


    function processSingleROBlock(roBlockText, removalOrdersArray) {
        const roIdLineMatch = roBlockText.match(/^\s*Removal order ID:[^\n]+/);
        if (!roIdLineMatch) {
            return;
        }
        const currentRoIdLine = roIdLineMatch[0].trim();

        const remainingText = roBlockText.substring(roIdLineMatch[0].length).trim();
        if (!remainingText) { return; }

        const shipmentBlocks = remainingText.split(/(?=^\s*Shipment ID:)/m);

        shipmentBlocks.forEach((shipmentBlock) => {
             const trimmedShipmentBlock = shipmentBlock.trim();
             if (trimmedShipmentBlock.startsWith('Shipment ID:') && trimmedShipmentBlock.includes('Merchant SKU:')) {
                 const completeOrderBlock = (currentRoIdLine + '\n' + trimmedShipmentBlock);
                 removalOrdersArray.push(completeOrderBlock);
             }
        });
    }

   function splitTextIntoRemovalOrders(inputText) {
        const removalOrders = [];
        if (!inputText) { return removalOrders; }

        let textToProcess = inputText.trim();
        const escapedAmzlTemplate = amzlTemplate.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const escapedUpsUspsTemplate = upsUspsTemplate.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const templateRegexAmzl = new RegExp('^\\s*' + escapedAmzlTemplate + '\\s*\\n*', 'gm');
        const templateRegexUpsUsps = new RegExp('^\\s*' + escapedUpsUspsTemplate + '\\s*\\n*', 'gm');

        textToProcess = textToProcess.replace(templateRegexAmzl, '').replace(templateRegexUpsUsps, '').trim();
        
        const linesForRO = textToProcess.split('\n');
        if (linesForRO.length > 2 && linesForRO[1].trim() === "" && linesForRO[2].startsWith("Removal order ID:")) {
            textToProcess = linesForRO.slice(2).join('\n');
        } else if (linesForRO.length > 0 && linesForRO[0].startsWith("Removal order ID:")) {
            textToProcess = linesForRO.join('\n');
        }
        
        const potentialROBlocks = textToProcess.split(/(?=^\s*Removal order ID:)/m);

        potentialROBlocks.forEach((roBlock) => {
            const trimmedROBlock = roBlock.trim();
            if (!trimmedROBlock) return;
            if (trimmedROBlock.startsWith('Removal order ID:')) {
                processSingleROBlock(trimmedROBlock, removalOrders);
            }
        });
        return removalOrders;
   }

   function createTemplates(removalOrders, removalOrdersPerTemplate) {
        const templates = [];
        if (!removalOrders || removalOrders.length === 0 || removalOrdersPerTemplate <= 0) {
            return templates;
        }
        for (let i = 0; i < removalOrders.length; i += removalOrdersPerTemplate) {
            const templateRemovalOrders = removalOrders.slice(i, i + removalOrdersPerTemplate);
             const validOrders = templateRemovalOrders.filter(order => order && typeof order === 'string');
             if (validOrders.length > 0) {
                 templates.push(validOrders.join('\n\n'));
             }
        }
        return templates;
   }

    let selectedMerchantDataForSplit = [];

    function openSplitModal() {
        selectedMerchantDataForSplit = [];
        const selectedDivs = document.querySelectorAll('#merchantList .merchant-stats:has(.merchant-checkbox:checked)');
        if (selectedDivs.length === 0) { alert("Please select at least one merchant to split."); return; }

        const modalElements = {
            modal: document.getElementById('splitModal'),
            merchantInfoDiv: document.getElementById('splitMerchantInfo'),
            ordersPerTemplateInput: document.getElementById('splitOrdersPerTemplate'),
            calculatedTemplatesSpan: document.getElementById('splitCalculatedTemplates'),
            splitNumberInput: document.getElementById('splitNumberInput')
        };
        let missingElement = null;
        for (const key in modalElements) { if (!modalElements[key]) { missingElement = key; break; } }
        if (missingElement) { console.error(`openSplitModal error: Modal element with ID '${missingElement}' not found!`); alert("Error: Could not initialize the split dialog."); return; }

        const modal = modalElements.modal;
        const merchantInfoDiv = modalElements.merchantInfoDiv;
        const ordersPerTemplateInput = modalElements.ordersPerTemplateInput;
        const calculatedTemplatesSpan = modalElements.calculatedTemplatesSpan;
        const splitNumberInput = modalElements.splitNumberInput;

        let combinedTextParts = [];
       let containsUpsUsps = false;
       let containsAmzl = false;

        selectedDivs.forEach((div) => {
            const key = div.dataset.key; 
            const displayName = div.dataset.displayName || `Merchant (Unknown)`;
            if (key !== undefined && key !== null) {
                selectedMerchantDataForSplit.push({ key: key, name: displayName });
                combinedTextParts.push(key);
                if (key.includes(upsUspsTemplate)) containsUpsUsps = true;
                if (key.includes(amzlTemplate)) containsAmzl = true;
            }
        });
        const merchantNames = selectedMerchantDataForSplit.map(item => item.name);
        const combinedText = combinedTextParts.join(noteSeparator.trimEnd()); 
        modal.dataset.combinedText = combinedText;
        modal.dataset.containsAmzl = containsAmzl;
        modal.dataset.containsUpsUsps = containsUpsUsps;


        if (merchantNames.length === 1) { merchantInfoDiv.textContent = `Merchant: ${merchantNames[0]}`; }
        else if (merchantNames.length > 1) { merchantInfoDiv.textContent = `Merchants: ${merchantNames.slice(0, 3).join(', ')}${merchantNames.length > 3 ? '...' : ''} (${merchantNames.length} total)`; }
        else { merchantInfoDiv.textContent = 'No valid merchants selected.'; }

        ordersPerTemplateInput.value = '2';
        splitNumberInput.value = ''; 
        calculatedTemplatesSpan.textContent = '0';
        updateCalculatedTemplates();
        modal.style.display = 'flex';
    }

    function closeSplitModal() {
        const modal = document.getElementById('splitModal');
        if(modal) {
          modal.style.display = 'none';
          modal.dataset.combinedText = '';
          modal.dataset.containsAmzl = '';
          modal.dataset.containsUpsUsps = '';
        }
    }

    function updateCalculatedTemplates() {
         const modal = document.getElementById('splitModal');
         if (!modal) return;
         const combinedText = modal.dataset.combinedText || '';
         const ordersPerTemplateInput = document.getElementById('splitOrdersPerTemplate');
         const calculatedTemplatesSpan = document.getElementById('splitCalculatedTemplates');
         if (!ordersPerTemplateInput || !calculatedTemplatesSpan) return;

         const ordersPerTemplate = parseInt(ordersPerTemplateInput.value) || 0;
         if (ordersPerTemplate > 0 && combinedText) {
             const removalOrders = splitTextIntoRemovalOrders(combinedText);
             const templateGroups = createTemplates(removalOrders, ordersPerTemplate);
             calculatedTemplatesSpan.textContent = templateGroups.length;
         } else {
             calculatedTemplatesSpan.textContent = '0';
         }
       }

   function generateAndDownloadSplits() {
        const modal = document.getElementById('splitModal');
        if (!modal) return;

        const combinedText = modal.dataset.combinedText || '';
        const ordersPerTemplateInput = document.getElementById('splitOrdersPerTemplate');
        const splitNumberInput = document.getElementById('splitNumberInput');
        const containsAmzl = modal.dataset.containsAmzl === 'true';
        const containsUpsUsps = modal.dataset.containsUpsUsps === 'true';

        if (!ordersPerTemplateInput || !splitNumberInput) { alert("Error: Modal inputs not found."); return; }

        const ordersPerTemplate = parseInt(ordersPerTemplateInput.value);
        const splitNumber = parseInt(splitNumberInput.value);

        if (!combinedText) { alert("Error: No text found for selected merchants."); return; }
        if (isNaN(ordersPerTemplate) || ordersPerTemplate < 1) { alert("Please enter a valid number for 'Removal Orders per Template'."); return; }
        if (isNaN(splitNumber) || splitNumber < 1) { alert("Please enter a valid number for 'Templates per Split File'."); return; }

        let templateToUse = amzlTemplate;
        if (containsUpsUsps && !containsAmzl) {
            templateToUse = upsUspsTemplate;
        } else if (containsUpsUsps && containsAmzl) {
            console.warn("Split contains mixed AMZL and UPS/USPS entries. Using AMZL template for splitting. This might not be ideal for UPS/USPS only data.");
        }

        const removalOrders = splitTextIntoRemovalOrders(combinedText);
        if (removalOrders.length === 0) {
            alert("Could not find any valid removal orders in the selected text after cleaning. Please check data format or if selected entries were only merchant names.");
            return;
        }

        const templateGroups = createTemplates(removalOrders, ordersPerTemplate);
        if (templateGroups.length === 0) { alert("Failed to generate template groups. This might happen if 'Orders per Template' is too high or data is unusual."); return; }

        const splitOutputs = [];
        for (let i = 0; i < templateGroups.length; i += splitNumber) {
            const groupChunk = templateGroups.slice(i, i + splitNumber);
            if (groupChunk.length > 0) {
                 const fileTemplates = groupChunk.map(dataForOneTemplate => templateToUse + "\n\n" + dataForOneTemplate);
                splitOutputs.push({ text: fileTemplates.join('\n\n'), count: groupChunk.length });
            }
        }

        if (splitOutputs.length === 0) { alert("No split files generated."); return; }

        let filenameMerchantPart = "SplitSelection";
        let merchantDisplayStringForFile = selectedMerchantDataForSplit.map(m=>m.name).join(' & '); 

        if (selectedMerchantDataForSplit.length === 1) {
            filenameMerchantPart = sanitizeFilename(selectedMerchantDataForSplit[0].name);
        } else if (selectedMerchantDataForSplit.length > 1) {
            filenameMerchantPart = sanitizeFilename(selectedMerchantDataForSplit[0].name) + "_Multi";
        }


        const dateStr = getFormattedDate();
        splitOutputs.forEach((outputData, index) => {
            const partNumber = index + 1;
            const filename = `3COUTB_${dateStr}_${filenameMerchantPart}_PART_${partNumber}(${outputData.count}).txt`;
            const fileContent = merchantDisplayStringForFile + '\n\n' + outputData.text + '\n';
            downloadText(fileContent, filename);
        });

        closeSplitModal();
   }

    document.addEventListener('DOMContentLoaded', () => {
        const shipmentInput = document.getElementById('shipmentInput');
        const noteArea = document.getElementById('noteArea');
        const groupToggle = document.getElementById('groupToggle');
        const groupSizeInput = document.getElementById('parserGroupSize');
        const upsUspsToggle = document.getElementById('upsUspsToggle');
        const upsUspsOutputContainer = document.getElementById('upsUspsOutputContainer');
        const upsUspsOutputArea = document.getElementById('upsUspsOutputArea');
        const groupOrdersControl = document.getElementById('groupOrdersControl');

        if (noteArea) {
            const savedNotes = localStorage.getItem(localStorageKey);
            if (savedNotes) { noteArea.value = savedNotes; }
             let countTimer;
             noteArea.addEventListener('input', () => {
                 clearTimeout(countTimer);
                 countTimer = setTimeout(() => {
                     saveNotesToLocalStorage(); 
                     countTemplatesNoteTaker(); 
                    }, 300);
             });
             noteArea.addEventListener('paste', (e) => {
                 setTimeout(() => {
                     saveNotesToLocalStorage(); 
                     countTemplatesNoteTaker(); 
                    }, 50);
             });
        } else { console.error("Note area element not found!"); }

        if (upsUspsOutputArea) {
            const savedUpsUspsTNs = localStorage.getItem(upsUspsOutputKey);
            if (savedUpsUspsTNs) {
                upsUspsOutputArea.value = savedUpsUspsTNs;
            }
        } else { console.error("UPS/USPS output area element not found!"); }

        try {
            const savedUpsUspsContext = localStorage.getItem(upsUspsContextKey);
            if (savedUpsUspsContext) {
                tempUpsUspsData = JSON.parse(savedUpsUspsContext);
                if (typeof tempUpsUspsData !== 'object' || tempUpsUspsData === null) {
                    tempUpsUspsData = {};
                }
            } else {
                tempUpsUspsData = {};
            }
        } catch (error) {
            console.error("Error loading UPS/USPS context from localStorage:", error);
            tempUpsUspsData = {};
        }


        if (shipmentInput) {
            let parseTimer;
            shipmentInput.addEventListener('input', () => {
                clearTimeout(parseTimer);
                if (shipmentInput.value.trim()) { parseTimer = setTimeout(parseShipmentData, 500); }
            });
        } else { console.error("Shipment input element not found!"); }

        try { countTemplatesNoteTaker(); } catch(error) { console.error("Error during initial countTemplatesNoteTaker:", error); }

         document.querySelector('.main-wrapper').addEventListener('click', function(event) {
            const targetButton = event.target.closest('button');
            if (!targetButton || targetButton.closest('#splitModal')) { return; } 

            try {
                switch (targetButton.id) {
                    case 'btnAddSeparator': addSeparator(); break;
                    case 'btnAddSpacing': addSpacing(); break;
                    case 'btnDownloadSelected': downloadSelectedMerchants(); break;
                    case 'btnClearSelected': clearSelectedMerchants(); break;
                    case 'btnSelectAll': selectAllMerchants(); break;
                    case 'btnDownloadAll': downloadAllNotes(); break;
                    case 'btnSplitSelected': openSplitModal(); break;
                    case 'btnProcessUpsUsps':
                        if (targetButton.closest('.parser-tool')) { 
                            processUpsUspsData();
                        }
                        break;
                    default: break;
                }
            } catch (error) {
                console.error(`Error executing action for button ${targetButton.id}:`, error);
            }
        });


         if (groupToggle && groupSizeInput) {
               groupToggle.addEventListener('change', function() { groupSizeInput.disabled = !this.checked; });
               groupSizeInput.disabled = !groupToggle.checked;
         } else { console.error("Parser Group toggle or group size input not found!"); }

         if (upsUspsToggle && upsUspsOutputContainer && groupOrdersControl && shipmentInput && upsUspsOutputArea) {
             function toggleUpsUspsMode(isUpsMode) {
                  upsUspsOutputContainer.style.display = isUpsMode ? 'block' : 'none';
                  groupOrdersControl.style.opacity = isUpsMode ? '0.5' : '1';
                  groupOrdersControl.style.pointerEvents = isUpsMode ? 'none' : 'auto';
                  if (isUpsMode && groupToggle) {
                      groupToggle.checked = false;
                       if (groupSizeInput) groupSizeInput.disabled = true;
                  }

                  if (isUpsMode) {
                      shipmentInput.placeholder = "Paste shipment data containing UPS/USPS...";
                  } else {
                      // Don't clear upsUspsOutputArea or tempUpsUspsData here
                      // as they might contain staged data the user wants to process later.
                      // Only clear them when 'Process & Add to Notes' is clicked for UPS/USPS.
                      shipmentInput.placeholder = "Paste Amazon removal shipment data here...";
                      if (groupToggle && groupSizeInput) groupSizeInput.disabled = !groupToggle.checked;
                  }
             }

              upsUspsToggle.addEventListener('change', function() {
                  toggleUpsUspsMode(this.checked);
              });
              toggleUpsUspsMode(upsUspsToggle.checked); // Initialize based on current state

         } else { console.error("Parser UPS/USPS toggle or related elements not found!"); }

         const splitModalEl = document.getElementById('splitModal');
         const btnCancelSplit = document.getElementById('btnCancelSplit');
         const btnGenerateSplits = document.getElementById('btnGenerateSplits');
         const ordersPerTemplateInputModal = document.getElementById('splitOrdersPerTemplate');
         if (splitModalEl && btnCancelSplit && btnGenerateSplits && ordersPerTemplateInputModal) {
               btnCancelSplit.addEventListener('click', closeSplitModal);
               splitModalEl.addEventListener('click', (event) => {
                    if (event.target === splitModalEl) { closeSplitModal(); }
                 });
               btnGenerateSplits.addEventListener('click', generateAndDownloadSplits);
               ordersPerTemplateInputModal.addEventListener('input', updateCalculatedTemplates);
         } else { console.error("Could not attach one or more Split Modal event listeners."); }
    });
</script>

</body>
</html>
