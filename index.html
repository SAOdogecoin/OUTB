<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Outbound AMZL Tool</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="." />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --system-font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            --mono-font: 'SF Mono', Consolas, 'Courier New', Courier, monospace;
            --primary-bg: #ffffff;
            --container-bg: #ffffff;
            --text-color: #1d1d1f; 
            --secondary-text-color: #6e6e73;
            --placeholder-text-color: #aaaaaf;
            --accent-blue: #007aff;
            --accent-blue-rgb: 0, 122, 255;

            --button-bg: #1d1d1f;
            --button-text: #ffffff;
            --button-border-color: #1d1d1f;
            --button-hover-bg: #38383a;
            --button-hover-border-color: #38383a;
            --button-active-bg: #4f4f52;
            --button-active-border-color: #4f4f52;
            --button-disabled-bg: #e0e0e0;
            --button-disabled-text: #9e9e9e;
            --button-disabled-border: #e0e0e0;

            --danger-button-bg: #ff3b30;
            --danger-button-text: #ffffff;
            --danger-button-border-color: #ff3b30;
            --danger-button-hover-bg: #ff453a;
            --danger-button-hover-border-color: #ff453a;
            --danger-button-active-bg: #d63027;
            --danger-button-active-border-color: #d63027;


            --border-color: #d2d2d7;
            --base-border-radius: 10px;
            --button-border-radius: 6px;
            --input-border-radius: 6px;
            --top-bar-height: 50px;
            --top-bar-bg: #1d1d1f; 
            --top-bar-text-color: #ffffff; 
        }
        html { box-sizing: border-box; }
        *, *:before, *:after { box-sizing: inherit; }
        body {
            font-family: var(--system-font); background-color: var(--primary-bg);
            color: var(--text-color); margin: 0; padding: 0; display: flex;
            flex-direction: column; min-height: 100vh;
            -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
            font-size: 14px;
        }

        .top-bar {
            background-color: var(--top-bar-bg);
            padding: 0 12px 0 10px; 
            height: var(--top-bar-height);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .top-bar-left {
            display: flex;
            align-items: center; 
            gap: 8px; 
        }

        .top-bar-title {
            font-size: 1.1em; 
            font-weight: 600; 
            color: var(--top-bar-text-color);
            margin: 0 0 0 10px; /* Added left margin since logo is removed */
            line-height: 1; 
        }
        
        .settings-button {
            background-color: transparent;
            color: var(--top-bar-text-color);
            border: none;
            font-size: 1.2em; /* Make icon a bit larger */
            padding: 8px;
            cursor: pointer;
            border-radius: var(--button-border-radius);
        }
        .settings-button:hover {
            background-color: rgba(255,255,255,0.1);
        }
        .settings-button:active {
            background-color: rgba(255,255,255,0.2);
        }


        .main-wrapper {
            display: flex; flex-direction: column; flex-grow: 1; padding: 16px; gap: 16px;
            width: 100%; max-width: 1600px; margin: 0 auto; overflow: hidden;
        }

        .left-column-wrapper {
            display: flex; flex-direction: column; gap: 16px;
        }

        .tool-card-title {
            display: none; /* Default for mobile */
            font-size: 1.1em;
            font-weight: 600;
            color: var(--text-color);
            margin: -5px 0 10px 0;
        }
        .tool-card-title > i.fa-solid, .tool-card-title > i.fa-regular {
            margin-right: 8px;
            font-size: 0.9em; /* Relative to title font size */
            color: var(--text-color); 
        }


        @media (min-width: 992px) {
            .main-wrapper {
                flex-direction: row; padding: 24px; gap: 24px; align-items: stretch;
            }
            .tool-card-title {
                display: flex; 
                align-items: center; 
            }
            .left-column-wrapper {
                width: calc(35% - (24px * 0.35)); 
                flex-shrink: 0;
                gap: 24px;
                max-height: calc(100vh - var(--top-bar-height) - (2 * 24px));
                overflow-y: auto; padding-bottom: 1px;
            }
            .note-taker-tool {
                width: calc(65% - (24px * 0.65)); 
                flex-shrink: 0;
                display: flex; flex-direction: column;
                max-height: calc(100vh - var(--top-bar-height) - (2 * 24px));
            }
             #noteArea { flex-grow: 1; min-height: 200px; }
             .note-taker-tool .controls-and-stats { flex-shrink: 0; margin-top: 16px; }
             .merchant-actions-tool #merchantList { height: 220px; }
        }
        /* Removed rule that hid .top-bar on max-width: 991px */
        @media (max-width: 991px) {
            /* .top-bar { display: none; } */ /* This line is removed/commented out */
            .main-wrapper { overflow-y: auto; overflow-x: hidden; max-height: calc(100vh - var(--top-bar-height)); } /* Adjust max-height */
             .left-column-wrapper, .note-taker-tool { max-height: none; overflow-y: visible; }
             #noteArea { min-height: 300px; }
             .merchant-actions-tool #merchantList { height: 200px; }
        }

        .tool-container {
             background-color: var(--container-bg); border-radius: var(--base-border-radius);
             box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
             padding: 20px;
             display: flex; flex-direction: column; position: relative;
             border: 1px solid var(--border-color);
         }

        textarea, input[type="text"], input[type="number"] {
            width: 100%; margin-bottom: 12px; padding: 10px 12px;
            border: 1px solid var(--border-color); border-radius: var(--input-border-radius);
            background-color: var(--container-bg);
            color: var(--text-color);
            line-height: 1.5; font-family: var(--system-font); font-size: 14px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            box-shadow: none;
        }
        textarea { font-family: var(--mono-font); resize: vertical; min-height: 100px; }
        textarea::placeholder, input::placeholder { color: var(--placeholder-text-color); }
        textarea:focus, input[type="text"]:focus, input[type="number"]:focus {
            border-color: var(--border-color); 
            outline: none;
            box-shadow: none; 
        }
        input[type="number"] { width: auto; margin-bottom: 0; }

       #shipmentInput { margin-bottom: 0; min-height: 150px; }

        button {
            background-color: var(--button-bg); color: var(--button-text);
            padding: 7px 14px;
            border: 1px solid var(--button-border-color);
            border-radius: var(--button-border-radius); cursor: pointer; margin: 0;
            transition: background-color 0.15s ease, border-color 0.15s ease, transform 0.1s ease;
            font-family: var(--system-font);
            font-weight: 500; font-size: 13px;
            flex-shrink: 0; text-align: center; display: inline-flex;
            align-items: center; justify-content: center; position: relative; overflow: hidden;
            box-shadow: none;
        }
        button:hover {
            background-color: var(--button-hover-bg);
            border-color: var(--button-hover-border-color);
        }
        button:active {
            background-color: var(--button-active-bg);
            border-color: var(--button-active-border-color);
            transform: scale(0.97);
        }
        button:disabled {
            background-color: var(--button-disabled-bg);
            color: var(--button-disabled-text);
            border-color: var(--button-disabled-border);
            cursor: not-allowed;
        }
        button.danger {
            background-color: var(--danger-button-bg);
            color: var(--danger-button-text);
            border-color: var(--danger-button-border-color);
        }
        button.danger:hover {
            background-color: var(--danger-button-hover-bg);
            border-color: var(--danger-button-hover-border-color);
        }
        button.danger:active {
            background-color: var(--danger-button-active-bg);
            border-color: var(--danger-button-active-border-color);
        }

        button:disabled:hover {
            background-color: var(--button-disabled-bg);
            border-color: var(--button-disabled-border);
        }
        button:disabled:active { transform: none; }
        
        button > i.fa-solid, button > i.fa-regular {
            margin-right: 6px; 
            font-size: 0.9em;  
        }

        .note-taker-tool .controls-and-stats { display: flex; flex-direction: column; gap: 12px; flex-shrink: 0; margin-top: auto; }
        .note-taker-tool .top-controls { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .note-taker-tool .button-group { display: flex; gap: 8px; flex-wrap: wrap; }

        .note-taker-tool .counter-pill {
            display: inline-flex; align-items: center; 
            background-color: var(--primary-bg);
            padding: 7px 14px;
            border-radius: var(--button-border-radius);
            border: 1px solid var(--border-color);
            font-size: 13px;
            font-weight: 500;
        }
        .note-taker-tool .counter-pill > i.fa-solid, 
        .note-taker-tool .counter-pill > i.fa-regular {
            margin-right: 4px; 
            margin-left: 0; 
            color: var(--text-color); 
            font-size: 0.9em; 
        }
        .note-taker-tool .counter-pill > i.fa-solid:not(:first-child),
        .note-taker-tool .counter-pill > i.fa-regular:not(:first-child) {
            margin-left: 8px; 
        }
        .note-taker-tool .counter-pill p { 
            margin: 0; 
            color: var(--text-color); 
        }
        .note-taker-tool .counter-pill p span { 
            font-weight: 600; color: var(--text-color); margin-left: 2px; 
        }


        .merchant-actions-tool .bulk-actions {
            margin-bottom: 12px; display: flex; gap: 8px; flex-wrap: wrap; flex-shrink: 0;
        }
        .merchant-actions-tool #merchantList {
            min-height: 150px; max-height: 60vh; overflow-y: auto; resize: vertical;
            margin: 0; padding: 8px; border: 1px solid var(--border-color);
            border-radius: var(--input-border-radius); display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 8px; align-content: start;
        }
        .merchant-actions-tool .merchant-stats {
            margin: 0; padding: 7px 10px; background-color: transparent; border: none;
            border-radius: 5px; display: flex; align-items: center; justify-content: flex-start;
            font-size: 13px; transition: background-color 0.15s ease; cursor: pointer;
            border: 1px solid var(--border-color);
        }
        .merchant-actions-tool .merchant-stats:hover { background-color: #f0f0f5; }
        .merchant-actions-tool .merchant-stats:has(.merchant-checkbox:checked) { background-color: #e8f3ff; } 
        .merchant-actions-tool .merchant-stats > div { display: flex; align-items: center; justify-content: flex-start; width: 100%; gap: 8px; }

        .merchant-actions-tool .merchant-checkbox {
            appearance: none; -webkit-appearance: none; -moz-appearance: none;
            width: 16px; height: 16px; border: 1px solid #c7c7cc; border-radius: 4px;
            outline: none; cursor: pointer; position: relative;
            transition: background-color 0.15s ease, border-color 0.15s ease;
            flex-shrink: 0; background-color: var(--container-bg); margin: 0;
        }
        .merchant-actions-tool .merchant-checkbox:checked {
            background-color: var(--text-color); 
            border-color: var(--text-color);  
        }
        .merchant-actions-tool .merchant-checkbox:checked::after {
            content: ''; position: absolute; top: 1px; left: 4px; width: 4px; height: 8px;
            border: solid white; border-width: 0 2px 2px 0; transform: rotate(45deg);
        }

        .merchant-name-display { text-overflow: ellipsis; overflow: hidden; white-space: nowrap; cursor: text; padding: 2px 4px; border: 1px solid transparent; border-radius: 3px; display: inline-block; flex-grow: 1; }
        .merchant-name-display:focus { border: 1px solid var(--border-color); background-color: var(--primary-bg); box-shadow: none; outline: none; white-space: normal; overflow: visible; }
        .merchant-name-editable-container { display: flex; align-items: baseline; overflow: hidden; flex-grow: 1; min-width: 0; }
        .merchant-count-text { flex-shrink: 0; margin-left: 4px; }

        * { scrollbar-width: thin; scrollbar-color: #c0c0c0 transparent; }
        *::-webkit-scrollbar { width: 9px; height: 9px; }
        *::-webkit-scrollbar-track { background: transparent; }
        *::-webkit-scrollbar-thumb { background-color: #cccccc; border-radius: 5px; border: 2px solid transparent; background-clip: content-box; }
        *::-webkit-scrollbar-thumb:hover { background-color: #b3b3b3; }

        .parser-controls { display: flex; align-items: center; gap: 16px; margin-top: 12px; margin-bottom: 0; padding-bottom: 4px; flex-wrap: wrap; }
        .toggle-label { font-size: 13px; color: var(--text-color); cursor: pointer; user-select: none; margin-right: 4px; }
        .toggle-switch {
            position: relative; 
            display: inline-block;
            width: 40px;
            height: 22px;
            flex-shrink: 0;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #c7c7cc; 
            transition: background-color 0.3s ease-in-out; 
        }
        .slider:before {
            position: absolute; 
            content: "";
            height: 18px;  
            width: 18px;   
            left: 2px;     
            bottom: 2px;   
            background-color: white; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.15);
            transition: transform 0.3s ease-in-out; 
        }
        input:checked + .slider {
            background-color: var(--text-color); 
        }
        input:checked + .slider:before {
            transform: translateX(18px); 
        }
        .slider.round {
            border-radius: 22px; 
        }
        .slider.round:before {
            border-radius: 50%; 
        }

        #parserGroupSize {
            width: 70px; padding: 6px 8px; font-size: 13px; margin-bottom: 0; text-align: center;
            border: 1px solid var(--border-color); border-radius: var(--input-border-radius);
            background-color: var(--container-bg); transition: background-color 0.3s ease, opacity 0.3s ease;
        }
        #parserGroupSize:disabled { background-color: #f8f8f8; color: #bbb; cursor: not-allowed; opacity: 0.7; border-color: #e8e8ed; }

        .duplicate-indicator { display: inline-block; width: 8px; height: 8px; background-color: #ff9f0a; border-radius: 50%; margin-right: 6px; vertical-align: middle; flex-shrink: 0; box-shadow: none; }
        #upsUspsOutputArea { width: 100%; min-height: 80px; resize: vertical; border-radius: var(--input-border-radius); }
        #btnProcessUpsUsps { margin-top: 8px; }
        #upsUspsOutputContainer { margin-top: 12px; padding-bottom: 4px; }

        /* Split Modal */
        #splitModal { backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); background-color: rgba(60,60,67,0.4); }
        #splitModalContent { background-color: #f9f9f9; margin: auto; padding: 20px; border: none; border-radius: 14px; width: 90%; max-width: 480px; box-shadow: 0 6px 20px rgba(0,0,0,0.12); display: flex; flex-direction: column; gap: 12px; }
        #splitModalContent h2 { 
            margin-top: 0; margin-bottom: 8px; font-size: 1.15em; font-weight: 600; color: var(--text-color); 
            border-bottom: 1px solid #e5e5ea; padding-bottom: 10px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        #splitModalContent h2 > i.fa-solid, #splitModalContent h2 > i.fa-regular {
            margin-right: 8px;
            font-size: 0.9em;
        }
        #splitModalContent label { font-size: 0.85rem; font-weight: 500; color: var(--secondary-text-color); margin-bottom: 4px; display: block; }
        #splitModalContent #splitOrdersPerTemplate, #splitModalContent #splitNumberInput { margin-bottom: 0; border-radius: var(--input-border-radius); }
        #splitModalContent #splitOrdersPerTemplate { width: 60px; }
        #splitModalContent #splitNumberInput { width: 75px; flex-grow: 1; }
        #splitMerchantInfo { font-size: 0.9em; color: var(--secondary-text-color); background-color: #f0f0f5; padding: 8px 12px; border-radius: var(--input-border-radius); border: 1px solid var(--border-color); }
        #splitModalContent hr { border: none; border-top: 1px solid #e5e5ea; margin: 6px 0; }
        #splitModalContent .modal-actions { display: flex; gap: 10px; margin-top: 10px; justify-content: flex-end; }

        /* Settings Modal */
        .modal-overlay {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; justify-content: center; align-items: center;
            backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
            background-color: rgba(60,60,67,0.4); font-family: var(--system-font);
        }
        .modal-content {
            background-color: #f9f9f9; margin: auto; padding: 20px; border: none;
            border-radius: 14px; width: 90%; max-width: 520px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.12); display: flex; flex-direction: column; gap: 15px;
        }
        .modal-content h2 {
            margin-top: 0; margin-bottom: 8px; font-size: 1.15em; font-weight: 600; color: var(--text-color);
            border-bottom: 1px solid #e5e5ea; padding-bottom: 10px;
            display: flex; align-items: center; justify-content: space-between;
        }
         .modal-content h2 > i.fa-solid { margin-right: 8px; font-size: 0.9em; }
        .modal-content .close-button {
            font-size: 1.3em; color: var(--secondary-text-color); cursor: pointer; background: none; border: none; padding: 0 5px;
        }
        .modal-content .close-button:hover { color: var(--text-color); }

        .modal-content .form-group { display: flex; flex-direction: column; gap: 5px; }
        .modal-content .form-group label { font-size: 0.9rem; font-weight: 500; color: var(--text-color); }
        .modal-content .form-group input[type="text"] { margin-bottom: 0; }
        .modal-content .form-group small { font-size: 0.8rem; color: var(--secondary-text-color); }
        .modal-actions { display: flex; gap: 10px; margin-top: 10px; justify-content: flex-end; }
        .modal-actions button { padding: 8px 16px; }

    </style>
</head>
<body>

    <div class="top-bar">
        <div class="top-bar-left">
            <!-- Icon placeholder removed -->
            <h1 class="top-bar-title">AMZL,UPS/USPS Outbound Tool</h1>
        </div>
        <button id="btnOpenSettings" class="settings-button" title="Settings"><i class="fa-solid fa-gear"></i></button>
        <!-- Version dropdown removed -->
    </div>

    <div class="main-wrapper">
        <div class="left-column-wrapper">
            <div class="tool-container parser-tool">
                <h3 class="tool-card-title"><i class="fa-solid fa-filter"></i>Parser</h3>
                <textarea id="shipmentInput" placeholder="Paste Amazon removal shipment data here..."></textarea>
                <div class="parser-controls">
                    <div style="display: flex; align-items: center; gap: 8px;" id="groupOrdersControl">
                        <label class="toggle-switch">
                            <input type="checkbox" id="groupToggle"> <span class="slider round"></span>
                        </label>
                        <label for="groupToggle" class="toggle-label">Group Orders (AMZL-type)</label>
                        <input type="number" id="parserGroupSize" min="1" value="2" disabled>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label class="toggle-switch">
                            <input type="checkbox" id="upsUspsToggle"> <span class="slider round"></span>
                        </label>
                        <label for="upsUspsToggle" class="toggle-label">Extract Other Carriers</label>
                    </div>
                </div>
                <div id="upsUspsOutputContainer" style="display: none;">
                    <textarea id="upsUspsOutputArea" placeholder="Extracted Other Carrier Tracking Numbers..."></textarea>
                    <button id="btnProcessUpsUsps"><i class="fa-solid fa-gears"></i>Process & Add to Notes</button>
                </div>
            </div>

            <div class="tool-container merchant-actions-tool">
                <h3 class="tool-card-title"><i class="fa-solid fa-users"></i>Merchants</h3>
                <div class="bulk-actions">
                    <button id="btnDownloadSelected"><i class="fa-solid fa-download"></i>Download Selected</button>
                    <button id="btnClearSelected" class="danger"><i class="fa-regular fa-trash-can"></i>Clear Selected</button>
                    <button id="btnSelectAll"><i class="fa-regular fa-square-check"></i>Select All</button>
                    <button id="btnSplitSelected" disabled><i class="fa-solid fa-table-columns"></i>Split Selected</button>
                    <button id="btnDownloadAll"><i class="fa-solid fa-file-arrow-down"></i>Download All Notes</button>
                </div>
                <div id="merchantList">
                </div>
            </div>
        </div>

        <div class="tool-container note-taker-tool">
            <h3 class="tool-card-title"><i class="fa-regular fa-pen-to-square"></i>Notes</h3>
            <textarea id="noteArea" placeholder="Notes area..."></textarea>
            <div class="controls-and-stats">
                <div class="top-controls">
                    <div class="button-group">
                        <button id="btnAddSeparator"><i class="fa-solid fa-minus"></i>Add Separator</button>
                        <button id="btnAddSpacing"><i class="fa-solid fa-grip-lines"></i>Add Spacing</button>
                        <button id="btnClearAllNotes" class="danger"><i class="fa-solid fa-eraser"></i>Clear All Notes</button>
                        <!-- Undo/Redo buttons removed -->
                    </div>
                    <div class="counter-pill">
                        <i class="fa-solid fa-users"></i><p class="merchant-count">Merchants: <span id="merchantCount">0</span></p>
                        <i class="fa-solid fa-file-lines"></i><p class="total-templates">Cases: <span id="totalTemplates">0</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Split Modal -->
    <div id="splitModal" class="modal-overlay" style="/* display: none; is now controlled by class or JS */">
        <div id="splitModalContent" class="modal-content">
             <h2><i class="fa-solid fa-table-columns"></i>Split Selected Merchant(s)</h2>
            <div id="splitMerchantInfo">
            </div>
            <div>
                <label for="splitOrdersPerTemplate">Removal Orders per Template:</label>
                <input type="number" id="splitOrdersPerTemplate" min="1" value="2">
            </div>
            <div style="font-size: 0.9em; color: var(--secondary-text-color);">
                Calculated Total Templates: <span id="splitCalculatedTemplates" style="font-weight: 600; color: var(--text-color);">0</span>
            </div>
            <hr>
            <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                <label for="splitNumberInput" style="flex-shrink: 0;">Templates per Split File:</label>
                <input type="number" id="splitNumberInput" min="1" placeholder="e.g., 100">
            </div>
            <div class="modal-actions">
                <button id="btnCancelSplit"><i class="fa-solid fa-xmark"></i>Cancel</button>
                <button id="btnGenerateSplits"><i class="fa-solid fa-file-zipper"></i>Generate & Download Splits</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-overlay">
        <div id="settingsModalContent" class="modal-content">
            <h2>
                <span><i class="fa-solid fa-sliders"></i>Application Settings</span>
                <button class="close-button" id="btnCloseSettingsModal" title="Close Settings">Ã—</button>
            </h2>
            
            <div class="form-group">
                <label for="settingsFilenamePrefix">Filename Prefix:</label>
                <input type="text" id="settingsFilenamePrefix" placeholder="e.g., 3COUTB">
                <small>Prefix used for downloaded files.</small>
            </div>

            <div class="form-group">
                <label for="settingsAmzlCarriers">AMZL-type Carriers:</label>
                <input type="text" id="settingsAmzlCarriers" placeholder="e.g., AMZL,AMZN,AMZL_US_PREMIUM">
                <small>Comma-separated list of carrier names treated like AMZL.</small>
            </div>

            <div class="form-group">
                <label for="settingsOtherCarriers">Other Carriers (for extraction):</label>
                <input type="text" id="settingsOtherCarriers" placeholder="e.g., UPS,USPS">
                <small>Comma-separated list of carriers for the 'Extract Other Carriers' mode.</small>
            </div>
            
            <div class="modal-actions">
                <button id="btnSaveChangesSettings"><i class="fa-solid fa-save"></i>Save Settings</button>
            </div>
        </div>
    </div>
    
<script>
    const amzlTemplate = `We've reviewed our removal orders and discovered some shipments whose delivery status is unclear. Could you please check on your end? We're unable to verify the tracking status. If they were lost in transit, could you kindly issue a reimbursement`;
    const upsUspsTemplate = `The Removal Order Status indicates "Completed," yet we never received this order. We kindly request a reimbursement for this discrepancy.`;
    const noteSeparator = '\n\n' + '-'.repeat(41) + '\n';
    const noteSeparatorRegex = /\n\n-{41}\n/g;
    const localStorageKey = 'savedNotesContent_amzlTool';
    const upsUspsOutputKey = 'stagedUpsUspsTNs_amzlTool';
    const upsUspsContextKey = 'stagedUpsUspsContext_amzlTool';

    // Settings Keys
    const settingsKey = 'outboundToolSettings_v1';
    let appSettings = {
        filenamePrefix: '3COUTB',
        amzlTypeCarriers: ['AMZN', 'AMZL', 'AMZL_US_PREMIUM'],
        otherCarriers: ['UPS', 'USPS']
    };
    // Regex patterns, will be initialized/updated by loadSettings
    let regexPatterns = {
        amzlSource: null,
        otherSource: null,
        allExisting: null,
        coreTnExtract: null
    };


    let tempUpsUspsData = {}; // Using a more generic name now

    function escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function buildCarrierRegexPart(carrierArray) {
        if (!carrierArray || carrierArray.length === 0) return '(?:UNKNOWN_CARRIER_TYPE)'; // Fallback
        return '(?:' + carrierArray.map(escapeRegExp).join('|') + ')';
    }

    function initializeRegexPatterns() {
        const amzlCarrierPart = buildCarrierRegexPart(appSettings.amzlTypeCarriers);
        const otherCarrierPart = buildCarrierRegexPart(appSettings.otherCarriers);
        const allCarriersCombined = [...appSettings.amzlTypeCarriers, ...appSettings.otherCarriers];
        const uniqueAllCarriers = Array.from(new Set(allCarriersCombined.filter(c => c.trim() !== '')));
        const allCarrierPart = buildCarrierRegexPart(uniqueAllCarriers.length > 0 ? uniqueAllCarriers : ['TEMP_PLACEHOLDER']); // Ensure this doesn't create an empty (?:)

        // Corrected regex: added capturing group around the carrier part
        regexPatterns.amzlSource = new RegExp(`\\b([A-Z0-9]+(?:-|\\s)*?)\\s*\\((${amzlCarrierPart})\\)`, 'gi');
        regexPatterns.otherSource = new RegExp(`\\b([A-Z0-9]+(?:-|\\s)*?)\\s*\\((${otherCarrierPart})\\)`, 'gi');
        
        // This one is for matching the whole "TN(CARRIER)" string, so it's slightly different.
        // The inner part (allCarrierPart) should still be a non-capturing group if it contains multiple options.
        // The outer parentheses capture the entire "TN(CARRIER)"
        regexPatterns.allExisting = new RegExp(`\\b([A-Z0-9]+(?:-|\\s)*?\\s*\\(${allCarrierPart}\\))`, 'gi');
        
        // This is for extracting the core TN by removing " (CARRIER_PART)"
        regexPatterns.coreTnExtract = new RegExp(`\\s*\\(${allCarrierPart}\\)$`, 'i');
    }


    function loadSettings() {
        const savedSettings = localStorage.getItem(settingsKey);
        if (savedSettings) {
            try {
                const parsed = JSON.parse(savedSettings);
                // Ensure default arrays if loaded ones are not arrays
                appSettings.filenamePrefix = parsed.filenamePrefix || '3COUTB';
                appSettings.amzlTypeCarriers = Array.isArray(parsed.amzlTypeCarriers) && parsed.amzlTypeCarriers.length > 0 ? parsed.amzlTypeCarriers : ['AMZN', 'AMZL', 'AMZL_US_PREMIUM'];
                appSettings.otherCarriers = Array.isArray(parsed.otherCarriers) && parsed.otherCarriers.length > 0 ? parsed.otherCarriers : ['UPS', 'USPS'];
            } catch (e) {
                console.error("Error parsing saved settings, using defaults.", e);
                // Defaults are already set in appSettings
            }
        }
        initializeRegexPatterns(); // Initialize regexes after loading settings
        // Populate settings modal inputs
        document.getElementById('settingsFilenamePrefix').value = appSettings.filenamePrefix;
        document.getElementById('settingsAmzlCarriers').value = appSettings.amzlTypeCarriers.join(',');
        document.getElementById('settingsOtherCarriers').value = appSettings.otherCarriers.join(',');
    }

    function saveSettings() {
        // Get values from modal
        appSettings.filenamePrefix = document.getElementById('settingsFilenamePrefix').value.trim() || '3COUTB';
        
        const amzlStr = document.getElementById('settingsAmzlCarriers').value.trim();
        appSettings.amzlTypeCarriers = amzlStr ? amzlStr.split(',').map(s => s.trim()).filter(s => s) : ['AMZN', 'AMZL', 'AMZL_US_PREMIUM'];
        if(appSettings.amzlTypeCarriers.length === 0) appSettings.amzlTypeCarriers = ['AMZN', 'AMZL', 'AMZL_US_PREMIUM']; // Ensure not empty

        const otherStr = document.getElementById('settingsOtherCarriers').value.trim();
        appSettings.otherCarriers = otherStr ? otherStr.split(',').map(s => s.trim()).filter(s => s) : ['UPS', 'USPS'];
        if(appSettings.otherCarriers.length === 0) appSettings.otherCarriers = ['UPS', 'USPS']; // Ensure not empty


        localStorage.setItem(settingsKey, JSON.stringify(appSettings));
        initializeRegexPatterns(); // Re-initialize regexes with new settings
        alert("Settings saved!");
    }


    function saveNotesToLocalStorage() {
        const noteArea = document.getElementById('noteArea');
        if (noteArea) {
            localStorage.setItem(localStorageKey, noteArea.value);
        }
    }

    function saveUpsUspsOutputToLocalStorage() {
        const upsUspsOutputArea = document.getElementById('upsUspsOutputArea');
        if (upsUspsOutputArea) {
            localStorage.setItem(upsUspsOutputKey, upsUspsOutputArea.value);
        }
    }

    function saveUpsUspsContextToLocalStorage() {
        try {
            localStorage.setItem(upsUspsContextKey, JSON.stringify(tempUpsUspsData));
        } catch (error) {
            console.error("Error saving Other Carrier context to localStorage:", error);
        }
    }

    function getFormattedDate() {
        const date = new Date();
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        return `${month}-${day}`;
    }

    function countTemplatesInText(text, templateString) {
        if (!text || !templateString) return 0;
        const escapedTemplate = templateString.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        return (text.match(new RegExp(escapedTemplate, 'g')) || []).length;
    }

    function downloadText(text, filename) {
        try {
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        } catch (error) {
            console.error("Error during download:", error);
            alert("An error occurred while trying to download the file.");
        }
    }

    function sanitizeFilename(name) {
        return name.replace(/[\s\\/:"*?<>|]+/g, '_').substring(0, 50);
    }

    function parseShipmentData() {
        const input = document.getElementById('shipmentInput');
        const noteArea = document.getElementById('noteArea');
        const groupToggle = document.getElementById('groupToggle');
        const groupSizeInput = document.getElementById('parserGroupSize');
        const upsUspsToggle = document.getElementById('upsUspsToggle'); // Renamed to "Other Carriers" toggle in UI
        const upsUspsOutputArea = document.getElementById('upsUspsOutputArea');
        
        const inputValue = input.value; 
        if (inputValue.trim()) {
            input.value = ''; 
        } else {
            return; 
        }

        const currentNoteValue = noteArea.value;
        const isUpsUspsMode = upsUspsToggle ? upsUspsToggle.checked : false;

        // Use pre-initialized regex patterns from appSettings
        const trackingNumberSourceRegex = isUpsUspsMode ? regexPatterns.otherSource : regexPatterns.amzlSource;
        const existingTrackingNumberRegexGlobal = regexPatterns.allExisting;
        const coreTNReplaceRegex = regexPatterns.coreTnExtract;

        const existingTrackingNumbers = new Set();
        let matchCheck;
        while ((matchCheck = existingTrackingNumberRegexGlobal.exec(currentNoteValue)) !== null) {
            const coreTN = matchCheck[1].replace(coreTNReplaceRegex, '').replace(/\s|-/g, '');
            if (coreTN) existingTrackingNumbers.add(coreTN);
        }
        if (upsUspsOutputArea && upsUspsOutputArea.value) {
            upsUspsOutputArea.value.split('\n').forEach(tn => {
                const trimmedTn = tn.trim();
                if (trimmedTn) existingTrackingNumbers.add(trimmedTn.replace(/\s|-/g, ''));
            });
        }
        const seenTrackingNumbersInCurrentInput = new Set();

        let groupSize = 1;
        const isGroupingActive = !isUpsUspsMode && groupToggle ? groupToggle.checked : false;
        if (isGroupingActive && groupSizeInput) {
            const parsedValue = parseInt(groupSizeInput.value, 10);
            groupSize = (!isNaN(parsedValue) && parsedValue >= 1) ? parsedValue : 2;
        }
        
        const overallBlocks = inputValue.split(/(?=Removal order ID:)/g);
        const parsedDataBlocksForAmzl = [];
        const extractedUpsUspsNumbers = [];
        let validShipmentsFound = 0;
        let skippedDuplicateCount = 0;
        let currentBlockRemovalOrderId = '';

        overallBlocks.forEach(block => {
            if (!block.trim()) return;
            const blockRoMatch = block.match(/Removal order ID:\s*([^\n]+)/);
            if (blockRoMatch) {
                currentBlockRemovalOrderId = blockRoMatch[1].trim();
            }
            const shipmentSections = block.split(/(?=Shipment ID:)/g).filter(section => section.trim() !== '');

            shipmentSections.forEach(section => {
                if (section.trim().startsWith("Removal order ID:")) return;

                const trackingMatches = Array.from(section.matchAll(trackingNumberSourceRegex));
                if (!trackingMatches || trackingMatches.length === 0) return;

                const sectionCoreTNs = new Set();
                const sectionFullTNs = []; 

                trackingMatches.forEach(match => {
                    const rawTNPart = match[1].trim(); 
                    const carrier = match[2]; // Carrier is the second captured group
                    const coreTN = rawTNPart.replace(/\s|-/g, ''); 
                    if (!coreTN) return;
                    sectionCoreTNs.add(coreTN);
                    const fullFormattedTN = `${rawTNPart}(${carrier})`; 
                    sectionFullTNs.push(fullFormattedTN);
                });

                let hasDuplicate = false;
                const coreTNsToCheck = Array.from(sectionCoreTNs);
                for (const coreTn of coreTNsToCheck) {
                    if (existingTrackingNumbers.has(coreTn) || seenTrackingNumbersInCurrentInput.has(coreTn)) {
                        hasDuplicate = true;
                        break;
                    }
                }

                if (hasDuplicate) {
                    skippedDuplicateCount++;
                    coreTNsToCheck.forEach(tn => seenTrackingNumbersInCurrentInput.add(tn));
                    return;
                }
                coreTNsToCheck.forEach(tn => seenTrackingNumbersInCurrentInput.add(tn));

                const shipmentIdMatch = section.match(/^Shipment ID:\s*([^\n]+)/m);
                const shipmentId = shipmentIdMatch ? shipmentIdMatch[1].trim() : 'N/A';
                const productLines = section.split('\n').map(line => line.trim());
                const parsedProducts = []; let currentProduct = null;
                for (let i = 0; i < productLines.length; i++) { const line = productLines[i]; if (line.startsWith('Merchant SKU:')) { if (currentProduct && currentProduct.merchantSku && currentProduct.qty !== undefined) { parsedProducts.push(currentProduct); } currentProduct = { merchantSku: line.substring('Merchant SKU:'.length).trim(), qty: undefined }; } else if (currentProduct) { if (line.startsWith('FNSKU:')) { currentProduct.fnsku = line.substring('FNSKU:'.length).trim(); } else if (/^\d{1,4}$/.test(line) && productLines[i - 1]?.match(/^(EAN|UPC|ISBN_10|Condition|Shipped Quantity|Cancelled Quantity):/i)) { currentProduct.qty = parseInt(line, 10); parsedProducts.push(currentProduct); currentProduct = null; } } } if (currentProduct && currentProduct.merchantSku && currentProduct.qty !== undefined && !parsedProducts.includes(currentProduct)) { parsedProducts.push(currentProduct); }

                if (parsedProducts.length === 0) return;
                const roIdToUse = currentBlockRemovalOrderId || "N/A";
                const outputParts = [ `Removal order ID:${roIdToUse}`, `Shipment ID:${shipmentId}`, `Tracking Number(s):${Array.from(new Set(sectionFullTNs)).join(', ')}` ];
                const productOutputs = parsedProducts.map(p => [`Merchant SKU:${p.merchantSku || 'N/A'}`, `FNSKU:${p.fnsku || 'N/A'}`, `Qty:${p.qty}`].join('\n') );
                const completeDataBlock = outputParts.join('\n') + '\n' + productOutputs.join('\n\n');

                if (isUpsUspsMode) {
                    coreTNsToCheck.forEach(coreTN => { 
                        if (!tempUpsUspsData[coreTN]) tempUpsUspsData[coreTN] = completeDataBlock;
                        extractedUpsUspsNumbers.push(coreTN);
                    });
                } else { 
                    parsedDataBlocksForAmzl.push(completeDataBlock);
                }
                validShipmentsFound++;
            });
        });

        if (isUpsUspsMode) {
            if (extractedUpsUspsNumbers.length > 0) {
                const uniqueNumbersToAdd = Array.from(new Set(extractedUpsUspsNumbers));
                upsUspsOutputArea.value += (upsUspsOutputArea.value ? '\n' : '') + uniqueNumbersToAdd.join('\n');
                upsUspsOutputArea.scrollTop = upsUspsOutputArea.scrollHeight;
                saveUpsUspsOutputToLocalStorage();
                saveUpsUspsContextToLocalStorage();
                let processedMessage = `Extracted ${uniqueNumbersToAdd.length} unique Other Carrier number(s) from batch. `;
                 if (skippedDuplicateCount > 0) processedMessage += `Skipped ${skippedDuplicateCount} duplicate(s). `;
                processedMessage += `Click 'Process' to add to notes.`;
                 input.placeholder = processedMessage;
            } else {
                 let message = "No new valid Other Carrier shipments found in batch. ";
                 if (skippedDuplicateCount > 0) message += `Skipped ${skippedDuplicateCount} duplicate(s). `;
                 input.placeholder = message;
            }
        } else { 
            let finalOutputString = '';
            if (parsedDataBlocksForAmzl.length > 0) {
                if (groupSize > 1) {
                    const groupedOutputs = [];
                    for (let i = 0; i < parsedDataBlocksForAmzl.length; i += groupSize) {
                        const dataChunk = parsedDataBlocksForAmzl.slice(i, i + groupSize);
                        groupedOutputs.push(amzlTemplate + "\n\n" + dataChunk.join('\n\n'));
                    }
                    finalOutputString = groupedOutputs.join('\n\n');
                } else {
                    finalOutputString = parsedDataBlocksForAmzl.map(dataBlock => amzlTemplate + "\n\n" + dataBlock ).join('\n\n');
                }
                const currentNoteTrimmed = noteArea.value.trimEnd();
                noteArea.value = currentNoteTrimmed + (currentNoteTrimmed ? '\n\n' : '') + finalOutputString;
                noteArea.scrollTop = noteArea.scrollHeight;
                countTemplatesNoteTaker(); 
                const groupingStatus = groupSize > 1 ? `ON (${groupSize} per template)` : 'OFF';
                let processedMessage = `Processed ${validShipmentsFound} new AMZL-type shipment(s) from batch. `;
                 if (skippedDuplicateCount > 0) processedMessage += `Skipped ${skippedDuplicateCount} duplicate(s). `;
                processedMessage += `Grouping: ${groupingStatus}. Ready...`;
                 input.placeholder = processedMessage;
            } else {
                 let message = "No new valid AMZL-type shipments found in batch. ";
                 if (skippedDuplicateCount > 0) message += `Skipped ${skippedDuplicateCount} duplicate(s). `;
                 input.placeholder = message;
            }
        }
        setTimeout(() => {
            if (input && !input.value.trim()) {
                const currentModeIsUps = document.getElementById('upsUspsToggle')?.checked;
                input.placeholder = currentModeIsUps
                    ? "Paste shipment data for Other Carriers..."
                    : "Paste Amazon removal shipment data here...";
            }
        }, 5000);
    }

   function processUpsUspsData() { // Renamed to be more generic internally
        const upsUspsOutputArea = document.getElementById('upsUspsOutputArea');
        const noteArea = document.getElementById('noteArea');
        const shipmentInput = document.getElementById('shipmentInput');
        if (!upsUspsOutputArea || !noteArea || !shipmentInput) return;

        const trackingNumbersToProcess = upsUspsOutputArea.value.split('\n').map(tn => tn.trim()).filter(tn => tn);
        if (trackingNumbersToProcess.length === 0) { alert("No Other Carrier tracking numbers found in the staging area."); return; }

        let processedBlocks = []; let notFoundCount = 0; const processedTNs = new Set();
        trackingNumbersToProcess.forEach(tn => {
            const coreTN = tn.replace(/\s|-/g, '');
            if (!processedTNs.has(coreTN)) {
                if (tempUpsUspsData[coreTN]) {
                    processedBlocks.push(upsUspsTemplate + "\n\n" + tempUpsUspsData[coreTN]);
                    processedTNs.add(coreTN);
                } else { notFoundCount++; }
            }
        });

        if (processedBlocks.length > 0) {
            const currentNoteTrimmed = noteArea.value.trimEnd();
            noteArea.value = currentNoteTrimmed + (currentNoteTrimmed ? '\n\n' : '') + processedBlocks.join('\n\n');
            noteArea.scrollTop = noteArea.scrollHeight;
            countTemplatesNoteTaker(); 
            const remainingOutputTNs = upsUspsOutputArea.value.split('\n').map(t => t.trim()).filter(t => t && !processedTNs.has(t.replace(/\s|-/g, '')));
            upsUspsOutputArea.value = remainingOutputTNs.join('\n');
            processedTNs.forEach(coreTN => { delete tempUpsUspsData[coreTN]; });
            saveUpsUspsOutputToLocalStorage(); saveUpsUspsContextToLocalStorage();
            shipmentInput.placeholder = `Added ${processedBlocks.length} Other Carrier entries to notes. Ready...`;
            setTimeout(() => { if (shipmentInput) shipmentInput.placeholder = "Paste shipment data for Other Carriers..."; }, 3000);
        } else { alert("No data could be processed."); }
        if (notFoundCount > 0) alert(`Warning: Could not find original data for ${notFoundCount} tracking number(s).`);
   }

    function addSeparator() { const ta = document.getElementById('noteArea'); const trimmed = ta.value.trimEnd(); ta.value = trimmed + (trimmed ? noteSeparator : ''); ta.focus(); ta.scrollTop = ta.scrollHeight; countTemplatesNoteTaker(); }
    function addSpacing() { const ta = document.getElementById('noteArea'); ta.value = ta.value.trimEnd() + '\n\n'; ta.focus(); ta.scrollTop = ta.scrollHeight; saveNotesToLocalStorage(); }
    function selectAllMerchants() { document.querySelectorAll('#merchantList .merchant-checkbox').forEach(cb => { cb.checked = true; }); updateSelectedCountNoteTaker(); }
    
    function clearAllNotes() {
        if (confirm("Are you sure you want to clear ALL notes? This action cannot be undone.")) {
            const noteArea = document.getElementById('noteArea');
            noteArea.value = '';
            saveNotesToLocalStorage();
            countTemplatesNoteTaker(); // This will refresh merchant list and counts
        }
    }

    function handleMerchantNameEdit(event, originalSectionKey, originalDisplayName, isNameOriginallyFromFirstLine) {
        const editableSpan = event.target; const newName = editableSpan.textContent.trim();
        if (!newName || newName === originalDisplayName) { editableSpan.textContent = originalDisplayName; return; }
        const noteArea = document.getElementById('noteArea'); const currentNotes = noteArea.value; let newSectionText;
        if (isNameOriginallyFromFirstLine) {
            const lines = originalSectionKey.split('\n');
            newSectionText = newName + (lines.length > 1 ? '\n' + lines.slice(1).join('\n') : '');
        } else { newSectionText = newName + '\n\n' + originalSectionKey; }
        const noteSeparatorCaptureRegex = new RegExp('(' + noteSeparator.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'g');
        const parts = currentNotes.split(noteSeparatorCaptureRegex); let reconstructedNotes = ""; let replaced = false;
        for (let i = 0; i < parts.length; i++) {
            if (i % 2 === 0) { 
                if (parts[i].trim() === originalSectionKey.trim()) { reconstructedNotes += newSectionText; replaced = true; }
                else { reconstructedNotes += parts[i]; }
            } else { reconstructedNotes += parts[i]; }
        }
        if (replaced) { noteArea.value = reconstructedNotes; saveNotesToLocalStorage(); countTemplatesNoteTaker(); }
        else { editableSpan.textContent = originalDisplayName; }
    }

    function countTemplatesNoteTaker() {
        const noteArea = document.getElementById('noteArea');
        const fullText = noteArea.value;
        const merchantListDiv = document.getElementById('merchantList');
        merchantListDiv.innerHTML = ''; 

        const trackingNumberRegex = regexPatterns.allExisting; 
        const coreTNReplaceRegex = regexPatterns.coreTnExtract;

        const allTrackingNumbers = (fullText.match(trackingNumberRegex) || []);
        const seenTrackingNumbers = new Set(); 
        const duplicatedTrackingNumbers = new Set(); 
        allTrackingNumbers.forEach(tnString => {
            const coreTN = tnString.replace(coreTNReplaceRegex, '').replace(/\s|-/g, '');
            if (seenTrackingNumbers.has(coreTN)) { duplicatedTrackingNumbers.add(coreTN); }
            seenTrackingNumbers.add(coreTN);
        });

        const merchantsData = {}; let totalTemplatesOverall = 0; let merchantIndex = 0;
        const sections = fullText.split(noteSeparatorRegex);
        sections.forEach((sectionTextOriginal) => {
            const sectionText = sectionTextOriginal.trim(); if (!sectionText) return;
            const amzlTemplateCount = countTemplatesInText(sectionText, amzlTemplate);
            const upsUspsTemplateCount = countTemplatesInText(sectionText, upsUspsTemplate);
            const templateCount = amzlTemplateCount + upsUspsTemplateCount;
            totalTemplatesOverall += templateCount;
            let merchantName = `Entry ${++merchantIndex}`; const firstLine = sectionText.split('\n')[0]?.trim(); let isNameFromFirstLine = false;
            if (firstLine && !firstLine.startsWith(amzlTemplate.substring(0, 10)) && !firstLine.startsWith(upsUspsTemplate.substring(0,10)) && firstLine.length < 100 && !firstLine.includes(':') && !firstLine.startsWith('Removal order ID')) {
                merchantName = firstLine; isNameFromFirstLine = true;
            } else if (sectionText.includes('Removal order ID:')) { merchantName = `Data Entry ${merchantIndex}`; }
            merchantsData[sectionTextOriginal] = { displayName: merchantName, isNameFromFirstLine: isNameFromFirstLine, count: templateCount, text: sectionTextOriginal };
        });
        document.getElementById('merchantCount').textContent = Object.keys(merchantsData).length;
        document.getElementById('totalTemplates').textContent = totalTemplatesOverall;
        const sortedMerchants = Object.entries(merchantsData).sort(([, a], [, b]) => a.displayName.localeCompare(b.displayName));
        sortedMerchants.forEach(([key, data]) => {
            const merchantDiv = document.createElement('div'); merchantDiv.className = 'merchant-stats';
            merchantDiv.dataset.key = key; merchantDiv.dataset.displayName = data.displayName; merchantDiv.dataset.count = data.count;
            const sectionTrackingNumbersFull = (data.text.match(trackingNumberRegex) || []);
            let sectionHasDuplicate = false; const duplicatesInSectionDisplay = new Set();
            sectionTrackingNumbersFull.forEach(tnString => {
                const coreTn = tnString.replace(coreTNReplaceRegex, '').replace(/\s|-/g, '');
                if (duplicatedTrackingNumbers.has(coreTn)) { sectionHasDuplicate = true; duplicatesInSectionDisplay.add(tnString); }
            });
            const titleText = `${data.displayName} (${data.count} ${data.count === 1 ? 'case' : 'cases'})`;
            const innerFlexDiv = document.createElement('div');
            if (sectionHasDuplicate) {
                const indicatorSpan = document.createElement('span'); indicatorSpan.className = 'duplicate-indicator';
                indicatorSpan.title = `Contains duplicate TN(s): ${Array.from(duplicatesInSectionDisplay).join(', ')}`;
                innerFlexDiv.appendChild(indicatorSpan);
            }
            const checkbox = document.createElement('input'); checkbox.type = 'checkbox'; checkbox.className = 'merchant-checkbox';
            checkbox.onchange = updateSelectedCountNoteTaker; innerFlexDiv.appendChild(checkbox);
            const nameAndCountWrapper = document.createElement('span'); nameAndCountWrapper.className = 'merchant-name-editable-container';
            const nameSpan = document.createElement('span'); nameSpan.className = 'merchant-name-display'; nameSpan.contentEditable = true;
            nameSpan.textContent = data.displayName; nameSpan.title = titleText + (sectionHasDuplicate ? ` | DUPLICATES FOUND: ${Array.from(duplicatesInSectionDisplay).join(', ')}` : '');
            nameSpan.addEventListener('blur', (e) => handleMerchantNameEdit(e, key, data.displayName, data.isNameFromFirstLine));
            nameSpan.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); e.target.blur(); } else if (e.key === 'Escape') { e.preventDefault(); e.target.textContent = data.displayName; e.target.blur(); } });
            nameAndCountWrapper.appendChild(nameSpan);
            const countSpan = document.createElement('span'); countSpan.className = 'merchant-count-text';
            countSpan.textContent = `(${data.count} ${data.count === 1 ? 'case' : 'cases'})`; nameAndCountWrapper.appendChild(countSpan);
            innerFlexDiv.appendChild(nameAndCountWrapper);
            merchantDiv.appendChild(innerFlexDiv);
            merchantDiv.onclick = (e) => { if (e.target.type !== 'checkbox' && e.target.contentEditable !== true) { const cb = merchantDiv.querySelector('.merchant-checkbox'); if (cb) { cb.checked = !cb.checked; updateSelectedCountNoteTaker(); } } };
            merchantListDiv.appendChild(merchantDiv);
        });
        updateSelectedCountNoteTaker();
    }

    function updateSelectedCountNoteTaker() {
        const selectedCheckboxes = document.querySelectorAll('#merchantList .merchant-checkbox:checked');
        const splitButton = document.getElementById('btnSplitSelected'); let selectedCaseCount = 0;
        selectedCheckboxes.forEach(cb => { selectedCaseCount += parseInt(cb.closest('.merchant-stats')?.dataset?.count || '0', 10); });
        const totalTemplatesSpan = document.getElementById('totalTemplates'); const merchantCountSpan = document.getElementById('merchantCount');
        const totalMerchantCount = document.querySelectorAll('#merchantList .merchant-stats').length;
        const totalCaseCountOverall = Array.from(document.querySelectorAll('#merchantList .merchant-stats')).reduce((sum, el) => sum + parseInt(el.dataset.count || '0', 10), 0);
        if (selectedCheckboxes.length > 0) {
            totalTemplatesSpan.textContent = selectedCaseCount; merchantCountSpan.textContent = selectedCheckboxes.length;
            if (splitButton) splitButton.disabled = false;
        } else {
            totalTemplatesSpan.textContent = totalCaseCountOverall; merchantCountSpan.textContent = totalMerchantCount;
            if (splitButton) splitButton.disabled = true;
        }
    }

    function downloadSelectedMerchants() {
        const selectedDivs = document.querySelectorAll('#merchantList .merchant-stats:has(.merchant-checkbox:checked)');
        if (selectedDivs.length === 0) { alert('Please select merchant(s) to download.'); return; }
        const textsToDownload = []; let totalSelectedCases = 0;
        selectedDivs.forEach((div) => { const key = div.dataset.key; if (key) { textsToDownload.push(key); totalSelectedCases += parseInt(div.dataset.count || '0', 10); } });
        if (textsToDownload.length === 0) { alert("Could not retrieve text."); return; }
        const combinedText = textsToDownload.join(noteSeparator.trimEnd()); 
        const filename = `${appSettings.filenamePrefix}_${getFormattedDate()}_(${totalSelectedCases}).txt`;
        downloadText(combinedText + '\n', filename); 
    }

    function clearSelectedMerchants() {
        const selectedDivs = document.querySelectorAll('#merchantList .merchant-stats:has(.merchant-checkbox:checked)');
        if (selectedDivs.length === 0) { alert('Please select merchant(s) to clear.'); return; }
        const noteArea = document.getElementById('noteArea'); const fullText = noteArea.value; const keysToRemove = new Set();
        selectedDivs.forEach(div => { if (div.dataset.key) keysToRemove.add(div.dataset.key); });
        const allSections = fullText.split(noteSeparatorRegex).filter(s => s.trim() !== "");
        const remainingSections = allSections.filter(section => !keysToRemove.has(section));
        noteArea.value = remainingSections.length > 0 ? remainingSections.join(noteSeparator) : "";
        countTemplatesNoteTaker(); 
    }

    function downloadAllNotes() {
        const noteArea = document.getElementById('noteArea'); const textToDownload = noteArea.value.trim();
        if (!textToDownload) { alert("Nothing to download."); return; }
        const totalTemplatesCount = document.getElementById('totalTemplates').textContent;
        const filename = `${appSettings.filenamePrefix}_${getFormattedDate()}_(${totalTemplatesCount}).txt`;
        downloadText(textToDownload + '\n', filename);
    }

    function processSingleROBlock(roBlockText, removalOrdersArray) {
        const roIdLineMatch = roBlockText.match(/^\s*Removal order ID:[^\n]+/); if (!roIdLineMatch) return;
        const currentRoIdLine = roIdLineMatch[0].trim(); const remainingText = roBlockText.substring(roIdLineMatch[0].length).trim(); if (!remainingText) return;
        const shipmentBlocks = remainingText.split(/(?=^\s*Shipment ID:)/m);
        shipmentBlocks.forEach((shipmentBlock) => {
             const trimmed = shipmentBlock.trim();
             if (trimmed.startsWith('Shipment ID:') && trimmed.includes('Merchant SKU:')) removalOrdersArray.push(currentRoIdLine + '\n' + trimmed);
        });
    }

   function splitTextIntoRemovalOrders(inputText) {
        const removalOrders = []; if (!inputText) return removalOrders;
        let textToProcess = inputText.trim();
        const escapedAmzl = amzlTemplate.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const escapedUps = upsUspsTemplate.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        textToProcess = textToProcess.replace(new RegExp('^\\s*' + escapedAmzl + '\\s*\\n*', 'gm'), '').replace(new RegExp('^\\s*' + escapedUps + '\\s*\\n*', 'gm'), '').trim();
        const lines = textToProcess.split('\n');
        if (lines.length > 2 && lines[1].trim() === "" && lines[2].startsWith("Removal order ID:")) textToProcess = lines.slice(2).join('\n');
        else if (lines.length > 0 && lines[0].startsWith("Removal order ID:")) textToProcess = lines.join('\n');
        const potentialROBlocks = textToProcess.split(/(?=^\s*Removal order ID:)/m);
        potentialROBlocks.forEach((roBlock) => {
            const trimmed = roBlock.trim(); if (!trimmed) return;
            if (trimmed.startsWith('Removal order ID:')) processSingleROBlock(trimmed, removalOrders);
        });
        return removalOrders;
   }

   function createTemplates(removalOrders, ordersPerTemplate) {
        const templates = []; if (!removalOrders || removalOrders.length === 0 || ordersPerTemplate <= 0) return templates;
        for (let i = 0; i < removalOrders.length; i += ordersPerTemplate) {
            const chunk = removalOrders.slice(i, i + ordersPerTemplate).filter(o => o && typeof o === 'string');
            if (chunk.length > 0) templates.push(chunk.join('\n\n'));
        }
        return templates;
   }

    let selectedMerchantDataForSplit = [];

    function openSplitModal() {
        selectedMerchantDataForSplit = [];
        const selectedDivs = document.querySelectorAll('#merchantList .merchant-stats:has(.merchant-checkbox:checked)');
        if (selectedDivs.length === 0) { alert("Please select merchant(s)."); return; }
        const modal = document.getElementById('splitModal'); const merchantInfoDiv = document.getElementById('splitMerchantInfo');
        if (!modal || !merchantInfoDiv) { alert("Split modal error."); return; }
        let combinedTextParts = []; let containsUpsUsps = false; let containsAmzl = false;
        selectedDivs.forEach((div) => {
            const key = div.dataset.key; const name = div.dataset.displayName || `Unknown`;
            if (key) { selectedMerchantDataForSplit.push({ key, name }); combinedTextParts.push(key);
                if (key.includes(upsUspsTemplate)) containsUpsUsps = true; if (key.includes(amzlTemplate)) containsAmzl = true;
            }
        });
        const names = selectedMerchantDataForSplit.map(item => item.name);
        modal.dataset.combinedText = combinedTextParts.join(noteSeparator.trimEnd());
        modal.dataset.containsAmzl = containsAmzl; modal.dataset.containsUpsUsps = containsUpsUsps;
        if (names.length === 1) merchantInfoDiv.textContent = `Merchant: ${names[0]}`;
        else if (names.length > 1) merchantInfoDiv.textContent = `Merchants: ${names.slice(0,3).join(', ')}${names.length > 3 ? '...' : ''} (${names.length} total)`;
        else merchantInfoDiv.textContent = 'No valid merchants.';
        document.getElementById('splitOrdersPerTemplate').value = '2'; document.getElementById('splitNumberInput').value = '';
        updateCalculatedTemplates(); modal.style.display = 'flex';
    }

    function closeSplitModal() { document.getElementById('splitModal').style.display = 'none'; }
    function openSettingsModal() { loadSettings(); document.getElementById('settingsModal').style.display = 'flex'; }
    function closeSettingsModal() { document.getElementById('settingsModal').style.display = 'none'; }


    function updateCalculatedTemplates() {
         const modal = document.getElementById('splitModal'); if (!modal) return;
         const combinedText = modal.dataset.combinedText || '';
         const ordersInput = document.getElementById('splitOrdersPerTemplate');
         const calcSpan = document.getElementById('splitCalculatedTemplates'); if (!ordersInput || !calcSpan) return;
         const ordersPer = parseInt(ordersInput.value) || 0;
         if (ordersPer > 0 && combinedText) {
             const ros = splitTextIntoRemovalOrders(combinedText);
             calcSpan.textContent = createTemplates(ros, ordersPer).length;
         } else calcSpan.textContent = '0';
       }

   function generateAndDownloadSplits() {
        const modal = document.getElementById('splitModal'); if (!modal) return;
        const combinedText = modal.dataset.combinedText || '';
        const ordersPerInput = document.getElementById('splitOrdersPerTemplate');
        const splitNumInput = document.getElementById('splitNumberInput');
        const containsAmzl = modal.dataset.containsAmzl === 'true'; const containsUpsUsps = modal.dataset.containsUpsUsps === 'true';
        if (!ordersPerInput || !splitNumInput) { alert("Modal input error."); return; }
        const ordersPer = parseInt(ordersPerInput.value); const splitNum = parseInt(splitNumInput.value);
        if (!combinedText) { alert("No text for selected merchants."); return; }
        if (isNaN(ordersPer) || ordersPer < 1) { alert("Invalid 'Orders per Template'."); return; }
        if (isNaN(splitNum) || splitNum < 1) { alert("Invalid 'Templates per Split File'."); return; }
        let templateToUse = amzlTemplate;
        if (containsUpsUsps && !containsAmzl) templateToUse = upsUspsTemplate;
        else if (containsUpsUsps && containsAmzl) console.warn("Mixed entries, using AMZL template.");
        const ros = splitTextIntoRemovalOrders(combinedText); if (ros.length === 0) { alert("No valid removal orders found."); return; }
        const templateGroups = createTemplates(ros, ordersPer); if (templateGroups.length === 0) { alert("Failed to generate template groups."); return; }
        const splitOutputs = [];
        for (let i = 0; i < templateGroups.length; i += splitNum) {
            const chunk = templateGroups.slice(i, i + splitNum);
            if (chunk.length > 0) splitOutputs.push({ text: chunk.map(data => templateToUse + "\n\n" + data).join('\n\n'), count: chunk.length });
        }
        if (splitOutputs.length === 0) { alert("No split files generated."); return; }
        let filenamePart = "SplitSelection"; let merchantDisplay = selectedMerchantDataForSplit.map(m=>m.name).join(' & ');
        if (selectedMerchantDataForSplit.length === 1) filenamePart = sanitizeFilename(selectedMerchantDataForSplit[0].name);
        else if (selectedMerchantDataForSplit.length > 1) filenamePart = sanitizeFilename(selectedMerchantDataForSplit[0].name) + "_Multi";
        const dateStr = getFormattedDate();
        splitOutputs.forEach((output, index) => {
            const filename = `${appSettings.filenamePrefix}_${dateStr}_${filenamePart}_PART_${index+1}(${output.count}).txt`;
            downloadText(merchantDisplay + '\n\n' + output.text + '\n', filename);
        });
        closeSplitModal();
   }

    document.addEventListener('DOMContentLoaded', () => {
        loadSettings(); // Load settings on page load

        const shipmentInput = document.getElementById('shipmentInput');
        const noteArea = document.getElementById('noteArea');
        const groupToggle = document.getElementById('groupToggle');
        const groupSizeInput = document.getElementById('parserGroupSize');
        const upsUspsToggle = document.getElementById('upsUspsToggle');
        const upsUspsOutputContainer = document.getElementById('upsUspsOutputContainer');
        const upsUspsOutputArea = document.getElementById('upsUspsOutputArea');
        const groupOrdersControl = document.getElementById('groupOrdersControl');

        if (noteArea) {
            const savedNotes = localStorage.getItem(localStorageKey);
            if (savedNotes) noteArea.value = savedNotes;
            let countTimer;
            noteArea.addEventListener('input', () => { clearTimeout(countTimer); countTimer = setTimeout(() => { saveNotesToLocalStorage(); countTemplatesNoteTaker(); }, 300); });
            noteArea.addEventListener('paste', () => { setTimeout(() => { saveNotesToLocalStorage(); countTemplatesNoteTaker(); }, 50); });
        }
        if (upsUspsOutputArea) { const saved = localStorage.getItem(upsUspsOutputKey); if (saved) upsUspsOutputArea.value = saved; }
        try { const savedCtx = localStorage.getItem(upsUspsContextKey); if (savedCtx) tempUpsUspsData = JSON.parse(savedCtx) || {}; }
        catch (e) { tempUpsUspsData = {}; }

        if (shipmentInput) {
            let parseTimer;
            shipmentInput.addEventListener('input', () => { clearTimeout(parseTimer); parseTimer = setTimeout(parseShipmentData, 300); });
        }
        try { countTemplatesNoteTaker(); } catch(e) { console.error("Initial count error:", e); }

        // Button Event Listeners
        document.getElementById('btnAddSeparator')?.addEventListener('click', addSeparator);
        document.getElementById('btnAddSpacing')?.addEventListener('click', addSpacing);
        document.getElementById('btnClearAllNotes')?.addEventListener('click', clearAllNotes);
        document.getElementById('btnDownloadSelected')?.addEventListener('click', downloadSelectedMerchants);
        document.getElementById('btnClearSelected')?.addEventListener('click', clearSelectedMerchants);
        document.getElementById('btnSelectAll')?.addEventListener('click', selectAllMerchants);
        document.getElementById('btnDownloadAll')?.addEventListener('click', downloadAllNotes);
        document.getElementById('btnSplitSelected')?.addEventListener('click', openSplitModal);
        document.getElementById('btnProcessUpsUsps')?.addEventListener('click', processUpsUspsData);
        
        // Settings Modal Listeners
        document.getElementById('btnOpenSettings')?.addEventListener('click', openSettingsModal);
        document.getElementById('btnCloseSettingsModal')?.addEventListener('click', closeSettingsModal);
        document.getElementById('btnSaveChangesSettings')?.addEventListener('click', () => { saveSettings(); closeSettingsModal(); });
        document.getElementById('settingsModal').addEventListener('click', (event) => { if (event.target === document.getElementById('settingsModal')) closeSettingsModal(); });


        if (groupToggle && groupSizeInput) {
            groupToggle.addEventListener('change', function() { groupSizeInput.disabled = !this.checked; });
            groupSizeInput.disabled = !groupToggle.checked;
        }
        if (upsUspsToggle && upsUspsOutputContainer && groupOrdersControl && shipmentInput && upsUspsOutputArea) {
            function toggleUpsUspsMode(isUpsMode) {
                upsUspsOutputContainer.style.display = isUpsMode ? 'block' : 'none';
                groupOrdersControl.style.opacity = isUpsMode ? '0.5' : '1';
                groupOrdersControl.style.pointerEvents = isUpsMode ? 'none' : 'auto';
                if (isUpsMode && groupToggle) { groupToggle.checked = false; if (groupSizeInput) groupSizeInput.disabled = true; }
                shipmentInput.placeholder = isUpsMode ? "Paste shipment data for Other Carriers..." : "Paste Amazon removal shipment data here...";
                if (!isUpsMode && groupToggle && groupSizeInput) groupSizeInput.disabled = !groupToggle.checked;
            }
            upsUspsToggle.addEventListener('change', function() { toggleUpsUspsMode(this.checked); });
            toggleUpsUspsMode(upsUspsToggle.checked);
        }

        // Split Modal Listeners
        const splitModalEl = document.getElementById('splitModal');
        document.getElementById('btnCancelSplit')?.addEventListener('click', closeSplitModal);
        splitModalEl?.addEventListener('click', (event) => { if (event.target === splitModalEl) closeSplitModal(); });
        document.getElementById('btnGenerateSplits')?.addEventListener('click', generateAndDownloadSplits);
        document.getElementById('splitOrdersPerTemplate')?.addEventListener('input', updateCalculatedTemplates);
    });
</script>

</body>
</html>
