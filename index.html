<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Outbound AMZL Tool</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="." />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://rsms.me/">
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    <style>
        :root {
            --system-font: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --mono-font: 'SF Mono', Consolas, 'Courier New', Courier, monospace;
            --bg-primary: #F6F6F6;
            --bg-window: rgba(255, 255, 255, 0.8);
            --bg-toolbar: #F0F0F0;
            --bg-glass: rgba(240, 240, 240, 0.7);
            --text-primary: #1d1d1f;
            --text-secondary: #6e6e73;
            --text-placeholder: #aaaaaf;
            --border-color: #C6C6C6;
            --border-subtle: #E0E0E0;
            --accent-blue: #007AFF;
            --accent-blue-dark: #006ADC;
            --accent-red: #ff3b30;
            --accent-red-hover: #ff453a;
            --top-bar-height: 50px;
        }

        /* --- Global & Layout --- */
        html { box-sizing: border-box; }
        *, *:before, *:after { box-sizing: inherit; }
        body {
            font-family: var(--system-font);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            margin: 0; padding: 0; display: flex; flex-direction: column;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
            font-size: 13px;
        }

        .top-bar {
            background-color: var(--bg-toolbar);
            padding: 0 16px;
            height: var(--top-bar-height);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
            border-bottom: 0.5px solid var(--border-color);
        }
        .top-bar-title { font-size: 1.1em; font-weight: 600; color: var(--text-primary); }

        .main-wrapper {
            display: flex; flex-direction: column; flex-grow: 1; padding: 16px; gap: 16px;
            width: 100%; max-width: 1600px; margin: 0 auto; overflow: hidden;
        }
        .left-column-wrapper { display: flex; flex-direction: column; gap: 16px; }

        .tool-container {
            background-color: var(--bg-window);
            border-radius: 12px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.05);
            padding: 20px;
            display: flex; flex-direction: column;
            position: relative;
            border: 0.5px solid rgba(0, 0, 0, 0.1);
        }
        .tool-card-title { display: none; font-size: 1.1em; font-weight: 600; color: var(--text-primary); margin: -5px 0 10px 0; }
        .tool-card-title > i.fa-solid { margin-right: 8px; font-size: 0.9em; }
        
        @media (min-width: 992px) {
            .main-wrapper { flex-direction: row; padding: 24px; gap: 24px; align-items: stretch; }
            .tool-card-title { display: flex; align-items: center; }
            .left-column-wrapper {
                width: calc(35% - 12px);
                flex-shrink: 0;
                gap: 24px;
                display: flex;
                flex-direction: column;
            }
            .note-taker-tool {
                width: calc(65% - 12px);
                flex-grow: 1;
                display: flex;
                flex-direction: column;
            }
            #noteArea { flex-grow: 1; min-height: 200px; resize: none; }
            .note-taker-tool .controls-and-stats { flex-shrink: 0; margin-top: 16px; }
        }

        /* --- macOS UI Components --- */
        
        /* Buttons */
        button.macos {
            font-family: var(--system-font); font-weight: 500; cursor: pointer;
            border: none; transition: all 0.15s ease;
            font-size: 13px; padding: 4px 14px; border-radius: 8px;
            display: inline-flex; align-items: center; justify-content: center;
        }
        button.macos.primary {
            background-image: linear-gradient(to bottom, #0A84FF, #007AFF);
            border: 0.5px solid transparent;
            box-shadow: 0 0.5px 1px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0,0,0,0.12);
            color: white;
        }
        button.macos.primary:hover { background-image: linear-gradient(to bottom, #1A94FF, #118AFF); }
        button.macos.primary:active { background-image: linear-gradient(to bottom, #006ADC, #0070E8); box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.15); }
        button.macos.primary:disabled { background-image: linear-gradient(to bottom, #87C9FF, #80C5FF); color: rgba(255,255,255,0.9); box-shadow: none; cursor: not-allowed; }
        
        button.macos.secondary {
            background-image: linear-gradient(to bottom, #FFFFFF, #F8F8F8);
            border: 0.5px solid var(--border-color);
            box-shadow: 0 0.5px 1px rgba(0, 0, 0, 0.08);
            color: var(--text-primary);
        }
        button.macos.secondary:active { background-image: linear-gradient(to bottom, #F0F0F0, #F7F7F7); border-color: #AFAFAF; box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1); }
        button.macos.secondary:disabled { background-image: linear-gradient(#FFFFFF, #F7F7F7); color: rgba(0,0,0,0.35); border-color: var(--border-subtle); cursor: not-allowed; }

        button.macos.danger { background-color: var(--accent-red); color: white; border: none; box-shadow: 0 0.5px 1px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0,0,0,0.12); }
        button.macos.danger:hover { background-color: var(--accent-red-hover); }
        
        button.macos > i { margin-right: 6px; font-size: 0.9em; }

        .macos-icon-button {
            background: rgba(255,255,255,0.5); border: 0.5px solid var(--border-color); cursor: pointer;
            width: 32px; height: 32px; border-radius: 8px;
            display: inline-flex; align-items: center; justify-content: center;
            color: var(--text-secondary); transition: all 0.15s ease;
            box-shadow: 0 0.5px 1px rgba(0, 0, 0, 0.08);
        }
        .macos-icon-button:hover { background-color: rgba(255,255,255,0.9); }
        .macos-icon-button:active { background-color: #e5e5e5; }

        /* Inputs & Textareas */
        textarea, input[type="text"], input[type="number"] { all: unset; box-sizing: border-box; }
        .macos-textfield-container {
            width: 100%; border-radius: 10px; border: 0.5px solid var(--border-color);
            background-color: white; box-shadow: 0 1px 1px rgba(0,0,0,0.02) inset;
            transition: all 0.15s ease;
        }
        .macos-textfield-container:focus-within { border-color: var(--accent-blue); box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.3); }
        .macos-textfield-container input, .macos-textfield-container textarea {
            width: 100%; background-color: transparent; padding: 8px 10px;
            font-size: 14px; color: var(--text-primary);
        }
        textarea.macos-textfield { font-family: var(--mono-font); resize: vertical; min-height: 150px; }
        
        /* Switches */
        .macos-switch { position: relative; display: inline-block; width: 44px; height: 26px; flex-shrink: 0; }
        .macos-switch input { opacity: 0; width: 0; height: 0; }
        .macos-switch .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #c7c7cc; transition: .2s; border-radius: 34px; }
        .macos-switch .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 2px; bottom: 2px; background-color: white; transition: .2s; border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.15); }
        .macos-switch input:checked + .slider { background-color: var(--accent-blue); }
        .macos-switch input:checked + .slider:before { transform: translateX(18px); }

        /* Modals */
        .modal-overlay {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; justify-content: center; align-items: center;
            background-color: rgba(60,60,67,0.3);
        }
        .modal-content {
            background-color: var(--bg-glass);
            backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            padding: 20px; border: 0.5px solid rgba(0,0,0,0.2);
            border-radius: 14px; width: 90%; max-width: 520px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex; flex-direction: column; gap: 15px;
        }
         .modal-content h2 { margin-top: 0; margin-bottom: 8px; font-size: 1.15em; font-weight: 600; border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 10px; display:flex; align-items:center; justify-content:space-between; }
        .modal-actions { display: flex; gap: 10px; margin-top: 10px; justify-content: flex-end; }
        
        /* Specifics */
        .left-column-wrapper, #merchantList, #noteArea { scrollbar-width: thin; scrollbar-color: #c0c0c0 transparent; }
        .left-column-wrapper::-webkit-scrollbar, #merchantList::-webkit-scrollbar, #noteArea::-webkit-scrollbar { width: 9px; }
        .left-column-wrapper::-webkit-scrollbar-thumb, #merchantList::-webkit-scrollbar-thumb, #noteArea::-webkit-scrollbar-thumb { background-color: #cccccc; border-radius: 5px; border: 2px solid transparent; background-clip: content-box; }
        
        #merchantList {
            min-height: 150px;
            max-height: 60vh;
            overflow-y: auto;
            resize: vertical;
            margin-top: 16px;
            padding: 8px;
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 8px;
            background-color: rgba(255,255,255,0.4);
        }

        .merchant-item {
            padding: 8px 12px;
            background-color: #fff;
            border-radius: 8px;
            border: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: flex-start;
            font-size: 13px;
            transition: background-color 0.15s ease, border-color 0.15s ease;
            cursor: pointer;
        }
        .merchant-item:hover { background-color: rgba(0,0,0,0.05); }
        .merchant-item.selected { background-color: #e8f3ff; border-color: #b0d7ff;}
        .merchant-item .case-count { font-size: 11px; font-weight: 500; color: var(--text-secondary); background-color: var(--border-subtle); padding: 2px 6px; border-radius: 5px; margin-left: auto; }
        
        .macos-checkbox-container { display: flex; align-items: center; cursor: pointer; gap: 8px; width: 100%; }
        .macos-checkbox {
            appearance: none; -webkit-appearance: none; margin: 0;
            width: 15px; height: 15px; border-radius: 4px;
            display: flex; align-items: center; justify-content: center;
            background-image: linear-gradient(#FFFFFF, #F7F7F7);
            border: 0.5px solid #BDBDBD;
            box-shadow: 0 0.5px 1px rgba(0, 0, 0, 0.07);
        }
        .macos-checkbox:checked { background-color: var(--accent-blue); border-color: var(--accent-blue-dark); box-shadow: 0 0.5px 1px rgba(0, 0, 0, 0.1); }
        .macos-checkbox:checked::after { content: '✔'; color: white; font-size: 11px; font-weight: bold; line-height: 1; }

        .counter-pill { display: flex; align-items: center; gap: 15px; padding: 5px 10px; border-radius: 8px; border: 1px solid var(--border-color); background: rgba(255,255,255,0.5); }
        .counter-pill p { margin:0; display:flex; align-items:center; gap: 5px;}
        .counter-pill p > i { color: var(--text-secondary); }

    </style>
</head>
<body>

    <div class="top-bar">
        <h1 class="top-bar-title">AMZL,UPS/USPS Outbound Tool</h1>
        <button id="btnOpenSettings" class="macos-icon-button" title="Settings"><i class="fa-solid fa-sliders"></i></button>
    </div>

    <div class="main-wrapper">
        <div class="left-column-wrapper">
            <div class="tool-container parser-tool">
                <h3 class="tool-card-title"><i class="fa-solid fa-filter" style="margin-right: 8px;"></i>Parser</h3>
                <div class="macos-textfield-container">
                    <textarea id="shipmentInput" class="macos-textfield" placeholder="Paste Amazon removal shipment data here..."></textarea>
                </div>
                <div class="parser-controls" style="margin-top:16px; display:flex; flex-direction:column; gap: 12px; align-items: flex-start;">
                    <div style="display: flex; align-items: center; gap: 8px;" id="groupOrdersControl">
                        <label class="macos-switch"><input type="checkbox" id="groupToggle"><span class="slider"></span></label>
                        <label for="groupToggle">Group Orders</label>
                        <div class="macos-textfield-container" style="width: 70px;">
                            <input type="number" id="parserGroupSize" class="macos-textfield" style="text-align:center;" min="1" value="2" disabled>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label class="macos-switch"><input type="checkbox" id="upsUspsToggle"><span class="slider"></span></label>
                        <label for="upsUspsToggle">Extract Other Carriers</label>
                    </div>
                </div>
                 <div id="upsUspsOutputContainer" style="display: none; margin-top: 16px;">
                    <div class="macos-textfield-container"><textarea id="upsUspsOutputArea" class="macos-textfield" placeholder="Extracted Other Carrier Tracking Numbers..."></textarea></div>
                    <button id="btnProcessUpsUsps" class="macos primary" style="margin-top: 8px;"><i class="fa-solid fa-gears"></i>Process & Add</button>
                </div>
            </div>

            <div class="tool-container merchant-actions-tool">
                <h3 class="tool-card-title"><i class="fa-solid fa-users" style="margin-right: 8px;"></i>Merchants</h3>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button id="btnDownloadSelected" class="macos primary"><i class="fa-solid fa-download"></i>Download Selected</button>
                    <button id="btnSelectAll" class="macos primary"><i class="fa-regular fa-square-check"></i>Select All</button>
                    <button id="btnDownloadAll" class="macos primary"><i class="fa-solid fa-file-arrow-down"></i>Download All</button>
                    <button id="btnSplitSelected" class="macos primary" disabled><i class="fa-solid fa-table-columns"></i>Split</button>
                    <button id="btnClearSelected" class="macos danger"><i class="fa-regular fa-trash-can"></i>Clear Selected</button>
                </div>
                 <div id="merchantSearchContainer" style="margin-top:16px; display: none; position:relative;">
                    <div class="macos-textfield-container">
                         <input type="text" id="merchantSearchInput" class="macos-textfield" style="padding-left:30px" placeholder="Search merchants...">
                    </div>
                     <i class="fa-solid fa-search" style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--text-placeholder);"></i>
                </div>
                <div id="merchantList"></div>
            </div>
        </div>

        <div class="tool-container note-taker-tool">
            <h3 class="tool-card-title"><i class="fa-regular fa-pen-to-square" style="margin-right: 8px;"></i>Notes</h3>
            <div class="macos-textfield-container" style="flex-grow: 1; display:flex;">
                <textarea id="noteArea" class="macos-textfield" placeholder="Notes area..."></textarea>
            </div>
            <div class="controls-and-stats" style="margin-top:16px;">
                <div style="display: flex; justify-content: space-between; align-items: center; gap: 10px;">
                    <div style="display: flex; gap: 8px;">
                        <button id="btnAddSeparator" class="macos secondary"><i class="fa-solid fa-minus"></i>Separator</button>
                        <button id="btnAddSpacing" class="macos secondary"><i class="fa-solid fa-grip-lines"></i>Spacing</button>
                        <button id="btnClearAllNotes" class="macos danger"><i class="fa-solid fa-eraser"></i>Clear All</button>
                    </div>
                     <div class="counter-pill">
                        <p><i class="fa-solid fa-users"></i>Merchants: <span id="merchantCount">0</span></p>
                        <p><i class="fa-solid fa-file-lines"></i>Cases: <span id="totalTemplates">0</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="splitModal" class="modal-overlay">
        <div class="modal-content">
            <h2><i class="fa-solid fa-table-columns" style="margin-right:8px;"></i>Split Selected Merchant(s)</h2>
            <div id="splitMerchantInfo" style="font-size: 0.9em; color: var(--text-secondary); background-color: rgba(0,0,0,0.05); padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border-subtle);"></div>
            <div>
                <label for="splitOrdersPerTemplate">Removal Orders per Template:</label>
                <div class="macos-textfield-container" style="width: 80px; margin-top: 4px;">
                    <input type="number" id="splitOrdersPerTemplate" class="macos-textfield" style="text-align:center;" min="1" value="2">
                </div>
            </div>
            <div style="font-size: 0.9em; color: var(--text-secondary);">
                Calculated Total Templates: <span id="splitCalculatedTemplates" style="font-weight: 600; color: var(--text-primary);">0</span>
            </div>
            <hr style="border:none; border-top: 1px solid var(--border-subtle); margin: 6px 0;">
            <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                <label for="splitNumberInput" style="flex-shrink: 0;">Templates per Split File:</label>
                <div class="macos-textfield-container" style="width: 100px;">
                    <input type="number" id="splitNumberInput" class="macos-textfield" style="text-align:center;" min="1" placeholder="e.g., 100">
                </div>
            </div>
            <div class="modal-actions">
                <button id="btnCancelSplit" class="macos secondary"><i class="fa-solid fa-xmark"></i>Cancel</button>
                <button id="btnGenerateSplits" class="macos primary"><i class="fa-solid fa-file-zipper"></i>Generate & Download</button>
            </div>
        </div>
    </div>
    
    <div id="settingsModal" class="modal-overlay">
        <div class="modal-content">
             <h2><span><i class="fa-solid fa-sliders"></i>Settings</span></h2>
            <div style="display:flex; flex-direction:column; gap: 15px;">
                <div style="display:flex; flex-direction:column; gap: 5px;">
                    <label for="settingsFilenamePrefix">Filename Prefix:</label>
                    <div class="macos-textfield-container"><input type="text" id="settingsFilenamePrefix" class="macos-textfield" placeholder="e.g., 3COUTB"></div>
                </div>
                 <div style="display:flex; flex-direction:column; gap: 5px;">
                     <label for="settingsAmzlCarriers">AMZL-type Carriers:</label>
                     <div class="macos-textfield-container"><input type="text" id="settingsAmzlCarriers" class="macos-textfield" placeholder="e.g., AMZL,AMZN"></div>
                </div>
                <div style="display:flex; flex-direction:column; gap: 5px;">
                     <label for="settingsOtherCarriers">Other Carriers (for extraction):</label>
                     <div class="macos-textfield-container"><input type="text" id="settingsOtherCarriers" class="macos-textfield" placeholder="e.g., UPS,USPS"></div>
                </div>
                 <div style="display: flex; justify-content: space-between; align-items: center;">
                    <label for="settingsShowMerchantSearchToggleInput">Show Merchant Search Bar</label>
                    <label class="macos-switch"><input type="checkbox" id="settingsShowMerchantSearchToggleInput"><span class="slider"></span></label>
                </div>
            </div>
            <div class="modal-actions">
                <button id="btnCloseSettingsModal" class="macos secondary">Cancel</button>
                <button id="btnSaveChangesSettings" class="macos primary"><i class="fa-solid fa-save"></i>Save Settings</button>
            </div>
        </div>
    </div>

<script>
    const amzlTemplate = `We've reviewed our removal orders and discovered some shipments whose delivery status is unclear. Could you please check on your end? We're unable to verify the tracking status. If they were lost in transit, could you kindly issue a reimbursement`;
    const upsUspsTemplate = `The Removal Order Status indicates "Completed," yet we never received this order. We kindly request a reimbursement for this discrepancy.`;
    const noteSeparator = '\n\n' + '-'.repeat(41) + '\n';
    const noteSeparatorRegex = /\n\n-{41}\n/g;
    const localStorageKey = 'savedNotesContent_amzlTool';
    const upsUspsOutputKey = 'stagedUpsUspsTNs_amzlTool';
    const upsUspsContextKey = 'stagedUpsUspsContext_amzlTool';

    // Settings Keys
    const settingsKey = 'outboundToolSettings_v1';
    let appSettings = {
        filenamePrefix: '3COUTB',
        amzlTypeCarriers: ['AMZN', 'AMZL', 'AMZL_US_PREMIUM'],
        otherCarriers: ['UPS', 'USPS'],
        showMerchantSearch: false // New setting, default to false
    };
    // Regex patterns, will be initialized/updated by loadSettings
    let regexPatterns = {
        amzlSource: null,
        otherSource: null,
        allExisting: null,
        coreTnExtract: null
    };


    let tempUpsUspsData = {}; 

    function escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function buildCarrierRegexPart(carrierArray) {
        if (!carrierArray || carrierArray.length === 0) return '(?:UNKNOWN_CARRIER_TYPE)'; 
        return '(?:' + carrierArray.map(escapeRegExp).join('|') + ')';
    }

    function initializeRegexPatterns() {
        const amzlCarrierPart = buildCarrierRegexPart(appSettings.amzlTypeCarriers);
        const otherCarrierPart = buildCarrierRegexPart(appSettings.otherCarriers);
        const allCarriersCombined = [...appSettings.amzlTypeCarriers, ...appSettings.otherCarriers];
        const uniqueAllCarriers = Array.from(new Set(allCarriersCombined.filter(c => c.trim() !== '')));
        const allCarrierPart = buildCarrierRegexPart(uniqueAllCarriers.length > 0 ? uniqueAllCarriers : ['TEMP_PLACEHOLDER']); 

        regexPatterns.amzlSource = new RegExp(`\\b([A-Z0-9]+(?:-|\\s)*?)\\s*\\((${amzlCarrierPart})\\)`, 'gi');
        regexPatterns.otherSource = new RegExp(`\\b([A-Z0-9]+(?:-|\\s)*?)\\s*\\((${otherCarrierPart})\\)`, 'gi');
        regexPatterns.allExisting = new RegExp(`\\b([A-Z0-9]+(?:-|\\s)*?\\s*\\(${allCarrierPart}\\))`, 'gi');
        regexPatterns.coreTnExtract = new RegExp(`\\s*\\(${allCarrierPart}\\)$`, 'i');
    }


    function loadSettings() {
        const savedSettings = localStorage.getItem(settingsKey);
        if (savedSettings) {
            try {
                const parsed = JSON.parse(savedSettings);
                appSettings.filenamePrefix = parsed.filenamePrefix || '3COUTB';
                appSettings.amzlTypeCarriers = Array.isArray(parsed.amzlTypeCarriers) && parsed.amzlTypeCarriers.length > 0 ? parsed.amzlTypeCarriers : ['AMZN', 'AMZL', 'AMZL_US_PREMIUM'];
                appSettings.otherCarriers = Array.isArray(parsed.otherCarriers) && parsed.otherCarriers.length > 0 ? parsed.otherCarriers : ['UPS', 'USPS'];
                appSettings.showMerchantSearch = parsed.hasOwnProperty('showMerchantSearch') ? parsed.showMerchantSearch : false;
            } catch (e) {
                console.error("Error parsing saved settings, using defaults.", e);
            }
        }
        initializeRegexPatterns(); 
        document.getElementById('settingsFilenamePrefix').value = appSettings.filenamePrefix;
        document.getElementById('settingsAmzlCarriers').value = appSettings.amzlTypeCarriers.join(',');
        document.getElementById('settingsOtherCarriers').value = appSettings.otherCarriers.join(',');
        document.getElementById('settingsShowMerchantSearchToggleInput').checked = appSettings.showMerchantSearch;
        applyMerchantSearchVisibility();
    }

    function saveSettings() {
        appSettings.filenamePrefix = document.getElementById('settingsFilenamePrefix').value.trim() || '3COUTB';
        
        const amzlStr = document.getElementById('settingsAmzlCarriers').value.trim();
        appSettings.amzlTypeCarriers = amzlStr ? amzlStr.split(',').map(s => s.trim()).filter(s => s) : ['AMZN', 'AMZL', 'AMZL_US_PREMIUM'];
        if(appSettings.amzlTypeCarriers.length === 0) appSettings.amzlTypeCarriers = ['AMZN', 'AMZL', 'AMZL_US_PREMIUM'];

        const otherStr = document.getElementById('settingsOtherCarriers').value.trim();
        appSettings.otherCarriers = otherStr ? otherStr.split(',').map(s => s.trim()).filter(s => s) : ['UPS', 'USPS'];
        if(appSettings.otherCarriers.length === 0) appSettings.otherCarriers = ['UPS', 'USPS'];

        appSettings.showMerchantSearch = document.getElementById('settingsShowMerchantSearchToggleInput').checked;

        localStorage.setItem(settingsKey, JSON.stringify(appSettings));
        initializeRegexPatterns(); 
        applyMerchantSearchVisibility();
        alert("Settings saved!");
    }

    function applyMerchantSearchVisibility() {
        const searchContainer = document.getElementById('merchantSearchContainer');
        const searchInput = document.getElementById('merchantSearchInput');
        if (searchContainer) {
            if (appSettings.showMerchantSearch) {
                searchContainer.style.display = 'block';
            } else {
                searchContainer.style.display = 'none';
                if (searchInput) searchInput.value = ''; 
            }
            filterMerchants();
        }
    }

    function filterMerchants() {
        const searchInput = document.getElementById('merchantSearchInput');
        const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : "";
        const merchantItems = document.querySelectorAll('#merchantList .merchant-item');

        merchantItems.forEach(item => {
            const displayName = item.dataset.displayName ? item.dataset.displayName.toLowerCase() : "";
            if (displayName.includes(searchTerm)) {
                item.style.display = 'flex'; 
            } else {
                item.style.display = 'none';
            }
        });
    }


    function saveNotesToLocalStorage() {
        const noteArea = document.getElementById('noteArea');
        if (noteArea) {
            localStorage.setItem(localStorageKey, noteArea.value);
        }
    }
    
    function getFormattedDate() {
        const date = new Date();
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        return `${month}-${day}`;
    }

    function downloadText(text, filename) {
        try {
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        } catch (error) {
            console.error("Error during download:", error);
            alert("An error occurred while trying to download the file.");
        }
    }

    function sanitizeFilename(name) {
        return name.replace(/[\s\\/:"*?<>|]+/g, '_').substring(0, 50);
    }
    
    function countTemplatesInText(text, templateString) {
        if (!text || !templateString) return 0;
        const escapedTemplate = templateString.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        return (text.match(new RegExp(escapedTemplate, 'g')) || []).length;
    }

    function parseShipmentData() {
        const input = document.getElementById('shipmentInput');
        if (!input.value.trim()) return;
        
        const noteArea = document.getElementById('noteArea');
        const groupToggle = document.getElementById('groupToggle');
        const groupSizeInput = document.getElementById('parserGroupSize');

        const inputValue = input.value;
        input.value = ''; 

        const existingTrackingNumbers = new Set(
            (noteArea.value.match(regexPatterns.allExisting) || [])
            .map(tn => tn.replace(regexPatterns.coreTnExtract, '').replace(/\s|-/g, ''))
            .filter(Boolean)
        );

        const seenInBatch = new Set();
        let skippedCount = 0;
        const merchantBlocks = {};

        const removalBlocks = inputValue.split(/(?=Removal order ID:)/g);
        removalBlocks.forEach(block => {
            if (!block.trim()) return;

            const roMatch = block.match(/Removal order ID:\s*(\S+)/);
            if (!roMatch) return;
            const removalOrderId = roMatch[1];
            
            const shipmentSections = block.split(/(?=Shipment ID:)/g);
            shipmentSections.forEach(section => {
                const tnMatch = section.match(regexPatterns.amzlSource);
                if (!tnMatch) return;
                
                const trackingNumber = tnMatch[1].replace(/\s|-/g, '');
                if (existingTrackingNumbers.has(trackingNumber) || seenInBatch.has(trackingNumber)) {
                    skippedCount++;
                    return;
                }
                seenInBatch.add(trackingNumber);

                const merchantSkuMatch = section.match(/Merchant SKU:\s*([^\n]+)/);
                const merchantName = merchantSkuMatch ? merchantSkuMatch[1].split('-')[0] : 'Unknown';
                
                if (!merchantBlocks[merchantName]) {
                    merchantBlocks[merchantName] = [];
                }
                merchantBlocks[merchantName].push(removalOrderId);
            });
        });

        let finalNoteText = noteArea.value.trim() ? noteArea.value.trim() + noteSeparator : "";
        const groupSize = groupToggle.checked ? parseInt(groupSizeInput.value, 10) : 1;

        Object.keys(merchantBlocks).forEach(merchantName => {
            const roIds = merchantBlocks[merchantName];
            for (let i = 0; i < roIds.length; i += groupSize) {
                const chunk = roIds.slice(i, i + groupSize);
                finalNoteText += `${merchantName}\n${amzlTemplate}\nRemoval order ID: ${chunk.join(', ')}\n\n`;
            }
        });
        
        noteArea.value = finalNoteText.trim() + '\n';
        saveNotesToLocalStorage();
        countTemplatesNoteTaker();
        input.placeholder = `Processed ${seenInBatch.size} new shipments. Skipped ${skippedCount} duplicates.`;
    }
    
    function countTemplatesNoteTaker() {
        const noteArea = document.getElementById('noteArea');
        const merchantListDiv = document.getElementById('merchantList');
        const fullText = noteArea.value;

        merchantListDiv.innerHTML = '';
        if (!fullText.trim()) {
            document.getElementById('merchantCount').textContent = '0';
            document.getElementById('totalTemplates').textContent = '0';
            return;
        }

        const sections = fullText.split(noteSeparatorRegex);
        let merchantCount = 0;
        let totalTemplates = 0;

        sections.forEach(section => {
            if (!section.trim()) return;
            merchantCount++;
            const templateCount = (section.match(new RegExp(amzlTemplate, 'g')) || []).length;
            totalTemplates += templateCount;
            
            const lines = section.trim().split('\n');
            const merchantName = lines[0] || `Merchant ${merchantCount}`;

            const merchantItem = document.createElement('div');
            merchantItem.className = 'merchant-item';
            merchantItem.dataset.key = section;
            merchantItem.dataset.displayName = merchantName;
            merchantItem.dataset.count = templateCount;
            
            const checkboxContainer = document.createElement('label');
            checkboxContainer.className = 'macos-checkbox-container';
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'macos-checkbox';
            checkbox.onchange = () => merchantItem.classList.toggle('selected', checkbox.checked);
            
            const nameSpan = document.createElement('span');
            nameSpan.textContent = merchantName;
            nameSpan.style.flexGrow = '1';

            const caseCountSpan = document.createElement('span');
            caseCountSpan.className = 'case-count';
            caseCountSpan.textContent = `${templateCount} case${templateCount !== 1 ? 's' : ''}`;
            
            checkboxContainer.appendChild(checkbox);
            checkboxContainer.appendChild(nameSpan);
            merchantItem.appendChild(checkboxContainer);
            merchantItem.appendChild(caseCountSpan);

            merchantListDiv.appendChild(merchantItem);
        });

        document.getElementById('merchantCount').textContent = merchantCount;
        document.getElementById('totalTemplates').textContent = totalTemplates;
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadSettings();
        
        const noteArea = document.getElementById('noteArea');
        if (noteArea) {
            noteArea.value = localStorage.getItem(localStorageKey) || "";
            let timer;
            noteArea.addEventListener('input', () => {
                clearTimeout(timer);
                timer = setTimeout(() => {
                    saveNotesToLocalStorage();
                    countTemplatesNoteTaker();
                }, 300);
            });
            countTemplatesNoteTaker();
        }

        document.getElementById('shipmentInput').addEventListener('paste', () => setTimeout(parseShipmentData, 50));
        
        document.getElementById('btnOpenSettings').addEventListener('click', () => document.getElementById('settingsModal').style.display = 'flex');
        document.getElementById('btnCloseSettingsModal').addEventListener('click', () => document.getElementById('settingsModal').style.display = 'none');
        document.getElementById('btnSaveChangesSettings').addEventListener('click', () => {
            saveSettings();
            document.getElementById('settingsModal').style.display = 'none';
        });

        document.getElementById('groupToggle').addEventListener('change', (e) => {
            document.getElementById('parserGroupSize').disabled = !e.target.checked;
        });

        // Event listeners for buttons
        document.getElementById('btnDownloadSelected').addEventListener('click', () => {
            const selected = Array.from(document.querySelectorAll('#merchantList .merchant-item.selected'));
            if (selected.length === 0) return alert("No merchants selected.");
            const text = selected.map(el => el.dataset.key).join(noteSeparator);
            const caseCount = selected.reduce((sum, el) => sum + parseInt(el.dataset.count, 10), 0);
            downloadText(text, `${appSettings.filenamePrefix}_${getFormattedDate()}_(${caseCount}).txt`);
        });

        document.getElementById('btnSelectAll').addEventListener('click', () => {
             document.querySelectorAll('#merchantList .macos-checkbox').forEach(cb => {
                if (!cb.checked) {
                    cb.checked = true;
                    cb.closest('.merchant-item')?.classList.add('selected');
                }
             });
        });
        
        document.getElementById('btnClearSelected').addEventListener('click', () => {
             if (!confirm("Are you sure you want to clear selected merchants from notes?")) return;
             const selectedKeys = new Set(Array.from(document.querySelectorAll('#merchantList .merchant-item.selected')).map(el => el.dataset.key));
             const sections = noteArea.value.split(noteSeparatorRegex);
             const newText = sections.filter(s => s.trim() && !selectedKeys.has(s)).join(noteSeparator);
             noteArea.value = newText;
             saveNotesToLocalStorage();
             countTemplatesNoteTaker();
        });

        document.getElementById('btnAddSeparator').addEventListener('click', () => {
            noteArea.value = noteArea.value.trim() + noteSeparator;
        });

        document.getElementById('btnAddSpacing').addEventListener('click', () => {
             noteArea.value = noteArea.value.trim() + '\n\n';
        });

        document.getElementById('btnClearAllNotes').addEventListener('click', () => {
            if (confirm("Are you sure you want to clear ALL notes?")) {
                noteArea.value = "";
                saveNotesToLocalStorage();
                countTemplatesNoteTaker();
            }
        });
    });
</script>
</body>
</html>
